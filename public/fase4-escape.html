<!DOCTYPE html>
<html lang="pt-PT">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAASI Escape Room - Fase 4: Implementação e Acompanhamento</title>
    <style>
      /* ===== TOAST SYSTEM - COPIED FROM FASE1-ESCAPE.HTML ===== */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
      }

      .toast {
        background: #333;
        color: white;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        padding-right: 50px;
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        background: #28a745;
        border-left: 4px solid #1e7e34;
      }

      .toast.error {
        background: #dc3545;
        border-left: 4px solid #c82333;
      }

      .toast.warning {
        background: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .toast.info {
        background: #17a2b8;
        border-left: 4px solid #138496;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* ===== BASE STYLES - FOLLOWING FASE1-ESCAPE.HTML PATTERN ===== */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
      }

      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        z-index: 1000;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .back-button:hover {
        background: rgba(84, 91, 98, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .score {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(51, 51, 51, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: rgba(245, 245, 245, 0.8);
        backdrop-filter: blur(5px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      .progress-bar {
        background: #e0e0e0;
        height: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .progress-fill {
        background: #4caf50;
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s;
        width: 0%;
      }

      .state {
        display: none;
        padding: 30px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .state.active {
        display: block;
        animation: slideIn 0.5s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        margin: 8px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* ===== PUZZLE 1: DYNAMIC PROGRESS MONITORING DASHBOARD ===== */
      .progress-monitoring-command-center {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
      }

      .monitoring-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 20px;
        border-left: 4px solid var(--metric-color);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .metric-icon {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .metric-content h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--metric-color);
      }

      .metric-trend {
        font-size: 0.9rem;
        margin-top: 5px;
      }

      .metric-trend.positive {
        color: #4caf50;
      }

      .metric-trend.negative {
        color: #f44336;
      }

      .programs-monitoring-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .program-monitor {
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .program-monitor.active {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .monitor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .program-icon {
        font-size: 2rem;
        margin-right: 10px;
      }

      .status-indicator {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-indicator.active {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .status-indicator.warning {
        background: #fff3e0;
        color: #f57c00;
      }

      .status-indicator.error {
        background: #ffebee;
        color: #c62828;
      }

      .progress-visualization {
        margin: 15px 0;
      }

      .progress-chart {
        width: 100%;
        height: 100px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
        position: relative;
        overflow: hidden;
      }

      .chart-bar {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #66bb6a);
        border-radius: 8px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .progress-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
      }

      .detail-item .label {
        color: #6c757d;
      }

      .detail-item .value {
        font-weight: 600;
        color: #2c3e50;
      }

      .monitoring-alerts {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        padding: 10px;
        margin: 10px 0;
      }

      .alert {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 6px;
        font-size: 0.9rem;
        margin: 5px 0;
      }

      .alert.positive {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .alert.warning {
        background: #fff3e0;
        color: #f57c00;
      }

      .alert.negative {
        background: #ffebee;
        color: #c62828;
      }

      .alert-icon {
        font-size: 1rem;
      }

      .monitoring-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
      }

      .action-btn {
        flex: 1;
        padding: 8px 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .action-btn:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      .predictive-analytics {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        padding: 20px;
        margin-top: 30px;
      }

      .prediction-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 15px;
      }

      .prediction-card {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-radius: 12px;
        padding: 15px;
        border-left: 4px solid #2196f3;
      }

      .prediction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .confidence-score {
        font-size: 0.8rem;
        color: #1565c0;
        font-weight: 600;
      }

      .prediction-timeline {
        display: flex;
        gap: 15px;
        margin-top: 10px;
      }

      .timeline-marker {
        text-align: center;
        flex: 1;
      }

      .marker-label {
        display: block;
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 5px;
      }

      .probability {
        font-size: 1rem;
        font-weight: bold;
        color: #2196f3;
      }

      /* ===== PUZZLE 2: CRISIS MANAGEMENT SIMULATION CENTER ===== */
      .crisis-management-center {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
      }

      .crisis-alert-system {
        margin-bottom: 30px;
      }

      .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .alert-icon {
        font-size: 2rem;
        animation: pulse 2s infinite;
      }

      .alert-level {
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 20px;
        font-weight: bold;
      }

      .active-crises {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .crisis-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #ff9800;
        position: relative;
        animation: highlightCrisis 2s ease-in-out infinite;
      }

      @keyframes highlightCrisis {
        0%,
        100% {
          background: white;
        }
        50% {
          background: #fff3e0;
        }
      }

      .crisis-card.urgent {
        border-color: #f44336;
        animation: urgentPulse 1s ease-in-out infinite;
      }

      @keyframes urgentPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      .crisis-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .crisis-icon {
        font-size: 2rem;
        margin-right: 15px;
      }

      .urgency-timer {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .timer-label {
        color: #ccc;
      }

      .timer-value {
        font-weight: bold;
        font-size: 1.1rem;
      }

      .crisis-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .crisis-details p {
        margin: 8px 0;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .crisis-response-options {
        display: grid;
        gap: 15px;
        margin: 20px 0;
      }

      .response-option {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .response-option:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .response-option.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .response-option.correct {
        border-color: #4caf50;
        background: #e8f5e9;
      }

      .response-option.incorrect {
        border-color: #f44336;
        background: #ffebee;
      }

      .option-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .success-probability {
        font-size: 0.8rem;
        padding: 4px 8px;
        background: #e3f2fd;
        color: #1565c0;
        border-radius: 8px;
        font-weight: 600;
      }

      .option-details {
        font-size: 0.9rem;
        line-height: 1.4;
        margin: 10px 0;
      }

      .option-details p {
        margin: 5px 0;
      }

      .option-risks {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .risk,
      .sustainability {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
      }

      .risk.low,
      .sustainability.high {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .risk.medium,
      .sustainability.medium {
        background: #fff3e0;
        color: #f57c00;
      }

      .risk.high,
      .sustainability.low {
        background: #ffebee;
        color: #c62828;
      }

      .crisis-decision-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        text-align: center;
      }

      .decision-timer {
        margin-bottom: 15px;
      }

      .timer-label {
        color: #6c757d;
        margin-right: 10px;
      }

      .decision-countdown {
        font-size: 1.2rem;
        font-weight: bold;
        color: #f44336;
      }

      .btn-crisis-action {
        background: #4caf50;
        margin: 0 5px;
      }

      .btn-crisis-action:hover {
        background: #45a049;
      }

      .btn-crisis-consult {
        background: #ff9800;
        margin: 0 5px;
      }

      .btn-crisis-consult:hover {
        background: #f57c00;
      }

      .crisis-impact-simulator {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
      }

      .impact-visualization {
        margin-top: 15px;
      }

      .scenario-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .scenario {
        background: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
      }

      .scenario.current {
        border: 2px solid #ff9800;
      }

      .scenario.projected {
        border: 2px solid #4caf50;
      }

      .impact-metrics {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
      }

      .impact-metrics .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 6px;
      }

      .risk-indicator {
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .risk-indicator.low {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .risk-indicator.medium {
        background: #fff3e0;
        color: #f57c00;
      }

      .risk-indicator.high {
        background: #ffebee;
        color: #c62828;
      }

      .risk-indicator.critical {
        background: #f44336;
        color: white;
      }

      /* ===== PUZZLE 3: STRATEGIC ADAPTATION LABORATORY ===== */
      .strategy-adaptation-lab {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
      }

      .adaptation-dashboard {
        margin-bottom: 30px;
      }

      .current-strategy-analysis {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .strategy-effectiveness-meter {
        text-align: center;
      }

      .effectiveness-gauge {
        position: relative;
        width: 200px;
        height: 100px;
        margin: 15px auto;
        background: #f0f0f0;
        border-radius: 100px 100px 0 0;
        overflow: hidden;
      }

      .gauge-fill {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 100%;
        background: linear-gradient(90deg, #f44336, #ff9800, #4caf50);
        border-radius: 100px 100px 0 0;
        transition: width 0.5s ease;
      }

      .gauge-value {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
      }

      .strategy-testing-environment {
        margin-top: 30px;
      }

      .testing-scenarios {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .scenario-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .scenario-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .scenario-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .scenario-icon {
        font-size: 2rem;
        margin-right: 15px;
      }

      .scenario-complexity {
        padding: 4px 12px;
        background: #fff3e0;
        color: #f57c00;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .scenario-description {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .scenario-description p {
        margin: 8px 0;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .strategy-options {
        display: grid;
        gap: 15px;
        margin: 20px 0;
      }

      .strategy-option {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .strategy-option:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .strategy-option.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .option-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .impact-preview {
        display: flex;
        gap: 10px;
      }

      .positive,
      .negative,
      .neutral {
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 500;
      }

      .positive {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .negative {
        background: #ffebee;
        color: #c62828;
      }

      .neutral {
        background: #fff3e0;
        color: #f57c00;
      }

      .strategy-simulation {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
      }

      .simulation-metrics {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .simulation-metrics .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
      }

      .value.increase {
        color: #4caf50;
        font-weight: 600;
      }

      .value.decrease {
        color: #f44336;
        font-weight: 600;
      }

      .value.maintain {
        color: #2196f3;
        font-weight: 600;
      }

      .strategy-testing-controls {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .btn-test-strategy,
      .btn-run-simulation {
        flex: 1;
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-test-strategy {
        background: #667eea;
        color: white;
      }

      .btn-test-strategy:hover {
        background: #5a6fd8;
      }

      .btn-run-simulation {
        background: #17a2b8;
        color: white;
      }

      .btn-run-simulation:hover {
        background: #138496;
      }

      .adaptation-results {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
      }

      .results-visualization {
        margin-top: 15px;
      }

      .before-after-comparison {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
      }

      .comparison-chart {
        background: #f8f9fa;
        border-radius: 8px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
      }

      .key-insights {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .insight {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .insight.positive {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .insight.warning {
        background: #fff3e0;
        color: #f57c00;
      }

      .insight-icon {
        font-size: 1rem;
      }

      /* ===== PUZZLE 4: AUTONOMY TRANSITION ORCHESTRATOR ===== */
      .autonomy-transition-orchestrator {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
      }

      .transition-dashboard {
        margin-bottom: 30px;
      }

      .autonomy-readiness-assessment {
        text-align: center;
        margin-bottom: 30px;
      }

      .readiness-radar {
        position: relative;
        width: 300px;
        height: 300px;
        margin: 20px auto;
        background: radial-gradient(circle, #f8f9fa, #e9ecef);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .radar-legend {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: white;
        border-radius: 8px;
      }

      .color-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .transition-planning-workspace {
        margin-top: 30px;
      }

      .transition-phases {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .phase-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .phase-card.active {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .phase-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .phase-icon {
        font-size: 2rem;
        margin-right: 15px;
      }

      .phase-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        background: #fff3e0;
        color: #f57c00;
      }

      .phase-objectives {
        margin: 15px 0;
      }

      .objectives-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .objective-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .objective-content {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .objective-text {
        color: #2c3e50;
      }

      .objective-progress {
        width: 100px;
      }

      .btn-plan-objective {
        padding: 6px 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
      }

      .phase-milestones {
        margin-top: 15px;
      }

      .milestones-timeline {
        display: flex;
        gap: 15px;
        margin-top: 10px;
      }

      .milestone {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .milestone-marker {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #667eea;
      }

      .milestone-content {
        display: flex;
        flex-direction: column;
      }

      .milestone-content h6 {
        margin: 0;
        font-size: 0.9rem;
        color: #2c3e50;
      }

      .milestone-date {
        font-size: 0.7rem;
        color: #6c757d;
      }

      .support-reduction-planner {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
      }

      .support-timeline {
        margin-top: 15px;
      }

      .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .timeline-controls {
        display: flex;
        gap: 10px;
      }

      .btn-auto-generate,
      .btn-customize {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-auto-generate {
        background: #4caf50;
        color: white;
      }

      .btn-customize {
        background: #667eea;
        color: white;
      }

      .support-categories {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .support-category {
        background: white;
        border-radius: 12px;
        padding: 15px;
        border: 2px solid #dee2e6;
      }

      .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .category-icon {
        font-size: 1.5rem;
        margin-right: 10px;
      }

      .current-intensity {
        padding: 4px 8px;
        background: #fff3e0;
        color: #f57c00;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .reduction-timeline {
        display: flex;
        justify-content: space-between;
        margin: 15px 0;
      }

      .timeline-month {
        text-align: center;
        flex: 1;
      }

      .month-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 8px;
      }

      .support-level {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .level-indicator {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
      }

      .support-level.high .level-indicator {
        background: #f44336;
      }

      .support-level.medium .level-indicator {
        background: #ff9800;
      }

      .support-level.low .level-indicator {
        background: #4caf50;
      }

      .level-text {
        font-size: 0.7rem;
        color: #6c757d;
      }

      .reduction-controls {
        margin-top: 15px;
      }

      .btn-adjust-timeline {
        width: 100%;
        padding: 8px 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
      }

      .maintenance-strategy-designer {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
      }

      .strategy-builder {
        margin-top: 15px;
      }

      .strategy-components {
        margin-bottom: 20px;
      }

      .components-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .component-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .component-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
      }

      .component-card.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .component-icon {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .component-description {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 10px 0;
      }

      .component-effectiveness {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
      }

      .effectiveness-stars {
        display: flex;
        gap: 2px;
      }

      .star {
        color: #ddd;
      }

      .star.filled {
        color: #ffc107;
      }

      .btn-add-component {
        width: 100%;
        padding: 8px 12px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 10px;
      }

      .strategy-preview {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
      }

      .strategy-timeline-preview {
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
      }

      /* ===== MOBILE RESPONSIVENESS ===== */
      @media (max-width: 1200px) {
        .monitoring-dashboard,
        .programs-monitoring-grid,
        .prediction-cards {
          grid-template-columns: 1fr;
        }

        .scenario-comparison,
        .before-after-comparison {
          grid-template-columns: 1fr;
        }

        .components-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
        }

        .container {
          padding: 20px;
        }

        .back-button,
        .score {
          position: static;
          display: inline-block;
          margin: 5px;
        }

        .crisis-card,
        .scenario-card,
        .phase-card {
          padding: 15px;
          margin: 10px 0;
        }

        .readiness-radar {
          width: 200px;
          height: 200px;
        }

        .radar-legend {
          grid-template-columns: 1fr;
        }

        .milestones-timeline {
          flex-direction: column;
          gap: 10px;
        }

        .btn {
          width: 100%;
          margin: 5px 0;
          padding: 15px;
          font-size: 16px;
        }
      }

      /* ===== ANIMATIONS ===== */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      .shake {
        animation: shake 0.5s ease-in-out;
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      /* ===== LOADING STATE ===== */
      .loading {
        text-align: center;
        padding: 50px;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <a href="index.html" class="back-button">← Voltar ao Menu</a>
    <div class="score">Pontuação: <span id="score">0</span>/100</div>

    <div class="main-container">
      <div class="container">
        <div class="header">
          <h1>🎯 SAASI Escape Room - Fase 4</h1>
          <h2>Implementação e Acompanhamento Avançado</h2>
          <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
          </div>
          <p>Progresso: <span id="progress-text">0%</span></p>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <h3>Inicializando Escape Room Fase 4...</h3>
          <p>Preparando simulações avançadas de implementação</p>
        </div>

        <!-- Estado 1: Início -->
        <div id="state-inicio" class="state">
          <h2>🎯 Bem-vindo à Fase 4 - Escape Room Final</h2>
          <div id="phases-summary">
            <h3>📋 Resumo do Escape Room Completo</h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
              "
            >
              <div
                style="background: #e8f5e9; padding: 15px; border-radius: 10px"
              >
                <h4>Fase 1</h4>
                <p>
                  <strong>Pontuação:</strong>
                  <span id="phase1-score">0</span>/100
                </p>
                <p><strong>Status:</strong> ✅ Concluído</p>
              </div>
              <div
                style="background: #e3f2fd; padding: 15px; border-radius: 10px"
              >
                <h4>Fase 2</h4>
                <p>
                  <strong>Pontuação:</strong>
                  <span id="phase2-score">0</span>/100
                </p>
                <p><strong>Status:</strong> ✅ Concluído</p>
              </div>
              <div
                style="background: #fff3e0; padding: 15px; border-radius: 10px"
              >
                <h4>Fase 3</h4>
                <p>
                  <strong>Pontuação:</strong>
                  <span id="phase3-score">0</span>/100
                </p>
                <p><strong>Status:</strong> ✅ Concluído</p>
              </div>
              <div
                style="background: #f3e5f5; padding: 15px; border-radius: 10px"
              >
                <h4>Fase 4</h4>
                <p>
                  <strong>Pontuação:</strong>
                  <span id="phase4-score">0</span>/100
                </p>
                <p><strong>Status:</strong> 🚀 Em curso</p>
              </div>
            </div>
          </div>

          <div
            style="
              background: #ffebee;
              padding: 20px;
              border-radius: 15px;
              margin: 20px 0;
            "
          >
            <h3>⚡ 4 Simulações Avançadas:</h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-top: 15px;
              "
            >
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #4caf50;
                "
              >
                <h4>📊 Puzzle 1</h4>
                <p>
                  <strong>Monitorização Dinâmica</strong><br />Dashboard em
                  tempo real
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #f44336;
                "
              >
                <h4>🚨 Puzzle 2</h4>
                <p>
                  <strong>Gestão de Crises</strong><br />Simulador de
                  emergências
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #2196f3;
                "
              >
                <h4>🧪 Puzzle 3</h4>
                <p>
                  <strong>Laboratório Estratégico</strong><br />Adaptação
                  inteligente
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #9c27b0;
                "
              >
                <h4>🌟 Puzzle 4</h4>
                <p>
                  <strong>Orquestrador Autonomia</strong><br />Transição
                  sustentável
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background: #e8f5e9;
              padding: 20px;
              border-radius: 15px;
              margin: 20px 0;
            "
          >
            <h3>📅 Situação: 3 Meses Após Implementação</h3>
            <p>
              O plano de intervenção está em execução há 3 meses. Como técnico
              SAASI, deve agora:
            </p>
            <ul>
              <li>🔍 <strong>Monitorizar</strong> o progresso em tempo real</li>
              <li>🚨 <strong>Gerir crises</strong> que possam surgir</li>
              <li>
                🎯 <strong>Adaptar estratégias</strong> baseado nos resultados
              </li>
              <li>
                🌟 <strong>Preparar a autonomia</strong> sustentável da
                Felisbina
              </li>
            </ul>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <button class="btn" onclick="startEscapeRoom()">
              🚀 Iniciar Simulação Final
            </button>
          </div>
        </div>

        <!-- Estado 2: Puzzle 1 - Dynamic Progress Monitoring -->
        <div id="state-puzzle1" class="state">
          <h2>📊 Puzzle 1: Monitorização Dinâmica de Progresso</h2>
          <p>
            <strong>Objetivo:</strong> Analise o progresso e identifique áreas
            que precisam de ajuste. Meta: responder a 3+ alertas corretamente
          </p>

          <div class="progress-monitoring-command-center">
            <div class="monitoring-dashboard">
              <div class="metric-card" style="--metric-color: #4caf50">
                <div class="metric-icon">📈</div>
                <div class="metric-content">
                  <h4>Progresso Geral</h4>
                  <div class="metric-value">67%</div>
                  <div class="metric-trend positive">+12% este mês</div>
                </div>
              </div>
              <div class="metric-card" style="--metric-color: #2196f3">
                <div class="metric-icon">💼</div>
                <div class="metric-content">
                  <h4>Qualificação</h4>
                  <div class="metric-value">78%</div>
                  <div class="metric-trend positive">+15% desde início</div>
                </div>
              </div>
              <div class="metric-card" style="--metric-color: #ff9800">
                <div class="metric-icon">🧠</div>
                <div class="metric-content">
                  <h4>Bem-estar Mental</h4>
                  <div class="metric-value">82%</div>
                  <div class="metric-trend positive">+22% melhoria</div>
                </div>
              </div>
              <div class="metric-card" style="--metric-color: #f44336">
                <div class="metric-icon">🏠</div>
                <div class="metric-content">
                  <h4>Estabilidade Habitacional</h4>
                  <div class="metric-value">45%</div>
                  <div class="metric-trend negative">-8% preocupante</div>
                </div>
              </div>
            </div>

            <div class="programs-monitoring-grid" id="programs-monitoring">
              <!-- Program monitors will be loaded dynamically -->
            </div>

            <div class="predictive-analytics">
              <h3>🔮 Análise Preditiva</h3>
              <div class="prediction-cards">
                <div class="prediction-card">
                  <div class="prediction-header">
                    <h4>Prontidão para Emprego</h4>
                    <div class="confidence-score">Confiança: 78%</div>
                  </div>
                  <div class="prediction-timeline">
                    <div class="timeline-marker">
                      <span class="marker-label">Mês 4</span>
                      <span class="probability">65% pronto</span>
                    </div>
                    <div class="timeline-marker">
                      <span class="marker-label">Mês 6</span>
                      <span class="probability">85% pronto</span>
                    </div>
                  </div>
                </div>
                <div class="prediction-card">
                  <div class="prediction-header">
                    <h4>Autonomia Plena</h4>
                    <div class="confidence-score">Confiança: 72%</div>
                  </div>
                  <div class="prediction-timeline">
                    <div class="timeline-marker">
                      <span class="marker-label">Mês 6</span>
                      <span class="probability">55% autónoma</span>
                    </div>
                    <div class="timeline-marker">
                      <span class="marker-label">Mês 9</span>
                      <span class="probability">80% autónoma</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <p>
              <strong>Progresso:</strong> <span id="puzzle1-progress">0</span>/3
              alertas analisados
            </p>
            <button
              id="btn-continue-puzzle2"
              class="btn"
              onclick="nextPuzzle(2)"
              style="display: none"
            >
              ➡️ Continuar para Puzzle 2
            </button>
          </div>
        </div>

        <!-- Estado 3: Puzzle 2 - Crisis Management Simulation -->
        <div id="state-puzzle2" class="state">
          <h2>🚨 Puzzle 2: Centro de Simulação de Gestão de Crises</h2>
          <p>
            <strong>Objetivo:</strong> Responda a situações de crise em tempo
            real. Meta: resolver 3+ crises dentro do tempo limite
          </p>

          <div class="crisis-management-center">
            <div class="crisis-alert-system">
              <div class="alert-header">
                <div style="display: flex; align-items: center">
                  <div class="alert-icon pulsing">🚨</div>
                  <h3>Sistema de Alertas de Crise</h3>
                </div>
                <div class="alert-level">NÍVEL ALTO</div>
              </div>

              <div class="active-crises" id="active-crises">
                <!-- Crisis scenarios will be loaded dynamically -->
              </div>
            </div>

            <div class="crisis-impact-simulator">
              <h3>📊 Simulador de Impacto</h3>
              <div class="impact-visualization">
                <div class="scenario-comparison">
                  <div class="scenario current">
                    <h4>Cenário Atual</h4>
                    <div class="impact-metrics">
                      <div class="metric">
                        <span class="label">Continuidade Programas</span>
                        <div class="risk-indicator high">Alto Risco</div>
                      </div>
                      <div class="metric">
                        <span class="label">Bem-estar Emocional</span>
                        <div class="risk-indicator critical">Crítico</div>
                      </div>
                      <div class="metric">
                        <span class="label">Estabilidade Financeira</span>
                        <div class="risk-indicator medium">Médio Risco</div>
                      </div>
                    </div>
                  </div>

                  <div class="scenario projected">
                    <h4>Após Intervenção</h4>
                    <div class="impact-metrics" id="projected-metrics">
                      <div class="metric">
                        <span class="label">Continuidade Programas</span>
                        <div class="risk-indicator medium">Risco Reduzido</div>
                      </div>
                      <div class="metric">
                        <span class="label">Bem-estar Emocional</span>
                        <div class="risk-indicator medium">Estável</div>
                      </div>
                      <div class="metric">
                        <span class="label">Estabilidade Financeira</span>
                        <div class="risk-indicator low">Baixo Risco</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <p>
              <strong>Progresso:</strong> <span id="puzzle2-progress">0</span>/3
              crises resolvidas
            </p>
            <button
              id="btn-continue-puzzle3"
              class="btn"
              onclick="nextPuzzle(3)"
              style="display: none"
            >
              ➡️ Continuar para Puzzle 3
            </button>
          </div>
        </div>

        <!-- Estado 4: Puzzle 3 - Strategic Adaptation Laboratory -->
        <div id="state-puzzle3" class="state">
          <h2>🧪 Puzzle 3: Laboratório de Adaptação Estratégica</h2>
          <p>
            <strong>Objetivo:</strong> Teste e adapte estratégias baseado nos
            resultados. Meta: otimizar plano com 3+ adaptações eficazes
          </p>

          <div class="strategy-adaptation-lab">
            <div class="adaptation-dashboard">
              <div class="current-strategy-analysis">
                <div class="strategy-effectiveness-meter">
                  <h4>Eficácia da Estratégia Atual</h4>
                  <div class="effectiveness-gauge">
                    <div class="gauge-fill" style="width: 67%"></div>
                    <div class="gauge-value">67%</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="strategy-testing-environment">
              <h3>🔬 Ambiente de Teste de Estratégias</h3>
              <div class="testing-scenarios" id="strategy-scenarios">
                <!-- Strategy scenarios will be loaded dynamically -->
              </div>
            </div>

            <div class="adaptation-results">
              <h3>📊 Resultados da Adaptação</h3>
              <div class="results-visualization">
                <div class="before-after-comparison">
                  <div class="comparison-chart" id="adaptation-chart">
                    <p>Teste estratégias para ver comparação</p>
                  </div>
                  <div class="key-insights" id="key-insights">
                    <div class="insight positive">
                      <span class="insight-icon">✅</span>
                      <span class="insight-text"
                        >Selecione estratégias para ver insights</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <p>
              <strong>Progresso:</strong> <span id="puzzle3-progress">0</span>/3
              estratégias testadas
            </p>
            <button
              id="btn-continue-puzzle4"
              class="btn"
              onclick="nextPuzzle(4)"
              style="display: none"
            >
              ➡️ Continuar para Puzzle 4
            </button>
          </div>
        </div>

        <!-- Estado 5: Puzzle 4 - Autonomy Transition Orchestrator -->
        <div id="state-puzzle4" class="state">
          <h2>🌟 Puzzle 4: Orquestrador de Transição para Autonomia</h2>
          <p>
            <strong>Objetivo:</strong> Planear a transição sustentável para
            autonomia. Meta: readiness score >90% com plano de manutenção
          </p>

          <div class="autonomy-transition-orchestrator">
            <div class="transition-dashboard">
              <div class="autonomy-readiness-assessment">
                <h3>🌟 Avaliação de Prontidão para Autonomia</h3>
                <div class="readiness-radar">
                  <div
                    style="position: absolute; font-size: 2rem; color: #667eea"
                  >
                    📊
                  </div>
                </div>
                <div class="radar-legend">
                  <div class="legend-item">
                    <span
                      class="color-indicator"
                      style="background: #4caf50"
                    ></span>
                    <span class="label">Competências Profissionais</span>
                    <span class="value">85%</span>
                  </div>
                  <div class="legend-item">
                    <span
                      class="color-indicator"
                      style="background: #ff9800"
                    ></span>
                    <span class="label">Autonomia Emocional</span>
                    <span class="value">65%</span>
                  </div>
                  <div class="legend-item">
                    <span
                      class="color-indicator"
                      style="background: #2196f3"
                    ></span>
                    <span class="label">Gestão Financeira</span>
                    <span class="value">70%</span>
                  </div>
                  <div class="legend-item">
                    <span
                      class="color-indicator"
                      style="background: #9c27b0"
                    ></span>
                    <span class="label">Rede Social</span>
                    <span class="value">58%</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="transition-planning-workspace">
              <h3>📋 Planeamento da Transição</h3>
              <div class="transition-phases" id="transition-phases">
                <!-- Transition phases will be loaded dynamically -->
              </div>
            </div>

            <div class="support-reduction-planner">
              <h3>📉 Planeador de Redução de Apoio</h3>
              <div class="support-timeline">
                <div class="timeline-header">
                  <h4>Cronograma de Redução Gradual</h4>
                  <div class="timeline-controls">
                    <button
                      class="btn-auto-generate"
                      onclick="autoGenerateReduction()"
                    >
                      🤖 Gerar Automaticamente
                    </button>
                    <button
                      class="btn-customize"
                      onclick="customizeReduction()"
                    >
                      ✏️ Personalizar
                    </button>
                  </div>
                </div>

                <div class="support-categories" id="support-categories">
                  <!-- Support categories will be loaded dynamically -->
                </div>
              </div>
            </div>

            <div class="maintenance-strategy-designer">
              <h3>🔧 Designer de Estratégias de Manutenção</h3>
              <div class="strategy-builder">
                <div class="strategy-components">
                  <h4>Componentes da Estratégia:</h4>
                  <div class="components-grid" id="maintenance-components">
                    <!-- Maintenance components will be loaded dynamically -->
                  </div>
                </div>

                <div class="strategy-preview">
                  <h4>Pré-visualização da Estratégia:</h4>
                  <div class="strategy-timeline-preview" id="strategy-preview">
                    <!-- Strategy preview will be populated -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <p>
              <strong>Progresso:</strong> <span id="puzzle4-progress">0</span>/4
              áreas planeadas
            </p>
            <button
              id="btn-finalize-escape-room"
              class="btn"
              onclick="nextState('conclusao')"
              style="display: none"
            >
              🎉 Finalizar Escape Room SAASI
            </button>
          </div>
        </div>

        <!-- Estado 6: Conclusão -->
        <div id="state-conclusao" class="state">
          <h1>🎉 ESCAPE ROOM SAASI CONCLUÍDO!</h1>
          <h2>🏆 PARABÉNS! CERTIFICAÇÃO COMPLETA!</h2>

          <div
            style="
              text-align: center;
              background: linear-gradient(135deg, #667eea, #764ba2);
              color: white;
              padding: 40px;
              border-radius: 15px;
              margin: 30px 0;
            "
          >
            <h2>
              Pontuação Final Fase 4: <span id="final-score-phase4">0</span>/100
            </h2>
            <h2>
              🌟 PONTUAÇÃO TOTAL ESCAPE ROOM:
              <span id="final-score-total">0</span>/400
            </h2>
            <h3 id="final-level">Mestre SAASI</h3>
            <p>
              <strong>Certificação:</strong>
              <span id="final-certification"
                >Técnico Especialista SAASI Completo</span
              >
            </p>
            <p>
              <strong>Tempo Total:</strong>
              <span id="total-time">0</span> minutos
            </p>
          </div>

          <div id="final-report">
            <h3>📊 Relatório Final Integrado - Todas as Fases:</h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
              "
            >
              <div
                style="
                  background: #e8f5e9;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #4caf50;
                "
              >
                <h4>🎯 Fase 1: Avaliação</h4>
                <p>
                  <strong>Pontos:</strong>
                  <span id="final-phase1-score">0</span>/100
                </p>
                <p><strong>Puzzles:</strong> 4/4 ✅</p>
              </div>
              <div
                style="
                  background: #e3f2fd;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #2196f3;
                "
              >
                <h4>🗺️ Fase 2: Planeamento</h4>
                <p>
                  <strong>Pontos:</strong>
                  <span id="final-phase2-score">0</span>/100
                </p>
                <p><strong>Puzzles:</strong> 4/4 ✅</p>
              </div>
              <div
                style="
                  background: #fff3e0;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #ff9800;
                "
              >
                <h4>🎯 Fase 3: Intervenção</h4>
                <p>
                  <strong>Pontos:</strong>
                  <span id="final-phase3-score">0</span>/100
                </p>
                <p><strong>Puzzles:</strong> 4/4 ✅</p>
              </div>
              <div
                style="
                  background: #f3e5f5;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #9c27b0;
                "
              >
                <h4>🌟 Fase 4: Acompanhamento</h4>
                <p>
                  <strong>Pontos:</strong>
                  <span id="final-phase4-score">0</span>/100
                </p>
                <p><strong>Puzzles:</strong> 4/4 ✅</p>
              </div>
            </div>
          </div>

          <div
            id="achievements-final"
            style="
              background: #fffde7;
              padding: 20px;
              border-radius: 15px;
              margin: 20px 0;
            "
          >
            <h3>🏆 Conquistas Desbloqueadas:</h3>
            <div id="achievements-list">
              <!-- Achievements will be populated dynamically -->
            </div>
          </div>

          <div
            style="
              background: #e8f5e9;
              padding: 20px;
              border-radius: 15px;
              margin: 20px 0;
            "
          >
            <h3>🎯 Resultado do Caso Felisbina Santos:</h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
              "
            >
              <div>
                <p>
                  <strong>Autonomia Final:</strong>
                  <span id="final-autonomy">90%</span>
                </p>
                <p>
                  <strong>Empregabilidade:</strong>
                  <span id="final-employability">85%</span>
                </p>
              </div>
              <div>
                <p>
                  <strong>Bem-estar Mental:</strong>
                  <span id="final-wellbeing">92%</span>
                </p>
                <p>
                  <strong>Rede Social:</strong>
                  <span id="final-social">78%</span>
                </p>
              </div>
            </div>
            <p>
              <strong>Estado Final:</strong> Pronta para autonomia plena com
              estratégias de manutenção implementadas! 🌟
            </p>
          </div>

          <div style="text-align: center; margin-top: 30px">
            <button class="btn" onclick="showFinalReport()">
              📊 Ver Relatório Completo
            </button>
            <button class="btn" onclick="exportResults()">
              💾 Exportar Certificação
            </button>
            <button class="btn" onclick="restartEscapeRoom()">
              🔄 Repetir Escape Room
            </button>
            <a
              href="index.html"
              class="btn"
              style="background: #6c757d; text-decoration: none"
              >🏠 Voltar ao Menu</a
            >
          </div>
        </div>
      </div>
    </div>

    <script src="js/fase4-escape-engine.js"></script>
    <script>
      // Game state following the exact pattern from fase1-escape.html
      let gameState = {
        currentState: "loading",
        score: 0,
        startTime: Date.now(),
        progress: 0,
        phase1Data: null,
        phase2Data: null,
        phase3Data: null,

        // Puzzle-specific states
        puzzle1: {
          score: 0,
          progress: 0,
          alertsAnalyzed: [],
          monitoringActions: {},
          completed: false,
        },
        puzzle2: {
          score: 0,
          progress: 0,
          crisesResolved: [],
          responseChoices: {},
          completed: false,
        },
        puzzle3: {
          score: 0,
          progress: 0,
          strategiesTested: [],
          adaptationChoices: {},
          effectiveness: 67,
          completed: false,
        },
        puzzle4: {
          score: 0,
          progress: 0,
          autonomyReadiness: {
            professional: 85,
            emotional: 65,
            financial: 70,
            social: 58,
          },
          maintenanceStrategies: [],
          reductionPlan: {},
          completed: false,
        },
      };

      // Initialize the escape room
      document.addEventListener("DOMContentLoaded", async () => {
        await loadAllPreviousPhases();
        await delay(2000); // Show loading animation

        // Initialize escape room engine
        if (typeof EscapeRoomPhase4 !== "undefined") {
          window.escapeRoom = new EscapeRoomPhase4(gameState);
        }

        startGame();
      });

      // Toast System - exact copy from fase1-escape.html
      function showToast(message, type = "info", duration = 5000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
                ${message}
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Load all previous phases data
      async function loadAllPreviousPhases() {
        const phase1Data = localStorage.getItem("saasi_phase1_results");
        const phase2Data = localStorage.getItem("saasi_phase2_results");
        const phase3Data = localStorage.getItem("saasi_phase3_results");

        if (!phase1Data || !phase2Data || !phase3Data) {
          showToast(
            "⚠️ Dados das fases anteriores incompletos. Redirecionando...",
            "error",
            3000
          );
          setTimeout(() => (window.location.href = "index.html"), 3000);
          return;
        }

        gameState.phase1Data = JSON.parse(phase1Data);
        gameState.phase2Data = JSON.parse(phase2Data);
        gameState.phase3Data = JSON.parse(phase3Data);

        console.log("All phases data loaded:", {
          phase1: gameState.phase1Data,
          phase2: gameState.phase2Data,
          phase3: gameState.phase3Data,
        });

        // Check Phase 3 access requirement (65+ points)
        if (gameState.phase3Data.score < 65) {
          showToast(
            "⚠️ Acesso negado à Fase 4!<br><br>Deve completar a Fase 3 com pelo menos 65 pontos.<br>Redirecionando...",
            "error",
            4000
          );
          setTimeout(() => (window.location.href = "fase3-escape.html"), 4000);
          return;
        }

        // Update summary
        document.getElementById("phase1-score").textContent =
          gameState.phase1Data.score;
        document.getElementById("phase2-score").textContent =
          gameState.phase2Data.score;
        document.getElementById("phase3-score").textContent =
          gameState.phase3Data.score;
        document.getElementById("phase4-score").textContent = "0";
      }

      // Start the game
      function startGame() {
        changeState("inicio");
      }

      // Start escape room
      function startEscapeRoom() {
        changeState("puzzle1");
        if (window.escapeRoom) {
          window.escapeRoom.initializePuzzle1();
        }
      }

      // Change state function - following fase1-escape.html pattern
      function changeState(newState) {
        // Hide current state
        document.querySelectorAll(".state").forEach((state) => {
          state.classList.remove("active");
        });
        document.getElementById("loading").style.display = "none";

        // Show new state
        document.getElementById(`state-${newState}`).classList.add("active");
        gameState.currentState = newState;
        updateProgress();

        // Add fade-in animation
        document.getElementById(`state-${newState}`).classList.add("fade-in");
      }

      // Next puzzle
      function nextPuzzle(puzzleNumber) {
        changeState(`puzzle${puzzleNumber}`);
        if (window.escapeRoom) {
          window.escapeRoom[`initializePuzzle${puzzleNumber}`]();
        }
      }

      // Next state
      function nextState(state) {
        changeState(state);
      }

      // Update progress
      function updateProgress() {
        const states = [
          "loading",
          "inicio",
          "puzzle1",
          "puzzle2",
          "puzzle3",
          "puzzle4",
          "conclusao",
        ];
        const currentIndex = states.indexOf(gameState.currentState);
        const progress =
          Math.max(0, (currentIndex - 1) / (states.length - 2)) * 100;

        document.getElementById("progress").style.width = progress + "%";
        document.getElementById("progress-text").textContent =
          Math.round(progress) + "%";

        // Update score display
        updateScore();
      }

      // Update score
      function updateScore() {
        gameState.score =
          gameState.puzzle1.score +
          gameState.puzzle2.score +
          gameState.puzzle3.score +
          gameState.puzzle4.score;
        document.getElementById("score").textContent = gameState.score;
      }

      // Add score
      function addScore(points, puzzle = null) {
        if (puzzle) {
          gameState[puzzle].score = Math.min(
            gameState[puzzle].score + points,
            25
          );
        }
        updateScore();
      }

      // Puzzle 4 functions - will be implemented in the engine
      function autoGenerateReduction() {
        if (window.escapeRoom) {
          window.escapeRoom.autoGenerateReduction();
        }
      }

      function customizeReduction() {
        if (window.escapeRoom) {
          window.escapeRoom.customizeReduction();
        }
      }

      // Show conclusion
      function showConclusion() {
        const duration = Math.round((Date.now() - gameState.startTime) / 60000);

        // Calculate total score
        const totalScore =
          (gameState.phase1Data?.score || 0) +
          (gameState.phase2Data?.score || 0) +
          (gameState.phase3Data?.score || 0) +
          gameState.score;

        // Calculate final level and certification
        let level = "Técnico Iniciante";
        let certification = "Técnico Competente SAASI";

        if (totalScore >= 350) {
          level = "Mestre SAASI";
          certification = "Mestre SAASI Certificado";
        } else if (totalScore >= 300) {
          level = "Técnico Especialista";
          certification = "Técnico Especialista SAASI Completo";
        } else if (totalScore >= 250) {
          level = "Técnico Proficiente";
          certification = "Técnico Proficiente SAASI";
        } else if (totalScore >= 200) {
          level = "Técnico Competente";
          certification = "Técnico Competente SAASI";
        }

        // Update displays
        document.getElementById("final-score-phase4").textContent =
          gameState.score;
        document.getElementById("final-score-total").textContent = totalScore;
        document.getElementById("final-level").textContent = level;
        document.getElementById("final-certification").textContent =
          certification;
        document.getElementById("total-time").textContent = duration;

        // Update individual phase scores
        document.getElementById("final-phase1-score").textContent =
          gameState.phase1Data?.score || 0;
        document.getElementById("final-phase2-score").textContent =
          gameState.phase2Data?.score || 0;
        document.getElementById("final-phase3-score").textContent =
          gameState.phase3Data?.score || 0;
        document.getElementById("final-phase4-score").textContent =
          gameState.score;

        // Update Felisbina's final status based on total performance
        const autonomyLevel = Math.min(95, 60 + totalScore / 10);
        document.getElementById("final-autonomy").textContent =
          Math.round(autonomyLevel) + "%";
        document.getElementById("final-employability").textContent =
          Math.round(autonomyLevel - 5) + "%";
        document.getElementById("final-wellbeing").textContent =
          Math.round(autonomyLevel + 2) + "%";
        document.getElementById("final-social").textContent =
          Math.round(autonomyLevel - 12) + "%";

        // Generate achievements
        generateFinalAchievements(totalScore);

        // Save final results
        saveEscapeRoomResults(totalScore, level, certification, duration);
      }

      function generateFinalAchievements(totalScore) {
        const achievements = [];

        // Phase-specific achievements
        if (gameState.puzzle1.score >= 20)
          achievements.push("📊 Monitor Especialista");
        if (gameState.puzzle2.score >= 25)
          achievements.push("🚨 Gestor de Crises");
        if (gameState.puzzle3.score >= 20)
          achievements.push("🧪 Estrategista Adaptável");
        if (gameState.puzzle4.score >= 18)
          achievements.push("🌟 Mentor da Autonomia");

        // Overall achievements
        if (totalScore >= 350) achievements.push("👑 Mestre SAASI Supremo");
        else if (totalScore >= 300)
          achievements.push("🏆 Especialista SAASI Completo");
        else if (totalScore >= 250) achievements.push("⭐ Proficiente SAASI");

        // Special achievements
        if (
          gameState.phase1Data?.score >= 90 &&
          gameState.phase2Data?.score >= 90 &&
          gameState.phase3Data?.score >= 90 &&
          gameState.score >= 90
        ) {
          achievements.push("💎 Perfeição em Todas as Fases");
        }

        const container = document.getElementById("achievements-list");
        if (achievements.length > 0) {
          container.innerHTML = achievements
            .map(
              (achievement) =>
                `<span style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 15px; border-radius: 20px; margin: 5px; font-weight: 600;">${achievement}</span>`
            )
            .join("");
        } else {
          container.innerHTML =
            "<p>Continue a praticar para desbloquear conquistas!</p>";
        }
      }

      function saveEscapeRoomResults(
        totalScore,
        level,
        certification,
        duration
      ) {
        const escapeRoomResults = {
          escapeRoom: "SAASI_COMPLETE",
          completionDate: new Date().toISOString(),
          totalScore: totalScore,
          maxTotalScore: 400,
          overallPercentage: Math.round((totalScore / 400) * 100),
          finalLevel: level,
          certification: certification,
          totalDuration: duration,
          phases: {
            phase1: gameState.phase1Data,
            phase2: gameState.phase2Data,
            phase3: gameState.phase3Data,
            phase4: {
              score: gameState.score,
              puzzleResults: {
                puzzle1: gameState.puzzle1,
                puzzle2: gameState.puzzle2,
                puzzle3: gameState.puzzle3,
                puzzle4: gameState.puzzle4,
              },
            },
          },
          felisbinaFinalStatus: {
            autonomy: Math.round(60 + totalScore / 10),
            employability: Math.round(55 + totalScore / 10),
            wellbeing: Math.round(62 + totalScore / 10),
            socialNetwork: Math.round(48 + totalScore / 10),
          },
        };

        localStorage.setItem(
          "saasi_escape_room_complete",
          JSON.stringify(escapeRoomResults)
        );
      }

      // Show final report
      function showFinalReport() {
        const totalScore =
          (gameState.phase1Data?.score || 0) +
          (gameState.phase2Data?.score || 0) +
          (gameState.phase3Data?.score || 0) +
          gameState.score;

        const report = `
🏆 RELATÓRIO FINAL - ESCAPE ROOM SAASI
=====================================

PONTUAÇÃO TOTAL: ${totalScore}/400 (${Math.round((totalScore / 400) * 100)}%)

DETALHAMENTO POR FASE:
• Fase 1 - Avaliação: ${gameState.phase1Data?.score || 0}/100
• Fase 2 - Planeamento: ${gameState.phase2Data?.score || 0}/100  
• Fase 3 - Intervenção: ${gameState.phase3Data?.score || 0}/100
• Fase 4 - Acompanhamento: ${gameState.score}/100

RESULTADO DO CASO FELISBINA:
• Autonomia Final: ${Math.round(60 + totalScore / 10)}%
• Prontidão para Emprego: ${Math.round(55 + totalScore / 10)}%
• Bem-estar Mental: ${Math.round(62 + totalScore / 10)}%
• Rede Social: ${Math.round(48 + totalScore / 10)}%

CERTIFICAÇÃO OBTIDA:
${
  totalScore >= 350
    ? "MESTRE SAASI CERTIFICADO"
    : totalScore >= 300
    ? "TÉCNICO ESPECIALISTA SAASI COMPLETO"
    : totalScore >= 250
    ? "TÉCNICO PROFICIENTE SAASI"
    : "TÉCNICO COMPETENTE SAASI"
}

Obrigado por completar o ESCAPE ROOM SAASI! 🎉
            `;

        alert(report);
      }

      // Export results
      function exportResults() {
        const results = JSON.parse(
          localStorage.getItem("saasi_escape_room_complete") || "{}"
        );

        const dataStr = JSON.stringify(results, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `SAASI_EscapeRoom_Certification_${
          new Date().toISOString().split("T")[0]
        }.json`;
        link.click();
        URL.revokeObjectURL(url);

        showToast("💾 Certificação exportada com sucesso!", "success", 3000);
      }

      // Restart escape room
      function restartEscapeRoom() {
        if (
          confirm(
            "🔄 Tem certeza que deseja reiniciar todo o Escape Room?\n\nTodos os progressos serão perdidos."
          )
        ) {
          localStorage.removeItem("saasi_phase1_results");
          localStorage.removeItem("saasi_phase2_results");
          localStorage.removeItem("saasi_phase3_results");
          localStorage.removeItem("saasi_phase4_results");
          localStorage.removeItem("saasi_escape_room_complete");

          showToast(
            "🔄 Escape Room reiniciado! Redirecionando...",
            "info",
            2000
          );
          setTimeout(() => (window.location.href = "fase1-escape.html"), 2000);
        }
      }

      // Get level title
      function getLevelTitle(score) {
        if (score >= 95) return "Mestre SAASI";
        if (score >= 85) return "Técnico Especialista";
        if (score >= 70) return "Técnico Proficiente";
        if (score >= 50) return "Técnico Competente";
        return "Técnico Iniciante";
      }

      // Utility function for delays
      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // When changing to conclusion, show the report
      const originalChangeState = changeState;
      changeState = function (newState) {
        originalChangeState(newState);
        if (newState === "conclusao") {
          showConclusion();
        }
      };
    </script>
  </body>
</html>
