<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAASI Escape Room - Fase 1 🎮</title>
    <style>
      /* Toast System */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
        pointer-events: none; /* Allow clicking through container */
      }

      .toast {
        background: #333;
        color: white;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        padding-right: 50px;
        pointer-events: auto; /* Allow clicking on toasts */
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        background: #28a745;
        border-left: 4px solid #1e7e34;
      }

      .toast.error {
        background: #dc3545;
        border-left: 4px solid #c82333;
      }

      .toast.warning {
        background: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .toast.info {
        background: #17a2b8;
        border-left: 4px solid #138496;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* Custom Dialog System */
      .custom-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 15000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .custom-dialog-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .custom-dialog {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.8) translateY(-50px);
        transition: all 0.3s ease;
      }

      .custom-dialog-overlay.show .custom-dialog {
        transform: scale(1) translateY(0);
      }

      .custom-dialog-header {
        padding: 20px 24px 15px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .custom-dialog-icon {
        font-size: 24px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .custom-dialog-icon.confirm {
        background: #e3f2fd;
        color: #1976d2;
      }

      .custom-dialog-icon.prompt {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      .custom-dialog-icon.alert {
        background: #fff3e0;
        color: #f57c00;
      }

      .custom-dialog-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .custom-dialog-body {
        padding: 20px 24px;
        color: #555;
        line-height: 1.6;
      }

      .custom-dialog-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        margin-top: 15px;
        transition: border-color 0.3s ease;
        outline: none;
      }

      .custom-dialog-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .custom-dialog-buttons {
        padding: 15px 24px 20px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        border-top: 1px solid #e0e0e0;
      }

      .custom-dialog-btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 80px;
      }

      .custom-dialog-btn.primary {
        background: #667eea;
        color: white;
      }

      .custom-dialog-btn.primary:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .custom-dialog-btn.secondary {
        background: #f5f5f5;
        color: #666;
        border: 1px solid #ddd;
      }

      .custom-dialog-btn.secondary:hover {
        background: #eeeeee;
        color: #333;
      }

      /* Mobile dialog adjustments */
      @media (max-width: 480px) {
        .custom-dialog {
          width: 95%;
          margin: 20px;
        }

        .custom-dialog-header,
        .custom-dialog-body,
        .custom-dialog-buttons {
          padding-left: 16px;
          padding-right: 16px;
        }

        .custom-dialog-buttons {
          flex-direction: column-reverse;
        }

        .custom-dialog-btn {
          width: 100%;
          margin: 4px 0;
        }
      }

      /* ESCAPE ROOM ENHANCEMENTS */
      .escape-room-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .timer-container {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 18px;
        font-weight: bold;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .timer-bar {
        width: 200px;
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        margin-top: 8px;
        overflow: hidden;
      }

      .timer-progress {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #ffc107, #f44336);
        transition: width 1s linear;
        border-radius: 4px;
      }

      .timer-warning {
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .clue-indicator {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ffd700;
        color: #333;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: glow 2s infinite;
        font-weight: bold;
      }

      @keyframes glow {
        0%,
        100% {
          box-shadow: 0 0 5px #ffd700;
        }
        50% {
          box-shadow: 0 0 20px #ffd700, 0 0 30px #ffd700;
        }
      }

      .hidden-element {
        opacity: 0.3;
        pointer-events: none;
        transition: all 0.5s ease;
      }

      .hidden-element.revealed {
        opacity: 1;
        pointer-events: auto;
        animation: reveal 0.5s ease;
      }

      @keyframes reveal {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .empathy-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        margin: 20px auto;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .empathy-avatar.happy {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        transform: scale(1.1);
      }

      .empathy-avatar.neutral {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      }

      .empathy-avatar.sad {
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        transform: scale(0.9);
      }

      .puzzle-counter {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 9999;
      }

      /* Original styles continue... */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .main-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        z-index: 1000;
      }
      .back-button:hover {
        background: rgba(108, 117, 125, 1);
        transform: translateY(-2px);
      }
      .score {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(51, 51, 51, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: bold;
        z-index: 1000;
      }
      .progress {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        margin: 20px 0;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.5s ease;
        border-radius: 4px;
      }
      .state {
        display: none;
        animation: fadeIn 0.5s ease;
      }
      .state.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        margin: 10px 5px;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .dialogue-option {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 20px;
        margin: 15px 0;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }
      .dialogue-option:hover {
        background: rgba(255, 255, 255, 0.95);
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
      }
      .dialogue-option.selected {
        background: rgba(102, 126, 234, 0.1);
        border-color: #667eea;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
      }
      .drag-item {
        background: rgba(255, 243, 224, 0.9);
        backdrop-filter: blur(5px);
        border: 2px solid #ff9800;
        padding: 15px;
        margin: 10px;
        border-radius: 12px;
        cursor: move;
        user-select: none;
        transition: all 0.3s ease;
        display: inline-block;
        min-width: 120px;
        text-align: center;
        font-weight: 500;
        position: relative;
        touch-action: manipulation;
      }
      .drag-item:hover {
        background: rgba(255, 224, 178, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
      }
      .drag-item:active {
        transform: scale(0.98);
      }
      .drag-item.selected {
        background: rgba(102, 126, 234, 0.9);
        border-color: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      .drag-item.placed {
        opacity: 0.6;
        background: rgba(200, 200, 200, 0.8);
        border-color: #ccc;
        cursor: not-allowed;
        transform: none;
        pointer-events: none;
      }
      .drop-zone {
        min-height: 120px;
        border: 3px dashed rgba(204, 204, 204, 0.7);
        padding: 20px;
        margin: 15px 0;
        border-radius: 15px;
        background: rgba(249, 249, 249, 0.8);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        position: relative;
        touch-action: manipulation;
      }
      .drop-zone.drag-over,
      .drop-zone.active {
        border-color: #667eea;
        background: rgba(227, 242, 253, 0.9);
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }
      .drop-zone.correct {
        border-color: #4caf50;
        background: rgba(232, 245, 233, 0.9);
        border-style: solid;
      }
      .drop-zone.incorrect {
        border-color: #f44336;
        background: rgba(255, 235, 238, 0.9);
        border-style: solid;
        animation: shake 0.5s ease-in-out;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }
      .mobile-instructions {
        background: rgba(227, 242, 253, 0.9);
        backdrop-filter: blur(5px);
        padding: 15px;
        border-radius: 12px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
        display: none;
      }
      .mobile-mode-button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        margin: 10px 0;
        transition: all 0.3s ease;
      }
      .mobile-mode-button:hover {
        background: #1976d2;
        transform: translateY(-1px);
      }
      .metrics {
        background: rgba(240, 240, 240, 0.8);
        backdrop-filter: blur(5px);
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        border-left: 4px solid #667eea;
        font-weight: 600;
      }
      .analysis-container {
        display: flex;
        gap: 30px;
        margin: 30px 0;
      }
      .analysis-column {
        flex: 1;
        background: rgba(255, 255, 255, 0.6);
        padding: 25px;
        border-radius: 15px;
        backdrop-filter: blur(5px);
      }
      #elements-pool {
        background: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        backdrop-filter: blur(5px);
        border: 2px solid rgba(255, 255, 255, 0.3);
      }
      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
        }
        .container {
          padding: 25px;
          margin-bottom: 15px;
        }
        .back-button {
          position: static;
          display: block;
          margin-bottom: 15px;
          text-align: center;
        }
        .score {
          position: static;
          display: block;
          text-align: center;
          margin-bottom: 15px;
        }
        .dialogue-option {
          padding: 15px;
          font-size: 14px;
        }
        .drag-item {
          min-width: 100px;
          padding: 12px;
          margin: 5px;
          font-size: 14px;
        }
        .drop-zone {
          min-height: 100px;
          padding: 15px;
        }
        .analysis-container {
          flex-direction: column;
          gap: 20px;
        }
        .mobile-instructions {
          display: block;
        }
        /* Make drag container scrollable on small screens */
        #elements-pool {
          max-height: 200px;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }
        /* Stack drop zones vertically on mobile */
        .analysis-container {
          flex-direction: column;
        }
        .timer-container {
          position: static;
          margin-bottom: 15px;
          text-align: center;
        }
        .timer-bar {
          width: 100%;
        }
      }
      /* Tablet adjustments */
      @media (max-width: 1024px) and (min-width: 769px) {
        .main-container {
          padding: 15px;
        }
        .container {
          padding: 30px;
        }
        .back-button,
        .score {
          position: fixed;
          top: 15px;
        }
        .back-button {
          left: 15px;
        }
        .score {
          right: 0;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          padding: 10px;
          z-index: 1001;
        }
        .dialogue-option {
          padding: 18px;
        }
        .drag-item {
          padding: 12px;
        }
        .drag-item {
          width: calc(50% - 10px);
          margin: 5px;
        }
        .drop-zone {
          min-height: 110px;
          padding: 18px;
        }
      }
      /* Pulse animation for newly unlocked objects */
      @keyframes pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(76, 175, 80, 0.3);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 20px rgba(76, 175, 80, 0);
        }
      }

      /* Touch-friendly improvements */
      @media (hover: none) and (pointer: coarse) {
        .drag-item {
          min-height: 60px;
          padding: 15px;
        }
        .dialogue-option {
          min-height: 60px;
          padding: 18px;
        }
        .drop-zone {
          min-height: 140px;
          padding: 25px;
        }
        .btn {
          min-height: 50px;
          padding: 15px 25px;
        }
      }

      /* ESCAPE ROOM SPECIFIC STYLES */
      .office-object {
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .office-object:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }

      .office-object:active {
        transform: translateY(-2px);
      }

      .clue-indicator.hidden {
        display: none !important;
      }

      .meeting-door {
        transition: all 0.5s ease;
      }

      .office-grid {
        position: relative;
      }

      @media (max-width: 768px) {
        .office-reception {
          padding: 20px !important;
          min-height: auto !important;
        }

        .office-grid {
          grid-template-columns: 1fr 1fr !important; /* Force 2 columns on mobile */
          gap: 15px !important;
          height: auto !important;
        }

        .office-object {
          padding: 15px;
          min-height: 120px; /* Equal height for all objects */
          aspect-ratio: 1; /* Square aspect ratio for consistency */
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          font-size: 14px;
        }

        .office-object div:first-child {
          font-size: 32px !important;
          margin-bottom: 8px;
        }

        .office-object div:last-child {
          font-size: 13px !important;
          font-weight: bold;
          line-height: 1.2;
        }

        .meeting-door {
          position: static !important;
          margin: 20px auto 0 auto;
          text-align: center;
          width: 200px;
        }
      }

      @media (max-width: 480px) {
        .office-reception {
          padding: 15px !important;
        }

        .office-grid {
          grid-template-columns: 1fr 1fr !important; /* Force 2 columns on mobile */
          gap: 12px !important;
          height: auto !important;
        }

        .office-object {
          padding: 12px;
          min-height: 100px; /* Slightly smaller but still equal */
          aspect-ratio: 1; /* Keep square shape */
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          font-size: 14px;
        }

        .office-object div:first-child {
          font-size: 28px !important;
          margin-bottom: 6px;
        }

        .office-object div:last-child {
          font-size: 12px !important;
          font-weight: bold;
          line-height: 1.2;
        }

        /* Mobile toast positioning */
        .toast-container {
          top: 10px !important;
          right: 10px !important;
          left: 10px !important;
          max-width: none !important;
        }

        .toast {
          font-size: 14px;
          padding: 12px 16px !important;
          margin-bottom: 8px;
        }

        .meeting-door {
          position: static !important;
          margin: 15px auto;
          width: 180px;
          padding: 12px;
        }

        .meeting-door div:first-child {
          font-size: 24px !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- ESCAPE ROOM TIMER -->
    <div class="timer-container" id="timer-container">
      <div>🕐 TEMPO RESTANTE: <span id="timer-display">45:00</span></div>
      <div class="timer-bar">
        <div class="timer-progress" id="timer-progress"></div>
      </div>
    </div>

    <!-- PUZZLE COUNTER -->
    <div class="puzzle-counter" id="puzzle-counter">
      🧩 PUZZLE <span id="current-puzzle">1</span>/5
    </div>

    <a href="index.html" class="back-button">← Voltar ao Menu</a>
    <div class="score">Pontuação: <span id="score">0</span>/150</div>

    <div class="main-container">
      <div class="container">
        <div class="escape-room-header">
          <h1>🎮 ESCAPE ROOM SAASI - FASE 1</h1>
          <h2>🕵️ O MISTÉRIO DA FELISBINA</h2>
          <p>
            <strong>Missão:</strong> Descobrir a verdadeira situação da
            Felisbina e tomar a decisão correta sobre o seu acompanhamento em 45
            minutos!
          </p>
        </div>

        <div class="progress">
          <div class="progress-bar" id="progress"></div>
        </div>

        <!-- ESTADO 1: INICIO -->
        <div id="state-inicio" class="state active">
          <h1>🎯 Bem-vindo ao Escape Room SAASI!</h1>
          <h2>Acolhimento e Avaliação Inicial</h2>

          <div
            style="
              background: #f8f9fa;
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
            "
          >
            <h3>📋 Briefing da Missão:</h3>
            <p>
              <strong>Caso:</strong> Felisbina Santos, 56 anos, beneficiária de
              RSI
            </p>
            <p>
              <strong>Objetivo:</strong> Realizar avaliação completa e decidir
              sobre elegibilidade DLD
            </p>
            <p><strong>Tempo Limite:</strong> 45 minutos (tempo real)</p>
            <p>
              <strong>Desafio:</strong> Descobrir pistas ocultas e códigos
              secretos durante a investigação
            </p>
          </div>

          <div
            style="
              background: #fff3cd;
              padding: 15px;
              border-radius: 8px;
              margin: 20px 0;
            "
          >
            <h4>🎮 Novidades do Modo Escape Room:</h4>
            <ul>
              <li>
                ⏰ <strong>Timer em tempo real</strong> - 45 minutos para
                completar
              </li>
              <li>
                🔍 <strong>Pistas ocultas</strong> - Elementos secretos para
                descobrir
              </li>
              <li>
                🎯 <strong>Códigos especiais</strong> - Combinações corretas
                desbloqueiam bonus
              </li>
              <li>
                🏆 <strong>Pontuação aumentada</strong> - Até 150 pontos (100
                base + 50 bonus)
              </li>
              <li>
                👁️ <strong>Avatar reativo</strong> - Felisbina muda conforme
                suas ações
              </li>
            </ul>
          </div>

          <button class="btn" onclick="startEscapeRoom()">
            🚀 Iniciar Missão
          </button>
        </div>

        <!-- PUZZLE 1: RECEPTION DESK MYSTERY -->
        <div id="state-reception" class="state">
          <h1>🧩 PUZZLE 1: O MISTÉRIO DA RECEÇÃO</h1>
          <h2>🕵️ Investigate the SAASI Office Reception</h2>

          <div
            class="metrics"
            style="
              background: rgba(255, 243, 224, 0.9);
              border-left: 4px solid #ff9800;
            "
          >
            <strong>🔍 Pistas Descobertas:</strong>
            <span id="clues-found">0</span>/5 | <strong>⚡ Energia:</strong>
            <span id="energy-level">50</span>/100 |
            <strong>🎯 Progresso:</strong> <span id="puzzle1-progress">0</span>%
          </div>

          <div
            class="office-reception"
            style="
              background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
              padding: 30px;
              border-radius: 15px;
              margin: 20px 0;
              position: relative;
              min-height: 400px;
            "
          >
            <h3 style="text-align: center; margin-bottom: 20px">
              🏢 Receção do SAASI
            </h3>
            <p style="text-align: center; color: #666; margin-bottom: 30px">
              Clique nos objetos para investigar e descobrir pistas sobre o caso
              da Felisbina
            </p>

            <!-- Interactive Office Objects -->
            <div
              class="office-grid"
              style="
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
                height: 300px;
              "
            >
              <!-- Computer Screen -->
              <div
                class="office-object"
                id="computer-screen"
                onclick="investigateObject('computer')"
                style="
                  background: #34495e;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">🖥️</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Computador
                </div>
                <div
                  class="clue-indicator hidden"
                  id="computer-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- File Cabinet -->
              <div
                class="office-object"
                id="file-cabinet"
                onclick="investigateObject('cabinet')"
                style="
                  background: #8e44ad;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">🗄️</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Arquivo
                </div>
                <div
                  class="clue-indicator hidden"
                  id="cabinet-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- Reception Clipboard -->
              <div
                class="office-object"
                id="clipboard"
                onclick="investigateObject('clipboard')"
                style="
                  background: #2980b9;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">📋</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Prancheta
                </div>
                <div
                  class="clue-indicator hidden"
                  id="clipboard-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- Coffee Machine -->
              <div
                class="office-object"
                id="coffee-machine"
                onclick="investigateObject('coffee')"
                style="
                  background: #c0392b;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">☕</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Café
                </div>
                <div
                  class="clue-indicator hidden"
                  id="coffee-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- Office Phone -->
              <div
                class="office-object"
                id="office-phone"
                onclick="investigateObject('phone')"
                style="
                  background: #27ae60;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">📞</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Telefone
                </div>
                <div
                  class="clue-indicator hidden"
                  id="phone-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- Notice Board -->
              <div
                class="office-object"
                id="notice-board"
                onclick="investigateObject('board')"
                style="
                  background: #f39c12;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">📌</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Quadro
                </div>
                <div
                  class="clue-indicator hidden"
                  id="board-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>
            </div>
          </div>

          <!-- Meeting Room Door (moved outside grid for better responsive layout) -->
          <div
            id="meeting-door"
            class="meeting-door"
            style="
              background: #95a5a6;
              padding: 15px;
              border-radius: 10px;
              cursor: not-allowed;
              opacity: 0.5;
              transition: all 0.3s ease;
              margin: 20px auto;
              text-align: center;
              max-width: 200px;
            "
          >
            <div style="font-size: 30px">🚪</div>
            <div style="font-weight: bold; margin-top: 5px">
              Sala de Reunião
            </div>
            <div style="font-size: 12px; color: #7f8c8d">🔒 Bloqueada</div>
          </div>

          <!-- Investigation Results Panel -->
          <div
            id="investigation-panel"
            class="investigation-panel"
            style="
              background: rgba(255, 255, 255, 0.9);
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
              min-height: 100px;
              border: 2px solid #bdc3c7;
            "
          >
            <h4>🔍 Resultados da Investigação:</h4>
            <div
              id="investigation-content"
              style="font-style: italic; color: #7f8c8d"
            >
              Selecione um objeto no escritório para investigar...
            </div>
          </div>

          <!-- Discovered Clues -->
          <div
            id="clues-display"
            class="clues-display"
            style="
              background: rgba(232, 245, 233, 0.9);
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
              border-left: 4px solid #4caf50;
            "
          >
            <h4>✅ Pistas Descobertas:</h4>
            <div id="clues-list" style="margin-top: 15px">
              <p style="font-style: italic; color: #666">
                Nenhuma pista descoberta ainda...
              </p>
            </div>
          </div>

          <button
            class="btn"
            id="next-reception"
            onclick="nextState()"
            style="
              display: none;
              background: linear-gradient(135deg, #4caf50, #45a049);
            "
          >
            🔓 Entrar na Sala de Reunião
          </button>
        </div>

        <!-- ESTADO 2: CONVERSA -->
        <div id="state-conversa" class="state">
          <h2>🗣️ Puzzle 1: Descodificar a Felisbina</h2>

          <div class="metrics">
            <strong>Empatia:</strong> <span id="empathy">0</span>/25 |
            <strong>Informação:</strong> <span id="information">0</span>% |
            <strong>Interações:</strong> <span id="interactions">0</span>
          </div>

          <!-- AVATAR DA FELISBINA -->
          <div class="empathy-avatar" id="felisbina-avatar">😐</div>

          <div id="dialogue-container">
            <!-- Diálogos serão inseridos dinamicamente -->
          </div>

          <button
            class="btn"
            id="next-dialogue"
            onclick="nextState()"
            style="display: none"
          >
            Continuar para Análise 🔍
          </button>
        </div>

        <!-- ESTADO 3: ANALISE -->
        <div id="state-analise" class="state">
          <h2>🧩 Puzzle 2: O Quebra-Cabeças Social</h2>
          <div class="metrics">
            <strong>Elementos Categorizados:</strong>
            <span id="elements-categorized">0</span>/12 |
            <strong>Elementos Ocultos Descobertos:</strong>
            <span id="hidden-discovered">0</span>/3
          </div>

          <div class="mobile-instructions">
            <p>
              📱 <strong>Modo Toque:</strong> Toque no elemento primeiro e
              depois toque na categoria desejada
            </p>
            <button class="mobile-mode-button" onclick="toggleMobileMode()">
              <span id="mode-text">Modo Toque</span>
            </button>
          </div>

          <div id="elements-pool">
            <h4>🎲 Elementos para Categorizar:</h4>
            <!-- Elementos serão inseridos dinamicamente -->
          </div>

          <div class="analysis-container">
            <div class="analysis-column">
              <h4 style="color: #d32f2f">🔴 Fatores de Risco</h4>
              <div
                class="drop-zone"
                id="risk-zone"
                ondrop="drop(event)"
                ondragover="allowDrop(event)"
                onclick="handleZoneClick('risk')"
              >
                <p>Selecione fatores de risco</p>
              </div>
            </div>
            <div class="analysis-column">
              <h4 style="color: #388e3c">🟢 Fatores de Proteção</h4>
              <div
                class="drop-zone"
                id="protection-zone"
                ondrop="drop(event)"
                ondragover="allowDrop(event)"
                onclick="handleZoneClick('protection')"
              >
                <p>Selecione fatores de proteção</p>
              </div>
            </div>
          </div>

          <button
            class="btn"
            id="next-analysis"
            onclick="nextState()"
            style="display: none"
          >
            Continuar para Documentação 📋
          </button>
        </div>

        <!-- ESTADO 4: DOCUMENTACAO -->
        <div id="state-documentacao" class="state">
          <h2>📋 Puzzle 3: A Caça ao Documento</h2>
          <div class="metrics">
            <strong>Documentos Identificados:</strong>
            <span id="docs-identified">0</span>/3 |
            <strong>Documentos Secretos:</strong>
            <span id="secret-docs">0</span>/2
          </div>

          <div
            style="
              background: #e3f2fd;
              padding: 15px;
              border-radius: 8px;
              margin: 20px 0;
            "
          >
            <p>
              🔍 <strong>Dica:</strong> Alguns documentos podem estar
              escondidos. Procure por pistas na conversa anterior!
            </p>
          </div>

          <div id="documents-list">
            <!-- Documentos serão inseridos dinamicamente -->
          </div>

          <!-- ÁREA DE BUSCA INTERATIVA -->
          <div
            style="
              background: #f5f5f5;
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
            "
          >
            <h4>🗄️ Área de Busca:</h4>
            <div style="display: flex; gap: 15px; flex-wrap: wrap">
              <button
                class="btn"
                onclick="searchArea('gaveta')"
                id="search-gaveta"
              >
                🗃️ Gaveta da Secretária
              </button>
              <button
                class="btn"
                onclick="searchArea('arquivo')"
                id="search-arquivo"
              >
                📁 Arquivo Antigo
              </button>
              <button
                class="btn"
                onclick="searchArea('pasta')"
                id="search-pasta"
              >
                📂 Pasta Confidencial
              </button>
            </div>
          </div>

          <button
            class="btn"
            id="next-docs"
            onclick="nextState()"
            style="display: none"
          >
            Continuar para Avaliação ⚖️
          </button>
        </div>

        <!-- ESTADO 5: AVALIACAO -->
        <div id="state-avaliacao" class="state">
          <h2>⚖️ Puzzle 4: O Veredicto Final</h2>

          <div
            style="
              background: #f5f5f5;
              padding: 20px;
              border-radius: 5px;
              margin: 20px 0;
            "
          >
            <h4>📊 Painel de Evidências Recolhidas:</h4>
            <div id="evidence-panel">
              <!-- Evidências serão inseridas dinamicamente -->
            </div>
          </div>

          <div
            style="
              background: #f5f5f5;
              padding: 20px;
              border-radius: 5px;
              margin: 20px 0;
            "
          >
            <h4>Critérios DLD:</h4>
            <p>✅ Desemprego de longa duração (>12 meses)</p>
            <p>⚠️ Idade 56 anos (fator de risco)</p>
            <p>⚠️ Qualificação 9º ano (baixa qualificação)</p>
            <p>✅ Beneficiária RSI + PSI ativas</p>
            <p>⚠️ Dependência emocional identificada</p>
          </div>

          <div>
            <h4>1. A Felisbina tem DISPONIBILIDADE para trabalhar?</h4>
            <div id="availability-options">
              <div
                class="dialogue-option"
                onclick="selectAvailability('sim_total')"
              >
                <strong>SIM - Disponibilidade total</strong><br />
                Sem dependentes, horário flexível, motivada para mudança
              </div>
              <div
                class="dialogue-option"
                onclick="selectAvailability('sim_condicionada')"
              >
                <strong>SIM - Disponibilidade condicionada</strong><br />
                Disponível mas com necessidade de apoio psicológico
              </div>
              <div class="dialogue-option" onclick="selectAvailability('nao')">
                <strong>NÃO - Indisponível temporariamente</strong><br />
                Necessita primeiro de estabilização emocional
              </div>
            </div>
          </div>

          <div id="capacity-section" style="display: none">
            <h4>2. A Felisbina tem CAPACIDADE para trabalhar?</h4>
            <div id="capacity-options">
              <div
                class="dialogue-option"
                onclick="selectCapacity('sim_plena')"
              >
                <strong>SIM - Capacidade plena</strong><br />
                Experiência anterior, sem limitações físicas
              </div>
              <div
                class="dialogue-option"
                onclick="selectCapacity('sim_formacao')"
              >
                <strong>SIM - Capacidade com formação</strong><br />
                Capacidade existente mas necessita qualificação adicional
              </div>
              <div class="dialogue-option" onclick="selectCapacity('nao')">
                <strong>NÃO - Incapacidade temporária</strong><br />
                Limitações emocionais impedem trabalho imediato
              </div>
            </div>
          </div>

          <button
            class="btn"
            id="finalize-assessment"
            onclick="nextState()"
            style="display: none"
          >
            Finalizar Avaliação 🏁
          </button>
        </div>

        <!-- ESTADO 6: CONCLUSAO -->
        <div id="state-conclusao" class="state">
          <h1>🎉 Missão Completada!</h1>

          <div
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 30px;
              border-radius: 15px;
              text-align: center;
              margin: 20px 0;
            "
          >
            <h2>🏆 Resultados da Missão</h2>
            <div style="font-size: 24px; margin: 15px 0">
              <strong
                >Pontuação Final: <span id="final-score">0</span>/150</strong
              >
            </div>
            <div style="font-size: 18px">
              <strong>Tempo Utilizado: <span id="time-used">--</span></strong>
            </div>
            <div style="font-size: 18px">
              <strong>Nível Alcançado: <span id="final-level">--</span></strong>
            </div>
          </div>

          <div
            id="achievements-panel"
            style="
              background: #f8f9fa;
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
            "
          >
            <h3>🏅 Conquistas Desbloqueadas:</h3>
            <div id="achievements-list">
              <!-- Conquistas serão inseridas dinamicamente -->
            </div>
          </div>

          <div style="text-align: center; margin-top: 30px">
            <button class="btn" onclick="restartGame()">
              🔄 Repetir Fase 1
            </button>
            <button
              class="btn"
              style="background: #4caf50"
              onclick="continueToPhase2()"
            >
              Continuar para Fase 2 ➡️
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Load existing systems for compatibility -->
    <script src="js/scoring-system.js"></script>
    <script src="js/assessment-logic.js"></script>
    <script src="js/case-data-felisbina.js"></script>
    <script src="js/modal-system.js"></script>
    <script src="js/shared.js"></script>

    <script>
      // Simple function to create native-style dialogs
      function showNativePrompt(message) {
        // Create a simple input dialog
        const result = window._originalPrompt
          ? window._originalPrompt(message)
          : prompt(message);
        return result;
      }

      function showNativeConfirm(message) {
        // Create a simple confirm dialog
        const result = window._originalConfirm
          ? window._originalConfirm(message)
          : confirm(message);
        return result;
      }

      // ESCAPE ROOM GAME STATE
      let escapeRoomState = {
        startTime: null,
        timeLimit: 45 * 60 * 1000, // 45 minutos em ms
        currentPuzzle: 1,
        codesDiscovered: [],
        hiddenElementsFound: 0,
        bonusPoints: 0,
        achievements: [],
      };

      // ESTADO DO JOGO ORIGINAL (mantido para compatibilidade)
      let gameState = {
        currentState: "inicio",
        score: 0,
        empathy: 0,
        information: 0,
        interactions: 0,
        docsIdentified: 0,
        availability: null,
        capacity: null,
        elementsPlaced: 0,
      };

      // DADOS DOS DIÁLOGOS (mantidos originais)
      const dialogueData = [
        {
          id: 1,
          question: "Olá Felisbina, como se sente hoje?",
          options: [
            {
              text: "Vejo que está nervosa. Não se preocupe, estamos aqui para a ajudar.",
              empathy: 8,
              info: 2,
              code: "empathy_high",
            },
            {
              text: "Preciso que me forneça algumas informações sobre a sua situação.",
              empathy: 2,
              info: 6,
              code: "direct_approach",
            },
            {
              text: "Conte-me um pouco sobre si e o que a trouxe até aqui.",
              empathy: 5,
              info: 5,
              code: "balanced",
            },
          ],
        },
        {
          id: 2,
          question: "Pode falar-me sobre a sua situação habitacional atual?",
          options: [
            {
              text: "Imagino que não seja fácil viver numa pensão. Como se sente lá?",
              empathy: 7,
              info: 4,
              code: "housing_empathy",
            },
            {
              text: "Há quanto tempo vive na pensão? Quanto paga de renda?",
              empathy: 1,
              info: 8,
              code: "housing_facts",
            },
            {
              text: "A pensão é temporária? Tem planos para mudar?",
              empathy: 4,
              info: 6,
              code: "housing_future",
            },
          ],
        },
        {
          id: 3,
          question:
            "Falou-me do seu pai. Pode contar-me mais sobre essa relação?",
          options: [
            {
              text: "Vejo que é uma pessoa muito importante para si. Isso é bonito.",
              empathy: 9,
              info: 3,
              code: "father_bond",
            },
            {
              text: "Essa dependência emocional pode afetar a sua autonomia?",
              empathy: 2,
              info: 8,
              code: "dependency_analysis",
            },
            {
              text: "Como é que essa relação a ajuda no dia-a-dia?",
              empathy: 6,
              info: 5,
              code: "support_system",
            },
          ],
        },
        {
          id: 4,
          question: "E sobre o seu irmão? Disse que cortaram relações...",
          options: [
            {
              text: "Deve ser muito difícil perder o apoio de alguém tão próximo.",
              empathy: 8,
              info: 4,
              code: "brother_loss",
            },
            {
              text: "O que aconteceu exatamente? Houve algum conflito específico?",
              empathy: 3,
              info: 7,
              code: "conflict_details",
            },
            {
              text: "Sente que consegue gerir as suas finanças sozinha agora?",
              empathy: 4,
              info: 7,
              code: "financial_autonomy",
            },
          ],
        },
        {
          id: 5,
          question:
            "Tem experiência de trabalho como empregada de limpeza. Como foi?",
          options: [
            {
              text: "Seis meses é um bom período. Deve ter aprendido muito.",
              empathy: 6,
              info: 5,
              code: "work_positive",
            },
            {
              text: "Porque é que o trabalho terminou? Houve algum problema?",
              empathy: 2,
              info: 8,
              code: "work_termination",
            },
            {
              text: "Gostaria de voltar a trabalhar na área de limpeza?",
              empathy: 5,
              info: 6,
              code: "work_interest",
            },
          ],
        },
      ];

      // DADOS DOS ELEMENTOS DE ANÁLISE (expandidos com elementos ocultos)
      const analysisElements = [
        // Elementos visíveis desde o início
        { id: "idade_56", text: "Idade: 56 anos", category: "risk", points: 5 },
        {
          id: "9ano_escolaridade",
          text: "9º ano escolaridade",
          category: "risk",
          points: 4,
        },
        {
          id: "vive_sozinha",
          text: "Vive sozinha",
          category: "risk",
          points: 6,
        },
        {
          id: "rsi_beneficiaria",
          text: "Beneficiária RSI",
          category: "risk",
          points: 3,
        },
        {
          id: "experiencia_limpeza",
          text: "Experiência em limpeza",
          category: "protection",
          points: 8,
        },
        {
          id: "psi_ativa",
          text: "PSI ativa",
          category: "protection",
          points: 6,
        },
        {
          id: "sem_dependentes",
          text: "Sem dependentes",
          category: "protection",
          points: 7,
        },
        {
          id: "motivacao_mudanca",
          text: "Motivação para mudança",
          category: "protection",
          points: 5,
        },
        {
          id: "isolamento_social",
          text: "Isolamento social",
          category: "risk",
          points: 7,
        },

        // Elementos ocultos (desbloqueados por códigos)
        {
          id: "dependencia_pai",
          text: "Dependência emocional do pai",
          category: "risk",
          points: 8,
          hidden: true,
          unlockCode: "father_bond",
        },
        {
          id: "perda_rede_apoio",
          text: "Perda da rede de apoio (irmão)",
          category: "risk",
          points: 6,
          hidden: true,
          unlockCode: "brother_loss",
        },
        {
          id: "capacidade_adaptacao",
          text: "Capacidade de adaptação",
          category: "protection",
          points: 9,
          hidden: true,
          unlockCode: "empathy_high",
        },
      ];

      // DADOS DOS DOCUMENTOS (expandidos com documentos secretos)
      const documentsData = [
        {
          id: "bi",
          name: "Bilhete de Identidade",
          available: true,
          mandatory: true,
          points: 5,
        },
        {
          id: "nif",
          name: "Número de Identificação Fiscal",
          available: true,
          mandatory: true,
          points: 5,
        },
        {
          id: "niss",
          name: "Número de Identificação da Segurança Social",
          available: false,
          mandatory: true,
          points: 8,
        },
        {
          id: "comprovativo_rsi",
          name: "Comprovativo RSI",
          available: true,
          mandatory: false,
          points: 3,
        },
        {
          id: "comprovativo_psi",
          name: "Comprovativo PSI",
          available: true,
          mandatory: false,
          points: 3,
        },
        {
          id: "cv",
          name: "Curriculum Vitae",
          available: false,
          mandatory: false,
          points: 2,
        },

        // Documentos secretos
        {
          id: "relatorio_medico",
          name: "Relatório Médico (Oculto)",
          available: false,
          mandatory: false,
          points: 10,
          hidden: true,
          location: "gaveta",
        },
        {
          id: "historial_emprego",
          name: "Historial de Emprego Detalhado",
          available: false,
          mandatory: false,
          points: 8,
          hidden: true,
          location: "arquivo",
        },
      ];

      // FUNÇÕES DO ESCAPE ROOM

      function startEscapeRoom() {
        escapeRoomState.startTime = Date.now();
        startTimer();
        changeState("reception"); // Start with reception puzzle
        initReceptionPuzzle();
        updatePuzzleCounter(1);
        showToast("🚀 Missão iniciada! Investigue a receção!", "info", 5000);
      }

      function startTimer() {
        const timerDisplay = document.getElementById("timer-display");
        const timerProgress = document.getElementById("timer-progress");
        const timerContainer = document.getElementById("timer-container");

        const updateTimer = () => {
          const elapsed = Date.now() - escapeRoomState.startTime;
          const remaining = Math.max(0, escapeRoomState.timeLimit - elapsed);

          const minutes = Math.floor(remaining / 60000);
          const seconds = Math.floor((remaining % 60000) / 1000);

          timerDisplay.textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

          const progress = (remaining / escapeRoomState.timeLimit) * 100;
          timerProgress.style.width = `${progress}%`;

          // Avisos de tempo
          if (
            remaining <= 300000 &&
            !timerContainer.classList.contains("timer-warning")
          ) {
            // 5 minutos
            timerContainer.classList.add("timer-warning");
            showToast("⚠️ Apenas 5 minutos restantes!", "warning", 3000);
          }

          if (remaining <= 60000 && remaining > 59000) {
            // 1 minuto
            showToast("🚨 ÚLTIMO MINUTO! Finalize rapidamente!", "error", 5000);
          }

          if (remaining <= 0) {
            timeUp();
            return;
          }

          setTimeout(updateTimer, 1000);
        };

        updateTimer();
      }

      function timeUp() {
        showToast(
          "⏰ Tempo esgotado! A missão será finalizada automaticamente.",
          "error",
          5000
        );
        // Penalização por tempo esgotado
        gameState.score = Math.max(0, gameState.score - 20);
        setTimeout(() => changeState("conclusao"), 3000);
      }

      function updatePuzzleCounter(puzzleNumber) {
        escapeRoomState.currentPuzzle = puzzleNumber;
        document.getElementById("current-puzzle").textContent = puzzleNumber;
      }

      function addBonusPoints(points, reason) {
        escapeRoomState.bonusPoints += points;
        gameState.score += points;
        showToast(`🎉 Bonus: +${points} pontos! ${reason}`, "success", 5000);
        updateScoreDisplay();
      }

      function updateScoreDisplay() {
        document.getElementById("score").textContent = gameState.score;
      }

      function discoverCode(code) {
        if (!escapeRoomState.codesDiscovered.includes(code)) {
          escapeRoomState.codesDiscovered.push(code);
          showToast(
            "🔓 Código descoberto! Novos elementos desbloqueados.",
            "info",
            3000
          );

          // Revelar elementos ocultos baseados no código
          revealHiddenElements(code);
        }
      }

      function revealHiddenElements(code) {
        analysisElements.forEach((element) => {
          if (element.hidden && element.unlockCode === code) {
            element.hidden = false;
            escapeRoomState.hiddenElementsFound++;

            // Adicionar elemento ao pool se estivermos na análise
            if (gameState.currentState === "analise") {
              addElementToPool(element);
            }
          }
        });

        // Atualizar contador de elementos ocultos
        if (document.getElementById("hidden-discovered")) {
          document.getElementById("hidden-discovered").textContent =
            escapeRoomState.hiddenElementsFound;
        }
      }

      function addElementToPool(element) {
        const pool = document.getElementById("elements-pool");
        const div = document.createElement("div");
        div.className = "drag-item hidden-element";
        div.draggable = true;
        div.textContent = element.text;
        div.dataset.id = element.id;
        div.dataset.category = element.category;
        div.dataset.points = element.points;
        div.ondragstart = drag;

        // Adicionar indicador de pista
        const clueIndicator = document.createElement("div");
        clueIndicator.className = "clue-indicator";
        clueIndicator.textContent = "!";
        div.appendChild(clueIndicator);

        pool.appendChild(div);

        // Animar revelação
        setTimeout(() => {
          div.classList.add("revealed");
        }, 100);
      }

      function updateFelisbinaAvatar() {
        const avatar = document.getElementById("felisbina-avatar");
        const empathy = gameState.empathy;

        if (empathy >= 20) {
          avatar.textContent = "😊";
          avatar.className = "empathy-avatar happy";
        } else if (empathy >= 10) {
          avatar.textContent = "🙂";
          avatar.className = "empathy-avatar neutral";
        } else {
          avatar.textContent = "😐";
          avatar.className = "empathy-avatar sad";
        }
      }

      // FUNÇÕES ORIGINAIS ADAPTADAS

      // Função para atualizar pontuação com limite
      function addScore(points) {
        gameState.score = Math.min(gameState.score + points, 150); // Aumentado para 150
        updateScoreDisplay();
      }

      // Toast System
      function showToast(message, type = "info", duration = 7000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
          ${message}
          <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Custom Dialog System
      class CustomDialog {
        constructor() {
          this.overlay = null;
          this.currentDialog = null;
          this.createOverlay();
        }

        createOverlay() {
          this.overlay = document.createElement("div");
          this.overlay.className = "custom-dialog-overlay";
          this.overlay.addEventListener("click", (e) => {
            if (e.target === this.overlay) {
              this.close(null);
            }
          });
          document.body.appendChild(this.overlay);
        }

        show(options) {
          const {
            type = "confirm",
            title = "Confirmação",
            message = "Tem a certeza?",
            okText = "OK",
            cancelText = "Cancelar",
            hasInput = false,
            inputPlaceholder = "Digite aqui...",
            inputValue = "",
          } = options;

          return new Promise((resolve) => {
            this.currentResolve = resolve;

            const iconMap = {
              confirm: "❓",
              prompt: "📝",
              alert: "ℹ️",
            };

            const dialog = document.createElement("div");
            dialog.className = "custom-dialog";

            dialog.innerHTML = `
              <div class="custom-dialog-header">
                <div class="custom-dialog-icon ${type}">${
              iconMap[type] || "❓"
            }</div>
                <h3 class="custom-dialog-title">${title}</h3>
              </div>
              <div class="custom-dialog-body">
                <div>${message}</div>
                ${
                  hasInput
                    ? `<input type="text" class="custom-dialog-input" placeholder="${inputPlaceholder}" value="${inputValue}">`
                    : ""
                }
              </div>
              <div class="custom-dialog-buttons">
                ${
                  type !== "alert"
                    ? `<button class="custom-dialog-btn secondary" data-action="cancel">${cancelText}</button>`
                    : ""
                }
                <button class="custom-dialog-btn primary" data-action="ok">${okText}</button>
              </div>
            `;

            this.overlay.innerHTML = "";
            this.overlay.appendChild(dialog);
            this.currentDialog = dialog;

            // Add button event listeners
            dialog.querySelectorAll(".custom-dialog-btn").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const action = e.target.dataset.action;
                if (action === "ok") {
                  if (hasInput) {
                    const input = dialog.querySelector(".custom-dialog-input");
                    this.close(input.value.trim() || null);
                  } else {
                    this.close(true);
                  }
                } else {
                  this.close(hasInput ? null : false);
                }
              });
            });

            // Handle Enter key for input
            if (hasInput) {
              const input = dialog.querySelector(".custom-dialog-input");
              input.focus();
              input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                  this.close(input.value.trim() || null);
                }
              });
            }

            // Handle Escape key
            const handleEscape = (e) => {
              if (e.key === "Escape") {
                this.close(hasInput ? null : false);
                document.removeEventListener("keydown", handleEscape);
              }
            };
            document.addEventListener("keydown", handleEscape);

            // Show dialog
            this.overlay.classList.add("show");
          });
        }

        close(result) {
          this.overlay.classList.remove("show");
          setTimeout(() => {
            if (this.currentResolve) {
              this.currentResolve(result);
              this.currentResolve = null;
            }
          }, 300);
        }

        // Convenience methods
        async confirm(message, title = "Confirmação") {
          return await this.show({
            type: "confirm",
            title,
            message,
            okText: "Sim",
            cancelText: "Não",
          });
        }

        async alert(message, title = "Informação") {
          return await this.show({
            type: "alert",
            title,
            message,
            okText: "OK",
          });
        }

        async prompt(message, title = "Input Necessário", defaultValue = "") {
          return await this.show({
            type: "prompt",
            title,
            message,
            hasInput: true,
            inputPlaceholder: "Digite sua resposta...",
            inputValue: defaultValue,
            okText: "OK",
            cancelText: "Cancelar",
          });
        }
      }

      // Global dialog instance
      const customDialog = new CustomDialog();

      // Override native dialogs with async versions
      window.customConfirm = (message) => customDialog.confirm(message);
      window.customAlert = (message) => customDialog.alert(message);
      window.customPrompt = (message, defaultValue = "") =>
        customDialog.prompt(message, "Input Necessário", defaultValue);

      function continueToPhase2() {
        // Verificar se pontuação é suficiente
        if (gameState.score < 70) {
          showToast(
            "⚠️ Precisa de pelo menos 70 pontos para desbloquear a Fase 2.<br>Pontuação atual: " +
              gameState.score,
            "warning",
            6000
          );
          return;
        }

        // Salvar dados da Fase 1 para transferir para Fase 2
        const phase1Data = {
          phase: 1,
          score: gameState.score,
          maxScore: 150,
          percentage: Math.round((gameState.score / 150) * 100),
          duration: escapeRoomState.startTime
            ? Math.round((Date.now() - escapeRoomState.startTime) / 60000)
            : 20,
          level: { title: getFinalLevel() },
          empathy: gameState.empathy,
          information: gameState.information,
          interactions: gameState.interactions,
          availability: gameState.availability,
          capacity: gameState.capacity,
          docsIdentified: gameState.docsIdentified,
          elementsPlaced: gameState.elementsPlaced,
          escapeRoomData: {
            bonusPoints: escapeRoomState.bonusPoints,
            codesDiscovered: escapeRoomState.codesDiscovered,
            hiddenElementsFound: escapeRoomState.hiddenElementsFound,
            achievements: escapeRoomState.achievements,
          },
        };

        // Salvar no localStorage
        localStorage.setItem(
          "saasi_phase1_results",
          JSON.stringify(phase1Data)
        );

        showToast(
          "🎉 Dados salvos! Redirecionando para Fase 2...",
          "success",
          2000
        );
        setTimeout(() => {
          window.location.href = "fase2.html";
        }, 2000);
      }

      function getFinalLevel() {
        const score = gameState.score;
        if (score >= 130) return "Detetive Master";
        if (score >= 110) return "Detetive Especialista";
        if (score >= 90) return "Detetive Proficiente";
        if (score >= 70) return "Detetive Competente";
        return "Detetive Iniciante";
      }

      // Resto das funções originais mantidas...
      // (Por brevidade, não incluí todas aqui, mas seriam copiadas da versão original)

      function changeState(newState) {
        // Esconder todos os estados
        document.querySelectorAll(".state").forEach((state) => {
          state.classList.remove("active");
        });

        // Mostrar novo estado
        document.getElementById(`state-${newState}`).classList.add("active");

        gameState.currentState = newState;
        updateProgress();

        // Atualizar contador de puzzle
        const puzzleMap = {
          reception: 1,
          conversa: 2,
          analise: 3,
          documentacao: 4,
          avaliacao: 5,
        };

        if (puzzleMap[newState]) {
          updatePuzzleCounter(puzzleMap[newState]);
        }
      }

      function updateProgress() {
        const states = [
          "inicio",
          "reception",
          "conversa",
          "analise",
          "documentacao",
          "avaliacao",
          "conclusao",
        ];
        const currentIndex = states.indexOf(gameState.currentState);
        const progress = (currentIndex / (states.length - 1)) * 100;

        document.getElementById("progress").style.width = progress + "%";
      }

      function nextState() {
        const states = [
          "inicio",
          "reception",
          "conversa",
          "analise",
          "documentacao",
          "avaliacao",
          "conclusao",
        ];
        const currentIndex = states.indexOf(gameState.currentState);
        const nextState = states[currentIndex + 1];

        if (nextState) {
          changeState(nextState);

          // Inicializar estado específico
          switch (nextState) {
            case "conversa":
              showDialogue();
              break;
            case "analise":
              initAnalysis();
              break;
            case "documentacao":
              initDocumentation();
              break;
            case "conclusao":
              showConclusion();
              break;
          }
        }
      }

      // ===== PUZZLE 1: RECEPTION DESK MYSTERY IMPLEMENTATION =====

      let receptionState = {
        cluesFound: 0,
        requiredClues: 5, // Exactly 5 clues total
        energyLevel: 50,
        investigatedObjects: new Set(),
        unlockedObjects: new Set(), // Track objects that are successfully unlocked
        discoveredClues: [],
        bonusEarned: false,
        contextPhase: "preparation", // preparation -> investigation -> completion
      };

      // Reception puzzle clues data - WITH DISCOVERABLE CLUES EMBEDDED
      const receptionClues = {
        // STARTER CLUE - Always available, contains clue for first code
        computer: {
          title: "Agendamento da Felisbina",
          content:
            "📅 <strong>Consulta agendada:</strong> Felisbina Santos, 56 anos, 9º ano escolaridade<br>🔍 <strong>Motivo:</strong> Avaliação DLD - Primeira consulta<br>📝 <strong>Observações:</strong> Cliente nervosa, menciona dependência do pai frequentemente<br>🏠 <strong>Habitação:</strong> Vive sozinha numa pensão<br><br>💰 <strong>Benefício Ativo:</strong> <span style='color: #e74c3c; font-weight: bold;'>RSI</span> desde Março <span style='color: #e74c3c; font-weight: bold;'>2025</span><br><br>🔑 <em>Para acessar os arquivos dos beneficiários, use o código do benefício + ano</em>",
          discovered: false,
          required: true,
          unlockRequirement: null, // Always available
          requiresCodeEntry: true,
          expectedCode: "RSI2025",
          hint: "Benefício + Ano visível no ecrã do computador",
          unlocksAccess: ["cabinet"],
        },

        // UNLOCKED BY: RSI2025 - Contains clue for next code
        cabinet: {
          title: "Pasta de Beneficiários",
          content:
            "📂 <strong>Felisbina Santos - Dados Oficiais:</strong><br>💰 <strong>RSI:</strong> Ativo desde Março 2025 (valor: 253.20€)<br>💊 <strong>PSI:</strong> Prestação Social para Inclusão ativa<br>🏠 <strong>Morada:</strong> Pensão - Rua da Esperança, nº 45<br>📊 <strong>Gestão Financeira:</strong> Anteriormente pelo irmão, agora independente<br><br>📋 <strong>Nota anexa:</strong> <em>\"Para orientação técnica, contactar linha de <span style='color: #27ae60; font-weight: bold;'>APOIO</span> - Extensão <span style='color: #27ae60; font-weight: bold;'>123</span>\"</em><br><br>🔑 <em>Use o contacto de apoio para aceder ao telefone</em>",
          discovered: false,
          required: true,
          unlockRequirement: "RSI2025",
          requiresCodeEntry: true,
          expectedCode: "APOIO123",
          hint: "Linha de contacto indicada na nota (palavra + número)",
          unlocksAccess: ["phone"],
        },

        // UNLOCKED BY: APOIO123 - Contains clue for next code
        phone: {
          title: "Chamada de Apoio Técnico",
          content:
            "📞 <strong>Conversa com colega experiente:</strong><br>👥 'A Felisbina precisa de abordagem empática e cuidadosa'<br>💡 'Atenção: dependência emocional do progenitor pode afetar autonomia'<br>✅ 'Ponto forte: 6 meses experiência como empregada de limpeza'<br>⚠️ 'Situação familiar: ruptura recente com irmão que geria finanças'<br><br>📋 'Para consultares as <span style='color: #8e44ad; font-weight: bold;'>NOTAS</span> anteriores, usa o código do ano passado: <span style='color: #8e44ad; font-weight: bold;'>2024</span>'<br><br>🔑 <em>O colega deu-te o código das notas anteriores</em>",
          discovered: false,
          required: true,
          unlockRequirement: "APOIO123",
          requiresCodeEntry: true,
          expectedCode: "NOTAS2024",
          hint: "Palavra + ano mencionados pelo colega na chamada",
          unlocksAccess: ["clipboard"],
        },

        // UNLOCKED BY: NOTAS2024 - Contains clue for next code
        clipboard: {
          title: "Notas dos Técnicos Anteriores",
          content:
            "📋 <strong>Avaliação técnica anterior:</strong><br>😟 <strong>Dependência Emocional:</strong> 'Elevada dependência emocional do progenitor'<br>💼 <strong>Experiência Profissional:</strong> '6 meses como empregada de limpeza - transferível'<br>⚠️ <strong>Situação Familiar:</strong> 'Ruptura recente com irmão responsável por finanças'<br>📈 <strong>Potencial:</strong> 'Disponibilidade alta, capacidade boa com formação'<br><br>🔐 <strong>Código de arquivo:</strong> <em>\"Protocolo <span style='color: #d35400; font-weight: bold;'>DLD</span> ano <span style='color: #d35400; font-weight: bold;'>2025</span> - usar para aceder aos procedimentos\"</em><br><br>🔑 <em>O código do protocolo atual está nas notas</em>",
          discovered: false,
          required: true,
          unlockRequirement: "NOTAS2024",
          requiresCodeEntry: true,
          expectedCode: "DLD2025",
          hint: "Protocolo + ano mencionados nas notas arquivadas",
          unlocksAccess: ["board"],
        },

        // FINAL CLUE - Contains obvious final code
        board: {
          title: "Procedimentos SAASI - Protocolo DLD",
          content:
            "📌 <strong>Protocolo Avaliação DLD 2025:</strong><br>1️⃣ <strong>Disponibilidade:</strong> Avaliar impedimentos para trabalho<br>2️⃣ <strong>Capacidade:</strong> Analisar competências e necessidades formação<br>3️⃣ <strong>Fatores:</strong> Identificar risco/proteção<br>4️⃣ <strong>Plano:</strong> Definir acompanhamento personalizado<br><br>✅ <strong>Perfil Felisbina:</strong> Disponível, capacidade boa c/ formação<br><br>🚪 <strong>Próximo passo:</strong> <em>\"Dirigir-se à sala de <span style='color: #c0392b; font-weight: bold;'>REUNIÃO</span> para iniciar avaliação formal\"</em><br><br>🔑 <em>A palavra para a próxima sala está destacada</em>",
          discovered: false,
          required: true,
          unlockRequirement: "DLD2025",
          requiresCodeEntry: true,
          expectedCode: "REUNIÃO",
          hint: "Tipo de sala mencionado nas instruções finais",
          unlocksAccess: ["meeting-door"],
        },

        // ALTERNATIVE ROUTE - Coffee with helpful hint
        coffee: {
          title: "Bem-estar no Trabalho Social",
          content:
            "☕ <strong>Máquina de café:</strong><br>💪 <strong>Energia aumentada!</strong> (+30 energia)<br>🧠 <strong>Foco melhorado</strong> para investigação complexa<br>💡 <strong>Dica profissional:</strong> Cuidar do bem-estar é essencial no trabalho social!<br><br>🔍 <strong>Dica de investigação:</strong> <em>Procure por palavras destacadas e números nos documentos - são pistas importantes!</em><br><br>⚡ <em>Com energia alta (≥70), pode saltar alguns passos!</em>",
          discovered: false,
          required: false,
          unlockRequirement: null,
          energyBoost: 30,
          requiresCodeEntry: false,
          unlocksAccess: [],
        },
      };

      function initReceptionPuzzle() {
        updateReceptionMetrics();
        showToast(
          "🔍 Explore o escritório! Clique nos objetos para descobrir pistas sobre a Felisbina.",
          "info",
          5000
        );

        // Show helpful instructions after a moment
        setTimeout(() => {
          showToast(
            "💡 DICA: Procure por palavras destacadas e números nos documentos - são códigos importantes!",
            "info",
            6000
          );
        }, 3000);
      }

      function investigateObject(objectId) {
        const clue = receptionClues[objectId];

        if (!clue) {
          showToast("❌ Objeto não encontrado!", "error", 4000);
          return;
        }

        // Check if this object is already unlocked (successfully completed)
        if (
          receptionState.unlockedObjects &&
          receptionState.unlockedObjects.has(objectId)
        ) {
          showToast("✅ Este objeto já foi desbloqueado!", "info", 4000);
          return;
        }

        // Check if this clue can be investigated now (proper order)
        if (!canInvestigateClue(clue)) {
          return;
        }

        // Don't mark as investigated yet - only when successfully unlocked

        // Show investigation result
        showInvestigationResult(clue);

        // Handle clue discovery - only for objects that don't require codes
        if (!clue.requiresCodeEntry) {
          // For objects like coffee that don't need codes, discover immediately
          if (!clue.discovered) {
            clue.discovered = true;

            // Mark as unlocked since no code is needed
            receptionState.unlockedObjects.add(objectId);
            receptionState.investigatedObjects.add(objectId);

            // Count clues and update discovery list
            if (clue.required) {
              receptionState.cluesFound++;
              receptionState.discoveredClues.push(clue);
            } else {
              receptionState.discoveredClues.push({ ...clue, optional: true });
            }

            // Enhanced scoring for puzzle solving
            if (clue.required) {
              addScore(15); // Points for required clue discovery
            } else {
              addScore(10); // Bonus points for optional clues
            }

            // Handle special cases (like coffee energy boost)
            if (objectId === "coffee" && clue.energyBoost) {
              receptionState.energyLevel = Math.min(
                100,
                receptionState.energyLevel + clue.energyBoost
              );
              addBonusPoints(5, "Bem-estar no trabalho!");
              showToast(
                "☕ Energia renovada! Agora pode acessar mais objetos!",
                "success",
                3000
              );
            }

            // Update UI
            updateCluesList();
            markObjectAsInvestigated(objectId);
            showClueIndicator(objectId);

            // Show discovery feedback
            showToast(
              `🎉 ${
                clue.required ? "Informação essencial" : "Bonus"
              } descoberta!`,
              "success",
              3000
            );

            // Direct unlock for items that don't need code entry
            if (clue.unlocksAccess && clue.unlocksAccess.length > 0) {
              unlockNewObjects(clue);
            }
          }
        } else {
          // For objects that require code entry, just show the prompt
          // Don't discover the clue until code is correctly entered
          setTimeout(async () => {
            await showCodeEntryPrompt(clue, objectId);
          }, 1000);
        }

        updateReceptionMetrics();
        checkPuzzleCompletion();
      }

      function canInvestigateClue(clue) {
        // Objects without unlock requirements are always available
        if (!clue.unlockRequirement) {
          return true;
        }

        // Initialize codes if not exists
        if (!receptionState.codesDiscovered) {
          receptionState.codesDiscovered = [];
        }

        // Check if we have the required code (entered successfully)
        if (receptionState.codesDiscovered.includes(clue.unlockRequirement)) {
          return true;
        }

        // Special energy-based unlocks (alternative paths)
        if (
          clue.unlockRequirement === "NOTAS2024" &&
          receptionState.energyLevel >= 70
        ) {
          showToast(
            "🔥 Energia alta permite acesso direto às notas!",
            "info",
            2000
          );
          return true;
        }

        // Show appropriate unlock hint
        const unlockHints = {
          RSI2025:
            "Precisa inserir código de acesso aos arquivos (computador primeiro)",
          APOIO123:
            "Precisa inserir código de contacto (pasta de beneficiários primeiro)",
          NOTAS2024:
            "Precisa inserir código das notas OU energia ≥70 (tente o café!)",
          DLD2025:
            "Precisa inserir código do protocolo (notas dos técnicos primeiro)",
        };

        const hint = unlockHints[clue.unlockRequirement] || "Objeto bloqueado";
        showToast(`🔒 ${hint}`, "warning", 3000);
        return false;
      }

      function unlockNewObjects(discoveredClue) {
        if (discoveredClue.unlocksAccess) {
          const newlyUnlocked = discoveredClue.unlocksAccess.filter((objId) => {
            const targetClue = receptionClues[objId];
            return (
              targetClue &&
              !targetClue.discovered &&
              !receptionState.investigatedObjects.has(objId)
            );
          });

          if (newlyUnlocked.length > 0) {
            const objectNames = {
              cabinet: "Arquivo",
              phone: "Telefone",
              clipboard: "Prancheta",
              board: "Quadro de Procedimentos",
              "meeting-door": "Sala de Reunião",
            };

            const unlockedNames = newlyUnlocked
              .map((id) => objectNames[id] || id)
              .join(", ");
            showToast(
              `🔓 Novo acesso desbloqueado: ${unlockedNames}!`,
              "info",
              4000
            );

            // Visual feedback - highlight newly unlocked objects
            highlightUnlockedObjects(newlyUnlocked);
          }
        }
      }

      function highlightUnlockedObjects(objectIds) {
        objectIds.forEach((objectId) => {
          const element = document.querySelector(
            `[onclick="investigateObject('${objectId}')"]`
          );
          if (element) {
            element.style.animation = "pulse 2s ease-in-out 3";
            element.style.border = "2px solid #4caf50";
            setTimeout(() => {
              element.style.animation = "";
              element.style.border = "";
            }, 6000);
          }
        });
      }

      function updateContextPhase() {
        // Simplified context phase based on codes discovered
        const codes = receptionState.codesDiscovered || [];

        if (
          codes.length >= 2 &&
          receptionState.contextPhase === "preparation"
        ) {
          receptionState.contextPhase = "investigation";
          showToast("🔄 Investigação aprofundada desbloqueada!", "info", 3000);
        } else if (
          codes.length >= 4 &&
          receptionState.contextPhase === "investigation"
        ) {
          receptionState.contextPhase = "completion";
          showToast(
            "🎯 Fase final! Todos os códigos revelam o caminho.",
            "info",
            3000
          );
        }
      }

      function showInvestigationResult(clue) {
        const panel = document.getElementById("investigation-content");

        let content = `
          <div style="border-left: 4px solid #3498db; padding-left: 15px;">
            <h5 style="color: #2c3e50; margin: 0 0 10px 0;">${clue.title}</h5>
            <div style="line-height: 1.6;">${clue.content}</div>
        `;

        // Show next action hint
        if (clue.requiresCodeEntry) {
          content += `
            <div style="margin-top: 15px; background: #fff3e0; padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <strong>🔑 Próximo passo:</strong> Inserir código para desbloquear acesso<br>
              <small style="color: #e67e22; margin-top: 5px; display: block;">💡 ${clue.hint}</small>
            </div>
          `;
        } else if (clue.unlocksAccess && clue.unlocksAccess.length > 0) {
          const objectNames = {
            cabinet: "🗄️ Arquivo",
            phone: "📞 Telefone",
            clipboard: "📋 Prancheta",
            board: "📌 Quadro de Procedimentos",
            "meeting-door": "🚪 Sala de Reunião",
          };
          const unlockNames = clue.unlocksAccess
            .map((id) => objectNames[id] || id)
            .join(", ");
          content += `
            <div style="margin-top: 10px; background: #e8f5e8; padding: 10px; border-radius: 5px; border-left: 4px solid #4caf50;">
              <strong>✅ Acesso direto desbloqueado:</strong> ${unlockNames}
            </div>
          `;
        }

        content += `</div>`;
        panel.innerHTML = content;
      }

      async function showCodeEntryPrompt(clue, objectId) {
        const promptMessage =
          `🔐 <strong>CÓDIGO NECESSÁRIO</strong><br><br>` +
          `📋 <strong>Objeto:</strong> ${clue.title}<br>` +
          `💡 <strong>Dica:</strong> ${clue.hint}<br><br>` +
          `Digite o código para desbloquear:`;

        const code = await customDialog.prompt(
          promptMessage,
          "Código de Acesso"
        );

        if (code === null || code === undefined) {
          // User cancelled or invalid input
          showToast("❌ Entrada de código cancelada", "warning", 4000);
          return;
        }

        // Convert to string and trim whitespace to handle any input type
        const userCode = String(code).trim();
        const expectedCode = String(clue.expectedCode).trim();

        if (userCode.toUpperCase() === expectedCode.toUpperCase()) {
          // Correct code!
          if (!receptionState.codesDiscovered) {
            receptionState.codesDiscovered = [];
          }
          receptionState.codesDiscovered.push(clue.expectedCode);

          addScore(20); // Bonus points for correct code entry
          showToast(`🎉 Código correto! Acesso desbloqueado!`, "success", 3000);

          // Mark this object as properly unlocked
          receptionState.unlockedObjects.add(objectId);
          receptionState.investigatedObjects.add(objectId);

          // Handle clue discovery (moved from investigateObject)
          if (!clue.discovered) {
            clue.discovered = true;

            // Count clues and update discovery list
            if (clue.required) {
              receptionState.cluesFound++;
              receptionState.discoveredClues.push(clue);
            } else {
              receptionState.discoveredClues.push({ ...clue, optional: true });
            }

            // Enhanced scoring for puzzle solving (additional points for successful unlock)
            if (clue.required) {
              addScore(15); // Points for required clue discovery
            } else {
              addScore(10); // Bonus points for optional clues
            }

            // Update UI after successful code entry
            updateCluesList();
            markObjectAsInvestigated(objectId);
            showClueIndicator(objectId);

            // Show discovery feedback
            showToast(
              `🎉 ${
                clue.required ? "Informação essencial" : "Bonus"
              } descoberta!`,
              "success",
              3000
            );
          }

          // Unlock new objects
          unlockNewObjects(clue);
        } else {
          // Wrong code
          showToast(
            `❌ Código incorreto: "${userCode}". Tente novamente!`,
            "error",
            3000
          );

          // Allow retry after delay
          setTimeout(async () => {
            const retry = await customDialog.confirm(
              `💡 <strong>Código incorreto!</strong><br><br>` +
                `<strong>Código inserido:</strong> "${userCode}"<br>` +
                `<strong>Dica:</strong> ${clue.hint}<br><br>` +
                `Deseja tentar novamente?`,
              "🔐 Código Incorreto"
            );
            if (retry) {
              await showCodeEntryPrompt(clue, objectId);
            }
          }, 1000);
        }
      }

      function updateCluesList() {
        const cluesList = document.getElementById("clues-list");

        if (receptionState.discoveredClues.length === 0) {
          cluesList.innerHTML =
            '<p style="font-style: italic; color: #666;">Nenhuma pista descoberta ainda...</p>';
          return;
        }

        cluesList.innerHTML = receptionState.discoveredClues
          .map(
            (clue, index) => `
          <div style="background: ${
            clue.optional ? "#fff3e0" : "#e8f5e8"
          }; margin: 10px 0; padding: 12px; border-radius: 8px; border-left: 4px solid ${
              clue.optional ? "#ff9800" : "#4caf50"
            };">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <strong>${clue.optional ? "🎁" : index + 1 + "."} ${
              clue.title
            }</strong>
              <span style="background: ${
                clue.optional ? "#ff9800" : "#4caf50"
              }; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${
              clue.optional ? "Bonus" : "+10 pts"
            }</span>
            </div>
            <div style="margin-top: 8px; font-size: 14px; color: #2c3e50;">${
              clue.content
            }</div>
          </div>
        `
          )
          .join("");
      }

      function markObjectAsInvestigated(objectId) {
        const object = document.getElementById(
          objectId === "computer"
            ? "computer-screen"
            : objectId === "cabinet"
            ? "file-cabinet"
            : objectId === "coffee"
            ? "coffee-machine"
            : objectId === "phone"
            ? "office-phone"
            : objectId === "board"
            ? "notice-board"
            : objectId
        );

        if (object) {
          object.style.opacity = "0.7";
          object.style.transform = "scale(0.95)";
          object.style.cursor = "default";
          object.style.border = "3px solid #4caf50";
        }
      }

      function showClueIndicator(objectId) {
        const indicator = document.getElementById(`${objectId}-clue`);
        if (indicator) {
          indicator.classList.remove("hidden");
          indicator.style.display = "flex";
        }
      }

      function updateReceptionMetrics() {
        // Fix: Only count required clues, cap at maximum
        const actualCluesFound = Math.min(
          receptionState.cluesFound,
          receptionState.requiredClues
        );
        document.getElementById("clues-found").textContent = actualCluesFound;
        document.getElementById("energy-level").textContent =
          receptionState.energyLevel;

        // Fix: Cap progress at 100%
        const progress = Math.min(
          100,
          Math.round((actualCluesFound / receptionState.requiredClues) * 100)
        );
        document.getElementById("puzzle1-progress").textContent = progress;
      }

      function checkPuzzleCompletion() {
        if (receptionState.cluesFound >= receptionState.requiredClues) {
          // Unlock meeting room
          const meetingDoor = document.getElementById("meeting-door");
          meetingDoor.style.background = "#4caf50";
          meetingDoor.style.cursor = "pointer";
          meetingDoor.style.opacity = "1";
          meetingDoor.style.transform = "scale(1.05)";
          meetingDoor.innerHTML = `
            <div style="font-size: 30px;">🚪</div>
            <div style="font-weight: bold; margin-top: 5px; color: white;">Sala de Reunião</div>
            <div style="font-size: 12px; color: #e8f8e8;">🔓 Desbloqueada!</div>
          `;

          // Show completion button
          document.getElementById("next-reception").style.display = "block";

          // Time bonus
          const elapsedMinutes =
            (Date.now() - escapeRoomState.startTime) / 60000;
          if (elapsedMinutes <= 2 && !receptionState.bonusEarned) {
            addBonusPoints(15, "Investigação rápida!");
            receptionState.bonusEarned = true;
          }

          showToast(
            "🎉 Puzzle completado! Todas as pistas descobertas!",
            "success",
            4000
          );
          setTimeout(() => {
            showToast(
              "🚪 A sala de reunião foi desbloqueada! Pode prosseguir.",
              "info",
              3000
            );
          }, 2000);
        }
      }

      // Placeholder para outras funções que seriam copiadas da versão original
      function showDialogue() {
        // Implementação do diálogo (copiada da original)
        console.log("Showing dialogue...");
      }

      function initAnalysis() {
        // Implementação da análise (copiada da original)
        console.log("Initializing analysis...");
      }

      function initDocumentation() {
        // Implementação da documentação (copiada da original)
        console.log("Initializing documentation...");
      }

      function showConclusion() {
        // Implementação da conclusão (adaptada para escape room)
        const timeUsed = escapeRoomState.startTime
          ? Math.round((Date.now() - escapeRoomState.startTime) / 60000)
          : 0;

        document.getElementById("final-score").textContent = gameState.score;
        document.getElementById(
          "time-used"
        ).textContent = `${timeUsed} minutos`;
        document.getElementById("final-level").textContent = getFinalLevel();

        // Calcular conquistas
        calculateAchievements(timeUsed);
      }

      function calculateAchievements(timeUsed) {
        const achievements = [];

        if (timeUsed <= 30)
          achievements.push(
            "⚡ Velocidade da Luz - Completou em menos de 30 minutos"
          );
        if (escapeRoomState.hiddenElementsFound >= 3)
          achievements.push(
            "🔍 Detetive Sherlock - Encontrou todos os elementos ocultos"
          );
        if (gameState.empathy >= 20)
          achievements.push(
            "❤️ Coração de Ouro - Máxima empatia com a Felisbina"
          );
        if (escapeRoomState.bonusPoints >= 30)
          achievements.push("🎯 Mestre dos Códigos - Desbloqueou muitos bonus");
        if (gameState.score >= 130)
          achievements.push("🏆 Perfeição Absoluta - Pontuação quase perfeita");

        const achievementsList = document.getElementById("achievements-list");
        if (achievements.length > 0) {
          achievementsList.innerHTML = achievements
            .map(
              (a) =>
                `<div style="margin: 10px 0; padding: 10px; background: #e8f5e8; border-radius: 5px;">${a}</div>`
            )
            .join("");
        } else {
          achievementsList.innerHTML =
            "<p>Nenhuma conquista especial desta vez. Tente novamente para desbloquear!</p>";
        }
      }

      function restartGame() {
        location.reload();
      }

      // Inicialização
      document.addEventListener("DOMContentLoaded", function () {
        updateProgress();
      });
    </script>
  </body>
</html>
