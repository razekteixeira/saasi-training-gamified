<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAASI Escape Room - Fase 1 🎮</title>
    <style>
      /* Toast System */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
        pointer-events: none; /* Allow clicking through container */
      }

      .toast {
        background: #333;
        color: white;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        padding-right: 50px;
        pointer-events: auto; /* Allow clicking on toasts */
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        background: #28a745;
        border-left: 4px solid #1e7e34;
      }

      .toast.error {
        background: #dc3545;
        border-left: 4px solid #c82333;
      }

      .toast.warning {
        background: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .toast.info {
        background: #17a2b8;
        border-left: 4px solid #138496;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* Custom Dialog System */
      .custom-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 15000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .custom-dialog-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .custom-dialog {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.8) translateY(-50px);
        transition: all 0.3s ease;
      }

      .custom-dialog-overlay.show .custom-dialog {
        transform: scale(1) translateY(0);
      }

      .custom-dialog-header {
        padding: 20px 24px 15px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .custom-dialog-icon {
        font-size: 24px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .custom-dialog-icon.confirm {
        background: #e3f2fd;
        color: #1976d2;
      }

      .custom-dialog-icon.prompt {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      .custom-dialog-icon.alert {
        background: #fff3e0;
        color: #f57c00;
      }

      .custom-dialog-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .custom-dialog-body {
        padding: 20px 24px;
        color: #555;
        line-height: 1.6;
      }

      .custom-dialog-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        margin-top: 15px;
        transition: border-color 0.3s ease;
        outline: none;
      }

      .custom-dialog-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .custom-dialog-buttons {
        padding: 15px 24px 20px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        border-top: 1px solid #e0e0e0;
      }

      .custom-dialog-btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 80px;
      }

      .custom-dialog-btn.primary {
        background: #667eea;
        color: white;
      }

      .custom-dialog-btn.primary:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .custom-dialog-btn.secondary {
        background: #f5f5f5;
        color: #666;
        border: 1px solid #ddd;
      }

      .custom-dialog-btn.secondary:hover {
        background: #eeeeee;
        color: #333;
      }

      /* Mobile dialog adjustments */
      @media (max-width: 480px) {
        .custom-dialog {
          width: 95%;
          margin: 20px;
        }

        .custom-dialog-header,
        .custom-dialog-body,
        .custom-dialog-buttons {
          padding-left: 16px;
          padding-right: 16px;
        }

        .custom-dialog-buttons {
          flex-direction: column-reverse;
        }

        .custom-dialog-btn {
          width: 100%;
          margin: 4px 0;
        }
      }

      /* ESCAPE ROOM ENHANCEMENTS */
      .escape-room-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .timer-container {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 18px;
        font-weight: bold;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .timer-bar {
        width: 200px;
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        margin-top: 8px;
        overflow: hidden;
      }

      .timer-progress {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #ffc107, #f44336);
        transition: width 1s linear;
        border-radius: 4px;
      }

      .timer-warning {
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .clue-indicator {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ffd700;
        color: #333;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: glow 2s infinite;
        font-weight: bold;
      }

      @keyframes glow {
        0%,
        100% {
          box-shadow: 0 0 5px #ffd700;
        }
        50% {
          box-shadow: 0 0 20px #ffd700, 0 0 30px #ffd700;
        }
      }

      .hidden-element {
        opacity: 0.3;
        pointer-events: none;
        transition: all 0.5s ease;
      }

      .hidden-element.revealed {
        opacity: 1;
        pointer-events: auto;
        animation: reveal 0.5s ease;
      }

      @keyframes reveal {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .empathy-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        margin: 20px auto;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .empathy-avatar.happy {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        transform: scale(1.1);
      }

      .empathy-avatar.neutral {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      }

      .empathy-avatar.sad {
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        transform: scale(0.9);
      }

      .puzzle-counter {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 9999;
      }

      /* Original styles continue... */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .main-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        z-index: 1000;
      }
      .back-button:hover {
        background: rgba(108, 117, 125, 1);
        transform: translateY(-2px);
      }
      .score {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(51, 51, 51, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: bold;
        z-index: 1000;
      }
      .progress {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        margin: 20px 0;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.5s ease;
        border-radius: 4px;
      }
      .state {
        display: none;
        animation: fadeIn 0.5s ease;
      }
      .state.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        margin: 10px 5px;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .dialogue-option {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 20px;
        margin: 15px 0;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }
      .dialogue-option:hover {
        background: rgba(255, 255, 255, 0.95);
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
      }
      .dialogue-option.selected {
        background: rgba(102, 126, 234, 0.1);
        border-color: #667eea;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
      }

      /* Conversation Cards Styles */
      .conversation-scene {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
      }

      .question-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        border-left: 5px solid #667eea;
      }

      .question-text {
        font-size: 18px;
        font-style: italic;
        color: #333;
        margin: 10px 0;
      }

      .conversation-area {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin: 20px 0;
      }

      .response-cards-area,
      .conversation-zone-area {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .response-cards {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .conversation-card {
        background: #ffffff;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .conversation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .conversation-card.selected {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
      }

      .conversation-card.dragging {
        opacity: 0.7;
        transform: rotate(5deg);
      }

      .card-content {
        margin-bottom: 10px;
      }

      .card-text {
        font-size: 14px;
        line-height: 1.4;
        color: #333;
        margin-bottom: 10px;
      }

      .card-metrics {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        opacity: 0.8;
      }

      .empathy-indicator {
        color: #e91e63;
        font-weight: bold;
      }

      .info-indicator {
        color: #2196f3;
        font-weight: bold;
      }

      .card-type-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.1);
        color: #666;
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: bold;
      }

      .card-excellent {
        border-left: 4px solid #4caf50;
      }

      .card-excellent .card-type-indicator {
        background: #4caf50;
        color: white;
      }

      .card-good {
        border-left: 4px solid #2196f3;
      }

      .card-good .card-type-indicator {
        background: #2196f3;
        color: white;
      }

      .card-adequate {
        border-left: 4px solid #ff9800;
      }

      .card-adequate .card-type-indicator {
        background: #ff9800;
        color: white;
      }

      .card-poor {
        border-left: 4px solid #f44336;
      }

      .card-poor .card-type-indicator {
        background: #f44336;
        color: white;
      }

      .conversation-drop-zone {
        min-height: 200px;
        border: 3px dashed #ccc;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        background: rgba(245, 245, 245, 0.5);
      }

      .conversation-drop-zone:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .conversation-drop-zone.has-preview {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.05);
      }

      .conversation-drop-zone.drag-over {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
        transform: scale(1.02);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
      }

      .drop-zone-content {
        text-align: center;
        width: 100%;
        padding: 20px;
      }

      .drop-instruction {
        color: #666;
        font-style: italic;
        margin: 0;
      }

      .conversation-preview {
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        border-left: 4px solid #4caf50;
      }

      .response-preview {
        text-align: left;
      }

      .felisbina-says {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 8px;
      }

      .preview-text {
        font-style: italic;
        margin-bottom: 10px;
        color: #333;
      }

      .preview-metrics {
        display: flex;
        gap: 15px;
        font-size: 12px;
      }

      .empathy-preview,
      .info-preview {
        background: rgba(0, 0, 0, 0.05);
        padding: 4px 8px;
        border-radius: 8px;
        font-weight: bold;
      }

      .empathy-preview {
        color: #e91e63;
      }

      .info-preview {
        color: #2196f3;
      }

      .conversation-controls {
        text-align: center;
        margin-top: 20px;
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .conversation-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #667eea;
        color: white;
      }

      .conversation-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .conversation-btn.secondary {
        background: #6c757d;
      }

      .conversation-btn.secondary:hover {
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
      }

      .empathy-avatar.preview {
        animation: pulse 1s ease-in-out;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Puzzle Completion Styles */
      .puzzle-completion {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #4caf50;
      }

      .completion-stats {
        margin: 20px 0;
        display: grid;
        gap: 15px;
      }

      .stat-item {
        background: rgba(245, 245, 245, 0.8);
        padding: 15px;
        border-radius: 10px;
        text-align: left;
      }

      .stat-bar {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        margin-top: 8px;
        overflow: hidden;
      }

      .stat-fill {
        height: 100%;
        transition: width 1s ease;
        border-radius: 4px;
      }

      .felisbina-final-message {
        margin: 25px 0;
      }

      .felisbina-message {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        border-radius: 12px;
        text-align: left;
      }

      .felisbina-message .avatar {
        font-size: 24px;
        min-width: 40px;
      }

      .felisbina-message .message {
        font-style: italic;
        line-height: 1.5;
      }

      .felisbina-message.excellent {
        background: rgba(76, 175, 80, 0.1);
        border-left: 4px solid #4caf50;
      }

      .felisbina-message.good {
        background: rgba(33, 150, 243, 0.1);
        border-left: 4px solid #2196f3;
      }

      .felisbina-message.adequate {
        background: rgba(255, 152, 0, 0.1);
        border-left: 4px solid #ff9800;
      }

      .felisbina-message.poor {
        background: rgba(244, 67, 54, 0.1);
        border-left: 4px solid #f44336;
      }

      /* Evidence Investigation Styles */
      .investigation-scene {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
      }

      .investigation-header {
        text-align: center;
        margin-bottom: 25px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        border-left: 5px solid #ff9800;
      }

      .evidence-metrics {
        background: rgba(255, 243, 224, 0.9);
        border-left: 4px solid #ff9800;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .evidence-examination-area {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-bottom: 30px;
      }

      .evidence-gallery,
      .magnifier-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .evidence-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 15px;
      }

      .evidence-item {
        background: #ffffff;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .evidence-item:hover {
        border-color: #ff9800;
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 152, 0, 0.2);
      }

      .evidence-item.examined {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.05);
      }

      .evidence-item.selected {
        border-color: #2196f3;
        background: rgba(33, 150, 243, 0.1);
        transform: translateY(-3px);
        box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
        animation: pulse-blue 1.5s infinite;
      }

      @keyframes pulse-blue {
        0% {
          box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
        }
        50% {
          box-shadow: 0 0 25px rgba(33, 150, 243, 0.8);
        }
        100% {
          box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
        }
      }

      /* Investigation Instructions */
      .investigation-instructions {
        background: rgba(33, 150, 243, 0.1);
        border: 2px solid rgba(33, 150, 243, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
      }

      .instruction-step {
        margin: 8px 0;
        font-size: 14px;
        color: #1976d2;
      }

      /* Connection Status */
      .connection-status {
        background: rgba(255, 193, 7, 0.1);
        border: 2px solid rgba(255, 193, 7, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        text-align: center;
      }

      .status-text {
        font-weight: bold;
        color: #f57c00;
        margin-bottom: 10px;
      }

      .selected-items {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .selected-item {
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        color: white;
        padding: 8px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        animation: pulse-blue 2s infinite;
      }

      /* Mobile Helper */
      .mobile-helper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: none;
        justify-content: center;
        align-items: center;
      }

      .mobile-helper.show {
        display: flex;
      }

      .helper-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 400px;
        text-align: center;
        margin: 20px;
      }

      .helper-content h4 {
        color: #2196f3;
        margin-bottom: 15px;
      }

      .helper-content p {
        margin: 10px 0;
        color: #333;
      }

      .evidence-item.categorized {
        opacity: 0.7;
        pointer-events: none;
      }

      .evidence-icon {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .evidence-title {
        font-size: 12px;
        font-weight: bold;
        color: #333;
        line-height: 1.2;
      }

      .evidence-type-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 8px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: bold;
      }

      .evidence-points {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: #ff9800;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 8px;
        font-weight: bold;
      }

      .magnifier-content {
        min-height: 200px;
        padding: 15px;
        background: rgba(245, 245, 245, 0.8);
        border-radius: 8px;
        border: 2px dashed #ccc;
      }

      .magnifier-instruction {
        text-align: center;
        color: #666;
        font-style: italic;
        margin: 0;
        padding: 60px 20px;
      }

      .evidence-analysis {
        background: white;
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid #2196f3;
      }

      .analysis-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }

      .analysis-icon {
        font-size: 20px;
      }

      .analysis-title {
        font-weight: bold;
        color: #333;
      }

      .analysis-text {
        color: #555;
        line-height: 1.5;
        margin-bottom: 10px;
      }

      .analysis-category {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: bold;
        margin-bottom: 8px;
      }

      .analysis-category.risk {
        background: rgba(244, 67, 54, 0.1);
        color: #d32f2f;
        border: 1px solid #f44336;
      }

      .analysis-category.protection {
        background: rgba(76, 175, 80, 0.1);
        color: #2e7d32;
        border: 1px solid #4caf50;
      }

      .evidence-board-area {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-bottom: 30px;
      }

      .board-column {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .risk-column h4 {
        color: #d32f2f;
        text-align: center;
      }

      .protection-column h4 {
        color: #2e7d32;
        text-align: center;
      }

      .evidence-drop-zone {
        min-height: 250px;
        border: 3px dashed #ccc;
        border-radius: 12px;
        background: rgba(250, 250, 250, 0.8);
        transition: all 0.3s ease;
        position: relative;
      }

      .evidence-drop-zone:hover {
        border-color: #ff9800;
        background: rgba(255, 152, 0, 0.05);
      }

      .evidence-drop-zone.drag-over {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
        transform: scale(1.02);
      }

      .zone-header {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .zone-icon {
        font-size: 24px;
        display: block;
        margin-bottom: 8px;
      }

      .zone-text {
        font-size: 14px;
        font-style: italic;
      }

      .evidence-slots {
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
      }

      .evidence-slot {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        position: relative;
      }

      .evidence-slot.correct {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .evidence-slot.incorrect {
        border-color: #f44336;
        background: rgba(244, 67, 54, 0.1);
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      .connection-system {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #9c27b0;
      }

      .connection-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 15px;
      }

      .connection-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background: #9c27b0;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .connection-btn:hover {
        background: #7b1fa2;
        transform: translateY(-2px);
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .evidence-examination-area,
        .evidence-board-area {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .evidence-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .evidence-item {
          min-height: 120px;
          padding: 12px;
          font-size: 14px;
        }

        .evidence-item.selected {
          border-width: 4px;
          box-shadow: 0 0 25px rgba(33, 150, 243, 0.7);
        }

        .instruction-step {
          font-size: 16px;
          margin: 12px 0;
        }

        .connection-status {
          padding: 20px;
        }

        .status-text {
          font-size: 16px;
        }

        .evidence-icon {
          font-size: 20px;
        }

        .evidence-title {
          font-size: 11px;
        }
      }
      .drag-item {
        background: rgba(255, 243, 224, 0.9);
        backdrop-filter: blur(5px);
        border: 2px solid #ff9800;
        padding: 15px;
        margin: 10px;
        border-radius: 12px;
        cursor: move;
        user-select: none;
        transition: all 0.3s ease;
        display: inline-block;
        min-width: 120px;
        text-align: center;
        font-weight: 500;
        position: relative;
        touch-action: manipulation;
      }
      .drag-item:hover {
        background: rgba(255, 224, 178, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
      }
      .drag-item:active {
        transform: scale(0.98);
      }
      .drag-item.selected {
        background: rgba(102, 126, 234, 0.9);
        border-color: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      .drag-item.placed {
        opacity: 0.6;
        background: rgba(200, 200, 200, 0.8);
        border-color: #ccc;
        cursor: not-allowed;
        transform: none;
        pointer-events: none;
      }
      .drop-zone {
        min-height: 120px;
        border: 3px dashed rgba(204, 204, 204, 0.7);
        padding: 20px;
        margin: 15px 0;
        border-radius: 15px;
        background: rgba(249, 249, 249, 0.8);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        position: relative;
        touch-action: manipulation;
      }
      .drop-zone.drag-over,
      .drop-zone.active {
        border-color: #667eea;
        background: rgba(227, 242, 253, 0.9);
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }
      .drop-zone.correct {
        border-color: #4caf50;
        background: rgba(232, 245, 233, 0.9);
        border-style: solid;
      }
      .drop-zone.incorrect {
        border-color: #f44336;
        background: rgba(255, 235, 238, 0.9);
        border-style: solid;
        animation: shake 0.5s ease-in-out;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }
      .mobile-instructions {
        background: rgba(227, 242, 253, 0.9);
        backdrop-filter: blur(5px);
        padding: 15px;
        border-radius: 12px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
        display: none;
      }
      .mobile-mode-button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        margin: 10px 0;
        transition: all 0.3s ease;
      }
      .mobile-mode-button:hover {
        background: #1976d2;
        transform: translateY(-1px);
      }
      .metrics {
        background: rgba(240, 240, 240, 0.8);
        backdrop-filter: blur(5px);
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        border-left: 4px solid #667eea;
        font-weight: 600;
      }
      .analysis-container {
        display: flex;
        gap: 30px;
        margin: 30px 0;
      }
      .analysis-column {
        flex: 1;
        background: rgba(255, 255, 255, 0.6);
        padding: 25px;
        border-radius: 15px;
        backdrop-filter: blur(5px);
      }
      #elements-pool {
        background: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        backdrop-filter: blur(5px);
        border: 2px solid rgba(255, 255, 255, 0.3);
      }
      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
        }
        .container {
          padding: 25px;
          margin-bottom: 15px;
        }
        .back-button {
          position: static;
          display: block;
          margin-bottom: 15px;
          text-align: center;
        }
        .score {
          position: static;
          display: block;
          text-align: center;
          margin-bottom: 15px;
        }
        .dialogue-option {
          padding: 15px;
          font-size: 14px;
        }

        /* Mobile Conversation Cards */
        .conversation-area {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .conversation-card {
          padding: 12px;
        }

        .card-text {
          font-size: 13px;
        }

        .conversation-drop-zone {
          min-height: 150px;
        }

        .conversation-controls {
          flex-direction: column;
          gap: 10px;
        }

        .conversation-btn {
          width: 100%;
          padding: 15px;
        }

        .drag-item {
          min-width: 100px;
          padding: 12px;
          margin: 5px;
          font-size: 14px;
        }
        .drop-zone {
          min-height: 100px;
          padding: 15px;
        }
        .analysis-container {
          flex-direction: column;
          gap: 20px;
        }
        .mobile-instructions {
          display: block;
        }
        /* Make drag container scrollable on small screens */
        #elements-pool {
          max-height: 200px;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }
        /* Stack drop zones vertically on mobile */
        .analysis-container {
          flex-direction: column;
        }
        .timer-container {
          position: static;
          margin-bottom: 15px;
          text-align: center;
        }
        .timer-bar {
          width: 100%;
        }
      }
      /* Tablet adjustments */
      @media (max-width: 1024px) and (min-width: 769px) {
        .main-container {
          padding: 15px;
        }
        .container {
          padding: 30px;
        }
        .back-button,
        .score {
          position: fixed;
          top: 15px;
        }
        .back-button {
          left: 15px;
        }
        .score {
          right: 0;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          padding: 10px;
          z-index: 1001;
        }
        .dialogue-option {
          padding: 18px;
        }
        .drag-item {
          padding: 12px;
        }
        .drag-item {
          width: calc(50% - 10px);
          margin: 5px;
        }
        .drop-zone {
          min-height: 110px;
          padding: 18px;
        }
      }
      /* Pulse animation for newly unlocked objects */
      @keyframes pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(76, 175, 80, 0.3);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 20px rgba(76, 175, 80, 0);
        }
      }

      /* Touch-friendly improvements */
      @media (hover: none) and (pointer: coarse) {
        .drag-item {
          min-height: 60px;
          padding: 15px;
        }
        .dialogue-option {
          min-height: 60px;
          padding: 18px;
        }
        .drop-zone {
          min-height: 140px;
          padding: 25px;
        }
        .btn {
          min-height: 50px;
          padding: 15px 25px;
        }
      }

      /* ESCAPE ROOM SPECIFIC STYLES */
      .office-object {
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .office-object:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }

      .office-object:active {
        transform: translateY(-2px);
      }

      .clue-indicator.hidden {
        display: none !important;
      }

      .meeting-door {
        transition: all 0.5s ease;
      }

      .office-grid {
        position: relative;
      }

      @media (max-width: 768px) {
        .office-reception {
          padding: 20px !important;
          min-height: auto !important;
        }

        .office-grid {
          grid-template-columns: 1fr 1fr !important; /* Force 2 columns on mobile */
          gap: 15px !important;
          height: auto !important;
        }

        .office-object {
          padding: 15px;
          min-height: 120px; /* Equal height for all objects */
          aspect-ratio: 1; /* Square aspect ratio for consistency */
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          font-size: 14px;
        }

        .office-object div:first-child {
          font-size: 32px !important;
          margin-bottom: 8px;
        }

        .office-object div:last-child {
          font-size: 13px !important;
          font-weight: bold;
          line-height: 1.2;
        }

        .meeting-door {
          position: static !important;
          margin: 20px auto 0 auto;
          text-align: center;
          width: 200px;
        }
      }

      @media (max-width: 480px) {
        .office-reception {
          padding: 15px !important;
        }

        .office-grid {
          grid-template-columns: 1fr 1fr !important; /* Force 2 columns on mobile */
          gap: 12px !important;
          height: auto !important;
        }

        .office-object {
          padding: 12px;
          min-height: 100px; /* Slightly smaller but still equal */
          aspect-ratio: 1; /* Keep square shape */
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          font-size: 14px;
        }

        .office-object div:first-child {
          font-size: 28px !important;
          margin-bottom: 6px;
        }

        .office-object div:last-child {
          font-size: 12px !important;
          font-weight: bold;
          line-height: 1.2;
        }

        /* Mobile toast positioning */
        .toast-container {
          top: 10px !important;
          right: 10px !important;
          left: 10px !important;
          max-width: none !important;
        }

        .toast {
          font-size: 14px;
          padding: 12px 16px !important;
          margin-bottom: 8px;
        }

        .meeting-door {
          position: static !important;
          margin: 15px auto;
          width: 180px;
          padding: 12px;
        }

        .meeting-door div:first-child {
          font-size: 24px !important;
        }
      }

      /* ========================================
         ASSESSMENT TERMINAL STYLES
      ======================================== */

      .terminal-container {
        background: #1e1e1e;
        color: #00ff00;
        font-family: "Courier New", monospace;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        margin: 20px 0;
        overflow: hidden;
        border: 2px solid #333;
      }

      .terminal-header {
        background: #333;
        color: #fff;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #555;
      }

      .terminal-controls {
        display: flex;
        gap: 8px;
      }

      .terminal-button {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .terminal-close {
        background: #ff5f56;
      }
      .terminal-minimize {
        background: #ffbd2e;
      }
      .terminal-maximize {
        background: #27ca3f;
      }

      .terminal-title {
        font-weight: bold;
        color: #00ff00;
        font-size: 14px;
      }

      .terminal-user {
        font-size: 12px;
        color: #aaa;
      }

      .terminal-body {
        padding: 20px;
        min-height: 500px;
        position: relative;
      }

      .terminal-screen {
        display: none;
        animation: fadeIn 0.3s ease-in;
      }

      .terminal-screen.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .screen-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #444;
      }

      .screen-header h3 {
        color: #00ff00;
        margin: 0;
        font-size: 18px;
      }

      .system-status,
      .progress-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #aaa;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ff0000;
      }

      .status-indicator.online {
        background: #00ff00;
        box-shadow: 0 0 5px #00ff00;
      }

      .criteria-dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .criteria-section,
      .profile-summary {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #444;
      }

      .criteria-section h4,
      .profile-summary h4 {
        color: #00ff00;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .profile-card {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .profile-field {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #444;
      }

      .profile-field:last-child {
        border-bottom: none;
      }

      .profile-field label {
        color: #aaa;
        font-weight: bold;
      }

      .profile-value {
        color: #00ff00;
      }

      .balance-scale-container,
      .capacity-assessment {
        margin: 20px 0;
      }

      .decision-section h4 {
        color: #00ff00;
        margin-bottom: 15px;
      }

      .scale-display {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 20px;
        align-items: center;
        margin: 20px 0;
        padding: 20px;
        background: #2a2a2a;
        border-radius: 8px;
        border: 1px solid #444;
      }

      .scale-left,
      .scale-right {
        text-align: center;
      }

      .scale-left h5,
      .scale-right h5 {
        color: #ffbd2e;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .factor-list {
        min-height: 80px;
        background: #1e1e1e;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 10px;
        font-size: 12px;
      }

      .scale-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }

      .balance-fulcrum {
        width: 20px;
        height: 20px;
        background: #ffbd2e;
        transform: rotate(45deg);
        margin-bottom: 10px;
      }

      .balance-beam {
        width: 100px;
        height: 4px;
        background: #666;
        border-radius: 2px;
        position: relative;
        transition: transform 0.3s ease;
      }

      .balance-beam.tilt-left {
        transform: rotate(-5deg);
      }

      .balance-beam.tilt-right {
        transform: rotate(5deg);
      }

      .option-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
      }

      .assessment-option {
        background: #2a2a2a;
        border: 2px solid #444;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .assessment-option:hover {
        border-color: #00ff00;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
      }

      .assessment-option.selected {
        border-color: #00ff00;
        background: #1a3d1a;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
      }

      .option-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .option-code {
        background: #444;
        color: #00ff00;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .option-weight {
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 3px;
      }

      .weight-high {
        background: #1a5d1a;
        color: #00ff00;
      }

      .weight-medium {
        background: #5d5d1a;
        color: #ffff00;
      }

      .weight-low {
        background: #5d1a1a;
        color: #ff6666;
      }

      .option-title {
        color: #00ff00;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 16px;
      }

      .option-description {
        color: #ccc;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .option-justification {
        color: #aaa;
        font-size: 13px;
        font-style: italic;
        border-top: 1px solid #444;
        padding-top: 8px;
      }

      .validation-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .decision-summary,
      .logic-validation,
      .code-generation,
      .assessment-report {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #444;
      }

      .decision-summary h4,
      .logic-validation h4,
      .code-generation h4,
      .assessment-report h4 {
        color: #00ff00;
        margin-top: 0;
        margin-bottom: 15px;
      }

      .decision-display {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .decision-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #444;
      }

      .decision-item:last-child {
        border-bottom: none;
      }

      .decision-item label {
        color: #aaa;
        font-weight: bold;
      }

      .decision-code {
        background: #444;
        color: #00ff00;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-left: 10px;
      }

      .validation-display,
      .report-display {
        background: #1e1e1e;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 15px;
        min-height: 100px;
        font-family: "Courier New", monospace;
      }

      .code-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .code-label {
        color: #aaa;
        font-size: 14px;
      }

      .code-value {
        background: #1e1e1e;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 15px;
        font-family: "Courier New", monospace;
        color: #00ff00;
        font-size: 16px;
        font-weight: bold;
        letter-spacing: 2px;
        text-align: center;
      }

      .copy-code-btn {
        background: #444;
        color: #00ff00;
        border: 1px solid #666;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        align-self: flex-start;
        transition: all 0.3s ease;
      }

      .copy-code-btn:hover {
        background: #555;
        box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
      }

      .screen-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #444;
      }

      .terminal-btn {
        background: #444;
        color: #00ff00;
        border: 2px solid #666;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-family: "Courier New", monospace;
        font-weight: bold;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .terminal-btn:hover {
        background: #555;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
      }

      .terminal-btn.primary {
        background: #1a5d1a;
        border-color: #00ff00;
      }

      .terminal-btn.primary:hover {
        background: #2d7d2d;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
      }

      .terminal-btn.secondary {
        background: #5d5d1a;
        border-color: #ffbd2e;
        color: #ffbd2e;
      }

      .terminal-btn.secondary:hover {
        background: #7d7d2d;
        box-shadow: 0 0 10px rgba(255, 189, 46, 0.3);
      }

      .terminal-btn.success {
        background: #1a5d1a;
        border-color: #27ca3f;
        color: #27ca3f;
      }

      .terminal-btn.success:hover {
        background: #2d7d2d;
        box-shadow: 0 0 15px rgba(39, 202, 63, 0.5);
      }

      .terminal-footer {
        background: #333;
        color: #aaa;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #555;
        font-size: 12px;
      }

      /* Mobile Responsiveness for Terminal */
      @media (max-width: 768px) {
        .criteria-dashboard {
          grid-template-columns: 1fr;
        }

        .scale-display {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .screen-navigation {
          flex-direction: column;
          gap: 10px;
        }

        .terminal-btn {
          width: 100%;
          text-align: center;
        }

        .option-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }

        .terminal-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
      }

      /* ========================================
         CARD GAME CONVERSATION INTERFACE
      ======================================== */

      .conversation-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
        padding: 15px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .metric-card {
        background: white;
        padding: 15px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .metric-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.05);
      }

      .empathy-metric .metric-icon {
        background: rgba(255, 99, 132, 0.1);
      }
      .information-metric .metric-icon {
        background: rgba(54, 162, 235, 0.1);
      }
      .interaction-metric .metric-icon {
        background: rgba(255, 206, 86, 0.1);
      }

      .metric-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .metric-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
      }

      .metric-value {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .metric-bar {
        width: 100%;
        height: 6px;
        background: #eee;
        border-radius: 3px;
        overflow: hidden;
      }

      .metric-progress {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        border-radius: 3px;
        transition: width 0.5s ease;
        width: 0%;
      }

      .empathy-metric .metric-progress {
        background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      }
      .information-metric .metric-progress {
        background: linear-gradient(90deg, #4ecdc4, #44a08d);
      }
      .interaction-metric .metric-progress {
        background: linear-gradient(90deg, #ffe066, #ff9a9e);
      }

      .card-game-board {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 25px;
        min-height: 600px;
      }

      /* Felisbina Section */
      .felisbina-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .felisbina-avatar-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .felisbina-avatar-container .empathy-avatar {
        font-size: 60px;
        margin-bottom: 15px;
        background: rgba(255, 255, 255, 0.2);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        transition: all 0.3s ease;
      }

      .avatar-status h3 {
        margin: 0 0 8px 0;
        font-size: 18px;
      }

      .avatar-status p {
        margin: 0 0 12px 0;
        opacity: 0.9;
        font-size: 14px;
      }

      .conversation-progress {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
      }

      .conversation-memory {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .conversation-memory h4 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 16px;
      }

      .memory-slots {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 200px;
      }

      .memory-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        text-align: center;
        animation: slideInMemory 0.5s ease;
      }

      @keyframes slideInMemory {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Card Game Area */
      .card-game-area {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .topic-deck-area {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .topic-deck-area h4 {
        margin: 0 0 15px 0;
        color: #333;
      }

      .topic-deck {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .topic-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        cursor: grab;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        position: relative;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .topic-card:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .topic-card:active {
        cursor: grabbing;
      }

      .topic-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
      }

      .topic-card.used {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
        transform: none !important;
      }

      .topic-card.locked {
        background: linear-gradient(135deg, #6c7b7f 0%, #4a5568 100%);
        color: #a0aec0;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .topic-card.locked:hover {
        transform: none;
        box-shadow: none;
      }

      .topic-card.available {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        animation: pulse 2s infinite;
        box-shadow: 0 0 15px rgba(72, 187, 120, 0.5);
      }

      .topic-card.in-progress {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        border: 2px solid #ff8c00;
        animation: pulse-orange 1.5s infinite;
        box-shadow: 0 0 15px rgba(255, 165, 0, 0.4);
      }

      @keyframes pulse-orange {
        0% {
          transform: scale(1);
          box-shadow: 0 0 15px rgba(255, 165, 0, 0.4);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 20px rgba(255, 165, 0, 0.6);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 15px rgba(255, 165, 0, 0.4);
        }
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 15px rgba(72, 187, 120, 0.5);
        }
        50% {
          box-shadow: 0 0 25px rgba(72, 187, 120, 0.8);
        }
        100% {
          box-shadow: 0 0 15px rgba(72, 187, 120, 0.5);
        }
      }

      .topic-card-status {
        position: absolute;
        top: -5px;
        right: -5px;
        background: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .topic-card {
        position: relative;
      }

      .topic-card-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .topic-card-subtitle {
        font-size: 11px;
        opacity: 0.8;
      }

      .deck-info {
        text-align: center;
        color: #666;
        font-size: 14px;
        font-weight: 500;
      }

      .topic-drop-zone {
        background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);
        border: 3px dashed #17a2b8;
        border-radius: 12px;
        padding: 20px;
        margin-top: 15px;
        text-align: center;
        transition: all 0.3s ease;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .topic-drop-zone.drag-over {
        border-color: #28a745;
        background: linear-gradient(135deg, #e8f5e9 0%, #d4f1d4 100%);
        transform: scale(1.02);
      }

      .topic-drop-zone .drop-zone-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .topic-drop-zone .drop-zone-icon {
        font-size: 24px;
        opacity: 0.7;
      }

      .topic-drop-zone .drop-zone-text {
        font-size: 14px;
        color: #666;
        font-weight: 500;
      }

      .active-conversation-area {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-height: 400px;
      }

      .conversation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .conversation-header h4 {
        margin: 0;
        color: #333;
        font-size: 18px;
      }

      .conversation-timer {
        background: #ff6b6b;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .response-cards-area {
        min-height: 200px;
        margin-bottom: 20px;
        position: relative;
      }

      .cards-instruction {
        text-align: center;
        color: #999;
        font-style: italic;
        padding: 50px 20px;
        border: 2px dashed #ddd;
        border-radius: 10px;
        background: #fafafa;
      }

      .response-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .response-card {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        color: #333;
        padding: 20px;
        border-radius: 12px;
        cursor: grab;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        position: relative;
        border: 2px solid transparent;
      }

      .response-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        border-color: #4caf50;
      }

      .response-card:active {
        cursor: grabbing;
      }

      .response-card.dragging {
        opacity: 0.7;
        transform: rotate(-2deg) scale(1.05);
        z-index: 1000;
      }

      .response-card.selected {
        border: 3px solid #4caf50;
        background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%);
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
      }

      .response-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .response-quality-badge {
        background: #4caf50;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .response-quality-badge.excellent {
        background: #4caf50;
      }
      .response-quality-badge.good {
        background: #ff9800;
      }
      .response-quality-badge.adequate {
        background: #2196f3;
      }
      .response-quality-badge.poor {
        background: #f44336;
      }

      .response-card-content {
        font-size: 14px;
        line-height: 1.4;
        margin-bottom: 10px;
      }

      .response-card-stats {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        opacity: 0.8;
      }

      .response-drop-zone {
        background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        border: 3px dashed #e17055;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .response-drop-zone.drag-over {
        background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        border-color: #00b894;
        transform: scale(1.02);
        box-shadow: 0 5px 20px rgba(0, 184, 148, 0.3);
      }

      .drop-zone-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .drop-zone-icon {
        font-size: 30px;
        opacity: 0.7;
      }

      .drop-zone-text {
        font-weight: bold;
        color: #e17055;
        font-size: 16px;
      }

      .response-drop-zone.drag-over .drop-zone-text {
        color: white;
      }

      .response-drop-zone.has-preview {
        background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%);
        border-color: #4caf50;
        border-style: solid;
      }

      .response-drop-zone.has-preview .drop-zone-text {
        color: #2e7d32;
        font-weight: bold;
      }

      .feedback-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        margin-top: 20px;
        animation: slideInFeedback 0.5s ease;
      }

      @keyframes slideInFeedback {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .feedback-content {
        margin-bottom: 20px;
      }

      .response-quality {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .empathy-gain,
      .information-gain {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .continue-btn {
        background: white;
        color: #667eea;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .continue-btn:hover {
        background: #f0f0f0;
        transform: translateY(-2px);
      }

      .conversation-complete {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: bold;
        margin-top: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .conversation-complete:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .conversation-metrics {
          grid-template-columns: 1fr;
        }

        .card-game-board {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .felisbina-section {
          order: 2;
        }

        .card-game-area {
          order: 1;
        }

        .topic-deck {
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }

        .response-cards-grid {
          grid-template-columns: 1fr;
        }

        .topic-card,
        .response-card {
          touch-action: manipulation;
        }
      }

      /* Drag and Drop Visual Effects */
      .card-dragging {
        pointer-events: none;
      }

      .drop-zone-active {
        animation: pulseDropZone 1s infinite;
      }

      @keyframes pulseDropZone {
        0%,
        100% {
          border-color: #e17055;
        }
        50% {
          border-color: #00b894;
        }
      }

      /* ========================================
         ENHANCED CONNECTION SYSTEM STYLES
      ======================================== */

      .connection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
      }

      .connection-header h4 {
        margin: 0;
        color: #9c27b0;
        font-size: 18px;
      }

      .connection-stats {
        display: flex;
        gap: 15px;
        font-size: 14px;
      }

      .connection-count {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
      }

      .connection-score {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
      }

      .connection-instructions {
        background: rgba(156, 39, 176, 0.1);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        border-left: 4px solid #9c27b0;
      }

      .connection-canvas-container {
        position: relative;
        background: #f8f9fa;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        min-height: 200px;
      }

      .connection-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
      }

      .canvas-overlay {
        position: relative;
        z-index: 2;
        height: 100%;
      }

      .connection-legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 5px;
        margin-bottom: 10px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
      }

      .legend-line {
        width: 20px;
        height: 3px;
        border-radius: 2px;
      }

      .legend-line.valid {
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
      }

      .legend-line.attempted {
        background: linear-gradient(90deg, #ff9800, #ffb74d);
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .connection-progress {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .connection-progress h5 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 16px;
      }

      .discovered-connections {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: 80px;
      }

      .connection-discovery {
        background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
        border: 2px solid #4caf50;
        border-radius: 8px;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideInConnection 0.5s ease;
      }

      @keyframes slideInConnection {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .connection-discovery-text {
        font-weight: bold;
        color: #2e7d2e;
      }

      .connection-discovery-points {
        background: #4caf50;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .connection-controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .connection-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: none;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .connection-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
      }

      .connection-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .connection-btn.secondary {
        background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(255, 152, 0, 0.3);
      }

      .connection-btn.secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
      }

      .connection-btn.danger {
        background: linear-gradient(135deg, #f44336 0%, #e57373 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
      }

      .connection-btn.danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
      }

      .connection-insights {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        animation: slideInInsights 0.5s ease;
      }

      @keyframes slideInInsights {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .connection-insights h5 {
        margin: 0 0 15px 0;
        font-size: 16px;
      }

      .insights-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .insight-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 12px;
        border-radius: 6px;
        border-left: 4px solid rgba(255, 255, 255, 0.3);
      }

      .insight-title {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 14px;
      }

      .insight-description {
        font-size: 13px;
        opacity: 0.9;
        line-height: 1.4;
      }

      /* Evidence Selection Enhancement */
      .evidence-slot.selected {
        border: 3px solid #9c27b0;
        box-shadow: 0 0 15px rgba(156, 39, 176, 0.5);
        transform: scale(1.05);
        z-index: 10;
      }

      .evidence-slot.connected {
        border: 3px solid #4caf50;
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
      }

      .evidence-slot.connection-candidate {
        border: 3px solid #ff9800;
        box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        animation: connectionPulse 1s infinite;
      }

      @keyframes connectionPulse {
        0%,
        100% {
          box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        }
        50% {
          box-shadow: 0 0 25px rgba(255, 152, 0, 0.8);
        }
      }

      /* Mobile Responsiveness for Connections */
      @media (max-width: 768px) {
        .connection-stats {
          flex-direction: column;
          gap: 8px;
        }

        .connection-controls {
          flex-direction: column;
          align-items: center;
        }

        .connection-btn {
          width: 200px;
          justify-content: center;
        }

        .connection-legend {
          flex-direction: column;
          gap: 10px;
          align-items: center;
        }

        .connection-canvas-container {
          min-height: 150px;
        }
      }

      /* ========================================
         DOCUMENT SCANNER MINI-GAME STYLES
      ======================================== */

      .scanner-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
        padding: 15px;
        background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #17a2b8;
      }

      .metric-item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .metric-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .metric-item .metric-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(23, 162, 184, 0.1);
      }

      .metric-data {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .metric-data .metric-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
      }

      .metric-data .metric-value {
        font-size: 16px;
        font-weight: bold;
        color: #333;
      }

      .scanner-metric .metric-icon {
        background: rgba(23, 162, 184, 0.1);
      }
      .accuracy-metric .metric-icon {
        background: rgba(40, 167, 69, 0.1);
      }
      .speed-metric .metric-icon {
        background: rgba(255, 193, 7, 0.1);
      }
      .security-metric .metric-icon {
        background: rgba(220, 53, 69, 0.1);
      }

      .scanner-workstation {
        display: grid;
        grid-template-columns: 300px 1fr 350px;
        gap: 20px;
        min-height: 600px;
        margin-bottom: 25px;
      }

      /* Document Queue Section */
      .document-queue-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #6f42c1;
      }

      .document-queue-section h3 {
        margin: 0 0 15px 0;
        color: #6f42c1;
        font-size: 18px;
      }

      .queue-instructions {
        background: rgba(111, 66, 193, 0.1);
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 15px;
        text-align: center;
        border: 1px solid rgba(111, 66, 193, 0.2);
      }

      .document-queue {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
        min-height: 400px;
      }

      .document-item {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px;
        border-radius: 8px;
        cursor: grab;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        border: 2px solid transparent;
      }

      .document-item:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        border-color: #ffc107;
      }

      .document-item:active {
        cursor: grabbing;
      }

      .document-item.dragging {
        opacity: 0.7;
        transform: rotate(-3deg) scale(1.05);
        z-index: 1000;
      }

      .document-item.processed {
        background: #6c757d;
        cursor: not-allowed;
        transform: none !important;
      }

      .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      .document-type {
        font-weight: bold;
        font-size: 14px;
      }

      .document-priority {
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
      }

      .document-priority.high {
        background: #dc3545;
      }
      .document-priority.medium {
        background: #ffc107;
        color: #333;
      }
      .document-priority.low {
        background: #28a745;
      }

      .document-description {
        font-size: 12px;
        opacity: 0.9;
        line-height: 1.3;
      }

      .queue-stats {
        text-align: center;
        font-size: 14px;
        color: #666;
        font-weight: 500;
      }

      /* Scanner Interface */
      .scanner-interface {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #17a2b8;
      }

      .scanner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .scanner-header h3 {
        margin: 0;
        color: #17a2b8;
        font-size: 18px;
      }

      .scanner-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .status-light {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: statusPulse 2s infinite;
      }

      .status-light.standby {
        background: #ffc107;
      }
      .status-light.active {
        background: #28a745;
      }
      .status-light.error {
        background: #dc3545;
      }

      @keyframes statusPulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .scanner-bed {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 3px dashed #adb5bd;
        border-radius: 12px;
        padding: 40px 20px;
        margin-bottom: 20px;
        min-height: 200px;
        position: relative;
        transition: all 0.3s ease;
      }

      .scanner-bed.document-loaded {
        border-color: #17a2b8;
        background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);
      }

      .scanner-bed.scanning {
        border-color: #28a745;
        background: linear-gradient(135deg, #e8f5e9 0%, #d4f1d4 100%);
      }

      .scanner-bed-content {
        position: relative;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .scanner-placeholder {
        text-align: center;
        color: #6c757d;
      }

      .placeholder-icon {
        font-size: 48px;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      .placeholder-text {
        font-size: 14px;
        font-style: italic;
      }

      .scanning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(40, 167, 69, 0.1);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 20px;
      }

      .scanning-laser {
        width: 80%;
        height: 4px;
        background: linear-gradient(90deg, transparent, #28a745, transparent);
        animation: scanningBeam 2s linear infinite;
        box-shadow: 0 0 10px #28a745;
      }

      @keyframes scanningBeam {
        0% {
          transform: translateY(-50px);
          opacity: 0;
        }
        20% {
          opacity: 1;
        }
        80% {
          opacity: 1;
        }
        100% {
          transform: translateY(150px);
          opacity: 0;
        }
      }

      .scanning-progress {
        width: 80%;
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        overflow: hidden;
      }

      .scanning-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        border-radius: 4px;
        width: 0%;
        transition: width 0.1s linear;
      }

      .scanner-controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .scanner-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 140px;
        justify-content: center;
      }

      .scanner-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }

      .scanner-btn.start-scan {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
      }

      .scanner-btn.start-scan:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
      }

      .scanner-btn.cancel-scan {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
      }

      .scanner-btn.cancel-scan:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
      }

      .scanner-btn.validate-doc {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);
      }

      .scanner-btn.validate-doc:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
      }

      .scan-timer {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 15px;
      }

      .timer-circle {
        width: 60px;
        height: 60px;
        border: 4px solid #e9ecef;
        border-top: 4px solid #17a2b8;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: timerSpin 1s linear infinite;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      @keyframes timerSpin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .timer-circle span {
        font-weight: bold;
        color: #17a2b8;
        font-size: 14px;
      }

      /* Processing Results */
      .processing-results {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #fd7e14;
      }

      .processing-results h3 {
        margin: 0 0 15px 0;
        color: #fd7e14;
        font-size: 18px;
      }

      .results-display {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        min-height: 150px;
      }

      .results-placeholder {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 40px 20px;
      }

      .scan-result {
        background: white;
        border: 2px solid #28a745;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        animation: slideInResult 0.5s ease;
      }

      @keyframes slideInResult {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .result-title {
        font-weight: bold;
        color: #28a745;
      }

      .result-time {
        font-size: 12px;
        color: #6c757d;
      }

      .result-content {
        font-size: 14px;
        line-height: 1.4;
      }

      .validation-panel {
        background: linear-gradient(135deg, #6f42c1 0%, #563d7c 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-top: 15px;
        animation: slideInValidation 0.5s ease;
      }

      @keyframes slideInValidation {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .validation-panel h4 {
        margin: 0 0 15px 0;
        font-size: 16px;
      }

      .validation-checks {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }

      .validation-check {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .validation-check.passed {
        border-left: 4px solid #28a745;
      }

      .validation-check.failed {
        border-left: 4px solid #dc3545;
      }

      .validation-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .validation-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .validation-btn.approve {
        background: #28a745;
        color: white;
      }

      .validation-btn.approve:hover {
        background: #218838;
        transform: translateY(-2px);
      }

      .validation-btn.reject {
        background: #dc3545;
        color: white;
      }

      .validation-btn.reject:hover {
        background: #c82333;
        transform: translateY(-2px);
      }

      /* Achievements */
      .scanning-achievements {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        animation: slideInAchievements 0.5s ease;
      }

      @keyframes slideInAchievements {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .scanning-achievements h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
      }

      .achievement-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .achievement-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: achievementPop 0.6s ease;
      }

      @keyframes achievementPop {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .achievement-icon {
        font-size: 24px;
      }

      .achievement-text {
        flex: 1;
      }

      .achievement-title {
        font-weight: bold;
        margin-bottom: 3px;
      }

      .achievement-description {
        font-size: 12px;
        opacity: 0.9;
      }

      .scanner-complete {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 auto;
      }

      .scanner-complete:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
      }

      /* Mobile Responsiveness for Scanner */
      @media (max-width: 768px) {
        .scanner-metrics {
          grid-template-columns: 1fr;
        }

        .scanner-workstation {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .document-queue-section {
          order: 1;
        }

        .scanner-interface {
          order: 2;
        }

        .processing-results {
          order: 3;
        }

        .scanner-controls {
          flex-direction: column;
          align-items: center;
        }

        .scanner-btn {
          width: 200px;
        }

        .validation-actions {
          flex-direction: column;
          align-items: center;
        }

        .validation-btn {
          width: 150px;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- ESCAPE ROOM TIMER -->
    <div class="timer-container" id="timer-container">
      <div>🕐 TEMPO RESTANTE: <span id="timer-display">45:00</span></div>
      <div class="timer-bar">
        <div class="timer-progress" id="timer-progress"></div>
      </div>
    </div>

    <!-- PUZZLE COUNTER -->
    <div class="puzzle-counter" id="puzzle-counter">
      🧩 PUZZLE <span id="current-puzzle">1</span>/5
    </div>

    <a href="index.html" class="back-button">← Voltar ao Menu</a>
    <div class="score">Pontuação: <span id="score">0</span>/150</div>

    <div class="main-container">
      <div class="container">
        <div class="escape-room-header">
          <h1>🎮 ESCAPE ROOM SAASI - FASE 1</h1>
          <h2>🕵️ O MISTÉRIO DA FELISBINA</h2>
          <p>
            <strong>Missão:</strong> Descobrir a verdadeira situação da
            Felisbina e tomar a decisão correta sobre o seu acompanhamento em 45
            minutos!
          </p>
        </div>

        <div class="progress">
          <div class="progress-bar" id="progress"></div>
        </div>

        <!-- ESTADO 1: INICIO -->
        <div id="state-inicio" class="state active">
          <h1>🎯 Bem-vindo ao Escape Room SAASI!</h1>
          <h2>Acolhimento e Avaliação Inicial</h2>

          <div
            style="
              background: #f8f9fa;
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
            "
          >
            <h3>📋 Briefing da Missão:</h3>
            <p>
              <strong>Caso:</strong> Felisbina Santos, 56 anos, beneficiária de
              RSI
            </p>
            <p>
              <strong>Objetivo:</strong> Realizar avaliação completa e decidir
              sobre elegibilidade DLD
            </p>
            <p><strong>Tempo Limite:</strong> 45 minutos (tempo real)</p>
            <p>
              <strong>Desafio:</strong> Descobrir pistas ocultas e códigos
              secretos durante a investigação
            </p>
          </div>

          <div
            style="
              background: #fff3cd;
              padding: 15px;
              border-radius: 8px;
              margin: 20px 0;
            "
          >
            <h4>🎮 Novidades do Modo Escape Room:</h4>
            <ul>
              <li>
                ⏰ <strong>Timer em tempo real</strong> - 45 minutos para
                completar
              </li>
              <li>
                🔍 <strong>Pistas ocultas</strong> - Elementos secretos para
                descobrir
              </li>
              <li>
                🎯 <strong>Códigos especiais</strong> - Combinações corretas
                desbloqueiam bonus
              </li>
              <li>
                🏆 <strong>Pontuação aumentada</strong> - Até 150 pontos (100
                base + 50 bonus)
              </li>
              <li>
                👁️ <strong>Avatar reativo</strong> - Felisbina muda conforme
                suas ações
              </li>
            </ul>
          </div>

          <button class="btn" onclick="startEscapeRoom()">
            🚀 Iniciar Missão
          </button>
        </div>

        <!-- PUZZLE 1: RECEPTION DESK MYSTERY -->
        <div id="state-reception" class="state">
          <h1>🧩 PUZZLE 1: O MISTÉRIO DA RECEÇÃO</h1>
          <h2>🕵️ Investigate the SAASI Office Reception</h2>

          <div
            class="metrics"
            style="
              background: rgba(255, 243, 224, 0.9);
              border-left: 4px solid #ff9800;
            "
          >
            <strong>🔍 Pistas Descobertas:</strong>
            <span id="clues-found">0</span>/6 | <strong>⚡ Energia:</strong>
            <span id="energy-level">50</span>/100 |
            <strong>🎯 Progresso:</strong> <span id="puzzle1-progress">0</span>%
          </div>

          <div
            class="office-reception"
            style="
              background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
              padding: 30px;
              border-radius: 15px;
              margin: 20px 0;
              position: relative;
              min-height: 400px;
            "
          >
            <h3 style="text-align: center; margin-bottom: 20px">
              🏢 Receção do SAASI
            </h3>
            <p style="text-align: center; color: #666; margin-bottom: 30px">
              Clique nos objetos para investigar e descobrir pistas sobre o caso
              da Felisbina
            </p>

            <!-- Interactive Office Objects -->
            <div
              class="office-grid"
              style="
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
                height: 300px;
              "
            >
              <!-- Computer Screen -->
              <div
                class="office-object"
                id="computer-screen"
                onclick="investigateObject('computer')"
                style="
                  background: #34495e;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">🖥️</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Computador
                </div>
                <div
                  class="clue-indicator hidden"
                  id="computer-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- File Cabinet -->
              <div
                class="office-object"
                id="file-cabinet"
                onclick="investigateObject('cabinet')"
                style="
                  background: #8e44ad;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">🗄️</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Arquivo
                </div>
                <div
                  class="clue-indicator hidden"
                  id="cabinet-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- Reception Clipboard -->
              <div
                class="office-object"
                id="clipboard"
                onclick="investigateObject('clipboard')"
                style="
                  background: #2980b9;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">📋</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Prancheta
                </div>
                <div
                  class="clue-indicator hidden"
                  id="clipboard-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- Coffee Machine -->
              <div
                class="office-object"
                id="coffee-machine"
                onclick="investigateObject('coffee')"
                style="
                  background: #c0392b;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">☕</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Café
                </div>
                <div
                  class="clue-indicator hidden"
                  id="coffee-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- Office Phone -->
              <div
                class="office-object"
                id="office-phone"
                onclick="investigateObject('phone')"
                style="
                  background: #27ae60;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">📞</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Telefone
                </div>
                <div
                  class="clue-indicator hidden"
                  id="phone-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>

              <!-- Notice Board -->
              <div
                class="office-object"
                id="notice-board"
                onclick="investigateObject('board')"
                style="
                  background: #f39c12;
                  border-radius: 10px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                "
              >
                <div style="font-size: 40px">📌</div>
                <div style="color: white; font-weight: bold; margin-top: 10px">
                  Quadro
                </div>
                <div
                  class="clue-indicator hidden"
                  id="board-clue"
                  style="
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background: #ffd700;
                    color: #333;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: glow 2s infinite;
                  "
                >
                  !
                </div>
              </div>
            </div>
          </div>

          <!-- Meeting Room Door (moved outside grid for better responsive layout) -->
          <div
            id="meeting-door"
            class="meeting-door"
            style="
              background: #95a5a6;
              padding: 15px;
              border-radius: 10px;
              cursor: not-allowed;
              opacity: 0.5;
              transition: all 0.3s ease;
              margin: 20px auto;
              text-align: center;
              max-width: 200px;
            "
          >
            <div style="font-size: 30px">🚪</div>
            <div style="font-weight: bold; margin-top: 5px">
              Sala de Reunião
            </div>
            <div style="font-size: 12px; color: #7f8c8d">🔒 Bloqueada</div>
          </div>

          <!-- Investigation Results Panel -->
          <div
            id="investigation-panel"
            class="investigation-panel"
            style="
              background: rgba(255, 255, 255, 0.9);
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
              min-height: 100px;
              border: 2px solid #bdc3c7;
            "
          >
            <h4>🔍 Resultados da Investigação:</h4>
            <div
              id="investigation-content"
              style="font-style: italic; color: #7f8c8d"
            >
              Selecione um objeto no escritório para investigar...
            </div>
          </div>

          <!-- Discovered Clues -->
          <div
            id="clues-display"
            class="clues-display"
            style="
              background: rgba(232, 245, 233, 0.9);
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
              border-left: 4px solid #4caf50;
            "
          >
            <h4>✅ Pistas Descobertas:</h4>
            <div id="clues-list" style="margin-top: 15px">
              <p style="font-style: italic; color: #666">
                Nenhuma pista descoberta ainda...
              </p>
            </div>
          </div>

          <button
            class="btn"
            id="next-reception"
            onclick="nextState()"
            style="
              display: none;
              background: linear-gradient(135deg, #4caf50, #45a049);
            "
          >
            🔓 Entrar na Sala de Reunião
          </button>
        </div>

        <!-- ESTADO 2: CONVERSA CARD GAME -->
        <div id="state-conversa" class="state">
          <h1>🃏 Puzzle 2: Jogo de Cartas de Conversa</h1>

          <!-- Enhanced Metrics Dashboard -->
          <div class="conversation-metrics">
            <div class="metric-card empathy-metric">
              <div class="metric-icon">❤️</div>
              <div class="metric-info">
                <span class="metric-label">Empatia</span>
                <span class="metric-value"><span id="empathy">0</span>/30</span>
                <div class="metric-bar">
                  <div class="metric-progress" id="empathy-progress"></div>
                </div>
              </div>
            </div>

            <div class="metric-card information-metric">
              <div class="metric-icon">📊</div>
              <div class="metric-info">
                <span class="metric-label">Informação</span>
                <span class="metric-value"
                  ><span id="information">0</span>%</span
                >
                <div class="metric-bar">
                  <div class="metric-progress" id="information-progress"></div>
                </div>
              </div>
            </div>

            <div class="metric-card interaction-metric">
              <div class="metric-icon">🔄</div>
              <div class="metric-info">
                <span class="metric-label">Interações</span>
                <span class="metric-value"
                  ><span id="interactions">0</span>/6</span
                >
                <div class="metric-bar">
                  <div class="metric-progress" id="interactions-progress"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Game Board Layout -->
          <div class="card-game-board">
            <!-- Felisbina Avatar & Status -->
            <div class="felisbina-section">
              <div class="felisbina-avatar-container">
                <div class="empathy-avatar" id="felisbina-avatar">😐</div>
                <div class="avatar-status">
                  <h3>Felisbina Santos</h3>
                  <p id="felisbina-mood">Estado neutro</p>
                  <div class="conversation-progress">
                    <span id="conversation-topic">Aguardando conversa...</span>
                  </div>
                </div>
              </div>

              <!-- Conversation Memory -->
              <div class="conversation-memory">
                <h4>💭 Tópicos Abordados</h4>
                <div class="memory-slots" id="memory-slots">
                  <!-- Completed conversation cards will appear here -->
                </div>
              </div>
            </div>

            <!-- Card Game Area -->
            <div class="card-game-area">
              <!-- Topic Selection Deck -->
              <div class="topic-deck-area">
                <h4>📚 Tópicos de Conversa</h4>
                <div class="topic-deck" id="topic-deck">
                  <!-- Topic cards will be generated here -->
                </div>
                <div class="deck-info">
                  <span id="remaining-topics">5</span> tópicos restantes
                </div>
              </div>

              <!-- Active Conversation Area -->
              <div class="active-conversation-area">
                <div class="conversation-header">
                  <h4 id="current-topic-title">
                    Selecione um tópico para começar
                  </h4>
                </div>

                <!-- Dialogue Container for conversation content -->
                <div id="dialogue-container">
                  <!-- Response Cards Area -->
                  <div class="response-cards-area" id="response-cards-area">
                    <div class="cards-instruction">
                      Arraste um tópico do baralho para iniciar a conversa
                    </div>
                  </div>

                  <!-- Drop Zone for Selected Response -->
                  <div class="response-drop-zone" id="response-drop-zone">
                    <div class="drop-zone-content">
                      <div class="drop-zone-icon">🎯</div>
                      <span class="drop-zone-text"
                        >Arraste sua resposta aqui</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Results & Feedback Panel -->
            <div
              class="feedback-panel"
              id="feedback-panel"
              style="display: none"
            >
              <div class="feedback-content">
                <div class="response-quality" id="response-quality">
                  <!-- Quality assessment will appear here -->
                </div>
                <div class="empathy-gain" id="empathy-gain">
                  <!-- Empathy points gained -->
                </div>
                <div class="information-gain" id="information-gain">
                  <!-- Information gathered -->
                </div>
              </div>
              <button
                class="btn continue-btn"
                id="continue-conversation"
                onclick="continueConversation()"
              >
                Próximo Tópico →
              </button>
            </div>
          </div>

          <!-- Game Complete Button -->
          <button
            class="btn conversation-complete"
            id="next-dialogue"
            onclick="nextState()"
            style="display: none"
          >
            🎉 Conversa Completa - Continuar para Análise 🔍
          </button>
        </div>

        <!-- ESTADO 3: ANALISE -->
        <div id="state-analise" class="state">
          <h2>🧩 Puzzle 3: Investigação de Evidências</h2>
          <div class="evidence-metrics">
            <strong>🔍 Evidências Examinadas:</strong>
            <span id="evidence-examined">0</span>/9 |
            <strong>📋 Categorizadas Corretamente:</strong>
            <span id="evidence-categorized">0</span>/9 |
            <strong>🔗 Conexões Descobertas:</strong>
            <span id="connections-found">0</span>/3
          </div>

          <div class="investigation-scene">
            <div class="investigation-header">
              <h3>🕵️ Sala de Investigação - Caso Felisbina Santos</h3>
              <div class="investigation-instructions">
                <div class="instruction-step">
                  <strong>1️⃣ Examine:</strong> Clique na lupa (🔍) para examinar
                  evidências
                </div>
                <div class="instruction-step">
                  <strong>2️⃣ Categorize:</strong> Arraste evidências para
                  Risco/Proteção
                </div>
                <div class="instruction-step">
                  <strong>3️⃣ Conecte:</strong> Clique em 2 evidências para fazer
                  conexões
                </div>
              </div>

              <!-- Connection Status Display -->
              <div class="connection-status" id="connection-status">
                <div class="status-text">
                  Selecione evidências para conectar
                </div>
                <div class="selected-items" id="selected-items"></div>
              </div>

              <!-- Mobile Helper -->
              <div class="mobile-helper" id="mobile-helper">
                <div class="helper-content">
                  <h4>📱 Como Usar no Mobile:</h4>
                  <p><strong>Examinar:</strong> 1 toque na evidência</p>
                  <p>
                    <strong>Selecionar para conexão:</strong> 2 toques rápidos
                  </p>
                  <p>
                    <strong>Arrastar para categorizar:</strong> Pressione e
                    arraste
                  </p>
                  <button class="btn" onclick="closeMobileHelper()">
                    Entendi!
                  </button>
                </div>
              </div>
            </div>

            <div class="evidence-examination-area">
              <div class="evidence-gallery">
                <h4>📸 Galeria de Evidências</h4>
                <div class="evidence-grid" id="evidence-grid">
                  <!-- Evidence items will be inserted here -->
                </div>
              </div>

              <div class="magnifier-panel" id="magnifier-panel">
                <h4>🔍 Análise Detalhada</h4>
                <div class="magnifier-content" id="magnifier-content">
                  <p class="magnifier-instruction">
                    Clique numa evidência para examinar com a lupa
                  </p>
                </div>
              </div>
            </div>

            <div class="evidence-board-area">
              <div class="board-column risk-column">
                <h4>🔴 Área Vermelha</h4>
                <div
                  class="evidence-drop-zone"
                  id="risk-zone"
                  ondrop="dropEvidence(event)"
                  ondragover="allowDrop(event)"
                  onclick="handleEvidenceZoneClick('risk')"
                >
                  <div class="zone-header">
                    <span class="zone-icon">⚠️</span>
                    <span class="zone-text">Arraste evidências de risco</span>
                  </div>
                  <div class="evidence-slots" id="risk-slots">
                    <!-- Risk evidence will be placed here -->
                  </div>
                </div>
              </div>

              <div class="board-column protection-column">
                <h4>🟢 Área Verde</h4>
                <div
                  class="evidence-drop-zone"
                  id="protection-zone"
                  ondrop="dropEvidence(event)"
                  ondragover="allowDrop(event)"
                  onclick="handleEvidenceZoneClick('protection')"
                >
                  <div class="zone-header">
                    <span class="zone-icon">🛡️</span>
                    <span class="zone-text"
                      >Arraste evidências apropriadas</span
                    >
                  </div>
                  <div class="evidence-slots" id="protection-slots">
                    <!-- Protection evidence will be placed here -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Connection System -->
            <div
              class="connection-system"
              id="connection-system"
              style="display: none"
            >
              <div class="connection-header">
                <h4>🔗 Sistema de Conexões Avançado</h4>
                <div class="connection-stats">
                  <span class="connection-count">
                    <span id="connections-made">0</span>/3 Conexões
                  </span>
                  <span class="connection-score">
                    Bonus: <span id="connection-bonus">0</span> pts
                  </span>
                </div>
              </div>

              <p class="connection-instructions">
                Selecione duas evidências relacionadas para conectá-las. As
                conexões corretas geram pontos bonus!
              </p>

              <!-- Connection Visualization Canvas -->
              <div class="connection-canvas-container">
                <canvas
                  id="connection-canvas"
                  class="connection-canvas"
                ></canvas>
                <div class="canvas-overlay">
                  <div class="connection-legend">
                    <div class="legend-item">
                      <div class="legend-line valid"></div>
                      <span>Conexão Válida</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-line attempted"></div>
                      <span>Tentativa</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Connection Progress -->
              <div class="connection-progress">
                <h5>🎯 Descobertas:</h5>
                <div class="discovered-connections" id="discovered-connections">
                  <!-- Discovered connections will appear here -->
                </div>
              </div>

              <!-- Enhanced Connection Controls -->
              <div class="connection-controls">
                <button
                  class="btn connection-btn primary"
                  id="analyze-connections"
                  onclick="analyzeCurrentConnections()"
                >
                  🔍 Analisar Relações
                </button>
                <button
                  class="btn connection-btn secondary"
                  id="show-hints"
                  onclick="showConnectionHints()"
                >
                  💡 Mostrar Dicas
                </button>
                <button
                  class="btn connection-btn danger"
                  id="clear-connections"
                  onclick="clearConnections()"
                >
                  🗑️ Limpar Conexões
                </button>
              </div>

              <!-- Connection Insights Panel -->
              <div
                class="connection-insights"
                id="connection-insights"
                style="display: none"
              >
                <h5>🧠 Insights Profissionais:</h5>
                <div class="insights-content" id="insights-content">
                  <!-- Professional insights about connections -->
                </div>
              </div>
            </div>
          </div>

          <button
            class="btn"
            id="next-analysis"
            onclick="nextState()"
            style="display: none"
          >
            Continuar para Documentação 📋
          </button>
        </div>

        <!-- ESTADO 4: DOCUMENT SCANNER MINI-GAME -->
        <div id="state-documentacao" class="state">
          <h1>📄 Puzzle 4: Laboratório de Digitalização de Documentos</h1>

          <!-- Enhanced Metrics Dashboard -->
          <div class="scanner-metrics">
            <div class="metric-item scanner-metric">
              <div class="metric-icon">📄</div>
              <div class="metric-data">
                <span class="metric-label">Documentos Processados</span>
                <span class="metric-value"
                  ><span id="docs-identified">0</span>/5</span
                >
              </div>
            </div>

            <div class="metric-item accuracy-metric">
              <div class="metric-icon">🎯</div>
              <div class="metric-data">
                <span class="metric-label">Precisão de Digitalização</span>
                <span class="metric-value"
                  ><span id="scan-accuracy">100</span>%</span
                >
              </div>
            </div>

            <div class="metric-item speed-metric">
              <div class="metric-icon">⚡</div>
              <div class="metric-data">
                <span class="metric-label">Velocidade Média</span>
                <span class="metric-value"
                  ><span id="scan-speed">0</span>s</span
                >
              </div>
            </div>

            <div class="metric-item security-metric">
              <div class="metric-icon">🔐</div>
              <div class="metric-data">
                <span class="metric-label">Docs Confidenciais</span>
                <span class="metric-value"
                  ><span id="secret-docs">0</span>/2</span
                >
              </div>
            </div>
          </div>

          <!-- Scanner Workstation -->
          <div class="scanner-workstation">
            <!-- Document Queue -->
            <div class="document-queue-section">
              <h3>📋 Fila de Digitalização</h3>
              <div class="queue-instructions">
                Arraste documentos para o scanner para processar
              </div>
              <div class="document-queue" id="document-queue">
                <!-- Document items will be generated here -->
              </div>
              <div class="queue-stats">
                <span id="queue-remaining">5</span> documentos aguardando
              </div>
            </div>

            <!-- Main Scanner Interface -->
            <div class="scanner-interface">
              <div class="scanner-header">
                <h3>🖨️ Scanner Profissional SAASI-2000</h3>
                <div class="scanner-status" id="scanner-status">
                  <span class="status-light standby"></span>
                  <span class="status-text">Standby</span>
                </div>
              </div>

              <!-- Scanner Bed -->
              <div class="scanner-bed" id="scanner-bed">
                <div class="scanner-bed-content">
                  <div class="scanner-placeholder">
                    <div class="placeholder-icon">📄</div>
                    <span class="placeholder-text"
                      >Arraste um documento aqui para digitalizar</span
                    >
                  </div>

                  <!-- Active scanning elements -->
                  <div
                    class="scanning-overlay"
                    id="scanning-overlay"
                    style="display: none"
                  >
                    <div class="scanning-laser"></div>
                    <div class="scanning-progress">
                      <div class="scanning-bar" id="scanning-bar"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Scanner Controls -->
              <div class="scanner-controls">
                <button
                  class="scanner-btn start-scan"
                  id="start-scan-btn"
                  onclick="startDocumentScan()"
                  disabled
                >
                  ▶️ Iniciar Digitalização
                </button>
                <button
                  class="scanner-btn cancel-scan"
                  id="cancel-scan-btn"
                  onclick="cancelScan()"
                  disabled
                >
                  ⏹️ Cancelar
                </button>
                <button
                  class="scanner-btn validate-doc"
                  id="validate-doc-btn"
                  onclick="validateDocument()"
                  disabled
                >
                  ✅ Validar Documento
                </button>
              </div>

              <!-- Scan Timer -->
              <div class="scan-timer" id="scan-timer" style="display: none">
                <div class="timer-circle">
                  <span id="timer-seconds">0</span>s
                </div>
              </div>
            </div>

            <!-- Processing Results -->
            <div class="processing-results">
              <h3>📊 Resultados de Processamento</h3>
              <div class="results-display" id="results-display">
                <div class="results-placeholder">
                  Resultados da digitalização aparecerão aqui
                </div>
              </div>

              <!-- Document Validation Panel -->
              <div
                class="validation-panel"
                id="validation-panel"
                style="display: none"
              >
                <h4>🔍 Validação de Autenticidade</h4>
                <div class="validation-checks" id="validation-checks">
                  <!-- Validation checks will appear here -->
                </div>
                <div class="validation-actions">
                  <button
                    class="validation-btn approve"
                    onclick="approveDocument()"
                  >
                    ✅ Aprovar
                  </button>
                  <button
                    class="validation-btn reject"
                    onclick="rejectDocument()"
                  >
                    ❌ Rejeitar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Achievement & Progress Panel -->
          <div
            class="scanning-achievements"
            id="scanning-achievements"
            style="display: none"
          >
            <h3>🏆 Conquistas de Digitalização</h3>
            <div class="achievement-list" id="achievement-list">
              <!-- Achievements will be added here -->
            </div>
          </div>

          <!-- Game Complete Button -->
          <button
            class="btn scanner-complete"
            id="next-docs"
            onclick="nextState()"
            style="display: none"
          >
            🎉 Digitalização Completa - Continuar para Avaliação ⚖️
          </button>
        </div>

        <!-- ESTADO 5: ASSESSMENT TERMINAL - Professional DLD Assessment System -->
        <div id="state-avaliacao" class="state">
          <h1>🖥️ Terminal de Avaliação DLD - Sistema IEFP</h1>

          <!-- Terminal Interface Container -->
          <div id="assessment-terminal" class="terminal-container">
            <!-- Terminal Header -->
            <div class="terminal-header">
              <div class="terminal-controls">
                <div class="terminal-button terminal-close"></div>
                <div class="terminal-button terminal-minimize"></div>
                <div class="terminal-button terminal-maximize"></div>
              </div>
              <div class="terminal-title">
                SAASI v2.1 - Sistema de Avaliação DLD
              </div>
              <div class="terminal-user">Utilizador: TÉCNICO_SAASI</div>
            </div>

            <!-- Multi-Screen Assessment Interface -->
            <div class="terminal-body">
              <!-- Screen 1: DLD Criteria Review Dashboard -->
              <div id="terminal-screen-1" class="terminal-screen active">
                <div class="screen-header">
                  <h3>📊 Dashboard - Critérios DLD</h3>
                  <div class="system-status">
                    <span class="status-indicator online"></span>
                    Sistema Online
                  </div>
                </div>

                <div class="criteria-dashboard">
                  <div class="criteria-section">
                    <h4>Critérios de Elegibilidade Identificados:</h4>
                    <div id="dld-criteria-list">
                      <!-- Populated dynamically -->
                    </div>
                  </div>

                  <div class="profile-summary">
                    <h4>Perfil do Beneficiário:</h4>
                    <div class="profile-card">
                      <div class="profile-field">
                        <label>Nome:</label>
                        <span class="profile-value"
                          >Felisbina Maria Santos</span
                        >
                      </div>
                      <div class="profile-field">
                        <label>Idade:</label>
                        <span class="profile-value">56 anos</span>
                      </div>
                      <div class="profile-field">
                        <label>Qualificação:</label>
                        <span class="profile-value">9º ano (1968)</span>
                      </div>
                      <div class="profile-field">
                        <label>Experiência:</label>
                        <span class="profile-value">6 meses em limpeza</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="screen-navigation">
                  <button
                    class="terminal-btn primary"
                    onclick="proceedToScreen(2)"
                  >
                    Prosseguir para Avaliação ➤
                  </button>
                </div>
              </div>

              <!-- Screen 2: Decision Balance Scale -->
              <div id="terminal-screen-2" class="terminal-screen">
                <div class="screen-header">
                  <h3>⚖️ Escala de Decisão - Avaliação DLD</h3>
                  <div class="progress-indicator">
                    <span>Passo 2 de 4</span>
                  </div>
                </div>

                <div class="balance-scale-container">
                  <div class="decision-section">
                    <h4>1. Avaliação de DISPONIBILIDADE:</h4>
                    <div class="decision-balance">
                      <div class="balance-visualization">
                        <div id="availability-scale" class="scale-display">
                          <div
                            class="scale-left"
                            id="availability-factors-negative"
                          >
                            <h5>Fatores Limitadores</h5>
                            <div
                              class="factor-list"
                              id="availability-negative-factors"
                            ></div>
                          </div>
                          <div class="scale-center">
                            <div class="balance-fulcrum"></div>
                            <div
                              class="balance-beam"
                              id="availability-beam"
                            ></div>
                          </div>
                          <div
                            class="scale-right"
                            id="availability-factors-positive"
                          >
                            <h5>Fatores Facilitadores</h5>
                            <div
                              class="factor-list"
                              id="availability-positive-factors"
                            ></div>
                          </div>
                        </div>
                      </div>

                      <div class="decision-options">
                        <div class="option-group">
                          <div
                            class="assessment-option"
                            data-choice="sim_total"
                            onclick="selectAvailabilityTerminal('sim_total')"
                          >
                            <div class="option-header">
                              <span class="option-code">DISP_TOTAL_2025</span>
                              <span class="option-weight weight-high"
                                >⚖️ ALTO</span
                              >
                            </div>
                            <div class="option-title">
                              SIM - Disponibilidade Total
                            </div>
                            <div class="option-description">
                              Sem dependentes, horário flexível, motivação
                              demonstrada
                            </div>
                            <div class="option-justification">
                              <strong>Justificação:</strong> Ausência de
                              impedimentos familiares diretos + motivação
                              demonstrada
                            </div>
                          </div>

                          <div
                            class="assessment-option"
                            data-choice="sim_condicionada"
                            onclick="selectAvailabilityTerminal('sim_condicionada')"
                          >
                            <div class="option-header">
                              <span class="option-code">DISP_COND_2025</span>
                              <span class="option-weight weight-medium"
                                >⚖️ MÉDIO</span
                              >
                            </div>
                            <div class="option-title">
                              SIM - Disponibilidade Condicionada
                            </div>
                            <div class="option-description">
                              Disponível com apoio psicológico preventivo
                            </div>
                            <div class="option-justification">
                              <strong>Justificação:</strong> Dependência
                              emocional identificada requer acompanhamento
                            </div>
                          </div>

                          <div
                            class="assessment-option"
                            data-choice="nao"
                            onclick="selectAvailabilityTerminal('nao')"
                          >
                            <div class="option-header">
                              <span class="option-code">DISP_NEG_2025</span>
                              <span class="option-weight weight-low"
                                >⚖️ BAIXO</span
                              >
                            </div>
                            <div class="option-title">
                              NÃO - Indisponibilidade Temporária
                            </div>
                            <div class="option-description">
                              Estabilização emocional prioritária
                            </div>
                            <div class="option-justification">
                              <strong>Justificação:</strong> Fatores emocionais
                              impedem inserção laboral imediata
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="screen-navigation">
                  <button
                    class="terminal-btn secondary"
                    onclick="proceedToScreen(1)"
                  >
                    ← Voltar
                  </button>
                  <button
                    class="terminal-btn primary"
                    id="proceed-to-capacity"
                    onclick="proceedToScreen(3)"
                    style="display: none"
                  >
                    Avaliação de Capacidade ➤
                  </button>
                </div>
              </div>

              <!-- Screen 3: Capacity Assessment -->
              <div id="terminal-screen-3" class="terminal-screen">
                <div class="screen-header">
                  <h3>🎯 Avaliação de CAPACIDADE</h3>
                  <div class="progress-indicator">
                    <span>Passo 3 de 4</span>
                  </div>
                </div>

                <div class="capacity-assessment">
                  <div class="decision-section">
                    <h4>2. Avaliação de CAPACIDADE para o trabalho:</h4>
                    <div class="decision-balance">
                      <div class="balance-visualization">
                        <div id="capacity-scale" class="scale-display">
                          <div
                            class="scale-left"
                            id="capacity-factors-negative"
                          >
                            <h5>Limitações Identificadas</h5>
                            <div
                              class="factor-list"
                              id="capacity-negative-factors"
                            ></div>
                          </div>
                          <div class="scale-center">
                            <div class="balance-fulcrum"></div>
                            <div class="balance-beam" id="capacity-beam"></div>
                          </div>
                          <div
                            class="scale-right"
                            id="capacity-factors-positive"
                          >
                            <h5>Competências e Experiência</h5>
                            <div
                              class="factor-list"
                              id="capacity-positive-factors"
                            ></div>
                          </div>
                        </div>
                      </div>

                      <div class="decision-options">
                        <div class="option-group">
                          <div
                            class="assessment-option"
                            data-choice="sim_formacao"
                            onclick="selectCapacityTerminal('sim_formacao')"
                          >
                            <div class="option-header">
                              <span class="option-code">CAP_FORM_2025</span>
                              <span class="option-weight weight-high"
                                >⚖️ ALTO</span
                              >
                            </div>
                            <div class="option-title">
                              SIM - Capacidade com Formação
                            </div>
                            <div class="option-description">
                              Experiência base + potencial de desenvolvimento
                            </div>
                            <div class="option-justification">
                              <strong>Justificação:</strong> 9º ano + 6 meses
                              experiência = base para qualificação adicional
                            </div>
                          </div>

                          <div
                            class="assessment-option"
                            data-choice="sim_plena"
                            onclick="selectCapacityTerminal('sim_plena')"
                          >
                            <div class="option-header">
                              <span class="option-code">CAP_PLENA_2025</span>
                              <span class="option-weight weight-medium"
                                >⚖️ MÉDIO</span
                              >
                            </div>
                            <div class="option-title">
                              SIM - Capacidade Plena
                            </div>
                            <div class="option-description">
                              Capacidade atual sem desenvolvimento adicional
                            </div>
                            <div class="option-justification">
                              <strong>Justificação:</strong> Experiência
                              anterior demonstrada, sem limitações físicas
                            </div>
                          </div>

                          <div
                            class="assessment-option"
                            data-choice="nao"
                            onclick="selectCapacityTerminal('nao')"
                          >
                            <div class="option-header">
                              <span class="option-code">CAP_NEG_2025</span>
                              <span class="option-weight weight-low"
                                >⚖️ BAIXO</span
                              >
                            </div>
                            <div class="option-title">
                              NÃO - Incapacidade Temporária
                            </div>
                            <div class="option-description">
                              Limitações impedem trabalho imediato
                            </div>
                            <div class="option-justification">
                              <strong>Justificação:</strong> Fatores
                              emocionais/educacionais limitam capacidade atual
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="screen-navigation">
                  <button
                    class="terminal-btn secondary"
                    onclick="proceedToScreen(2)"
                  >
                    ← Voltar
                  </button>
                  <button
                    class="terminal-btn primary"
                    id="proceed-to-validation"
                    onclick="proceedToScreen(4)"
                    style="display: none"
                  >
                    Validação Final ➤
                  </button>
                </div>
              </div>

              <!-- Screen 4: Logic Validation & Code Generation -->
              <div id="terminal-screen-4" class="terminal-screen">
                <div class="screen-header">
                  <h3>🔍 Validação e Geração de Código</h3>
                  <div class="progress-indicator">
                    <span>Passo 4 de 4 - Finalização</span>
                  </div>
                </div>

                <div class="validation-section">
                  <div class="decision-summary">
                    <h4>Resumo das Decisões:</h4>
                    <div class="decision-display">
                      <div class="decision-item">
                        <label>Disponibilidade:</label>
                        <span id="final-availability-display">-</span>
                        <span id="final-availability-code" class="decision-code"
                          >-</span
                        >
                      </div>
                      <div class="decision-item">
                        <label>Capacidade:</label>
                        <span id="final-capacity-display">-</span>
                        <span id="final-capacity-code" class="decision-code"
                          >-</span
                        >
                      </div>
                    </div>
                  </div>

                  <div class="logic-validation">
                    <h4>Validação de Lógica:</h4>
                    <div id="validation-results" class="validation-display">
                      <!-- Populated dynamically -->
                    </div>
                  </div>

                  <div class="code-generation">
                    <h4>Código de Validação DLD:</h4>
                    <div class="code-display">
                      <div class="code-container">
                        <div class="code-label">Código Gerado:</div>
                        <div id="generated-code" class="code-value">
                          <!-- Generated dynamically -->
                        </div>
                        <button
                          class="copy-code-btn"
                          onclick="copyCodeToClipboard()"
                        >
                          📋 Copiar Código
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="assessment-report">
                    <h4>Relatório de Avaliação:</h4>
                    <div id="final-assessment-report" class="report-display">
                      <!-- Generated assessment report -->
                    </div>
                  </div>
                </div>

                <div class="screen-navigation">
                  <button
                    class="terminal-btn secondary"
                    onclick="proceedToScreen(3)"
                  >
                    ← Voltar
                  </button>
                  <button
                    class="terminal-btn success"
                    id="finalize-assessment-terminal"
                    onclick="finalizeAssessmentTerminal()"
                    style="display: none"
                  >
                    ✅ Finalizar Avaliação
                  </button>
                </div>
              </div>
            </div>

            <!-- Terminal Footer -->
            <div class="terminal-footer">
              <div class="terminal-status">
                <span id="terminal-status-text">Sistema pronto</span>
              </div>
              <div class="terminal-timestamp">
                <span id="terminal-timestamp"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- ESTADO 6: CONCLUSAO -->
        <div id="state-conclusao" class="state">
          <h1>🎉 Missão Completada!</h1>

          <div
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 30px;
              border-radius: 15px;
              text-align: center;
              margin: 20px 0;
            "
          >
            <h2>🏆 Resultados da Missão</h2>
            <div style="font-size: 24px; margin: 15px 0">
              <strong
                >Pontuação Final: <span id="final-score">0</span>/150</strong
              >
            </div>
            <div style="font-size: 18px">
              <strong>Tempo Utilizado: <span id="time-used">--</span></strong>
            </div>
            <div style="font-size: 18px">
              <strong>Nível Alcançado: <span id="final-level">--</span></strong>
            </div>
          </div>

          <div
            id="achievements-panel"
            style="
              background: #f8f9fa;
              padding: 20px;
              border-radius: 10px;
              margin: 20px 0;
            "
          >
            <h3>🏅 Conquistas Desbloqueadas:</h3>
            <div id="achievements-list">
              <!-- Conquistas serão inseridas dinamicamente -->
            </div>
          </div>

          <div style="text-align: center; margin-top: 30px">
            <button class="btn" onclick="restartGame()">
              🔄 Repetir Fase 1
            </button>
            <button
              class="btn"
              style="background: #4caf50"
              onclick="continueToPhase2()"
            >
              Continuar para Fase 2 ➡️
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Load existing systems for compatibility -->
    <script src="js/scoring-system.js"></script>
    <script src="js/assessment-logic.js"></script>
    <script src="js/case-data-felisbina.js"></script>
    <script src="js/modal-system.js"></script>
    <script src="js/shared.js"></script>

    <script>
      // Simple function to create native-style dialogs
      function showNativePrompt(message) {
        // Create a simple input dialog
        const result = window._originalPrompt
          ? window._originalPrompt(message)
          : prompt(message);
        return result;
      }

      function showNativeConfirm(message) {
        // Create a simple confirm dialog
        const result = window._originalConfirm
          ? window._originalConfirm(message)
          : confirm(message);
        return result;
      }

      // ESCAPE ROOM GAME STATE
      let escapeRoomState = {
        startTime: null,
        timeLimit: 45 * 60 * 1000, // 45 minutos em ms
        currentPuzzle: 1,
        codesDiscovered: [],
        hiddenElementsFound: 0,
        bonusPoints: 0,
        achievements: [],
      };

      // ESTADO DO JOGO ORIGINAL (mantido para compatibilidade)
      let gameState = {
        currentState: "inicio",
        score: 0,
        empathy: 0,
        information: 0,
        interactions: 0,
        docsIdentified: 0,
        availability: null,
        capacity: null,
        elementsPlaced: 0,
      };

      // DADOS DOS DIÁLOGOS (mantidos originais)
      const dialogueData = [
        {
          id: 1,
          question: "Olá Felisbina, sou técnica do SAASI. Como se sente hoje?",
          options: [
            {
              text: "Vejo que está nervosa. Não se preocupe, estamos aqui para a ajudar.",
              empathy: 8,
              info: 2,
              code: "empathy_high",
            },
            {
              text: "Preciso que me forneça algumas informações sobre a sua situação.",
              empathy: 2,
              info: 6,
              code: "direct_approach",
            },
            {
              text: "Conte-me um pouco sobre si e o que a trouxe até aqui.",
              empathy: 5,
              info: 5,
              code: "balanced",
            },
          ],
        },
        {
          id: 2,
          question: "Vive sozinha numa pensão. Como é essa situação para si?",
          options: [
            {
              text: "Imagino que não seja fácil viver numa pensão. Como se sente lá?",
              empathy: 7,
              info: 4,
              code: "housing_empathy",
            },
            {
              text: "Há quanto tempo vive na pensão? Quanto paga de renda?",
              empathy: 1,
              info: 8,
              code: "housing_facts",
            },
            {
              text: "A pensão é temporária? Tem planos para mudar?",
              empathy: 4,
              info: 6,
              code: "housing_future",
            },
          ],
        },
        {
          id: 3,
          question:
            "Tem experiência de trabalho como empregada de limpeza. Como foi?",
          options: [
            {
              text: "Seis meses é um bom período. Deve ter aprendido muito.",
              empathy: 6,
              info: 5,
              code: "work_positive",
            },
            {
              text: "Porque é que o trabalho terminou? Houve algum problema?",
              empathy: 2,
              info: 8,
              code: "work_termination",
            },
            {
              text: "Gostaria de voltar a trabalhar na área de limpeza?",
              empathy: 5,
              info: 6,
              code: "work_future",
            },
          ],
        },
        {
          id: 4,
          question:
            "Falou-me do seu pai e do irmão. Como são essas relações familiares?",
          options: [
            {
              text: "Vejo que o seu pai é muito importante para si. Essa ligação é muito forte.",
              empathy: 8,
              info: 4,
              code: "father_bond",
            },
            {
              text: "Deve ser difícil ter perdido o apoio do irmão que a orientava.",
              empathy: 7,
              info: 6,
              code: "brother_loss",
            },
            {
              text: "Como se sente agora sem o apoio financeiro e orientação do irmão?",
              empathy: 5,
              info: 8,
              code: "autonomy_challenge",
            },
          ],
        },
        {
          id: 5,
          question:
            "Disse que se sente sozinha agora. Como está a lidar com essas mudanças?",
          options: [
            {
              text: "É compreensível sentir-se assim. Estas mudanças são muito difíceis.",
              empathy: 9,
              info: 3,
              code: "loneliness_empathy",
            },
            {
              text: "Tem algum apoio além do RSI? Conhece outros serviços que possam ajudar?",
              empathy: 4,
              info: 8,
              code: "support_resources",
            },
            {
              text: "Como imagina o seu futuro? Que objetivos tem para si própria?",
              empathy: 6,
              info: 6,
              code: "future_planning",
            },
          ],
        },
      ];

      // DADOS DOS ELEMENTOS DE ANÁLISE (expandidos com elementos ocultos)
      const analysisElements = [
        // Elementos visíveis desde o início
        { id: "idade_56", text: "Idade: 56 anos", category: "risk", points: 5 },
        {
          id: "9ano_escolaridade",
          text: "9º ano escolaridade",
          category: "risk",
          points: 4,
        },
        {
          id: "vive_sozinha",
          text: "Vive sozinha",
          category: "risk",
          points: 6,
        },
        {
          id: "rsi_beneficiaria",
          text: "Beneficiária RSI",
          category: "risk",
          points: 3,
        },
        {
          id: "experiencia_limpeza",
          text: "Experiência em limpeza",
          category: "protection",
          points: 8,
        },
        {
          id: "psi_ativa",
          text: "PSI ativa",
          category: "protection",
          points: 6,
        },
        {
          id: "sem_dependentes",
          text: "Sem dependentes",
          category: "protection",
          points: 7,
        },
        {
          id: "motivacao_mudanca",
          text: "Motivação para mudança",
          category: "protection",
          points: 5,
        },
        {
          id: "isolamento_social",
          text: "Isolamento social",
          category: "risk",
          points: 7,
        },

        // Elementos ocultos (desbloqueados por códigos)
        {
          id: "dependencia_pai",
          text: "Dependência emocional do pai",
          category: "risk",
          points: 8,
          hidden: true,
          unlockCode: "father_bond",
        },
        {
          id: "perda_rede_apoio",
          text: "Perda da rede de apoio (irmão)",
          category: "risk",
          points: 6,
          hidden: true,
          unlockCode: "brother_loss",
        },
        {
          id: "capacidade_adaptacao",
          text: "Capacidade de adaptação",
          category: "protection",
          points: 9,
          hidden: true,
          unlockCode: "empathy_high",
        },
      ];

      // DADOS DOS DOCUMENTOS (expandidos com documentos secretos)
      const documentsData = [
        {
          id: "bi",
          name: "Bilhete de Identidade",
          available: true,
          mandatory: true,
          points: 5,
        },
        {
          id: "nif",
          name: "Número de Identificação Fiscal",
          available: true,
          mandatory: true,
          points: 5,
        },
        {
          id: "niss",
          name: "Número de Identificação da Segurança Social",
          available: false,
          mandatory: true,
          points: 8,
        },
        {
          id: "comprovativo_rsi",
          name: "Comprovativo RSI",
          available: true,
          mandatory: false,
          points: 3,
        },
        {
          id: "comprovativo_psi",
          name: "Comprovativo PSI",
          available: true,
          mandatory: false,
          points: 3,
        },
        {
          id: "cv",
          name: "Curriculum Vitae",
          available: false,
          mandatory: false,
          points: 2,
        },

        // Documentos secretos
        {
          id: "relatorio_medico",
          name: "Relatório Médico (Oculto)",
          available: false,
          mandatory: false,
          points: 10,
          hidden: true,
          location: "gaveta",
        },
        {
          id: "historial_emprego",
          name: "Historial de Emprego Detalhado",
          available: false,
          mandatory: false,
          points: 8,
          hidden: true,
          location: "arquivo",
        },
      ];

      // FUNÇÕES DO ESCAPE ROOM

      function startEscapeRoom() {
        escapeRoomState.startTime = Date.now();
        startTimer();
        changeState("reception"); // Start with reception puzzle
        initReceptionPuzzle();
        updatePuzzleCounter(1);
        showToast("🚀 Missão iniciada! Investigue a receção!", "info", 5000);
      }

      function startTimer() {
        const timerDisplay = document.getElementById("timer-display");
        const timerProgress = document.getElementById("timer-progress");
        const timerContainer = document.getElementById("timer-container");

        const updateTimer = () => {
          const elapsed = Date.now() - escapeRoomState.startTime;
          const remaining = Math.max(0, escapeRoomState.timeLimit - elapsed);

          const minutes = Math.floor(remaining / 60000);
          const seconds = Math.floor((remaining % 60000) / 1000);

          timerDisplay.textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

          const progress = (remaining / escapeRoomState.timeLimit) * 100;
          timerProgress.style.width = `${progress}%`;

          // Avisos de tempo
          if (
            remaining <= 300000 &&
            !timerContainer.classList.contains("timer-warning")
          ) {
            // 5 minutos
            timerContainer.classList.add("timer-warning");
            showToast("⚠️ Apenas 5 minutos restantes!", "warning", 3000);
          }

          if (remaining <= 60000 && remaining > 59000) {
            // 1 minuto
            showToast("🚨 ÚLTIMO MINUTO! Finalize rapidamente!", "error", 5000);
          }

          if (remaining <= 0) {
            timeUp();
            return;
          }

          setTimeout(updateTimer, 1000);
        };

        updateTimer();
      }

      function timeUp() {
        showToast(
          "⏰ Tempo esgotado! A missão será finalizada automaticamente.",
          "error",
          5000
        );
        // Penalização por tempo esgotado
        gameState.score = Math.max(0, gameState.score - 20);
        setTimeout(() => changeState("conclusao"), 3000);
      }

      function updatePuzzleCounter(puzzleNumber) {
        escapeRoomState.currentPuzzle = puzzleNumber;
        document.getElementById("current-puzzle").textContent = puzzleNumber;
      }

      function addBonusPoints(points, reason) {
        escapeRoomState.bonusPoints += points;
        gameState.score += points;
        showToast(`🎉 Bonus: +${points} pontos! ${reason}`, "success", 5000);
        updateScoreDisplay();
      }

      function updateScoreDisplay() {
        document.getElementById("score").textContent = gameState.score;
      }

      function discoverCode(code) {
        if (!escapeRoomState.codesDiscovered.includes(code)) {
          escapeRoomState.codesDiscovered.push(code);
          showToast(
            "🔓 Código descoberto! Novos elementos desbloqueados.",
            "info",
            3000
          );

          // Revelar elementos ocultos baseados no código
          revealHiddenElements(code);
        }
      }

      function revealHiddenElements(code) {
        analysisElements.forEach((element) => {
          if (element.hidden && element.unlockCode === code) {
            element.hidden = false;
            escapeRoomState.hiddenElementsFound++;

            // Adicionar elemento ao pool se estivermos na análise
            if (gameState.currentState === "analise") {
              addElementToPool(element);
            }
          }
        });

        // Atualizar contador de elementos ocultos
        if (document.getElementById("hidden-discovered")) {
          document.getElementById("hidden-discovered").textContent =
            escapeRoomState.hiddenElementsFound;
        }
      }

      function addElementToPool(element) {
        const pool = document.getElementById("elements-pool");
        const div = document.createElement("div");
        div.className = "drag-item hidden-element";
        div.draggable = true;
        div.textContent = element.text;
        div.dataset.id = element.id;
        div.dataset.category = element.category;
        div.dataset.points = element.points;
        div.ondragstart = drag;

        // Adicionar indicador de pista
        const clueIndicator = document.createElement("div");
        clueIndicator.className = "clue-indicator";
        clueIndicator.textContent = "!";
        div.appendChild(clueIndicator);

        pool.appendChild(div);

        // Animar revelação
        setTimeout(() => {
          div.classList.add("revealed");
        }, 100);
      }

      function updateFelisbinaAvatar() {
        const avatar = document.getElementById("felisbina-avatar");
        const empathy = gameState.empathy;

        if (empathy >= 20) {
          avatar.textContent = "😊";
          avatar.className = "empathy-avatar happy";
        } else if (empathy >= 10) {
          avatar.textContent = "🙂";
          avatar.className = "empathy-avatar neutral";
        } else {
          avatar.textContent = "😐";
          avatar.className = "empathy-avatar sad";
        }
      }

      // FUNÇÕES ORIGINAIS ADAPTADAS

      // Função para atualizar pontuação com limite
      function addScore(points) {
        gameState.score = Math.min(gameState.score + points, 150); // Aumentado para 150
        updateScoreDisplay();
      }

      // Toast System
      function showToast(message, type = "info", duration = 7000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
          ${message}
          <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Custom Dialog System
      class CustomDialog {
        constructor() {
          this.overlay = null;
          this.currentDialog = null;
          this.createOverlay();
        }

        createOverlay() {
          this.overlay = document.createElement("div");
          this.overlay.className = "custom-dialog-overlay";
          this.overlay.addEventListener("click", (e) => {
            if (e.target === this.overlay) {
              this.close(null);
            }
          });
          document.body.appendChild(this.overlay);
        }

        show(options) {
          const {
            type = "confirm",
            title = "Confirmação",
            message = "Tem a certeza?",
            okText = "OK",
            cancelText = "Cancelar",
            hasInput = false,
            inputPlaceholder = "Digite aqui...",
            inputValue = "",
          } = options;

          return new Promise((resolve) => {
            this.currentResolve = resolve;

            const iconMap = {
              confirm: "❓",
              prompt: "📝",
              alert: "ℹ️",
            };

            const dialog = document.createElement("div");
            dialog.className = "custom-dialog";

            dialog.innerHTML = `
              <div class="custom-dialog-header">
                <div class="custom-dialog-icon ${type}">${
              iconMap[type] || "❓"
            }</div>
                <h3 class="custom-dialog-title">${title}</h3>
              </div>
              <div class="custom-dialog-body">
                <div>${message}</div>
                ${
                  hasInput
                    ? `<input type="text" class="custom-dialog-input" placeholder="${inputPlaceholder}" value="${inputValue}">`
                    : ""
                }
              </div>
              <div class="custom-dialog-buttons">
                ${
                  type !== "alert"
                    ? `<button class="custom-dialog-btn secondary" data-action="cancel">${cancelText}</button>`
                    : ""
                }
                <button class="custom-dialog-btn primary" data-action="ok">${okText}</button>
              </div>
            `;

            this.overlay.innerHTML = "";
            this.overlay.appendChild(dialog);
            this.currentDialog = dialog;

            // Add button event listeners
            dialog.querySelectorAll(".custom-dialog-btn").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const action = e.target.dataset.action;
                if (action === "ok") {
                  if (hasInput) {
                    const input = dialog.querySelector(".custom-dialog-input");
                    this.close(input.value.trim() || null);
                  } else {
                    this.close(true);
                  }
                } else {
                  this.close(hasInput ? null : false);
                }
              });
            });

            // Handle Enter key for input
            if (hasInput) {
              const input = dialog.querySelector(".custom-dialog-input");
              input.focus();
              input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                  this.close(input.value.trim() || null);
                }
              });
            }

            // Handle Escape key
            const handleEscape = (e) => {
              if (e.key === "Escape") {
                this.close(hasInput ? null : false);
                document.removeEventListener("keydown", handleEscape);
              }
            };
            document.addEventListener("keydown", handleEscape);

            // Show dialog
            this.overlay.classList.add("show");
          });
        }

        close(result) {
          this.overlay.classList.remove("show");
          setTimeout(() => {
            if (this.currentResolve) {
              this.currentResolve(result);
              this.currentResolve = null;
            }
          }, 300);
        }

        // Convenience methods
        async confirm(message, title = "Confirmação") {
          return await this.show({
            type: "confirm",
            title,
            message,
            okText: "Sim",
            cancelText: "Não",
          });
        }

        async alert(message, title = "Informação") {
          return await this.show({
            type: "alert",
            title,
            message,
            okText: "OK",
          });
        }

        async prompt(message, title = "Input Necessário", defaultValue = "") {
          return await this.show({
            type: "prompt",
            title,
            message,
            hasInput: true,
            inputPlaceholder: "Digite sua resposta...",
            inputValue: defaultValue,
            okText: "OK",
            cancelText: "Cancelar",
          });
        }
      }

      // Global dialog instance
      const customDialog = new CustomDialog();

      // Override native dialogs with async versions
      window.customConfirm = (message) => customDialog.confirm(message);
      window.customAlert = (message) => customDialog.alert(message);
      window.customPrompt = (message, defaultValue = "") =>
        customDialog.prompt(message, "Input Necessário", defaultValue);

      function continueToPhase2() {
        // Verificar se pontuação é suficiente
        if (gameState.score < 70) {
          showToast(
            "⚠️ Precisa de pelo menos 70 pontos para desbloquear a Fase 2.<br>Pontuação atual: " +
              gameState.score,
            "warning",
            6000
          );
          return;
        }

        // Salvar dados da Fase 1 para transferir para Fase 2
        const phase1Data = {
          phase: 1,
          score: gameState.score,
          maxScore: 150,
          percentage: Math.round((gameState.score / 150) * 100),
          duration: escapeRoomState.startTime
            ? Math.round((Date.now() - escapeRoomState.startTime) / 60000)
            : 20,
          level: { title: getFinalLevel() },
          empathy: gameState.empathy,
          information: gameState.information,
          interactions: gameState.interactions,
          availability: gameState.availability,
          capacity: gameState.capacity,
          docsIdentified: gameState.docsIdentified,
          elementsPlaced: gameState.elementsPlaced,
          escapeRoomData: {
            bonusPoints: escapeRoomState.bonusPoints,
            codesDiscovered: escapeRoomState.codesDiscovered,
            hiddenElementsFound: escapeRoomState.hiddenElementsFound,
            achievements: escapeRoomState.achievements,
          },
        };

        // Salvar no localStorage
        localStorage.setItem(
          "saasi_phase1_results",
          JSON.stringify(phase1Data)
        );

        showToast(
          "🎉 Dados salvos! Redirecionando para Fase 2...",
          "success",
          2000
        );
        setTimeout(() => {
          window.location.href = "fase2-escape.html";
        }, 2000);
      }

      function getFinalLevel() {
        const score = gameState.score;
        if (score >= 130) return "Detetive Master";
        if (score >= 110) return "Detetive Especialista";
        if (score >= 90) return "Detetive Proficiente";
        if (score >= 70) return "Detetive Competente";
        return "Detetive Iniciante";
      }

      // Resto das funções originais mantidas...
      // (Por brevidade, não incluí todas aqui, mas seriam copiadas da versão original)

      function changeState(newState) {
        // Esconder todos os estados
        document.querySelectorAll(".state").forEach((state) => {
          state.classList.remove("active");
        });

        // Mostrar novo estado
        document.getElementById(`state-${newState}`).classList.add("active");

        gameState.currentState = newState;
        updateProgress();

        // Atualizar contador de puzzle
        const puzzleMap = {
          reception: 1,
          conversa: 2,
          analise: 3,
          documentacao: 4,
          avaliacao: 5,
        };

        if (puzzleMap[newState]) {
          updatePuzzleCounter(puzzleMap[newState]);
        }
      }

      function updateProgress() {
        const states = [
          "inicio",
          "reception",
          "conversa",
          "analise",
          "documentacao",
          "avaliacao",
          "conclusao",
        ];
        const currentIndex = states.indexOf(gameState.currentState);
        const progress = (currentIndex / (states.length - 1)) * 100;

        document.getElementById("progress").style.width = progress + "%";
      }

      function nextState() {
        const states = [
          "inicio",
          "reception",
          "conversa",
          "analise",
          "documentacao",
          "avaliacao",
          "conclusao",
        ];
        const currentIndex = states.indexOf(gameState.currentState);
        const nextState = states[currentIndex + 1];

        if (nextState) {
          changeState(nextState);

          // Inicializar estado específico
          switch (nextState) {
            case "conversa":
              showDialogue();
              break;
            case "analise":
              initAnalysis();
              break;
            case "documentacao":
              initDocumentation();
              break;
            case "conclusao":
              showConclusion();
              break;
          }
        }
      }

      // ===== PUZZLE 1: RECEPTION DESK MYSTERY IMPLEMENTATION =====

      let receptionState = {
        cluesFound: 0,
        requiredClues: 6, // All visible objects (including coffee)
        energyLevel: 50,
        investigatedObjects: new Set(),
        unlockedObjects: new Set(), // Track objects that are successfully unlocked
        discoveredClues: [],
        bonusEarned: false,
        contextPhase: "preparation", // preparation -> investigation -> completion
      };

      // Reception puzzle clues data - WITH DISCOVERABLE CLUES EMBEDDED
      const receptionClues = {
        // STARTER CLUE - Always available, contains clue for first code
        computer: {
          title: "Agendamento da Felisbina",
          content:
            "📅 <strong>Consulta agendada:</strong> Felisbina Santos, 56 anos, 9º ano escolaridade<br>🔍 <strong>Motivo:</strong> Avaliação DLD – Primeiro atendimento<br>📝 <strong>Observações:</strong> Cliente nervosa, menciona dependência do pai frequentemente<br>🏠 <strong>Habitação:</strong> Vive sozinha numa pensão<br><br>💰 <strong>Benefício Ativo:</strong> <span style='color: #e74c3c; font-weight: bold;'>RSI</span> desde Março <span style='color: #e74c3c; font-weight: bold;'>2025</span><br><br>🔑 <em>Para acessar os arquivos dos beneficiários, use o código do benefício + ano</em>",
          discovered: false,
          required: true,
          unlockRequirement: null, // Always available
          requiresCodeEntry: true,
          expectedCode: "RSI2025",
          hint: "Benefício + Ano visível no ecrã do computador",
          unlocksAccess: ["cabinet"],
        },

        // UNLOCKED BY: RSI2025 - Contains clue for next code
        cabinet: {
          title: "Pasta de Beneficiários",
          content:
            "📂 <strong>Felisbina Santos - Dados Oficiais:</strong><br>💰 <strong>RSI:</strong> Ativo desde Março 2025 (valor: 253.20€)<br>💊 <strong>PSI:</strong> Prestação Social para Inclusão<br>🏠 <strong>Morada:</strong> Pensão - Rua da Esperança, nº 45<br>📊 <strong>Gestão Financeira:</strong> Anteriormente pelo irmão, agora independente<br><br>📋 <strong>Nota anexa:</strong> <em>\"Para orientação técnica, contactar linha de <span style='color: #27ae60; font-weight: bold;'>APOIO</span> - Extensão <span style='color: #27ae60; font-weight: bold;'>123</span>\"</em><br><br>🔑 <em>Use o contacto de apoio para aceder ao telefone</em>",
          discovered: false,
          required: true,
          unlockRequirement: "RSI2025",
          requiresCodeEntry: true,
          expectedCode: "APOIO123",
          hint: "Linha de contacto indicada na nota (palavra + número)",
          unlocksAccess: ["phone"],
        },

        // UNLOCKED BY: APOIO123 - Contains clue for next code
        phone: {
          title: "Chamada de Apoio Técnico",
          content:
            "📞 <strong>Conversa com colega experiente:</strong><br>👥 'A Felisbina precisa de abordagem empática e cuidadosa'<br>💡 'Atenção: dependência emocional do progenitor pode afetar autonomia'<br>✅ 'Ponto forte: 6 meses experiência como empregada de limpeza'<br>⚠️ 'Situação familiar: ruptura recente com irmão que geria finanças'<br><br>📋 'Para consultares as <span style='color: #8e44ad; font-weight: bold;'>NOTAS</span> anteriores, usa o código do ano passado: <span style='color: #8e44ad; font-weight: bold;'>2024</span>'<br><br>🔑 <em>O colega deu-te o código das notas anteriores</em>",
          discovered: false,
          required: true,
          unlockRequirement: "APOIO123",
          requiresCodeEntry: true,
          expectedCode: "NOTAS2024",
          hint: "Palavra + ano mencionados pelo colega na chamada",
          unlocksAccess: ["clipboard"],
        },

        // UNLOCKED BY: NOTAS2024 - Contains clue for next code
        clipboard: {
          title: "Notas dos Técnicos Anteriores",
          content:
            "📋 <strong>Avaliação técnica anterior:</strong><br>😟 <strong>Dependência Emocional:</strong> 'Elevada dependência emocional do progenitor'<br>💼 <strong>Experiência Profissional:</strong> '6 meses como empregada de limpeza'<br>⚠️ <strong>Situação Familiar:</strong> 'Ruptura recente com irmão responsável por finanças'<br>📈 <strong>Potencial:</strong> 'Disponibilidade alta, capacidade boa com formação'<br><br>🔐 <strong>Código de arquivo:</strong> <em>\"Protocolo <span style='color: #d35400; font-weight: bold;'>DLD</span> ano <span style='color: #d35400; font-weight: bold;'>2025</span> - usar para aceder aos procedimentos\"</em><br><br>🔑 <em>O código do protocolo atual está nas notas</em>",
          discovered: false,
          required: true,
          unlockRequirement: "NOTAS2024",
          requiresCodeEntry: true,
          expectedCode: "DLD2025",
          hint: "Protocolo + ano mencionados nas notas arquivadas",
          unlocksAccess: ["board"],
        },

        // FINAL CLUE - Contains obvious final code
        board: {
          title: "Procedimentos SAASI - Protocolo DLD",
          content:
            "📌 <strong>Protocolo Avaliação DLD 2025:</strong><br>1️⃣ <strong>Disponibilidade:</strong> Avaliar impedimentos para trabalho<br>2️⃣ <strong>Capacidade:</strong> Analisar competências e necessidades formação<br>3️⃣ <strong>Fatores:</strong> Identificar risco/proteção<br>4️⃣ <strong>Plano:</strong> Definir acompanhamento personalizado<br><br>✅ <strong>Perfil Felisbina:</strong> Disponível, capacidade boa c/ formação<br><br>🚪 <strong>Próximo passo:</strong> <em>\"Dirigir-se à sala de <span style='color: #c0392b; font-weight: bold;'>REUNIÃO</span> para iniciar avaliação formal\"</em><br><br>🔑 <em>A palavra para a próxima sala está destacada</em>",
          discovered: false,
          required: true,
          unlockRequirement: "DLD2025",
          requiresCodeEntry: true,
          expectedCode: "REUNIÃO",
          hint: "Tipo de sala mencionado nas instruções finais",
          unlocksAccess: ["meeting-door"],
        },

        // ALTERNATIVE ROUTE - Coffee with helpful hint
        coffee: {
          title: "Bem-estar no Trabalho Social",
          content:
            "☕ <strong>Máquina de café:</strong><br>💪 <strong>Energia aumentada!</strong> (+30 energia)<br>🧠 <strong>Foco melhorado</strong> para investigação complexa<br>💡 <strong>Dica profissional:</strong> Cuidar do bem-estar é essencial no trabalho social!<br><br>🔍 <strong>Dica de investigação:</strong> <em>Procure por palavras destacadas e números nos documentos - são pistas importantes!</em><br><br>⚡ <em>Energia alta ajuda na concentração e foco!</em>",
          discovered: false,
          required: true,
          unlockRequirement: null,
          energyBoost: 30,
          requiresCodeEntry: false,
          unlocksAccess: [],
        },
      };

      function initReceptionPuzzle() {
        updateReceptionMetrics();
        showToast(
          "🔍 Explore o escritório! Clique nos objetos para descobrir pistas sobre a Felisbina.",
          "info",
          5000
        );

        // Show helpful instructions after a moment
        setTimeout(() => {
          showToast(
            "💡 DICA: Procure por palavras destacadas e números nos documentos - são códigos importantes!",
            "info",
            6000
          );
        }, 3000);
      }

      function investigateObject(objectId) {
        const clue = receptionClues[objectId];

        if (!clue) {
          showToast("❌ Objeto não encontrado!", "error", 4000);
          return;
        }

        // Check if this object is already unlocked (successfully completed)
        if (
          receptionState.unlockedObjects &&
          receptionState.unlockedObjects.has(objectId)
        ) {
          showToast("✅ Este objeto já foi desbloqueado!", "info", 4000);
          return;
        }

        // Check if this clue can be investigated now (proper order)
        if (!canInvestigateClue(clue)) {
          return;
        }

        // Don't mark as investigated yet - only when successfully unlocked

        // Show investigation result
        showInvestigationResult(clue);

        // Handle clue discovery - only for objects that don't require codes
        if (!clue.requiresCodeEntry) {
          // For objects like coffee that don't need codes, discover immediately
          if (!clue.discovered) {
            clue.discovered = true;

            // Mark as unlocked since no code is needed
            receptionState.unlockedObjects.add(objectId);
            receptionState.investigatedObjects.add(objectId);

            // Count clues and update discovery list
            if (clue.required) {
              receptionState.cluesFound++;
              receptionState.discoveredClues.push(clue);
            } else {
              receptionState.discoveredClues.push({ ...clue, optional: true });
            }

            // Enhanced scoring for puzzle solving
            if (clue.required) {
              addScore(15); // Points for required clue discovery
            } else {
              addScore(10); // Bonus points for optional clues
            }

            // Handle special cases (like coffee energy boost)
            if (objectId === "coffee" && clue.energyBoost) {
              receptionState.energyLevel = Math.min(
                100,
                receptionState.energyLevel + clue.energyBoost
              );
              addBonusPoints(5, "Bem-estar no trabalho!");
              showToast(
                "☕ Energia renovada! Agora pode acessar mais objetos!",
                "success",
                3000
              );
            }

            // Update UI
            updateCluesList();
            markObjectAsInvestigated(objectId);
            showClueIndicator(objectId);

            // Show discovery feedback
            showToast(
              `🎉 ${
                clue.required ? "Informação essencial" : "Bonus"
              } descoberta!`,
              "success",
              3000
            );

            // Direct unlock for items that don't need code entry
            if (clue.unlocksAccess && clue.unlocksAccess.length > 0) {
              unlockNewObjects(clue);
            }

            // Check if puzzle is complete after clue discovery
            updateReceptionMetrics();
            checkPuzzleCompletion();
          }
        } else {
          // For objects that require code entry, just show the prompt
          // Don't discover the clue until code is correctly entered
          setTimeout(async () => {
            await showCodeEntryPrompt(clue, objectId);
          }, 1000);
        }
      }

      function canInvestigateClue(clue) {
        // Objects without unlock requirements are always available
        if (!clue.unlockRequirement) {
          return true;
        }

        // Initialize codes if not exists
        if (!receptionState.codesDiscovered) {
          receptionState.codesDiscovered = [];
        }

        // Check if we have the required code (entered successfully)
        if (receptionState.codesDiscovered.includes(clue.unlockRequirement)) {
          return true;
        }

        // Special energy-based unlocks (alternative paths)
        if (
          clue.unlockRequirement === "NOTAS2024" &&
          receptionState.energyLevel >= 70
        ) {
          showToast(
            "🔥 Energia alta permite acesso direto às notas!",
            "info",
            2000
          );
          return true;
        }

        // Show appropriate unlock hint
        const unlockHints = {
          RSI2025:
            "Precisa inserir código de acesso aos arquivos (computador primeiro)",
          APOIO123:
            "Precisa inserir código de contacto (pasta de beneficiários primeiro)",
          NOTAS2024:
            "Precisa inserir código das notas OU energia ≥70 (tente o café!)",
          DLD2025:
            "Precisa inserir código do protocolo (notas dos técnicos primeiro)",
        };

        const hint = unlockHints[clue.unlockRequirement] || "Objeto bloqueado";
        showToast(`🔒 ${hint}`, "warning", 3000);
        return false;
      }

      function unlockNewObjects(discoveredClue) {
        if (discoveredClue.unlocksAccess) {
          const newlyUnlocked = discoveredClue.unlocksAccess.filter((objId) => {
            const targetClue = receptionClues[objId];
            return (
              targetClue &&
              !targetClue.discovered &&
              !receptionState.investigatedObjects.has(objId)
            );
          });

          if (newlyUnlocked.length > 0) {
            const objectNames = {
              cabinet: "Arquivo",
              phone: "Telefone",
              clipboard: "Prancheta",
              board: "Quadro de Procedimentos",
              "meeting-door": "Sala de Reunião",
            };

            const unlockedNames = newlyUnlocked
              .map((id) => objectNames[id] || id)
              .join(", ");
            showToast(
              `🔓 Novo acesso desbloqueado: ${unlockedNames}!`,
              "info",
              4000
            );

            // Visual feedback - highlight newly unlocked objects
            highlightUnlockedObjects(newlyUnlocked);
          }
        }
      }

      function highlightUnlockedObjects(objectIds) {
        objectIds.forEach((objectId) => {
          const element = document.querySelector(
            `[onclick="investigateObject('${objectId}')"]`
          );
          if (element) {
            element.style.animation = "pulse 2s ease-in-out 3";
            element.style.border = "2px solid #4caf50";
            setTimeout(() => {
              element.style.animation = "";
              element.style.border = "";
            }, 6000);
          }
        });
      }

      function updateContextPhase() {
        // Simplified context phase based on codes discovered
        const codes = receptionState.codesDiscovered || [];

        if (
          codes.length >= 2 &&
          receptionState.contextPhase === "preparation"
        ) {
          receptionState.contextPhase = "investigation";
          showToast("🔄 Investigação aprofundada desbloqueada!", "info", 3000);
        } else if (
          codes.length >= 4 &&
          receptionState.contextPhase === "investigation"
        ) {
          receptionState.contextPhase = "completion";
          showToast(
            "🎯 Fase final! Todos os códigos revelam o caminho.",
            "info",
            3000
          );
        }
      }

      function showInvestigationResult(clue) {
        const panel = document.getElementById("investigation-content");

        let content = `
          <div style="border-left: 4px solid #3498db; padding-left: 15px;">
            <h5 style="color: #2c3e50; margin: 0 0 10px 0;">${clue.title}</h5>
            <div style="line-height: 1.6;">${clue.content}</div>
        `;

        // Show next action hint
        if (clue.requiresCodeEntry) {
          content += `
            <div style="margin-top: 15px; background: #fff3e0; padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <strong>🔑 Próximo passo:</strong> Inserir código para desbloquear acesso<br>
              <small style="color: #e67e22; margin-top: 5px; display: block;">💡 ${clue.hint}</small>
            </div>
          `;
        } else if (clue.unlocksAccess && clue.unlocksAccess.length > 0) {
          const objectNames = {
            cabinet: "🗄️ Arquivo",
            phone: "📞 Telefone",
            clipboard: "📋 Prancheta",
            board: "📌 Quadro de Procedimentos",
            "meeting-door": "🚪 Sala de Reunião",
          };
          const unlockNames = clue.unlocksAccess
            .map((id) => objectNames[id] || id)
            .join(", ");
          content += `
            <div style="margin-top: 10px; background: #e8f5e8; padding: 10px; border-radius: 5px; border-left: 4px solid #4caf50;">
              <strong>✅ Acesso direto desbloqueado:</strong> ${unlockNames}
            </div>
          `;
        }

        content += `</div>`;
        panel.innerHTML = content;
      }

      async function showCodeEntryPrompt(clue, objectId) {
        const promptMessage =
          `🔐 <strong>CÓDIGO NECESSÁRIO</strong><br><br>` +
          `📋 <strong>Objeto:</strong> ${clue.title}<br>` +
          `💡 <strong>Dica:</strong> ${clue.hint}<br><br>` +
          `Digite o código para desbloquear:`;

        const code = await customDialog.prompt(
          promptMessage,
          "Código de Acesso"
        );

        if (code === null || code === undefined) {
          // User cancelled or invalid input
          showToast("❌ Entrada de código cancelada", "warning", 4000);
          return;
        }

        // Convert to string and trim whitespace to handle any input type
        const userCode = String(code).trim();
        const expectedCode = String(clue.expectedCode).trim();

        if (userCode.toUpperCase() === expectedCode.toUpperCase()) {
          // Correct code!
          if (!receptionState.codesDiscovered) {
            receptionState.codesDiscovered = [];
          }
          receptionState.codesDiscovered.push(clue.expectedCode);

          addScore(20); // Bonus points for correct code entry
          showToast(`🎉 Código correto! Acesso desbloqueado!`, "success", 3000);

          // Mark this object as properly unlocked
          receptionState.unlockedObjects.add(objectId);
          receptionState.investigatedObjects.add(objectId);

          // Handle clue discovery (moved from investigateObject)
          if (!clue.discovered) {
            clue.discovered = true;

            // Count clues and update discovery list
            if (clue.required) {
              receptionState.cluesFound++;
              receptionState.discoveredClues.push(clue);
            } else {
              receptionState.discoveredClues.push({ ...clue, optional: true });
            }

            // Enhanced scoring for puzzle solving (additional points for successful unlock)
            if (clue.required) {
              addScore(15); // Points for required clue discovery
            } else {
              addScore(10); // Bonus points for optional clues
            }

            // Update UI after successful code entry
            updateCluesList();
            markObjectAsInvestigated(objectId);
            showClueIndicator(objectId);

            // Show discovery feedback
            showToast(
              `🎉 ${
                clue.required ? "Informação essencial" : "Bonus"
              } descoberta!`,
              "success",
              3000
            );
          }

          // Unlock new objects
          unlockNewObjects(clue);

          // Check if puzzle is complete after successful unlock
          updateReceptionMetrics();
          checkPuzzleCompletion();
        } else {
          // Wrong code
          showToast(
            `❌ Código incorreto: "${userCode}". Tente novamente!`,
            "error",
            3000
          );

          // Allow retry after delay
          setTimeout(async () => {
            const retry = await customDialog.confirm(
              `💡 <strong>Código incorreto!</strong><br><br>` +
                `<strong>Código inserido:</strong> "${userCode}"<br>` +
                `<strong>Dica:</strong> ${clue.hint}<br><br>` +
                `Deseja tentar novamente?`,
              "🔐 Código Incorreto"
            );
            if (retry) {
              await showCodeEntryPrompt(clue, objectId);
            }
          }, 1000);
        }
      }

      function updateCluesList() {
        const cluesList = document.getElementById("clues-list");

        if (receptionState.discoveredClues.length === 0) {
          cluesList.innerHTML =
            '<p style="font-style: italic; color: #666;">Nenhuma pista descoberta ainda...</p>';
          return;
        }

        cluesList.innerHTML = receptionState.discoveredClues
          .map(
            (clue, index) => `
          <div style="background: ${
            clue.optional ? "#fff3e0" : "#e8f5e8"
          }; margin: 10px 0; padding: 12px; border-radius: 8px; border-left: 4px solid ${
              clue.optional ? "#ff9800" : "#4caf50"
            };">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <strong>${clue.optional ? "🎁" : index + 1 + "."} ${
              clue.title
            }</strong>
              <span style="background: ${
                clue.optional ? "#ff9800" : "#4caf50"
              }; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${
              clue.optional ? "Bonus" : "+10 pts"
            }</span>
            </div>
            <div style="margin-top: 8px; font-size: 14px; color: #2c3e50;">${
              clue.content
            }</div>
          </div>
        `
          )
          .join("");
      }

      function markObjectAsInvestigated(objectId) {
        const object = document.getElementById(
          objectId === "computer"
            ? "computer-screen"
            : objectId === "cabinet"
            ? "file-cabinet"
            : objectId === "coffee"
            ? "coffee-machine"
            : objectId === "phone"
            ? "office-phone"
            : objectId === "board"
            ? "notice-board"
            : objectId
        );

        if (object) {
          object.style.opacity = "0.7";
          object.style.transform = "scale(0.95)";
          object.style.cursor = "default";
          object.style.border = "3px solid #4caf50";
        }
      }

      function showClueIndicator(objectId) {
        const indicator = document.getElementById(`${objectId}-clue`);
        if (indicator) {
          indicator.classList.remove("hidden");
          indicator.style.display = "flex";
        }
      }

      function updateReceptionMetrics() {
        // Fix: Only count required clues, cap at maximum
        const actualCluesFound = Math.min(
          receptionState.cluesFound,
          receptionState.requiredClues
        );
        document.getElementById("clues-found").textContent = actualCluesFound;
        document.getElementById("energy-level").textContent =
          receptionState.energyLevel;

        // Fix: Cap progress at 100%
        const progress = Math.min(
          100,
          Math.round((actualCluesFound / receptionState.requiredClues) * 100)
        );
        document.getElementById("puzzle1-progress").textContent = progress;
      }

      function checkPuzzleCompletion() {
        if (receptionState.cluesFound >= receptionState.requiredClues) {
          // Unlock meeting room
          const meetingDoor = document.getElementById("meeting-door");
          meetingDoor.style.background = "#4caf50";
          meetingDoor.style.cursor = "pointer";
          meetingDoor.style.opacity = "1";
          meetingDoor.style.transform = "scale(1.05)";
          meetingDoor.innerHTML = `
            <div style="font-size: 30px;">🚪</div>
            <div style="font-weight: bold; margin-top: 5px; color: white;">Sala de Reunião</div>
            <div style="font-size: 12px; color: #e8f8e8;">🔓 Desbloqueada!</div>
          `;

          // Add click handler to the meeting door
          meetingDoor.onclick = function () {
            showToast("🚪 Entrando na Sala de Reunião...", "info", 2000);
            setTimeout(() => {
              nextState(); // Go to conversa (Puzzle 2)
            }, 1000);
          };

          // Hide the redundant button since the door itself is now clickable
          document.getElementById("next-reception").style.display = "none";

          // Visual energy cost for completing puzzle (cosmetic only)
          if (receptionState.energyLevel > 20) {
            receptionState.energyLevel = Math.max(
              20,
              receptionState.energyLevel - 15
            );
            showToast("⚡ Energia gasta na investigação (-15)", "info", 3000);
            updateReceptionMetrics();
          }

          // Time bonus
          const elapsedMinutes =
            (Date.now() - escapeRoomState.startTime) / 60000;
          if (elapsedMinutes <= 2 && !receptionState.bonusEarned) {
            addBonusPoints(15, "Investigação rápida!");
            receptionState.bonusEarned = true;
          }

          showToast(
            "🎉 Puzzle completado! Todas as pistas descobertas!",
            "success",
            4000
          );
          setTimeout(() => {
            showToast(
              "🚪 A sala de reunião foi desbloqueada! Pode prosseguir.",
              "info",
              3000
            );
          }, 2000);
        }
      }

      // ===== PUZZLE 2: CONVERSATION CARDS IMPLEMENTATION =====

      let conversationState = {
        currentQuestionIndex: 0,
        questionsCompleted: 0,
        totalQuestions: 5,
        usedResponses: new Set(),
        selectedCard: null,
        cardInteractionCount: 0,
        perfectEmpathyResponses: 0,
        perfectInfoResponses: 0,
        completionTime: null,
        dragMode: "desktop", // 'desktop' or 'mobile'
      };

      function showDialogue() {
        updatePuzzleCounter(2);
        resetConversationState();
        setupMobileToggle();

        // Initialize the card game system
        initializeCardGame();
        setupTopicDropZone();
        generateTopicCards();

        showToast(
          "🗣️ Comece a conversa! Arraste um tópico do baralho para iniciar a conversa.",
          "info",
          6000
        );

        setTimeout(() => {
          showToast(
            "💡 DICA: Observe as expressões da Felisbina - ela reage às suas respostas!",
            "info",
            5000
          );
        }, 3000);
      }

      function resetConversationState() {
        conversationState = {
          currentQuestionIndex: 0,
          questionsCompleted: 0,
          totalQuestions: dialogueData.length,
          usedResponses: new Set(),
          selectedCard: null,
          cardInteractionCount: 0,
          perfectEmpathyResponses: 0,
          perfectInfoResponses: 0,
          completionTime: Date.now(),
          dragMode: window.innerWidth <= 768 ? "mobile" : "desktop",
        };
      }

      function setupMobileToggle() {
        const mobileButton = document.querySelector(".mobile-mode-button");
        const modeText = document.getElementById("mode-text");

        if (window.innerWidth <= 768) {
          conversationState.dragMode = "mobile";
          if (modeText) modeText.textContent = "Modo Toque Ativo";
          if (mobileButton) mobileButton.style.background = "#4caf50";
        } else {
          conversationState.dragMode = "desktop";
          if (modeText) modeText.textContent = "Modo Arrastar";
          if (mobileButton) mobileButton.style.background = "#2196f3";
        }
      }

      function toggleMobileMode() {
        const modeText = document.getElementById("mode-text");
        const mobileButton = document.querySelector(".mobile-mode-button");

        if (conversationState.dragMode === "desktop") {
          conversationState.dragMode = "mobile";
          if (modeText) modeText.textContent = "Modo Toque Ativo";
          if (mobileButton) mobileButton.style.background = "#4caf50";
          showToast(
            "📱 Modo Toque ativado! Toque na carta e depois na zona de conversa.",
            "info",
            4000
          );
        } else {
          conversationState.dragMode = "desktop";
          if (modeText) modeText.textContent = "Modo Arrastar";
          if (mobileButton) mobileButton.style.background = "#2196f3";
          showToast(
            "🖱️ Modo Arrastar ativado! Arraste as cartas para a zona de conversa.",
            "info",
            4000
          );
        }
      }

      function getCardSuitability(option) {
        const empathy = option.empathy || 0;
        const info = option.info || 0;

        if (empathy >= 7 && info >= 5) return "card-excellent";
        if (empathy >= 5 || info >= 6) return "card-good";
        if (empathy >= 3 || info >= 4) return "card-adequate";
        return "card-poor";
      }

      function getCardTypeLabel(option) {
        const empathy = option.empathy || 0;
        const info = option.info || 0;

        if (empathy >= 7) return "Confortável";
        if (info >= 7) return "Informativa";
        if (empathy >= 5 && info >= 5) return "Equilibrada";
        if (empathy >= 4) return "Acolhedora";
        return "Direta";
      }

      function dragConversationCard(event) {
        if (conversationState.dragMode === "mobile") {
          event.preventDefault();
          return;
        }

        // Find the actual conversation card element (might be a child element)
        const cardElement = event.target.closest(".conversation-card");
        if (!cardElement) {
          console.error("Could not find conversation card element");
          return;
        }

        const cardData = {
          optionIndex: cardElement.dataset.optionIndex,
          empathy: cardElement.dataset.empathy,
          info: cardElement.dataset.info,
          code: cardElement.dataset.code,
          text: cardElement.querySelector(".card-text").textContent,
        };

        console.log("Dragging card data:", cardData);

        // Validate card data before setting transfer data
        if (!cardData.optionIndex && cardData.optionIndex !== "0") {
          console.error("Missing optionIndex on card element:", cardElement);
          showToast("❌ Erro na carta. Recarregue a página.", "error", 3000);
          return;
        }

        event.dataTransfer.setData("text/plain", JSON.stringify(cardData));
        cardElement.classList.add("dragging");
      }

      function selectConversationCard(cardElement) {
        // Remove previous selections
        document.querySelectorAll(".response-card").forEach((card) => {
          card.classList.remove("selected");
        });

        // Select this card
        cardElement.classList.add("selected");
        conversationState.selectedCard = {
          optionIndex: parseInt(cardElement.dataset.optionIndex),
          empathy: parseInt(cardElement.dataset.empathy),
          info: parseInt(cardElement.dataset.info),
          code:
            cardElement.dataset.code ||
            `response_${cardElement.dataset.optionIndex}`,
          text: cardElement
            .querySelector(".response-card-content")
            .textContent.trim(),
        };

        // Show preview in conversation zone
        showConversationPreview(conversationState.selectedCard);

        // Show instruction for mobile users
        showToast(
          "💬 Carta selecionada! Arraste para a zona de resposta ou toque na zona para confirmar.",
          "info",
          3000
        );
      }

      function handleConversationZoneClick() {
        if (
          conversationState.dragMode === "mobile" &&
          conversationState.selectedCard
        ) {
          confirmResponse();
        }
      }

      function dropConversationCard(event) {
        event.preventDefault();

        if (conversationState.dragMode === "mobile") {
          return; // Mobile mode uses click
        }

        try {
          const transferData = event.dataTransfer.getData("text/plain");
          console.log("Received transfer data:", transferData);

          if (!transferData) {
            throw new Error("No data transferred");
          }

          const cardData = JSON.parse(transferData);
          console.log("Parsed card data:", cardData);

          // Validate card data
          if (!cardData.optionIndex && cardData.optionIndex !== 0) {
            throw new Error("Invalid card data: missing optionIndex");
          }

          conversationState.selectedCard = cardData;

          showConversationPreview(cardData);

          // Auto-confirm for drag & drop
          setTimeout(() => {
            confirmResponse();
          }, 1000);
        } catch (error) {
          console.error("Drop error:", error);
          showToast(
            "❌ Erro ao processar a carta. Tente novamente.",
            "error",
            3000
          );
        }

        // Remove dragging class and drop zone highlighting
        document.querySelectorAll(".conversation-card").forEach((card) => {
          card.classList.remove("dragging");
        });
        document.querySelectorAll(".conversation-drop-zone").forEach((zone) => {
          zone.classList.remove("drag-over");
        });
      }

      function showConversationPreview(cardData) {
        // Show preview information in the response drop zone
        const dropZone = document.getElementById("response-drop-zone");
        if (dropZone) {
          const dropZoneText = dropZone.querySelector(".drop-zone-text");
          if (dropZoneText) {
            dropZoneText.innerHTML = `
              <strong>Resposta Selecionada:</strong><br>
              "${cardData.text}"<br>
              <small>❤️ ${cardData.empathy} | 📊 ${cardData.info}</small>
            `;
          }
          dropZone.classList.add("has-preview");
        }

        // Update Felisbina's expression preview
        updateFelisbinaExpressionPreview(cardData.empathy);
      }

      function updateFelisbinaExpressionPreview(empathyValue) {
        const avatar = document.getElementById("felisbina-avatar");
        const currentEmpathy = gameState.empathy + empathyValue;

        // Preview the expression change
        if (empathyValue >= 7) {
          avatar.textContent = "😊";
          avatar.className = "empathy-avatar happy preview";
        } else if (empathyValue >= 4) {
          avatar.textContent = "😐";
          avatar.className = "empathy-avatar neutral preview";
        } else {
          avatar.textContent = "😟";
          avatar.className = "empathy-avatar sad preview";
        }

        // Add a glow effect
        avatar.style.boxShadow = "0 0 20px rgba(102, 126, 234, 0.6)";

        setTimeout(() => {
          avatar.style.boxShadow = "none";
        }, 2000);
      }

      function confirmResponse() {
        if (!conversationState.selectedCard) {
          showToast("❌ Selecione uma carta primeiro!", "warning", 3000);
          return;
        }

        const cardData = conversationState.selectedCard;
        const responseKey = `q${conversationState.currentQuestionIndex}_opt${cardData.optionIndex}`;

        // Check for repetitive responses
        if (conversationState.usedResponses.has(responseKey)) {
          showToast(
            "⚠️ Já usou uma resposta similar! Tente variar as suas abordagens.",
            "warning",
            4000
          );
          return;
        }

        // Process the response
        processConversationResponse(cardData, responseKey);
      }

      function processConversationResponse(cardData, responseKey) {
        // Mark response as used
        conversationState.usedResponses.add(responseKey);
        conversationState.cardInteractionCount++;

        // Update game state
        gameState.empathy = Math.min(
          25,
          gameState.empathy + parseInt(cardData.empathy)
        );
        gameState.information = Math.min(
          100,
          gameState.information + parseInt(cardData.info)
        );
        gameState.interactions++;

        // Track perfect responses
        if (parseInt(cardData.empathy) >= 7)
          conversationState.perfectEmpathyResponses++;
        if (parseInt(cardData.info) >= 7)
          conversationState.perfectInfoResponses++;

        // Update UI
        updateFelisbinaAvatar();
        updateEmpathyDisplay();

        // Discover codes for hidden elements
        if (cardData.code) {
          discoverCode(cardData.code);
        }

        // Calculate response score
        const responseScore = calculateResponseScore(cardData);
        addScore(responseScore);

        // Show feedback animation
        showResponseFeedback(cardData);

        // Clear the current conversation and allow selecting new topic
        setTimeout(() => {
          clearCurrentConversation();
        }, 2500);
      }

      function calculateResponseScore(cardData) {
        const empathy = parseInt(cardData.empathy);
        const info = parseInt(cardData.info);
        let score = 0;

        // Base scoring from conversation scoring system in spec
        if (empathy >= 8) score += 15; // Excellent empathy
        else if (empathy >= 6) score += 12; // Good empathy
        else if (empathy >= 4) score += 8; // Adequate empathy
        else score += 4; // Poor empathy

        // Information bonus
        if (info >= 7) score += 5;
        if (info >= 5) score += 3;

        // Bonus for balanced responses
        if (empathy >= 5 && info >= 5) score += 3;

        return score;
      }

      function showResponseFeedback(cardData) {
        const empathy = parseInt(cardData.empathy);
        const info = parseInt(cardData.info);

        let feedbackMessage = "";
        let feedbackType = "info";

        if (empathy >= 8) {
          feedbackMessage =
            "❤️ Excelente empatia! A Felisbina sente-se compreendida.";
          feedbackType = "success";
        } else if (empathy >= 6) {
          feedbackMessage =
            "😊 Boa abordagem empática! Felisbina está mais confortável.";
          feedbackType = "success";
        } else if (empathy >= 4) {
          feedbackMessage =
            "😐 Resposta adequada, mas pode ser mais acolhedora.";
          feedbackType = "info";
        } else {
          feedbackMessage =
            "😟 Felisbina parece desconfortável. Tente ser mais acolhedor.";
          feedbackType = "warning";
        }

        if (info >= 7) {
          feedbackMessage += " 📊 Informação valiosa recolhida!";
        }

        showToast(feedbackMessage, feedbackType, 4000);
      }

      function updateEmpathyDisplay() {
        document.getElementById("empathy").textContent = gameState.empathy;
        document.getElementById("information").textContent = Math.round(
          gameState.information
        );
        document.getElementById("interactions").textContent =
          gameState.interactions;
      }

      function clearCurrentConversation() {
        // Reset current topic
        cardGameState.currentTopic = null;
        cardGameState.topicStartTime = null;

        // Clear the dialogue container content and reset to topic selection
        const container = document.getElementById("dialogue-container");
        if (container) {
          container.innerHTML = `
            <!-- Response Cards Area -->
            <div class="response-cards-area" id="response-cards-area">
              <div class="cards-instruction">
                Arraste um tópico do baralho para iniciar a conversa
              </div>
            </div>

            <!-- Drop Zone for Selected Response -->
            <div class="response-drop-zone" id="response-drop-zone">
              <div class="drop-zone-content">
                <div class="drop-zone-icon">🎯</div>
                <span class="drop-zone-text">Arraste sua resposta aqui</span>
              </div>
            </div>
          `;
        }

        // Reset conversation header
        const header = document.getElementById("current-topic-title");
        if (header) {
          header.textContent = "Selecione um tópico para começar";
        }

        // Regenerate topic cards to update visual states
        generateTopicCards();

        // Note: Completion check happens in addToConversationMemory after response is submitted
        showToast(
          `✅ Resposta registrada! Selecione outro tópico para continuar. (${cardGameState.completedTopics.size}/${topicCards.length} tópicos concluídos)`,
          "success",
          4000
        );
      }

      function completeConversationPuzzle() {
        conversationState.completionTime =
          Date.now() - conversationState.completionTime;
        const completionMinutes = Math.round(
          conversationState.completionTime / 60000
        );

        // Calculate final bonuses (this function calls addBonusPoints internally)
        calculateConversationBonuses(completionMinutes);

        // Show completion message
        const container = document.getElementById("dialogue-container");
        container.innerHTML = `
          <div class="puzzle-completion">
            <h3>🎉 Conversa Concluída!</h3>
            <div class="completion-stats">
              <div class="stat-item">
                <strong>Empatia Final:</strong> ${gameState.empathy}/25
                <div class="stat-bar">
                  <div class="stat-fill" style="width: ${
                    (gameState.empathy / 25) * 100
                  }%; background: #e91e63;"></div>
                </div>
              </div>
              <div class="stat-item">
                <strong>Informação Recolhida:</strong> ${Math.round(
                  gameState.information
                )}%
                <div class="stat-bar">
                  <div class="stat-fill" style="width: ${
                    gameState.information
                  }%; background: #2196f3;"></div>
                </div>
              </div>
              <div class="stat-item">
                <strong>Tempo:</strong> ${completionMinutes} minutos
              </div>
              <div class="stat-item">
                <strong>Variedade de Respostas:</strong> ${
                  conversationState.usedResponses.size
                }/${dialogueData.length * 3}
              </div>
            </div>
            <div class="felisbina-final-message">
              ${getFelisbinaFinalMessage()}
            </div>
          </div>
        `;

        // Mark puzzle as completed
        gameState.conversationCompleted = true;

        // Update score display immediately
        updateScoreDisplay();
        updateEmpathyDisplay();

        // Show next button
        const nextButton = document.getElementById("next-dialogue");
        if (nextButton) {
          nextButton.style.display = "block";
        }

        showToast(
          "✅ Puzzle 2 concluído! Clique no botão para avançar para a análise.",
          "success",
          5000
        );
      }

      function calculateConversationBonuses(completionMinutes) {
        // Speed bonus (under 3 minutes)
        if (completionMinutes <= 3) {
          addBonusPoints(15, "Velocidade na conversa!");
        }

        // Perfect empathy bonus (25/25 empathy)
        if (gameState.empathy >= 25) {
          addBonusPoints(30, "Empatia perfeita!");
        }

        // No repetition bonus (used all different response types)
        if (conversationState.usedResponses.size >= dialogueData.length * 0.8) {
          addBonusPoints(25, "Variedade de respostas!");
        }

        // Information target bonus (≥70% information)
        if (gameState.information >= 70) {
          if (gameState.information >= 85) {
            addBonusPoints(20, "Informação excelente!");
          } else {
            addBonusPoints(10, "Boa recolha de informação!");
          }
        }

        // Perfect information bonus (100% information)
        if (gameState.information >= 100) {
          addBonusPoints(50, "Informação perfeita!");
        }
      }

      function getFelisbinaFinalMessage() {
        const empathy = gameState.empathy;
        const info = gameState.information;

        if (empathy >= 20 && info >= 80) {
          return `
            <div class="felisbina-message excellent">
              <div class="avatar">😊</div>
              <div class="message">"Sinto-me muito compreendida e acolhida. Obrigada por me ouvir com tanta atenção. Estou pronta para trabalhar consigo."</div>
            </div>
          `;
        } else if (empathy >= 15 && info >= 60) {
          return `
            <div class="felisbina-message good">
              <div class="avatar">😌</div>
              <div class="message">"Foi uma conversa agradável. Sinto que me compreende e que quer ajudar-me."</div>
            </div>
          `;
        } else if (empathy >= 10) {
          return `
            <div class="felisbina-message adequate">
              <div class="avatar">😐</div>
              <div class="message">"Obrigada pela conversa. Espero que consiga ajudar-me com a minha situação."</div>
            </div>
          `;
        } else {
          return `
            <div class="felisbina-message poor">
              <div class="avatar">😟</div>
              <div class="message">"Bem... espero que as próximas conversas sejam mais... compreensivas."</div>
            </div>
          `;
        }
      }

      function cancelSelection() {
        // Clear selection
        document.querySelectorAll(".response-card").forEach((card) => {
          card.classList.remove("selected");
        });

        conversationState.selectedCard = null;

        // Hide preview
        const preview = document.getElementById("conversation-preview");
        if (preview) {
          preview.style.display = "none";
        }

        const zone = document.getElementById("response-drop-zone");
        if (zone) {
          zone.classList.remove("has-preview");
        }

        // Reset Felisbina avatar
        updateFelisbinaAvatar();

        showToast("✅ Seleção cancelada.", "info", 2000);
      }

      // ===== PUZZLE 3: EVIDENCE BOARD IMPLEMENTATION =====

      let evidenceState = {
        examinedEvidence: new Set(),
        categorizedEvidence: new Set(),
        selectedEvidence: null,
        connections: [],
        selectedForConnection: [],
        correctPlacements: 0,
        totalEvidence: 9,
        connectionPairs: [
          ["idade_avancada", "isolamento_social"],
          ["experiencia_trabalho", "motivacao_trabalho"],
          ["dependencia_emocional", "ruptura_familiar"],
        ],
      };

      const evidenceData = [
        // Risk Factors
        {
          id: "idade_avancada",
          type: "document",
          icon: "👵",
          title: "Idade 56 anos",
          category: "risk",
          analysis:
            "Estudos indicam menor taxa de sucesso em recolocação profissional após os 50 anos. Requer estratégias de apoio específicas.",
          points: 5,
          connections: ["isolamento_social"],
        },
        {
          id: "isolamento_social",
          type: "photo",
          icon: "🏠",
          title: "Vive sozinha numa pensão",
          category: "risk",
          analysis:
            "Rede de suporte social limitada após ruptura familiar. Situação habitacional precária pode afetar autoestima e motivação.",
          points: 8,
          connections: ["idade_avancada"],
        },
        {
          id: "dependencia_emocional",
          type: "document",
          icon: "👨‍👧",
          title: "Dependência emocional do pai",
          category: "risk",
          analysis:
            "Menciona sempre o pai nos atendimentos - pode limitar autonomia. Dependência excessiva pode impedir desenvolvimento de competências independentes.",
          points: 10,
          connections: ["ruptura_familiar"],
        },
        {
          id: "baixa_escolaridade",
          type: "document",
          icon: "📚",
          title: "9º ano - Limitação formativa",
          category: "risk",
          analysis:
            "Embora adequado para a época (1968), limita acesso a empregos que requerem qualificações superiores no mercado atual.",
          points: 6,
          connections: [],
        },
        {
          id: "ruptura_familiar",
          type: "document",
          icon: "💔",
          title: "Perda apoio do irmão",
          category: "risk",
          analysis:
            "Ruptura recente com irmão que geria finanças. Perda de suporte emocional e prático numa fase de vulnerabilidade.",
          points: 7,
          connections: ["dependencia_emocional"],
        },

        // Protection Factors
        {
          id: "experiencia_trabalho",
          type: "photo",
          icon: "🧹",
          title: "6 meses experiência em limpeza",
          category: "protection",
          analysis:
            "Demonstra capacidade de trabalho e competências transferíveis. Experiência recente comprova aptidão laboral.",
          points: 12,
          connections: ["motivacao_trabalho"],
        },
        {
          id: "educacao_adequada",
          type: "document",
          icon: "🎓",
          title: "9º ano (adequado para 1968)",
          category: "protection",
          analysis:
            "Educação representativa e adequada para a época de nascimento. Base educacional sólida para a geração.",
          points: 8,
          connections: [],
        },
        {
          id: "beneficios_ativos",
          type: "document",
          icon: "💰",
          title: "RSI + PSI ativos",
          category: "protection",
          analysis:
            "Estabilidade financeira básica garantida durante período de transição. Apoio do Estado permite foco na reinserção.",
          points: 7,
          connections: [],
        },
        {
          id: "motivacao_trabalho",
          type: "document",
          icon: "💪",
          title: "Motivação para mudança",
          category: "protection",
          analysis:
            "Demonstra vontade de alteração da situação atual. Atitude proativa é fundamental para sucesso do acompanhamento.",
          points: 9,
          connections: ["experiencia_trabalho"],
        },
      ];

      function initAnalysis() {
        updatePuzzleCounter(3);
        resetEvidenceState();
        loadEvidenceGallery();

        // Show mobile helper on touch devices
        if (isTouchDevice()) {
          setTimeout(() => showMobileHelper(), 1000);
        }

        showToast(
          "🔍 Examine cada evidência com a lupa antes de categorizar!",
          "info",
          6000
        );

        setTimeout(() => {
          showToast(
            "💡 DICA: Procure conexões entre evidências relacionadas para pontos bonus!",
            "info",
            5000
          );
        }, 3000);
      }

      function resetEvidenceState() {
        evidenceState = {
          examinedEvidence: new Set(),
          categorizedEvidence: new Set(),
          selectedEvidence: null,
          connections: [],
          selectedForConnection: [],
          correctPlacements: 0,
          totalEvidence: evidenceData.length,
          connectionPairs: [
            ["idade_avancada", "isolamento_social"],
            ["experiencia_trabalho", "motivacao_trabalho"],
            ["dependencia_emocional", "ruptura_familiar"],
          ],
        };
      }

      function loadEvidenceGallery() {
        const grid = document.getElementById("evidence-grid");
        grid.innerHTML = "";

        evidenceData.forEach((evidence) => {
          const evidenceElement = document.createElement("div");
          evidenceElement.className = "evidence-item";
          evidenceElement.dataset.evidenceId = evidence.id;
          evidenceElement.dataset.category = evidence.category;
          evidenceElement.draggable = true;

          evidenceElement.innerHTML = `
            <div class="evidence-type-badge">${
              evidence.type === "photo" ? "FOTO" : "DOC"
            }</div>
            <div class="evidence-points">${evidence.points}pt</div>
            <div class="evidence-icon">${evidence.icon}</div>
            <div class="evidence-title">${evidence.title}</div>
          `;

          // Add click for examination
          evidenceElement.addEventListener("click", (e) => {
            if (e.target.closest(".evidence-action")) {
              return; // Let action button handle its own click
            }
            examineEvidence(evidence.id);
          });

          // Add double-tap/double-click for connection selection
          let clickCount = 0;
          evidenceElement.addEventListener("dblclick", (e) => {
            e.preventDefault();
            selectForConnection(evidence.id);
          });

          // Mobile touch selection for connections
          evidenceElement.addEventListener("touchstart", (e) => {
            clickCount++;
            if (clickCount === 1) {
              setTimeout(() => {
                if (clickCount === 1) {
                  examineEvidence(evidence.id);
                } else {
                  selectForConnection(evidence.id);
                }
                clickCount = 0;
              }, 300);
            }
          });
          evidenceElement.addEventListener("dragstart", (e) =>
            dragEvidenceStart(e)
          );
          evidenceElement.addEventListener("dragend", (e) =>
            dragEvidenceEnd(e)
          );

          grid.appendChild(evidenceElement);
        });

        updateEvidenceMetrics();
      }

      function examineEvidence(evidenceId) {
        const evidence = evidenceData.find((e) => e.id === evidenceId);
        if (!evidence) return;

        // Mark as examined
        evidenceState.examinedEvidence.add(evidenceId);

        // Update visual state
        const evidenceElement = document.querySelector(
          `[data-evidence-id="${evidenceId}"]`
        );
        evidenceElement.classList.add("examined");

        // Show in magnifier
        showEvidenceAnalysis(evidence);

        // Update metrics
        updateEvidenceMetrics();

        // Award points for examination
        addScore(2);
        showToast(`🔍 Evidência examinada: ${evidence.title}`, "success", 3000);
      }

      function showEvidenceAnalysis(evidence) {
        const magnifierContent = document.getElementById("magnifier-content");

        magnifierContent.innerHTML = `
          <div class="evidence-analysis">
            <div class="analysis-header">
              <span class="analysis-icon">${evidence.icon}</span>
              <span class="analysis-title">${evidence.title}</span>
            </div>
            <div class="analysis-category ${evidence.category}">
              ${
                evidence.category === "risk"
                  ? "⚠️ REQUER ATENÇÃO"
                  : "🛡️ ASPETO POSITIVO"
              }
            </div>
            <div class="analysis-text">${evidence.analysis}</div>
            <div style="margin-top: 10px;">
              <strong>Pontuação:</strong> ${evidence.points} pontos<br>
              <strong>Tipo:</strong> ${
                evidence.type === "photo"
                  ? "Evidência Fotográfica"
                  : "Documento Oficial"
              }
            </div>
            ${
              evidence.connections.length > 0
                ? `
              <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                <strong>💡 Dica:</strong> Esta evidência pode estar relacionada com outras do caso.
              </div>
            `
                : ""
            }
          </div>
        `;
      }

      function allowDrop(e) {
        e.preventDefault();

        // Add visual feedback when dragging over the drop zone
        const dropZone = e.target.closest(".conversation-drop-zone");
        if (dropZone) {
          dropZone.classList.add("drag-over");
        }
      }

      function dragLeave(e) {
        // Remove visual feedback when leaving the drop zone
        const dropZone = e.target.closest(".conversation-drop-zone");
        if (dropZone && !dropZone.contains(e.relatedTarget)) {
          dropZone.classList.remove("drag-over");
        }
      }

      function dragEvidenceStart(e) {
        const evidenceId = e.target.dataset.evidenceId;
        e.dataTransfer.setData("text/plain", evidenceId);
        e.target.style.opacity = "0.5";
      }

      function dragEvidenceEnd(e) {
        e.target.style.opacity = "1";
      }

      function dropEvidence(e) {
        e.preventDefault();
        const evidenceId = e.dataTransfer.getData("text/plain");
        const dropZone = e.currentTarget;
        const zoneType = dropZone.id.includes("risk") ? "risk" : "protection";

        categorizeEvidence(evidenceId, zoneType);
      }

      function handleEvidenceZoneClick(zoneType) {
        if (evidenceState.selectedEvidence) {
          categorizeEvidence(evidenceState.selectedEvidence, zoneType);
        }
      }

      function categorizeEvidence(evidenceId, zoneType) {
        const evidence = evidenceData.find((e) => e.id === evidenceId);
        if (!evidence) return;

        // Check if evidence was examined first
        if (!evidenceState.examinedEvidence.has(evidenceId)) {
          showToast(
            "❌ Examine a evidência com a lupa primeiro!",
            "warning",
            4000
          );
          return;
        }

        // Check if already categorized
        if (evidenceState.categorizedEvidence.has(evidenceId)) {
          showToast("⚠️ Esta evidência já foi categorizada!", "warning", 3000);
          return;
        }

        // Mark as categorized
        evidenceState.categorizedEvidence.add(evidenceId);

        // Check if correct category
        const isCorrect = evidence.category === zoneType;

        if (isCorrect) {
          evidenceState.correctPlacements++;
          addScore(evidence.points);
          showToast(`✅ Correto! +${evidence.points} pontos`, "success", 3000);
        } else {
          addScore(Math.max(1, Math.floor(evidence.points / 2))); // Partial points
          showToast(
            `❌ Categoria incorreta, mas +${Math.floor(
              evidence.points / 2
            )} pontos pelo esforço`,
            "warning",
            4000
          );
        }

        // Create evidence slot in the zone
        createEvidenceSlot(evidence, zoneType, isCorrect);

        // Update visual state
        const evidenceElement = document.querySelector(
          `[data-evidence-id="${evidenceId}"]`
        );
        evidenceElement.classList.add("categorized");

        // Update metrics
        updateEvidenceMetrics();

        // Check if connections system should be unlocked
        if (evidenceState.categorizedEvidence.size >= 6) {
          unlockConnectionSystem();
        }

        // Check completion
        checkEvidencePuzzleCompletion();
      }

      function createEvidenceSlot(evidence, zoneType, isCorrect) {
        const slotsContainer = document.getElementById(
          zoneType === "risk" ? "risk-slots" : "protection-slots"
        );

        const slot = document.createElement("div");
        slot.className = `evidence-slot ${isCorrect ? "correct" : "incorrect"}`;
        slot.dataset.evidenceId = evidence.id;

        slot.innerHTML = `
          <div style="font-size: 18px; margin-bottom: 5px;">${evidence.icon}</div>
          <div style="font-size: 10px; font-weight: bold;">${evidence.title}</div>
          <div style="font-size: 9px; color: #666; margin-top: 3px;">${evidence.points}pt</div>
        `;

        // Make clickable for connections
        slot.addEventListener("click", () => selectForConnection(evidence.id));

        slotsContainer.appendChild(slot);
      }

      function unlockConnectionSystem() {
        const connectionSystem = document.getElementById("connection-system");
        connectionSystem.style.display = "block";
        showToast(
          "🔗 Sistema de Conexões desbloqueado! Conecte evidências relacionadas.",
          "info",
          5000
        );
      }

      function selectForConnection(evidenceId) {
        const evidence = evidenceData.find((e) => e.id === evidenceId);

        if (evidenceState.selectedForConnection.includes(evidenceId)) {
          // Deselect
          evidenceState.selectedForConnection =
            evidenceState.selectedForConnection.filter(
              (id) => id !== evidenceId
            );
          document
            .querySelectorAll(`[data-evidence-id="${evidenceId}"]`)
            .forEach((el) => el.classList.remove("selected"));

          showToast(
            `❌ ${evidence.icon} ${evidence.title} desmarcado`,
            "info",
            2000
          );
        } else if (evidenceState.selectedForConnection.length < 2) {
          // Select
          evidenceState.selectedForConnection.push(evidenceId);
          document
            .querySelectorAll(`[data-evidence-id="${evidenceId}"]`)
            .forEach((el) => el.classList.add("selected"));

          showToast(
            `✅ ${evidence.icon} ${evidence.title} selecionado para conexão`,
            "success",
            2000
          );

          // If two selected, try to connect
          if (evidenceState.selectedForConnection.length === 2) {
            setTimeout(() => attemptConnection(), 500);
          }
        } else {
          showToast(
            "⚠️ Máximo de 2 evidências podem ser selecionadas! Clique numa selecionada para desmarcá-la.",
            "warning",
            4000
          );
        }

        // Update visual status
        updateConnectionStatus();
      }

      function updateConnectionStatus() {
        const statusText = document.querySelector(".status-text");
        const selectedItemsContainer =
          document.getElementById("selected-items");

        if (!statusText || !selectedItemsContainer) return;

        const selectedCount = evidenceState.selectedForConnection.length;

        if (selectedCount === 0) {
          statusText.textContent = "Selecione evidências para conectar";
          statusText.style.color = "#f57c00";
          selectedItemsContainer.innerHTML = "";
        } else if (selectedCount === 1) {
          statusText.textContent =
            "Selecione mais 1 evidência para fazer conexão";
          statusText.style.color = "#2196f3";
          updateSelectedItemsDisplay();
        } else if (selectedCount === 2) {
          statusText.textContent = "Verificando conexão...";
          statusText.style.color = "#4caf50";
          updateSelectedItemsDisplay();
        }
      }

      function updateSelectedItemsDisplay() {
        const selectedItemsContainer =
          document.getElementById("selected-items");
        if (!selectedItemsContainer) return;

        selectedItemsContainer.innerHTML = evidenceState.selectedForConnection
          .map((id) => {
            const evidence = evidenceData.find((e) => e.id === id);
            return `<div class="selected-item">${evidence.icon} ${evidence.title}</div>`;
          })
          .join("");
      }

      function attemptConnection() {
        const [id1, id2] = evidenceState.selectedForConnection;

        // Check if this is a valid connection
        const isValidConnection = evidenceState.connectionPairs.some(
          (pair) =>
            (pair[0] === id1 && pair[1] === id2) ||
            (pair[0] === id2 && pair[1] === id1)
        );

        if (isValidConnection) {
          // Add connection
          evidenceState.connections.push([id1, id2]);

          // Enhanced feedback
          const evidence1 = evidenceData.find((e) => e.id === id1);
          const evidence2 = evidenceData.find((e) => e.id === id2);

          addBonusPoints(15, "Conexão descoberta!");

          // Add to discovered connections display
          addConnectionDiscovery(evidence1, evidence2);

          // Draw connection line
          drawConnectionLine(id1, id2, true);

          // Mark evidence as connected
          document
            .querySelector(`[data-evidence-id="${id1}"]`)
            .classList.add("connected");
          document
            .querySelector(`[data-evidence-id="${id2}"]`)
            .classList.add("connected");

          showToast(
            `🔗 Conexão válida: ${evidence1.title} ↔ ${evidence2.title}`,
            "success",
            4000
          );
        } else {
          // Show attempted connection briefly
          drawConnectionLine(id1, id2, false);
          setTimeout(() => clearCanvas(), 2000);

          showToast(
            "❌ Estas evidências não estão relacionadas.",
            "error",
            3000
          );
        }

        // Clear selection
        evidenceState.selectedForConnection.forEach((id) => {
          document
            .querySelectorAll(`[data-evidence-id="${id}"]`)
            .forEach((element) => {
              element.classList.remove("selected");
            });
        });
        evidenceState.selectedForConnection = [];

        // Update visual status - force reset
        const statusText = document.querySelector(".status-text");
        if (statusText) {
          statusText.textContent = "Selecione evidências para conectar";
          statusText.style.color = "#f57c00";
        }
        const selectedItemsContainer =
          document.getElementById("selected-items");
        if (selectedItemsContainer) {
          selectedItemsContainer.innerHTML = "";
        }
        updateConnectionStatus();

        updateEvidenceMetrics();
        updateConnectionStats();
      }

      // Mobile Helper Functions
      function isTouchDevice() {
        return "ontouchstart" in window || navigator.maxTouchPoints > 0;
      }

      function showMobileHelper() {
        const helper = document.getElementById("mobile-helper");
        if (helper && !localStorage.getItem("puzzle3_helper_shown")) {
          helper.classList.add("show");
        }
      }

      function closeMobileHelper() {
        const helper = document.getElementById("mobile-helper");
        if (helper) {
          helper.classList.remove("show");
          localStorage.setItem("puzzle3_helper_shown", "true");
        }
      }

      function clearConnections() {
        evidenceState.connections = [];
        evidenceState.selectedForConnection = [];
        document.querySelectorAll(".evidence-slot.selected").forEach((slot) => {
          slot.classList.remove("selected");
        });
        updateEvidenceMetrics();
        showToast("🔗 Conexões limpas.", "info", 2000);
      }

      function showConnectionHints() {
        const hints = [
          "💡 A idade pode estar relacionada com a situação social",
          "💡 A experiência de trabalho conecta-se com a motivação",
          "💡 A dependência emocional relaciona-se com perdas familiares",
        ];

        hints.forEach((hint, index) => {
          setTimeout(() => {
            showToast(hint, "info", 4000);
          }, index * 1500);
        });
      }

      function updateEvidenceMetrics() {
        document.getElementById("evidence-examined").textContent =
          evidenceState.examinedEvidence.size;
        document.getElementById("evidence-categorized").textContent =
          evidenceState.categorizedEvidence.size;
        document.getElementById("connections-found").textContent =
          evidenceState.connections.length;
      }

      function checkEvidencePuzzleCompletion() {
        if (
          evidenceState.categorizedEvidence.size >= evidenceState.totalEvidence
        ) {
          // Calculate completion bonus
          const accuracyBonus = Math.round(
            (evidenceState.correctPlacements / evidenceState.totalEvidence) * 25
          );
          const connectionBonus = evidenceState.connections.length * 10;

          addBonusPoints(accuracyBonus, `Precisão na categorização!`);
          if (connectionBonus > 0) {
            addBonusPoints(connectionBonus, `Conexões descobertas!`);
          }

          showToast(
            "🎉 Puzzle 3 concluído! Investigação completa!",
            "success",
            5000
          );

          // Show next button
          document.getElementById("next-analysis").style.display = "block";
        }
      }

      function initDocumentation() {
        // Implementação da documentação (copiada da original)
        console.log("Initializing documentation...");
      }

      function showConclusion() {
        // Implementação da conclusão (adaptada para escape room)
        const timeUsed = escapeRoomState.startTime
          ? Math.round((Date.now() - escapeRoomState.startTime) / 60000)
          : 0;

        document.getElementById("final-score").textContent = gameState.score;
        document.getElementById(
          "time-used"
        ).textContent = `${timeUsed} minutos`;
        document.getElementById("final-level").textContent = getFinalLevel();

        // Calcular conquistas
        calculateAchievements(timeUsed);
      }

      function calculateAchievements(timeUsed) {
        const achievements = [];

        if (timeUsed <= 30)
          achievements.push(
            "⚡ Velocidade da Luz - Completou em menos de 30 minutos"
          );
        if (escapeRoomState.hiddenElementsFound >= 3)
          achievements.push(
            "🔍 Detetive Sherlock - Encontrou todos os elementos ocultos"
          );
        if (gameState.empathy >= 20)
          achievements.push(
            "❤️ Coração de Ouro - Máxima empatia com a Felisbina"
          );
        if (escapeRoomState.bonusPoints >= 30)
          achievements.push("🎯 Mestre dos Códigos - Desbloqueou muitos bonus");
        if (gameState.score >= 130)
          achievements.push("🏆 Perfeição Absoluta - Pontuação quase perfeita");

        const achievementsList = document.getElementById("achievements-list");
        if (achievements.length > 0) {
          achievementsList.innerHTML = achievements
            .map(
              (a) =>
                `<div style="margin: 10px 0; padding: 10px; background: #e8f5e8; border-radius: 5px;">${a}</div>`
            )
            .join("");
        } else {
          achievementsList.innerHTML =
            "<p>Nenhuma conquista especial desta vez. Tente novamente para desbloquear!</p>";
        }
      }

      function restartGame() {
        location.reload();
      }

      // ========================================
      // ASSESSMENT TERMINAL SYSTEM - PUZZLE 5
      // ========================================

      // Assessment Terminal State
      const assessmentTerminalState = {
        currentScreen: 1,
        selectedAvailability: null,
        selectedCapacity: null,
        validationCodes: {
          availability: {
            sim_total: "DISP_TOTAL_2025",
            sim_condicionada: "DISP_COND_2025",
            nao: "DISP_NEG_2025",
          },
          capacity: {
            sim_formacao: "CAP_FORM_2025",
            sim_plena: "CAP_PLENA_2025",
            nao: "CAP_NEG_2025",
          },
        },
        generatedCode: null,
        assessmentReport: null,
      };

      /**
       * Initialize Assessment Terminal when state-avaliacao is entered
       */
      function initializeAssessmentTerminal() {
        // Initialize timestamp
        updateTerminalTimestamp();
        setInterval(updateTerminalTimestamp, 1000);

        // Load DLD criteria data
        loadDLDCriteria();

        // Load balance scale factors
        loadBalanceFactors();

        // Set terminal status
        updateTerminalStatus("Sistema de Avaliação DLD carregado com sucesso");

        showToast("🖥️ Terminal de Avaliação DLD inicializado", "success", 3000);
      }

      /**
       * Update terminal timestamp
       */
      function updateTerminalTimestamp() {
        const timestamp = document.getElementById("terminal-timestamp");
        if (timestamp) {
          timestamp.textContent = new Date().toLocaleString("pt-PT");
        }
      }

      /**
       * Update terminal status message
       */
      function updateTerminalStatus(message) {
        const statusText = document.getElementById("terminal-status-text");
        if (statusText) {
          statusText.textContent = message;
        }
      }

      /**
       * Load DLD criteria into the dashboard
       */
      function loadDLDCriteria() {
        if (typeof AssessmentLogic !== "undefined") {
          const criteria = AssessmentLogic.generateDLDCriteria();
          const criteriaList = document.getElementById("dld-criteria-list");

          if (criteriaList) {
            criteriaList.innerHTML = Object.entries(criteria)
              .map(
                ([key, criterion]) => `
              <div class="criteria-item">
                <span class="criteria-status">${criterion.status}</span>
                <span class="criteria-text">${criterion.text}</span>
                ${
                  criterion.context
                    ? `<div class="criteria-context">${criterion.context}</div>`
                    : ""
                }
              </div>
            `
              )
              .join("");
          }
        }
      }

      /**
       * Load balance scale factors
       */
      function loadBalanceFactors() {
        // Availability factors
        const availabilityNegative = document.getElementById(
          "availability-negative-factors"
        );
        const availabilityPositive = document.getElementById(
          "availability-positive-factors"
        );

        if (availabilityNegative) {
          availabilityNegative.innerHTML = `
            • Dependência emocional identificada<br>
            • Ruptura familiar recente<br>
            • Idade como fator de risco (56 anos)
          `;
        }

        if (availabilityPositive) {
          availabilityPositive.innerHTML = `
            • Sem dependentes diretos<br>
            • Motivação para mudança demonstrada<br>
            • Horário flexível possível
          `;
        }

        // Capacity factors
        const capacityNegative = document.getElementById(
          "capacity-negative-factors"
        );
        const capacityPositive = document.getElementById(
          "capacity-positive-factors"
        );

        if (capacityNegative) {
          capacityNegative.innerHTML = `
            • Baixa qualificação formal<br>
            • Dependência emocional<br>
            • Isolamento social
          `;
        }

        if (capacityPositive) {
          capacityPositive.innerHTML = `
            • 6 meses experiência em limpeza<br>
            • 9º ano adequado para época<br>
            • Sem limitações físicas
          `;
        }
      }

      /**
       * Navigate between terminal screens
       */
      function proceedToScreen(screenNumber) {
        // Hide all screens
        for (let i = 1; i <= 4; i++) {
          const screen = document.getElementById(`terminal-screen-${i}`);
          if (screen) {
            screen.classList.remove("active");
          }
        }

        // Show target screen
        const targetScreen = document.getElementById(
          `terminal-screen-${screenNumber}`
        );
        if (targetScreen) {
          targetScreen.classList.add("active");
          assessmentTerminalState.currentScreen = screenNumber;

          // Update terminal status
          const screenNames = {
            1: "Dashboard de Critérios DLD",
            2: "Avaliação de Disponibilidade",
            3: "Avaliação de Capacidade",
            4: "Validação e Geração de Código",
          };

          updateTerminalStatus(`Ecrã ativo: ${screenNames[screenNumber]}`);
        }
      }

      /**
       * Select availability option in terminal interface
       */
      function selectAvailabilityTerminal(choice) {
        assessmentTerminalState.selectedAvailability = choice;

        // Remove selected class from all availability options
        document
          .querySelectorAll("#terminal-screen-2 .assessment-option")
          .forEach((option) => {
            option.classList.remove("selected");
          });

        // Add selected class to chosen option
        const selectedOption = document.querySelector(
          `#terminal-screen-2 .assessment-option[data-choice="${choice}"]`
        );
        if (selectedOption) {
          selectedOption.classList.add("selected");
        }

        // Update balance scale visualization
        updateBalanceScale("availability", choice);

        // Show next button
        const nextBtn = document.getElementById("proceed-to-capacity");
        if (nextBtn) {
          nextBtn.style.display = "block";
        }

        // Update game state for compatibility
        gameState.availability = choice;

        updateTerminalStatus(
          `Disponibilidade selecionada: ${choice
            .replace("_", " ")
            .toUpperCase()}`
        );
        showToast("✅ Disponibilidade avaliada", "success", 2000);
      }

      /**
       * Select capacity option in terminal interface
       */
      function selectCapacityTerminal(choice) {
        assessmentTerminalState.selectedCapacity = choice;

        // Remove selected class from all capacity options
        document
          .querySelectorAll("#terminal-screen-3 .assessment-option")
          .forEach((option) => {
            option.classList.remove("selected");
          });

        // Add selected class to chosen option
        const selectedOption = document.querySelector(
          `#terminal-screen-3 .assessment-option[data-choice="${choice}"]`
        );
        if (selectedOption) {
          selectedOption.classList.add("selected");
        }

        // Update balance scale visualization
        updateBalanceScale("capacity", choice);

        // Show next button
        const nextBtn = document.getElementById("proceed-to-validation");
        if (nextBtn) {
          nextBtn.style.display = "block";
        }

        // Update game state for compatibility
        gameState.capacity = choice;

        updateTerminalStatus(
          `Capacidade selecionada: ${choice.replace("_", " ").toUpperCase()}`
        );
        showToast("✅ Capacidade avaliada", "success", 2000);

        // Auto-proceed to validation after brief delay
        setTimeout(() => {
          proceedToScreen(4);
          generateAssessmentValidation();
        }, 1500);
      }

      /**
       * Update balance scale visual representation
       */
      function updateBalanceScale(type, choice) {
        const beam = document.getElementById(`${type}-beam`);
        if (!beam) return;

        // Remove existing tilt classes
        beam.classList.remove("tilt-left", "tilt-right");

        // Add appropriate tilt based on choice
        if (choice === "sim_total" || choice === "sim_formacao") {
          beam.classList.add("tilt-right"); // Positive factors win
        } else if (choice === "nao") {
          beam.classList.add("tilt-left"); // Negative factors win
        }
        // sim_condicionada/sim_plena stays balanced (no tilt)
      }

      /**
       * Generate assessment validation and code
       */
      function generateAssessmentValidation() {
        const availability = assessmentTerminalState.selectedAvailability;
        const capacity = assessmentTerminalState.selectedCapacity;

        if (!availability || !capacity) {
          showToast("❌ Selecione disponibilidade e capacidade", "error", 3000);
          return;
        }

        // Update decision summary
        updateDecisionSummary();

        // Generate validation results
        generateValidationResults();

        // Generate validation code
        generateValidationCode();

        // Generate assessment report
        generateFinalAssessmentReport();

        // Show finalize button
        const finalizeBtn = document.getElementById(
          "finalize-assessment-terminal"
        );
        if (finalizeBtn) {
          finalizeBtn.style.display = "block";
        }

        updateTerminalStatus("Validação completa - Pronto para finalizar");
      }

      /**
       * Update decision summary display
       */
      function updateDecisionSummary() {
        const availability = assessmentTerminalState.selectedAvailability;
        const capacity = assessmentTerminalState.selectedCapacity;

        // Update availability display
        const availabilityDisplay = document.getElementById(
          "final-availability-display"
        );
        const availabilityCode = document.getElementById(
          "final-availability-code"
        );

        if (availabilityDisplay && availabilityCode) {
          const availabilityTexts = {
            sim_total: "SIM - Total",
            sim_condicionada: "SIM - Condicionada",
            nao: "NÃO - Temporário",
          };

          availabilityDisplay.textContent = availabilityTexts[availability];
          availabilityCode.textContent =
            assessmentTerminalState.validationCodes.availability[availability];
        }

        // Update capacity display
        const capacityDisplay = document.getElementById(
          "final-capacity-display"
        );
        const capacityCodeEl = document.getElementById("final-capacity-code");

        if (capacityDisplay && capacityCodeEl) {
          const capacityTexts = {
            sim_formacao: "SIM - Com Formação",
            sim_plena: "SIM - Plena",
            nao: "NÃO - Temporário",
          };

          capacityDisplay.textContent = capacityTexts[capacity];
          capacityCodeEl.textContent =
            assessmentTerminalState.validationCodes.capacity[capacity];
        }
      }

      /**
       * Generate logic validation results
       */
      function generateValidationResults() {
        const availability = assessmentTerminalState.selectedAvailability;
        const capacity = assessmentTerminalState.selectedCapacity;

        const validationResults = document.getElementById("validation-results");
        if (!validationResults) return;

        let validationText = "";
        let isLogicallyConsistent = true;

        // Check for logical inconsistencies
        if (
          availability === "nao" &&
          (capacity === "sim_plena" || capacity === "sim_formacao")
        ) {
          validationText +=
            "⚠️ AVISO: Inconsistência detectada - Sem disponibilidade mas com capacidade\n";
          isLogicallyConsistent = false;
        }

        if (availability === "sim_total" && capacity === "nao") {
          validationText +=
            "⚠️ AVISO: Inconsistência detectada - Disponibilidade total mas sem capacidade\n";
          isLogicallyConsistent = false;
        }

        if (isLogicallyConsistent) {
          validationText +=
            "✅ VALIDAÇÃO APROVADA: Decisões logicamente consistentes\n";
          validationText +=
            "✅ CRITÉRIOS DLD: Todos os requisitos verificados\n";
          validationText +=
            "✅ JUSTIFICAÇÃO: Adequada para o perfil do beneficiário\n";
        } else {
          validationText +=
            "❌ VALIDAÇÃO FALHADA: Revise as decisões selecionadas\n";
        }

        // Add contextual validation
        if (typeof AssessmentLogic !== "undefined") {
          const validation = AssessmentLogic.validateAssessmentConsistency({
            availability: availability,
            capacity: capacity,
          });

          if (validation.warnings.length > 0) {
            validationText += "\n📋 OBSERVAÇÕES:\n";
            validation.warnings.forEach((warning) => {
              validationText += `• ${warning}\n`;
            });
          }
        }

        validationResults.textContent = validationText;
      }

      /**
       * Generate validation code
       */
      function generateValidationCode() {
        const availability = assessmentTerminalState.selectedAvailability;
        const capacity = assessmentTerminalState.selectedCapacity;

        const availCode =
          assessmentTerminalState.validationCodes.availability[availability];
        const capCode =
          assessmentTerminalState.validationCodes.capacity[capacity];

        // Generate unique validation code
        const timestamp = Date.now().toString().slice(-6);
        const validationCode = `${availCode}-${capCode}-${timestamp}`;

        assessmentTerminalState.generatedCode = validationCode;

        const codeDisplay = document.getElementById("generated-code");
        if (codeDisplay) {
          codeDisplay.textContent = validationCode;
        }
      }

      /**
       * Generate final assessment report
       */
      function generateFinalAssessmentReport() {
        const availability = assessmentTerminalState.selectedAvailability;
        const capacity = assessmentTerminalState.selectedCapacity;

        let report = "";

        if (typeof AssessmentLogic !== "undefined") {
          const decisions = { availability, capacity };
          const assessmentReport =
            AssessmentLogic.generateAssessmentReport(decisions);

          report += `RELATÓRIO DE AVALIAÇÃO DLD\n`;
          report += `========================\n\n`;
          report += `Beneficiário: Felisbina Maria Santos\n`;
          report += `Data: ${new Date().toLocaleDateString("pt-PT")}\n`;
          report += `Técnico: SAASI_USER\n\n`;

          report += `DECISÕES:\n`;
          report += `• Disponibilidade: ${assessmentReport.availability.justification}\n`;
          report += `• Capacidade: ${assessmentReport.capacity.justification}\n\n`;

          report += `AVALIAÇÃO GERAL:\n`;
          report += `• Pontuação: ${assessmentReport.overall.points}/${assessmentReport.overall.maxPoints}\n`;
          report += `• Qualidade: ${assessmentReport.overall.quality.toUpperCase()}\n`;
          report += `• Recomendação: ${assessmentReport.overall.recommendation}\n\n`;

          report += `OBSERVAÇÕES:\n`;
          report += `• ${assessmentReport.contextual_assessment.dld_status}\n`;
          report += `• ${assessmentReport.contextual_assessment.age_considerations}\n`;
        } else {
          // Fallback report if AssessmentLogic is not available
          report = `RELATÓRIO BÁSICO DE AVALIAÇÃO DLD\n`;
          report += `================================\n\n`;
          report += `Decisões registadas:\n`;
          report += `• Disponibilidade: ${availability}\n`;
          report += `• Capacidade: ${capacity}\n\n`;
          report += `Código de validação gerado: ${assessmentTerminalState.generatedCode}\n`;
        }

        assessmentTerminalState.assessmentReport = report;

        const reportDisplay = document.getElementById(
          "final-assessment-report"
        );
        if (reportDisplay) {
          reportDisplay.textContent = report;
        }
      }

      /**
       * Copy validation code to clipboard
       */
      function copyCodeToClipboard() {
        const code = assessmentTerminalState.generatedCode;
        if (!code) {
          showToast("❌ Nenhum código para copiar", "error", 2000);
          return;
        }

        navigator.clipboard
          .writeText(code)
          .then(() => {
            showToast("📋 Código copiado para clipboard", "success", 2000);
          })
          .catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            showToast("📋 Código copiado", "success", 2000);
          });
      }

      /**
       * Finalize assessment terminal
       */
      function finalizeAssessmentTerminal() {
        const availability = assessmentTerminalState.selectedAvailability;
        const capacity = assessmentTerminalState.selectedCapacity;

        if (!availability || !capacity) {
          showToast("❌ Complete todas as avaliações", "error", 3000);
          return;
        }

        // Update game state with final decisions
        gameState.availability = availability;
        gameState.capacity = capacity;

        // Calculate assessment score using existing logic
        if (typeof ScoringSystem !== "undefined") {
          const assessmentScore =
            ScoringSystem.calculateAssessmentScore(gameState);
          gameState.score += Math.round(assessmentScore * 25); // Convert to points
        }

        // Show completion message
        showToast("🎉 Avaliação DLD concluída com sucesso!", "success", 4000);

        updateTerminalStatus(
          "Avaliação finalizada - Sistema pronto para encerrar"
        );

        // Proceed to conclusion after brief delay
        setTimeout(() => {
          nextState(); // This should transition to the conclusion state
        }, 2000);
      }

      // Compatibility functions to maintain existing flow
      function selectAvailability(choice) {
        // Legacy function - redirect to terminal version
        if (assessmentTerminalState.currentScreen >= 2) {
          selectAvailabilityTerminal(choice);
        } else {
          // Fallback for non-terminal mode
          gameState.availability = choice;
          const nextSection = document.getElementById("capacity-section");
          if (nextSection) {
            nextSection.style.display = "block";
          }
        }
      }

      function selectCapacity(choice) {
        // Legacy function - redirect to terminal version
        if (assessmentTerminalState.currentScreen >= 3) {
          selectCapacityTerminal(choice);
        } else {
          // Fallback for non-terminal mode
          gameState.capacity = choice;
          const finalizeBtn = document.getElementById("finalize-assessment");
          if (finalizeBtn) {
            finalizeBtn.style.display = "block";
          }
        }
      }

      // ========================================
      // END ASSESSMENT TERMINAL SYSTEM
      // ========================================

      // ========================================
      // CARD GAME CONVERSATION SYSTEM - PUZZLE 2
      // ========================================

      // Card Game State
      const cardGameState = {
        currentTopic: null,
        currentTopicIndex: 0,
        usedTopics: new Set(), // Topics that have been started
        completedTopics: new Set(), // Topics that have been answered
        responseCards: [],
        selectedResponse: null,
        topicTimer: null,
        topicStartTime: null,
        gameStartTime: null,
        isActive: false,
      };

      // Topic Card Data (matches existing dialogue data)
      const topicCards = [
        {
          id: 1,
          title: "Apresentação",
          subtitle: "Como se sente hoje?",
          icon: "👋",
          description: "Iniciar conversa com cortesia",
        },
        {
          id: 2,
          title: "Situação Atual",
          subtitle: "Fale sobre sua situação",
          icon: "💭",
          description: "Explorar contexto pessoal",
        },
        {
          id: 3,
          title: "Experiência",
          subtitle: "Trabalho em limpeza",
          icon: "🧹",
          description: "Competências profissionais",
        },
        {
          id: 4,
          title: "Dependência",
          subtitle: "Relações familiares",
          icon: "🤝",
          description: "Pai e irmão",
        },
        {
          id: 5,
          title: "Mudanças",
          subtitle: "Sentimentos atuais",
          icon: "💭",
          description: "Solidão e futuro",
        },
      ];

      /**
       * Initialize Card Game when conversation state is entered
       */
      function initializeCardGame() {
        cardGameState.gameStartTime = Date.now();
        cardGameState.isActive = true;

        // Generate topic cards
        generateTopicCards();

        // Update metrics display
        updateCardGameMetrics();

        // Setup topic drop zone
        setupTopicDropZone();

        // Initialize avatar
        updateFelisbinaAvatar("😐", "Estado neutro", "Aguardando conversa...");

        showToast(
          "🃏 Jogo de cartas iniciado! Arraste um tópico para a zona de conversa",
          "info",
          4000
        );
      }

      /**
       * Generate topic cards in the deck
       */
      function generateTopicCards() {
        const topicDeck = document.getElementById("topic-deck");
        if (!topicDeck) return;

        topicDeck.innerHTML = topicCards
          .map((topic) => {
            const isCompleted = cardGameState.completedTopics.has(topic.id);
            const isStarted = cardGameState.usedTopics.has(topic.id);
            const nextExpected = cardGameState.completedTopics.size + 1;
            const isAvailable = topic.id === nextExpected;
            const isLocked = !isCompleted && !isAvailable;

            let cardClass = "topic-card";
            if (isCompleted) cardClass += " used";
            if (isStarted && !isCompleted) cardClass += " in-progress";
            if (isLocked) cardClass += " locked";
            if (isAvailable) cardClass += " available";

            const statusIcon = isCompleted
              ? "✅"
              : isStarted
              ? "💬"
              : isAvailable
              ? "👆"
              : "🔒";

            return `
          <div class="${cardClass}" 
               draggable="${!isLocked}" 
               data-topic-id="${topic.id}"
               ondragstart="handleTopicDragStart(event)"
               ondragend="handleTopicDragEnd(event)"
               onclick="handleTopicClick(event)">
            <div class="topic-card-status">${statusIcon}</div>
            <div class="topic-card-title">${topic.icon} ${topic.title}</div>
            <div class="topic-card-subtitle">${topic.subtitle}</div>
          </div>
        `;
          })
          .join("");

        // Update remaining topics count
        const remainingElement = document.getElementById("remaining-topics");
        if (remainingElement) {
          remainingElement.textContent =
            topicCards.length - cardGameState.completedTopics.size;
        }
      }

      /**
       * Handle topic card drag start
       */
      function handleTopicDragStart(event) {
        const topicId = parseInt(event.target.dataset.topicId);

        // Check if topic already completed
        if (cardGameState.completedTopics.has(topicId)) {
          event.preventDefault();
          showToast("Este tópico já foi completado", "warning", 2000);
          return;
        }

        // Check if topic is locked (enforce sequence based on completed topics)
        const nextExpectedTopic = cardGameState.completedTopics.size + 1;
        if (topicId !== nextExpectedTopic) {
          event.preventDefault();
          const topicNames = [
            "",
            "Apresentação",
            "Situação Atual",
            "Experiência",
            "Dependência",
            "Mudanças",
          ];
          showToast(
            `❌ Por favor, siga a ordem da conversa. Próximo tópico: ${topicNames[nextExpectedTopic]}`,
            "warning",
            4000
          );
          return;
        }

        event.dataTransfer.setData("text/plain", topicId);
        event.target.classList.add("dragging");

        // Activate topic drop zone
        const topicDropZone = document.getElementById("topic-drop-zone");
        if (topicDropZone) {
          topicDropZone.classList.add("drag-over");
        }
      }

      /**
       * Handle topic card drag end
       */
      function handleTopicDragEnd(event) {
        event.target.classList.remove("dragging");

        // Deactivate topic drop zone
        const topicDropZone = document.getElementById("topic-drop-zone");
        if (topicDropZone) {
          topicDropZone.classList.remove("drag-over");
        }
      }

      /**
       * Handle topic click for mobile devices
       */
      function handleTopicClick(event) {
        const topicId = parseInt(event.currentTarget.dataset.topicId);

        // Check if topic already completed
        if (cardGameState.completedTopics.has(topicId)) {
          showToast("Este tópico já foi completado", "warning", 2000);
          return;
        }

        // Enforce sequence: next topic should be (number of completed topics + 1)
        const nextExpectedTopic = cardGameState.completedTopics.size + 1;
        if (topicId !== nextExpectedTopic) {
          const topicNames = [
            "",
            "Apresentação",
            "Situação Atual",
            "Experiência",
            "Dependência",
            "Mudanças",
          ];
          showToast(
            `❌ Por favor, siga a ordem da conversa. Próximo tópico: ${topicNames[nextExpectedTopic]}`,
            "warning",
            4000
          );
          return;
        }

        // Start conversation
        startConversationTopic(topicId);

        showToast(
          "✅ Tópico selecionado! Agora escolha uma resposta.",
          "success",
          3000
        );
      }

      /**
       * Setup topic drop zone for starting conversations
       */
      function setupTopicDropZone() {
        const topicDropZone = document.getElementById("topic-drop-zone");
        if (!topicDropZone) return;

        topicDropZone.addEventListener("dragover", handleTopicDropZoneDragOver);
        topicDropZone.addEventListener("drop", handleTopicDrop);
        topicDropZone.addEventListener(
          "dragleave",
          handleTopicDropZoneDragLeave
        );
      }

      /**
       * Handle topic drop zone drag over
       */
      function handleTopicDropZoneDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add("drag-over");
      }

      /**
       * Handle topic drop zone drag leave
       */
      function handleTopicDropZoneDragLeave(event) {
        event.currentTarget.classList.remove("drag-over");
      }

      /**
       * Handle topic drop into conversation area
       */
      function handleTopicDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");

        const topicId = parseInt(event.dataTransfer.getData("text/plain"));

        // Check if it's a valid topic card
        if (!topicCards.find((t) => t.id === topicId)) {
          return;
        }

        // Check if topic already completed
        if (cardGameState.completedTopics.has(topicId)) {
          showToast("Este tópico já foi completado", "warning", 2000);
          return;
        }

        // Enforce sequence: next topic should be (number of completed topics + 1)
        const nextExpectedTopic = cardGameState.completedTopics.size + 1;
        if (topicId !== nextExpectedTopic) {
          const topicNames = [
            "",
            "Apresentação",
            "Situação Atual",
            "Experiência",
            "Dependência",
            "Mudanças",
          ];
          showToast(
            `❌ Por favor, siga a ordem da conversa. Próximo tópico: ${topicNames[nextExpectedTopic]}`,
            "warning",
            4000
          );
          return;
        }

        // Start conversation
        startConversationTopic(topicId);
      }

      /**
       * Start conversation topic
       */
      function startConversationTopic(topicId) {
        const topic = topicCards.find((t) => t.id === topicId);
        if (!topic) return;

        cardGameState.currentTopic = topic;
        cardGameState.topicStartTime = Date.now();
        cardGameState.usedTopics.add(topicId);

        // Update UI
        updateTopicHeader(topic);
        generateResponseCards(topicId);
        generateTopicCards(); // Update topic cards visual states
        startTopicTimer();

        // Update avatar and progress
        updateFelisbinaAvatar(
          "🤔",
          "Pensativa",
          `Falando sobre: ${topic.title}`
        );

        // Mark topic card as used
        const topicCard = document.querySelector(
          `[data-topic-id="${topicId}"]`
        );
        if (topicCard) {
          topicCard.classList.add("used");
          topicCard.draggable = false;
        }

        // Update remaining count
        const remainingElement = document.getElementById("remaining-topics");
        if (remainingElement) {
          remainingElement.textContent =
            topicCards.length - cardGameState.completedTopics.size;
        }

        showToast(`💬 Iniciando conversa: ${topic.title}`, "success", 3000);
      }

      /**
       * Update topic header
       */
      function updateTopicHeader(topic) {
        const titleElement = document.getElementById("current-topic-title");
        if (titleElement) {
          titleElement.textContent = `${topic.icon} ${topic.title} - ${topic.subtitle}`;
        }
      }

      /**
       * Generate response cards for current topic
       */
      function generateResponseCards(topicId) {
        const responseArea = document.getElementById("response-cards-area");
        if (!responseArea) return;

        // Get dialogue data for this topic
        const dialogueItem = dialogueData.find((d) => d.id === topicId);
        if (!dialogueItem) return;

        // Generate response cards
        const responseCards = dialogueItem.options.map((option, index) => {
          const qualityClass = getResponseQuality(topicId, index);
          return {
            id: `${topicId}_${index}`,
            topicId: topicId,
            optionIndex: index,
            content: option.text,
            empathy: option.empathy,
            info: option.info,
            quality: qualityClass,
          };
        });

        cardGameState.responseCards = responseCards;

        // Render response cards
        responseArea.innerHTML = `
          <div class="response-cards-grid">
            ${responseCards
              .map(
                (card) => `
              <div class="response-card" 
                   draggable="true"
                   data-card-id="${card.id}"
                   data-option-index="${card.optionIndex}"
                   data-empathy="${card.empathy}"
                   data-info="${card.info}"
                   ondragstart="handleResponseDragStart(event)"
                   ondragend="handleResponseDragEnd(event)"
                   onclick="selectConversationCard(this)">
                <div class="response-card-header">
                  <span class="response-quality-badge ${card.quality}">${card.quality}</span>
                </div>
                <div class="response-card-content">${card.content}</div>
                <div class="response-card-stats">
                  <span>❤️ ${card.empathy}</span>
                  <span>📊 ${card.info}</span>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;

        // Setup drop zone
        setupResponseDropZone();
      }

      /**
       * Get response quality class
       */
      function getResponseQuality(topicId, optionIndex) {
        if (typeof DIALOGUE_QUALITY_MAP !== "undefined") {
          const qualityKey = `${topicId}_option_${optionIndex}`;
          return DIALOGUE_QUALITY_MAP[qualityKey] || "adequate";
        }
        return "adequate";
      }

      /**
       * Setup response drop zone
       */
      function setupResponseDropZone() {
        const dropZone = document.getElementById("response-drop-zone");
        if (!dropZone) return;

        dropZone.innerHTML = `
          <div class="drop-zone-content">
            <div class="drop-zone-icon">🎯</div>
            <span class="drop-zone-text">Arraste sua resposta aqui</span>
          </div>
        `;

        // Add drop event listeners
        dropZone.addEventListener("dragover", handleDropZoneDragOver);
        dropZone.addEventListener("drop", handleResponseDrop);
        dropZone.addEventListener("dragleave", handleDropZoneDragLeave);
      }

      /**
       * Handle response card drag start
       */
      function handleResponseDragStart(event) {
        const cardId = event.target.dataset.cardId;
        event.dataTransfer.setData("text/plain", cardId);
        event.target.classList.add("dragging");
      }

      /**
       * Handle response card drag end
       */
      function handleResponseDragEnd(event) {
        event.target.classList.remove("dragging");
      }

      /**
       * Handle drop zone drag over
       */
      function handleDropZoneDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add("drag-over");
      }

      /**
       * Handle drop zone drag leave
       */
      function handleDropZoneDragLeave(event) {
        event.currentTarget.classList.remove("drag-over");
      }

      /**
       * Handle response drop
       */
      function handleResponseDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");

        const cardId = event.dataTransfer.getData("text/plain");

        // Handle response drop only
        const responseCard = cardGameState.responseCards.find(
          (c) => c.id === cardId
        );
        if (responseCard) {
          selectResponse(responseCard);
        } else {
          showToast(
            "Arraste apenas cartas de resposta para esta área",
            "warning",
            2000
          );
        }
      }

      /**
       * Select and process response
       */
      function selectResponse(responseCard) {
        cardGameState.selectedResponse = responseCard;

        // Stop timer
        if (cardGameState.topicTimer) {
          clearInterval(cardGameState.topicTimer);
        }

        // Calculate response time
        const responseTime = Date.now() - cardGameState.topicStartTime;
        const responseTimeSeconds = Math.round(responseTime / 1000);

        // Process response using existing scoring system
        processCardResponse(responseCard, responseTimeSeconds);

        // Show feedback
        showResponseFeedback(responseCard, responseTimeSeconds);

        // Add to memory
        addToConversationMemory(cardGameState.currentTopic, responseCard);
      }

      /**
       * Process card response with scoring
       */
      function processCardResponse(responseCard, responseTime) {
        const rawScores = {
          empathy: responseCard.empathy,
          info: responseCard.info,
        };

        // Use existing scoring system if available
        if (typeof ScoringSystem !== "undefined") {
          const weightedScores = ScoringSystem.calculateWeightedResponse(
            responseCard.topicId,
            responseCard.optionIndex,
            rawScores
          );

          const updatedMetrics = ScoringSystem.updateDialogueMetrics(
            gameState,
            weightedScores
          );

          // Update game state
          gameState.empathy = updatedMetrics.empathy;
          gameState.information = updatedMetrics.information;
          gameState.interactions = updatedMetrics.interactions;
        } else {
          // Fallback scoring
          gameState.empathy = Math.min(
            30,
            gameState.empathy + responseCard.empathy
          );
          gameState.information = Math.min(
            75,
            gameState.information + responseCard.info
          );
          gameState.interactions = Math.min(6, gameState.interactions + 1);
        }

        // Time bonus
        if (responseTime < 30000) {
          // Under 30 seconds
          addBonusPoints(2, "Resposta rápida!");
        }

        // Update UI metrics
        updateCardGameMetrics();
      }

      /**
       * Show response feedback
       */
      function showResponseFeedback(responseCard, responseTime) {
        const feedbackPanel = document.getElementById("feedback-panel");
        if (!feedbackPanel) return;

        const qualityTexts = {
          excellent: "🌟 Excelente!",
          good: "👍 Boa resposta!",
          adequate: "👌 Adequado",
          poor: "😕 Pode melhorar",
        };

        const qualityText =
          qualityTexts[responseCard.quality] || "Resposta registada";

        feedbackPanel.innerHTML = `
          <div class="feedback-content">
            <div class="response-quality">${qualityText}</div>
            <div class="empathy-gain">❤️ Empatia: +${responseCard.empathy}</div>
            <div class="information-gain">📊 Informação: +${responseCard.info}</div>
            <div class="time-info">⏱️ Tempo: ${responseTime}s</div>
          </div>
          <button class="btn continue-btn" onclick="continueConversation()">
            Próximo Tópico →
          </button>
        `;

        feedbackPanel.style.display = "block";

        // Update Felisbina's reaction
        const reactionEmojis = {
          excellent: "😊",
          good: "🙂",
          adequate: "😐",
          poor: "😟",
        };

        const reactionTexts = {
          excellent: "Muito bem!",
          good: "Entendo...",
          adequate: "Compreendo",
          poor: "Hmm...",
        };

        updateFelisbinaAvatar(
          reactionEmojis[responseCard.quality],
          reactionTexts[responseCard.quality],
          `Tópico: ${cardGameState.currentTopic.title} concluído`
        );
      }

      /**
       * Add topic to conversation memory
       */
      function addToConversationMemory(topic, response) {
        // Mark topic as completed
        cardGameState.completedTopics.add(topic.id);

        // Update visual indicators
        generateTopicCards();

        const memorySlots = document.getElementById("memory-slots");
        if (!memorySlots) return;

        const memoryCard = document.createElement("div");
        memoryCard.className = "memory-card";
        memoryCard.innerHTML = `
          <strong>${topic.icon} ${topic.title}</strong><br>
          <small>${response.quality.toUpperCase()}</small>
        `;

        memorySlots.appendChild(memoryCard);
      }

      /**
       * Continue to next conversation topic
       */
      function continueConversation() {
        const feedbackPanel = document.getElementById("feedback-panel");
        if (feedbackPanel) {
          feedbackPanel.style.display = "none";
        }

        // Check if all topics completed (must have responses submitted)
        if (cardGameState.completedTopics.size >= topicCards.length) {
          completeCardGame();
        } else {
          // Reset for next topic
          resetForNextTopic();
        }
      }

      /**
       * Reset interface for next topic
       */
      function resetForNextTopic() {
        // Clear response area
        const responseArea = document.getElementById("response-cards-area");
        if (responseArea) {
          responseArea.innerHTML = `
            <div class="cards-instruction">
              Arraste outro tópico do baralho para continuar
            </div>
          `;
        }

        // Reset topic header
        const titleElement = document.getElementById("current-topic-title");
        if (titleElement) {
          titleElement.textContent = "Selecione outro tópico para continuar";
        }

        // Reset drop zone
        setupResponseDropZone();

        // Update avatar
        updateFelisbinaAvatar(
          "😐",
          "Aguardando",
          "Pronta para próximo tópico..."
        );

        cardGameState.currentTopic = null;
        cardGameState.selectedResponse = null;
      }

      /**
       * Complete card game
       */
      function completeCardGame() {
        cardGameState.isActive = false;

        const totalTime = Date.now() - cardGameState.gameStartTime;
        const totalMinutes = Math.round(totalTime / 60000);

        // Final bonuses
        if (totalMinutes < 5) {
          addBonusPoints(10, "Conversa eficiente!");
        }

        if (gameState.empathy >= 25) {
          addBonusPoints(15, "Alta empatia alcançada!");
        }

        // Show completion message
        updateFelisbinaAvatar(
          "😊",
          "Satisfeita",
          "Conversa completa - obrigada!"
        );

        showToast(
          "🎉 Conversa completa! Todos os tópicos abordados",
          "success",
          4000
        );

        // Mark puzzle as completed
        gameState.conversationCompleted = true;

        // Update score display
        updateScoreDisplay();
        updateEmpathyDisplay();

        // Show continue button
        const nextButton = document.getElementById("next-dialogue");
        if (nextButton) {
          nextButton.style.display = "block";
        }

        // Hide other UI elements
        const responseArea = document.getElementById("response-cards-area");
        if (responseArea) {
          responseArea.innerHTML = `
            <div class="cards-instruction">
              🎉 Conversa Concluída com Sucesso!<br>
              <small>Todos os tópicos foram abordados</small>
            </div>
          `;
        }
      }

      /**
       * Update card game metrics display
       */
      function updateCardGameMetrics() {
        // Update values
        const empathyElement = document.getElementById("empathy");
        const informationElement = document.getElementById("information");
        const interactionsElement = document.getElementById("interactions");

        if (empathyElement) empathyElement.textContent = gameState.empathy;
        if (informationElement)
          informationElement.textContent = Math.round(gameState.information);
        if (interactionsElement)
          interactionsElement.textContent = gameState.interactions;

        // Update progress bars
        updateProgressBar("empathy-progress", gameState.empathy, 30);
        updateProgressBar("information-progress", gameState.information, 75);
        updateProgressBar("interactions-progress", gameState.interactions, 6);
      }

      /**
       * Update progress bar
       */
      function updateProgressBar(elementId, value, max) {
        const progressBar = document.getElementById(elementId);
        if (progressBar) {
          const percentage = Math.min(100, (value / max) * 100);
          progressBar.style.width = `${percentage}%`;
        }
      }

      /**
       * Update Felisbina avatar
       */
      function updateFelisbinaAvatar(emoji, mood, status) {
        const avatar = document.getElementById("felisbina-avatar");
        const moodElement = document.getElementById("felisbina-mood");
        const topicElement = document.getElementById("conversation-topic");

        if (avatar) avatar.textContent = emoji;
        if (moodElement) moodElement.textContent = mood;
        if (topicElement) topicElement.textContent = status;
      }

      /**
       * Start topic timer
       */
      function startTopicTimer() {
        let seconds = 0;
        const timerElement = document.getElementById("topic-timer");

        cardGameState.topicTimer = setInterval(() => {
          seconds++;
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = seconds % 60;

          if (timerElement) {
            timerElement.textContent = `⏱️ ${minutes}:${remainingSeconds
              .toString()
              .padStart(2, "0")}`;
          }
        }, 1000);
      }

      // ========================================
      // END CARD GAME CONVERSATION SYSTEM
      // ========================================

      // ========================================
      // ENHANCED CONNECTION SYSTEM FUNCTIONS
      // ========================================

      /**
       * Initialize connection canvas
       */
      function initializeConnectionCanvas() {
        const canvas = document.getElementById("connection-canvas");
        if (!canvas) return;

        const container = canvas.parentElement;
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;

        // Redraw existing connections
        redrawAllConnections();
      }

      /**
       * Draw connection line between two evidence items
       */
      function drawConnectionLine(id1, id2, isValid) {
        const canvas = document.getElementById("connection-canvas");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");
        const element1 = document.querySelector(`[data-evidence-id="${id1}"]`);
        const element2 = document.querySelector(`[data-evidence-id="${id2}"]`);

        if (!element1 || !element2) return;

        const rect1 = element1.getBoundingClientRect();
        const rect2 = element2.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();

        // Calculate relative positions
        const x1 = rect1.left + rect1.width / 2 - canvasRect.left;
        const y1 = rect1.top + rect1.height / 2 - canvasRect.top;
        const x2 = rect2.left + rect2.width / 2 - canvasRect.left;
        const y2 = rect2.top + rect2.height / 2 - canvasRect.top;

        // Draw line
        ctx.lineWidth = 4;
        ctx.lineCap = "round";

        if (isValid) {
          // Valid connection - green gradient
          const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
          gradient.addColorStop(0, "#4CAF50");
          gradient.addColorStop(1, "#8BC34A");
          ctx.strokeStyle = gradient;
          ctx.shadowColor = "rgba(76, 175, 80, 0.5)";
          ctx.shadowBlur = 10;
        } else {
          // Attempted connection - orange
          ctx.strokeStyle = "#FF9800";
          ctx.shadowColor = "rgba(255, 152, 0, 0.5)";
          ctx.shadowBlur = 8;
        }

        ctx.beginPath();
        ctx.moveTo(x1, y1);

        // Draw curved line for aesthetics
        const midX = (x1 + x2) / 2;
        const midY = (y1 + y2) / 2 - 30; // Curve up
        ctx.quadraticCurveTo(midX, midY, x2, y2);

        ctx.stroke();

        // Add connection nodes
        drawConnectionNode(ctx, x1, y1, isValid);
        drawConnectionNode(ctx, x2, y2, isValid);
      }

      /**
       * Draw connection node
       */
      function drawConnectionNode(ctx, x, y, isValid) {
        ctx.shadowBlur = 0;
        ctx.fillStyle = isValid ? "#4CAF50" : "#FF9800";
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, 2 * Math.PI);
        ctx.fill();

        // Inner highlight
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
      }

      /**
       * Clear canvas
       */
      function clearCanvas() {
        const canvas = document.getElementById("connection-canvas");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      /**
       * Redraw all valid connections
       */
      function redrawAllConnections() {
        clearCanvas();
        evidenceState.connections.forEach(([id1, id2]) => {
          drawConnectionLine(id1, id2, true);
        });
      }

      /**
       * Add connection discovery to display
       */
      function addConnectionDiscovery(evidence1, evidence2) {
        const container = document.getElementById("discovered-connections");
        if (!container) return;

        const discovery = document.createElement("div");
        discovery.className = "connection-discovery";
        discovery.innerHTML = `
          <div class="connection-discovery-text">
            ${evidence1.icon} ${evidence1.title} ↔ ${evidence2.icon} ${evidence2.title}
          </div>
          <div class="connection-discovery-points">+15 pts</div>
        `;

        container.appendChild(discovery);
      }

      /**
       * Update connection statistics
       */
      function updateConnectionStats() {
        const connectionsElement = document.getElementById("connections-made");
        const bonusElement = document.getElementById("connection-bonus");

        if (connectionsElement) {
          connectionsElement.textContent = evidenceState.connections.length;
        }

        if (bonusElement) {
          bonusElement.textContent = evidenceState.connections.length * 15;
        }
      }

      /**
       * Analyze current connections - new feature
       */
      function analyzeCurrentConnections() {
        if (evidenceState.connections.length === 0) {
          showToast(
            "🔍 Nenhuma conexão para analisar. Conecte evidências primeiro!",
            "info",
            3000
          );
          return;
        }

        const insights = generateConnectionInsights();
        displayConnectionInsights(insights);

        showToast("🧠 Análise profissional gerada!", "success", 3000);
      }

      /**
       * Generate professional insights about connections
       */
      function generateConnectionInsights() {
        const insights = [];

        evidenceState.connections.forEach(([id1, id2]) => {
          const evidence1 = evidenceData.find((e) => e.id === id1);
          const evidence2 = evidenceData.find((e) => e.id === id2);

          // Generate contextual professional insight
          const insight = getConnectionInsight(evidence1, evidence2);
          if (insight) {
            insights.push(insight);
          }
        });

        return insights;
      }

      /**
       * Get professional insight for specific connection
       */
      function getConnectionInsight(evidence1, evidence2) {
        const connectionMap = {
          idade_dependencia: {
            title: "Vulnerabilidade Etária e Dependência",
            description:
              "A idade avançada (56 anos) combinada com dependência emocional cria um perfil que necessita apoio especializado para inserção laboral sustentável.",
          },
          experiencia_motivacao: {
            title: "Competência e Motivação Profissional",
            description:
              "A experiência prévia em limpeza aliada à motivação demonstrada indica potencial para desenvolvimento profissional com formação adequada.",
          },
          dependencia_ruptura: {
            title: "Impacto Psicossocial da Separação",
            description:
              "A ruptura familiar agravou a dependência emocional existente, requerendo intervenção psicológica como parte do plano de inserção.",
          },
          isolamento_educacao: {
            title: "Barreira Educacional e Social",
            description:
              "O isolamento social combinado com baixa escolaridade formal pode ser mitigado através de programas de literacia e integração social.",
          },
          idade_experiencia: {
            title: "Maturidade Profissional",
            description:
              "A combinação de idade e experiência representa um ativo - trabalhadores maduros trazem estabilidade e dedicação ao local de trabalho.",
          },
          educacao_experiencia: {
            title: "Competências Práticas vs Formais",
            description:
              "A experiência prática complementa a educação formal limitada, sugerindo que formação técnica específica seria mais eficaz que educação geral.",
          },
        };

        // Determine connection type based on evidence IDs
        const key = getConnectionKey(evidence1.id, evidence2.id);
        return (
          connectionMap[key] || {
            title: `Relação: ${evidence1.title} ↔ ${evidence2.title}`,
            description:
              "Esta conexão revela um aspecto importante do perfil que deve ser considerado na avaliação DLD.",
          }
        );
      }

      /**
       * Get connection key for insight mapping
       */
      function getConnectionKey(id1, id2) {
        const connectionKeys = {
          "idade-dependencia_emocional": "idade_dependencia",
          "experiencia_trabalho-motivacao_trabalho": "experiencia_motivacao",
          "dependencia_emocional-ruptura_familiar": "dependencia_ruptura",
          "isolamento_social-baixa_educacao": "isolamento_educacao",
          "idade-experiencia_trabalho": "idade_experiencia",
          "baixa_educacao-experiencia_trabalho": "educacao_experiencia",
        };

        // Try both directions
        const key1 = `${id1}-${id2}`;
        const key2 = `${id2}-${id1}`;

        return connectionKeys[key1] || connectionKeys[key2] || null;
      }

      /**
       * Display connection insights
       */
      function displayConnectionInsights(insights) {
        const insightsPanel = document.getElementById("connection-insights");
        const insightsContent = document.getElementById("insights-content");

        if (!insightsPanel || !insightsContent) return;

        insightsContent.innerHTML = insights
          .map(
            (insight) => `
          <div class="insight-item">
            <div class="insight-title">${insight.title}</div>
            <div class="insight-description">${insight.description}</div>
          </div>
        `
          )
          .join("");

        insightsPanel.style.display = "block";
      }

      /**
       * Enhanced clear connections function
       */
      function clearConnections() {
        evidenceState.connections = [];
        evidenceState.selectedForConnection = [];

        // Clear visual elements
        document
          .querySelectorAll(".evidence-slot.selected, .evidence-slot.connected")
          .forEach((slot) => {
            slot.classList.remove("selected", "connected");
          });

        // Clear canvas
        clearCanvas();

        // Clear discovered connections display
        const discoveredContainer = document.getElementById(
          "discovered-connections"
        );
        if (discoveredContainer) {
          discoveredContainer.innerHTML = "";
        }

        // Hide insights panel
        const insightsPanel = document.getElementById("connection-insights");
        if (insightsPanel) {
          insightsPanel.style.display = "none";
        }

        updateEvidenceMetrics();
        updateConnectionStats();
        showToast("🔗 Todas as conexões foram removidas.", "info", 2000);
      }

      /**
       * Enhanced unlock connection system
       */
      function unlockConnectionSystem() {
        const connectionSystem = document.getElementById("connection-system");
        if (connectionSystem) {
          connectionSystem.style.display = "block";

          // Initialize canvas
          setTimeout(() => {
            initializeConnectionCanvas();
          }, 100);

          showToast(
            "🔗 Sistema de Conexões Avançado desbloqueado! Conecte evidências para obter insights profissionais.",
            "info",
            5000
          );
        }
      }

      // Window resize handler for canvas
      window.addEventListener("resize", () => {
        if (document.getElementById("connection-canvas")) {
          setTimeout(() => {
            initializeConnectionCanvas();
          }, 100);
        }
      });

      // ========================================
      // END ENHANCED CONNECTION SYSTEM
      // ========================================

      // ========================================
      // DOCUMENT SCANNER MINI-GAME SYSTEM
      // ========================================

      // Scanner Game State
      const scannerState = {
        documentsQueue: [],
        processedDocuments: [],
        currentDocument: null,
        scanningInProgress: false,
        scanStartTime: null,
        totalScanTime: 0,
        accuracyScore: 100,
        scanSpeed: 0,
        secretDocsFound: 0,
        achievements: [],
        isActive: false,
      };

      // Document Data for scanning
      const documentDatabase = [
        {
          id: "curriculum_vitae",
          type: "Curriculum Vitae",
          description: "CV de Felisbina Santos - Experiência Profissional",
          priority: "high",
          icon: "📄",
          scanTime: 8000, // 8 seconds
          validationChecks: [
            { name: "Dados Pessoais Completos", requirement: true },
            { name: "Experiência Documentada", requirement: true },
            { name: "Referências Profissionais", requirement: false },
          ],
          isSecret: false,
          content:
            "Documento com experiência de trabalho em limpeza hospitalar",
        },
        {
          id: "certificado_habilitacoes",
          type: "Certificado de Habilitações",
          description: "Escolaridade: 9º ano (1968)",
          priority: "medium",
          icon: "🎓",
          scanTime: 6000,
          validationChecks: [
            { name: "Assinatura Digital Válida", requirement: true },
            { name: "Selo Oficial Presente", requirement: true },
            { name: "Data de Emissão Legível", requirement: true },
          ],
          isSecret: false,
          content: "Certificado oficial do 9º ano de escolaridade",
        },
        {
          id: "relatorio_medico",
          type: "Relatório Médico",
          description: "Avaliação de capacidade laboral",
          priority: "high",
          icon: "🏥",
          scanTime: 10000,
          validationChecks: [
            { name: "Assinatura Médica Válida", requirement: true },
            { name: "Carimbo Hospitalar", requirement: true },
            { name: "Data Recente (< 6 meses)", requirement: true },
          ],
          isSecret: true,
          content: "Estado de saúde compatível com atividade laboral",
        },
        {
          id: "declaracao_irs",
          type: "Declaração IRS",
          description: "Situação fiscal atual",
          priority: "medium",
          icon: "💰",
          scanTime: 7000,
          validationChecks: [
            { name: "Código de Validação AT", requirement: true },
            { name: "Período Fiscal Correto", requirement: true },
            { name: "Valores Consistentes", requirement: false },
          ],
          isSecret: false,
          content: "Declaração de rendimentos e situação fiscal",
        },
        {
          id: "carta_recomendacao_secreta",
          type: "Carta de Recomendação",
          description: "Referência confidencial do anterior empregador",
          priority: "low",
          icon: "✉️",
          scanTime: 12000,
          validationChecks: [
            { name: "Selo de Confidencialidade", requirement: true },
            { name: "Assinatura Reconhecida", requirement: true },
            { name: "Papel Timbrado Original", requirement: true },
          ],
          isSecret: true,
          content:
            "Avaliação positiva do desempenho e comportamento profissional",
        },
      ];

      /**
       * Initialize Document Scanner Mini-Game
       */
      function initializeDocumentScanner() {
        scannerState.isActive = true;
        scannerState.documentsQueue = [...documentDatabase];
        scannerState.processedDocuments = [];
        scannerState.currentDocument = null;
        scannerState.accuracyScore = 100;

        // Generate document queue UI
        generateDocumentQueue();

        // Update metrics
        updateScannerMetrics();

        // Setup scanner bed drop zone
        setupScannerDropZone();

        showToast(
          "🖨️ Scanner SAASI-2000 inicializado! Arraste documentos para processar",
          "info",
          4000
        );
      }

      /**
       * Generate document queue interface
       */
      function generateDocumentQueue() {
        const queueContainer = document.getElementById("document-queue");
        if (!queueContainer) return;

        const availableDocs = scannerState.documentsQueue.filter(
          (doc) => !scannerState.processedDocuments.includes(doc.id)
        );

        queueContainer.innerHTML = availableDocs
          .map(
            (doc) => `
          <div class="document-item" 
               draggable="true" 
               data-document-id="${doc.id}"
               ondragstart="handleDocumentDragStart(event)"
               ondragend="handleDocumentDragEnd(event)">
            <div class="document-header">
              <span class="document-type">${doc.icon} ${doc.type}</span>
              <span class="document-priority ${
                doc.priority
              }">${doc.priority.toUpperCase()}</span>
            </div>
            <div class="document-description">${doc.description}</div>
          </div>
        `
          )
          .join("");

        // Update queue stats
        const remainingElement = document.getElementById("queue-remaining");
        if (remainingElement) {
          remainingElement.textContent = availableDocs.length;
        }
      }

      /**
       * Handle document drag start
       */
      function handleDocumentDragStart(event) {
        const documentId = event.target.dataset.documentId;

        // Check if already processed
        if (scannerState.processedDocuments.includes(documentId)) {
          event.preventDefault();
          showToast("Este documento já foi processado", "warning", 2000);
          return;
        }

        event.dataTransfer.setData("text/plain", documentId);
        event.target.classList.add("dragging");

        // Activate scanner bed
        const scannerBed = document.getElementById("scanner-bed");
        if (scannerBed) {
          scannerBed.classList.add("drop-zone-active");
        }
      }

      /**
       * Handle document drag end
       */
      function handleDocumentDragEnd(event) {
        event.target.classList.remove("dragging");

        // Deactivate scanner bed
        const scannerBed = document.getElementById("scanner-bed");
        if (scannerBed) {
          scannerBed.classList.remove("drop-zone-active");
        }
      }

      /**
       * Setup scanner bed drop zone
       */
      function setupScannerDropZone() {
        const scannerBed = document.getElementById("scanner-bed");
        if (!scannerBed) return;

        scannerBed.addEventListener("dragover", handleScannerDragOver);
        scannerBed.addEventListener("drop", handleDocumentDrop);
        scannerBed.addEventListener("dragleave", handleScannerDragLeave);
      }

      /**
       * Handle scanner drag over
       */
      function handleScannerDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add("document-loaded");
      }

      /**
       * Handle scanner drag leave
       */
      function handleScannerDragLeave(event) {
        event.currentTarget.classList.remove("document-loaded");
      }

      /**
       * Handle document drop on scanner
       */
      function handleDocumentDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove(
          "document-loaded",
          "drop-zone-active"
        );

        const documentId = event.dataTransfer.getData("text/plain");
        const foundDoc = documentDatabase.find((doc) => doc.id === documentId);

        if (foundDoc && !scannerState.processedDocuments.includes(documentId)) {
          loadDocumentIntoScanner(foundDoc);
        }
      }

      /**
       * Load document into scanner
       */
      function loadDocumentIntoScanner(docData) {
        scannerState.currentDocument = docData;

        // Update scanner bed display
        const scannerBed = document.getElementById("scanner-bed");
        const placeholder = scannerBed.querySelector(".scanner-placeholder");

        if (placeholder) {
          placeholder.innerHTML = `
            <div class="placeholder-icon">${docData.icon}</div>
            <span class="placeholder-text">
              <strong>${docData.type}</strong><br>
              ${docData.description}
            </span>
          `;
        }

        scannerBed.classList.add("document-loaded");

        // Enable scan button
        const startBtn = document.getElementById("start-scan-btn");
        if (startBtn) {
          startBtn.disabled = false;
        }

        // Update scanner status
        updateScannerStatus(
          "Documento carregado - Pronto para digitalizar",
          "active"
        );

        showToast(`📄 ${docData.type} carregado no scanner`, "success", 2000);
      }

      /**
       * Start document scanning process
       */
      function startDocumentScan() {
        if (!scannerState.currentDocument || scannerState.scanningInProgress)
          return;

        scannerState.scanningInProgress = true;
        scannerState.scanStartTime = Date.now();

        const currentDoc = scannerState.currentDocument;
        const scannerBed = document.getElementById("scanner-bed");
        const scanningOverlay = document.getElementById("scanning-overlay");
        const scanTimer = document.getElementById("scan-timer");
        const timerSeconds = document.getElementById("timer-seconds");

        // Update UI
        scannerBed.classList.add("scanning");
        scanningOverlay.style.display = "flex";
        scanTimer.style.display = "flex";

        // Disable buttons
        document.getElementById("start-scan-btn").disabled = true;
        document.getElementById("cancel-scan-btn").disabled = false;

        // Update status
        updateScannerStatus("Digitalizando documento...", "active");

        // Start scan animation and timer
        let scanProgress = 0;
        let timeRemaining = Math.ceil(currentDoc.scanTime / 1000);

        const scanInterval = setInterval(() => {
          scanProgress += 100 / (currentDoc.scanTime / 100);

          // Update progress bar
          const scanningBar = document.getElementById("scanning-bar");
          if (scanningBar) {
            scanningBar.style.width = `${Math.min(scanProgress, 100)}%`;
          }

          // Update timer
          if (timerSeconds) {
            timerSeconds.textContent = Math.max(0, timeRemaining);
            timeRemaining--;
          }

          // Check if scan complete
          if (scanProgress >= 100) {
            clearInterval(scanInterval);
            completeScan();
          }
        }, 100);

        // Store interval for potential cancellation
        scannerState.scanInterval = scanInterval;

        showToast(
          `🖨️ Iniciando digitalização de ${currentDoc.type}`,
          "info",
          3000
        );
      }

      /**
       * Cancel scanning process
       */
      function cancelScan() {
        if (!scannerState.scanningInProgress) return;

        // Clear scan interval
        if (scannerState.scanInterval) {
          clearInterval(scannerState.scanInterval);
        }

        // Reset scanner state
        resetScannerInterface();

        // Penalty for cancellation
        scannerState.accuracyScore = Math.max(
          0,
          scannerState.accuracyScore - 10
        );

        updateScannerStatus("Digitalização cancelada", "error");
        updateScannerMetrics();

        showToast(
          "⏹️ Digitalização cancelada - Precisão reduzida",
          "warning",
          3000
        );
      }

      /**
       * Complete scanning process
       */
      function completeScan() {
        const currentDoc = scannerState.currentDocument;
        const scanTime = Date.now() - scannerState.scanStartTime;

        // Calculate performance metrics
        const targetTime = currentDoc.scanTime;
        const timeBonus = scanTime < targetTime ? 5 : 0;
        const qualityPoints = Math.random() > 0.8 ? 10 : 0; // Random quality bonus

        // Add to processed documents
        scannerState.processedDocuments.push(currentDoc.id);
        scannerState.totalScanTime += scanTime;

        // Calculate average speed
        scannerState.scanSpeed = Math.round(
          scannerState.totalScanTime /
            scannerState.processedDocuments.length /
            1000
        );

        // Check for secret documents
        if (currentDoc.isSecret) {
          scannerState.secretDocsFound++;
          addScannerAchievement(
            "🔐 Documento Confidencial",
            "Descobriu um documento secreto!"
          );
        }

        // Show scan results
        displayScanResults(currentDoc, scanTime, timeBonus + qualityPoints);

        // Show validation panel
        showValidationPanel(currentDoc);

        // Reset scanner interface
        resetScannerInterface();

        // Update document queue
        generateDocumentQueue();
        updateScannerMetrics();

        // Check if all documents processed
        if (scannerState.processedDocuments.length >= documentDatabase.length) {
          completeScannerMiniGame();
        }
      }

      /**
       * Reset scanner interface
       */
      function resetScannerInterface() {
        scannerState.scanningInProgress = false;
        scannerState.currentDocument = null;

        const scannerBed = document.getElementById("scanner-bed");
        const scanningOverlay = document.getElementById("scanning-overlay");
        const scanTimer = document.getElementById("scan-timer");
        const placeholder = scannerBed.querySelector(".scanner-placeholder");

        // Reset UI
        scannerBed.classList.remove("scanning", "document-loaded");
        scanningOverlay.style.display = "none";
        scanTimer.style.display = "none";

        // Reset placeholder
        if (placeholder) {
          placeholder.innerHTML = `
            <div class="placeholder-icon">📄</div>
            <span class="placeholder-text">Arraste um documento aqui para digitalizar</span>
          `;
        }

        // Reset progress bar
        const scanningBar = document.getElementById("scanning-bar");
        if (scanningBar) {
          scanningBar.style.width = "0%";
        }

        // Reset buttons
        document.getElementById("start-scan-btn").disabled = true;
        document.getElementById("cancel-scan-btn").disabled = true;
        document.getElementById("validate-doc-btn").disabled = true;

        updateScannerStatus("Standby - Aguardando documento", "standby");
      }

      /**
       * Display scan results
       */
      function displayScanResults(docData, scanTime, bonusPoints) {
        const resultsDisplay = document.getElementById("results-display");
        if (!resultsDisplay) return;

        const scanTimeSeconds = Math.round(scanTime / 1000);
        const currentTime = new Date().toLocaleTimeString("pt-PT");

        const resultElement = document.createElement("div");
        resultElement.className = "scan-result";
        resultElement.innerHTML = `
          <div class="result-header">
            <span class="result-title">${docData.icon} ${docData.type}</span>
            <span class="result-time">${currentTime}</span>
          </div>
          <div class="result-content">
            <strong>Status:</strong> Digitalização concluída<br>
            <strong>Tempo:</strong> ${scanTimeSeconds}s<br>
            <strong>Qualidade:</strong> ${
              docData.isSecret ? "Confidencial" : "Normal"
            }<br>
            <strong>Pontos Bonus:</strong> +${bonusPoints}<br>
            <strong>Conteúdo:</strong> ${docData.content}
          </div>
        `;

        // Remove placeholder if exists
        const placeholder = resultsDisplay.querySelector(
          ".results-placeholder"
        );
        if (placeholder) {
          placeholder.remove();
        }

        resultsDisplay.appendChild(resultElement);

        // Add bonus points to game
        if (bonusPoints > 0) {
          addBonusPoints(
            bonusPoints,
            `Digitalização eficiente de ${document.type}`
          );
        }
      }

      /**
       * Show validation panel
       */
      function showValidationPanel(docData) {
        const validationPanel = document.getElementById("validation-panel");
        const validationChecks = document.getElementById("validation-checks");

        if (!validationPanel || !validationChecks) return;

        // Generate validation checks
        validationChecks.innerHTML = docData.validationChecks
          .map((check) => {
            const status = Math.random() > 0.2 || check.requirement; // 80% pass rate for required, 100% for optional
            return `
            <div class="validation-check ${status ? "passed" : "failed"}">
              <span>${check.name}</span>
              <span>${status ? "✅" : "❌"}</span>
            </div>
          `;
          })
          .join("");

        validationPanel.style.display = "block";

        // Enable validation button
        document.getElementById("validate-doc-btn").disabled = false;
      }

      /**
       * Approve document validation
       */
      function approveDocument() {
        const currentDoc = scannerState.currentDocument;
        if (!currentDoc) return;

        // Mark document as processed in UI
        const documentElement = document.querySelector(
          `[data-document-id="${currentDoc.id}"]`
        );
        if (documentElement) {
          documentElement.classList.add("processed");
          documentElement.draggable = false;
        }

        // Add accuracy bonus
        scannerState.accuracyScore = Math.min(
          100,
          scannerState.accuracyScore + 2
        );

        // Hide validation panel
        const validationPanel = document.getElementById("validation-panel");
        if (validationPanel) {
          validationPanel.style.display = "none";
        }

        updateScannerMetrics();
        showToast(`✅ ${document.type} aprovado e arquivado`, "success", 3000);

        // Check for achievements
        checkScannerAchievements();
      }

      /**
       * Reject document validation
       */
      function rejectDocument() {
        const currentDoc = scannerState.currentDocument;
        if (!currentDoc) return;

        // Accuracy penalty
        scannerState.accuracyScore = Math.max(
          0,
          scannerState.accuracyScore - 5
        );

        // Hide validation panel
        const validationPanel = document.getElementById("validation-panel");
        if (validationPanel) {
          validationPanel.style.display = "none";
        }

        updateScannerMetrics();
        showToast(
          `❌ ${currentDoc.type} rejeitado - Precisão reduzida`,
          "warning",
          3000
        );
      }

      /**
       * Update scanner metrics display
       */
      function updateScannerMetrics() {
        const docsElement = document.getElementById("docs-identified");
        const accuracyElement = document.getElementById("scan-accuracy");
        const speedElement = document.getElementById("scan-speed");
        const secretElement = document.getElementById("secret-docs");

        if (docsElement)
          docsElement.textContent = scannerState.processedDocuments.length;
        if (accuracyElement)
          accuracyElement.textContent = scannerState.accuracyScore;
        if (speedElement) speedElement.textContent = scannerState.scanSpeed;
        if (secretElement)
          secretElement.textContent = scannerState.secretDocsFound;
      }

      /**
       * Update scanner status
       */
      function updateScannerStatus(message, status) {
        const statusText = document.querySelector(
          "#scanner-status .status-text"
        );
        const statusLight = document.querySelector(
          "#scanner-status .status-light"
        );

        if (statusText) statusText.textContent = message;
        if (statusLight) {
          statusLight.className = `status-light ${status}`;
        }
      }

      /**
       * Add scanner achievement
       */
      function addScannerAchievement(title, description) {
        const achievement = { title, description, timestamp: Date.now() };
        scannerState.achievements.push(achievement);

        // Show achievements panel
        const achievementsPanel = document.getElementById(
          "scanning-achievements"
        );
        const achievementList = document.getElementById("achievement-list");

        if (achievementsPanel && achievementList) {
          achievementsPanel.style.display = "block";

          const achievementElement = document.createElement("div");
          achievementElement.className = "achievement-item";
          achievementElement.innerHTML = `
            <div class="achievement-icon">🏆</div>
            <div class="achievement-text">
              <div class="achievement-title">${title}</div>
              <div class="achievement-description">${description}</div>
            </div>
          `;

          achievementList.appendChild(achievementElement);
        }
      }

      /**
       * Check for scanner achievements
       */
      function checkScannerAchievements() {
        const processed = scannerState.processedDocuments.length;
        const accuracy = scannerState.accuracyScore;
        const avgSpeed = scannerState.scanSpeed;

        // Speed achievements
        if (avgSpeed <= 5 && processed >= 2) {
          addScannerAchievement(
            "⚡ Operador Rápido",
            "Velocidade média inferior a 5 segundos"
          );
        }

        // Accuracy achievements
        if (accuracy >= 95 && processed >= 3) {
          addScannerAchievement(
            "🎯 Precisão Máxima",
            "Manteve precisão acima de 95%"
          );
        }

        // Secret documents achievement
        if (scannerState.secretDocsFound >= 2) {
          addScannerAchievement(
            "🕵️ Detetive Documentos",
            "Descobriu todos os documentos confidenciais"
          );
        }

        // Perfect game achievement
        if (processed >= 5 && accuracy === 100) {
          addScannerAchievement(
            "🏆 Digitalização Perfeita",
            "Completou todos os documentos sem erros"
          );
        }
      }

      /**
       * Complete scanner mini-game
       */
      function completeScannerMiniGame() {
        scannerState.isActive = false;

        // Final scoring
        const finalScore = Math.round(
          scannerState.accuracyScore * 0.4 +
            scannerState.secretDocsFound * 20 +
            scannerState.achievements.length * 10
        );

        // Add final score to game
        addBonusPoints(finalScore, "Digitalização de documentos completa!");

        // Show completion message
        showToast(
          "🎉 Laboratório de Digitalização concluído com sucesso!",
          "success",
          4000
        );

        // Show continue button
        const nextButton = document.getElementById("next-docs");
        if (nextButton) {
          nextButton.style.display = "block";
        }

        // Final achievement
        addScannerAchievement(
          "📄 Mestre da Digitalização",
          "Completou o laboratório de documentos com sucesso"
        );
      }

      // ========================================
      // END DOCUMENT SCANNER MINI-GAME SYSTEM
      // ========================================

      // Inicialização
      document.addEventListener("DOMContentLoaded", function () {
        updateProgress();

        // Initialize assessment terminal if on assessment state
        if (document.getElementById("assessment-terminal")) {
          initializeAssessmentTerminal();
        }

        // Initialize card game if on conversation state
        if (document.getElementById("topic-deck")) {
          initializeCardGame();
        }

        // Initialize document scanner if on documentation state
        if (document.getElementById("document-queue")) {
          initializeDocumentScanner();
        }
      });
    </script>
  </body>
</html>
