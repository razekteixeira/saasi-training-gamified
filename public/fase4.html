<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAASI Escape Room - Fase 4: Implementação e Acompanhamento</title>
    <link rel="stylesheet" href="css/main.css" />
    <style>
      /* Toast System */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
      }

      .toast {
        background: #333;
        color: white;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        padding-right: 50px;
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        background: #28a745;
        border-left: 4px solid #1e7e34;
      }

      .toast.error {
        background: #dc3545;
        border-left: 4px solid #c82333;
      }

      .toast.warning {
        background: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .toast.info {
        background: #17a2b8;
        border-left: 4px solid #138496;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* Estilos específicos da Fase 4 - CONFORME ESPECIFICAÇÃO DETALHADA */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
      }

      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        z-index: 1000;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .back-button:hover {
        background: rgba(84, 91, 98, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      /* Layout Grid Fase 4 - CONFORME ESPECIFICAÇÃO */
      .fase4-container {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 30px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .puzzle-area {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        min-height: 600px;
      }

      .sidebar {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 25px;
        height: fit-content;
        position: sticky;
        top: 20px;
      }

      /* Dashboard de Acompanhamento - CONFORME ESPECIFICAÇÃO */
      .progress-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .program-progress-card {
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 20px;
        border-left: 4px solid var(--progress-color);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .program-progress-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .progress-indicator {
        position: relative;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 15px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--progress-start),
          var(--progress-end)
        );
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      /* Sistema de Alertas de Crise - CONFORME ESPECIFICAÇÃO */
      .crisis-alert {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        animation: pulse 2s infinite;
        border: 2px solid #ff4757;
        position: relative;
      }

      .crisis-timer {
        position: absolute;
        top: 10px;
        right: 15px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 0.9rem;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      /* Timeline de Ajustes - CONFORME ESPECIFICAÇÃO */
      .adjustment-timeline {
        position: relative;
        padding: 20px 0;
      }

      .timeline-line {
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #667eea, #764ba2);
        transform: translateX(-50%);
      }

      .timeline-event {
        position: relative;
        margin: 20px 0;
        display: flex;
        align-items: center;
      }

      .timeline-event:nth-child(odd) {
        flex-direction: row-reverse;
      }

      .event-content {
        flex: 1;
        margin: 0 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      /* Estados do jogo */
      .state {
        display: block;
      }

      .state-hidden {
        display: none;
      }

      .puzzle-section {
        margin-bottom: 30px;
        padding: 25px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.8);
      }

      .puzzle-section.active {
        background: rgba(255, 243, 205, 0.6);
        border: 2px solid #ffc107;
      }

      .puzzle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .puzzle-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }

      .puzzle-score {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* Componentes específicos dos puzzles */
      .indicator-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .indicator-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
      }

      .indicator-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-bottom: 5px;
      }

      .indicator-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .status-positive {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .status-neutral {
        background: #fff3e0;
        color: #f57c00;
      }
      .status-negative {
        background: #ffebee;
        color: #c62828;
      }

      /* Botões de ação */
      .action-button {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin: 5px;
        transition: all 0.3s ease;
      }

      .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
      }

      .action-button.inadequate {
        background: linear-gradient(135deg, #f44336, #d32f2f);
      }

      .action-button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Crisis management específico */
      .crisis-scenario {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border: 2px solid #ff9800;
        animation: highlightCrisis 1s ease-in-out;
      }

      @keyframes highlightCrisis {
        0% {
          background: #fff3e0;
        }
        50% {
          background: #ffecb3;
        }
        100% {
          background: white;
        }
      }

      .crisis-options {
        display: grid;
        gap: 10px;
        margin-top: 15px;
      }

      .crisis-option {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .crisis-option:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .crisis-option.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .crisis-option.correct {
        border-color: #4caf50;
        background: #e8f5e9;
      }

      .crisis-option.incorrect {
        border-color: #f44336;
        background: #ffebee;
      }

      /* Strategy adjustment específico */
      .strategy-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .strategy-card.selectable:hover {
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .strategy-card.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.05);
      }

      .strategy-card.inadequate {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Autonomy preparation específico */
      .autonomy-area {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
      }

      .action-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        border-left: 3px solid #667eea;
      }

      .maintenance-strategy {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .maintenance-strategy:hover {
        border-color: #667eea;
      }

      .maintenance-strategy.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.05);
      }

      /* Responsividade */
      @media (max-width: 1200px) {
        .fase4-container {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .sidebar {
          position: static;
          margin-top: 20px;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
        }

        .container,
        .puzzle-area {
          padding: 20px;
        }

        .progress-dashboard {
          grid-template-columns: 1fr;
        }

        .timeline-event {
          flex-direction: column !important;
        }

        .timeline-line {
          left: 20px;
        }
      }

      /* Animações específicas */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 15px auto;
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <a href="index.html" class="back-button">🏠 Voltar ao Menu</a>

    <div class="main-container">
      <div class="fase4-container">
        <!-- Área Principal dos Puzzles -->
        <div class="puzzle-area">
          <div class="header">
            <h1>🎯 Fase 4: Implementação e Acompanhamento</h1>
            <p class="subtitle">
              Executar o plano de intervenção, gerir imprevistos e ajustar
              estratégias
            </p>
          </div>

          <!-- Estado: Introdução -->
          <div id="state-intro" class="state">
            <div class="container">
              <h3>📅 Situação Atual - 3 Meses Depois</h3>
              <p>
                Passaram-se 3 meses desde o início da implementação do plano de
                intervenção da Felisbina. O plano está em execução, mas surgem
                desafios que requerem ajustes e tomadas de decisão em tempo
                real.
              </p>

              <div class="progress-dashboard">
                <div
                  class="program-progress-card"
                  style="--progress-color: #4caf50"
                >
                  <h4>🧠 Consultas de Psicologia</h4>
                  <div class="progress-indicator">
                    <div
                      class="progress-fill"
                      style="
                        --progress-start: #4caf50;
                        --progress-end: #66bb6a;
                        width: 67%;
                      "
                    ></div>
                  </div>
                  <p>
                    <strong>8 de 12 sessões realizadas</strong> - Progresso
                    positivo
                  </p>
                  <div class="indicator-status status-positive">
                    Em curso - Progresso consistente
                  </div>
                </div>

                <div
                  class="program-progress-card"
                  style="--progress-color: #ff9800"
                >
                  <h4>📚 Programa Qualifica</h4>
                  <div class="progress-indicator">
                    <div
                      class="progress-fill"
                      style="
                        --progress-start: #ff9800;
                        --progress-end: #ffb74d;
                        width: 50%;
                      "
                    ></div>
                  </div>
                  <p><strong>50% concluído</strong> - Algumas dificuldades</p>
                  <div class="indicator-status status-neutral">
                    Dificuldades na componente teórica
                  </div>
                </div>

                <div
                  class="program-progress-card"
                  style="--progress-color: #f44336"
                >
                  <h4>👥 Grupos de Apoio Social</h4>
                  <div class="progress-indicator">
                    <div
                      class="progress-fill"
                      style="
                        --progress-start: #f44336;
                        --progress-end: #ef5350;
                        width: 40%;
                      "
                    ></div>
                  </div>
                  <p>
                    <strong>Participação irregular</strong> - Resistência
                    inicial
                  </p>
                  <div class="indicator-status status-negative">
                    Resistência à participação
                  </div>
                </div>
              </div>

              <div class="alert alert-warning">
                <h4>🚨 Situações que Requerem Atenção:</h4>
                <ul>
                  <li>
                    <strong>Situação habitacional:</strong> Mudança inesperada -
                    precisa novo alojamento
                  </li>
                  <li>
                    <strong>Oportunidade de emprego:</strong> Surgiu vaga em
                    empresa de limpeza
                  </li>
                  <li>
                    <strong>Programa Qualifica:</strong> Dificuldades na
                    componente teórica
                  </li>
                </ul>
              </div>

              <div style="text-align: center; margin-top: 30px">
                <button
                  onclick="changeState('gestao-progresso')"
                  class="btn btn-primary"
                >
                  🚀 Iniciar Gestão do Acompanhamento
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Gestão de Progresso (PUZZLE 1) -->
          <div id="state-gestao-progresso" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  📊 Puzzle 1: Gestão de Progresso e Indicadores
                </h2>
                <div class="puzzle-score" id="puzzle1-score">0/25 pontos</div>
              </div>

              <p>
                Avalie o progresso atual dos programas e identifique áreas que
                necessitam ajuste.
              </p>

              <div id="progress-analysis-container">
                <!-- Conteúdo será carregado dinamicamente -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-crisis"
                  onclick="changeState('gestao-crises')"
                  class="btn btn-primary"
                  style="display: none"
                >
                  ➡️ Continuar para Gestão de Crises
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Gestão de Crises (PUZZLE 2) -->
          <div id="state-gestao-crises" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  🚨 Puzzle 2: Gestão de Situações Imprevistas
                </h2>
                <div class="puzzle-score" id="puzzle2-score">0/30 pontos</div>
              </div>

              <p>
                Responda a crises e situações não planeadas que surgem durante a
                implementação.
              </p>

              <div id="crisis-scenarios-container">
                <!-- Cenários de crise serão carregados dinamicamente -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-strategies"
                  onclick="changeState('ajuste-estrategias')"
                  class="btn btn-primary"
                  style="display: none"
                >
                  ➡️ Continuar para Ajuste de Estratégias
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Ajuste de Estratégias (PUZZLE 3) -->
          <div id="state-ajuste-estrategias" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">🎯 Puzzle 3: Ajuste de Estratégias</h2>
                <div class="puzzle-score" id="puzzle3-score">0/25 pontos</div>
              </div>

              <p>
                Modifique o plano original baseado nos resultados obtidos e
                situações imprevistas.
              </p>

              <div id="strategy-adjustment-container">
                <!-- Estratégias de ajuste serão carregadas dinamicamente -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-autonomy"
                  onclick="changeState('preparacao-autonomia')"
                  class="btn btn-primary"
                  style="display: none"
                >
                  ➡️ Continuar para Preparação de Autonomia
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Preparação para Autonomia (PUZZLE 4) -->
          <div id="state-preparacao-autonomia" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  🌟 Puzzle 4: Preparação para Autonomia
                </h2>
                <div class="puzzle-score" id="puzzle4-score">0/20 pontos</div>
              </div>

              <p>
                Defina estratégias de manutenção e redução gradual do apoio para
                promover a autonomia sustentável.
              </p>

              <div id="autonomy-preparation-container">
                <!-- Planeamento de autonomia será carregado dinamicamente -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-finalize-phase4"
                  onclick="changeState('conclusao')"
                  class="btn btn-primary"
                  style="display: none"
                >
                  ✅ Finalizar Fase 4
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Conclusão -->
          <div id="state-conclusao" class="state state-hidden">
            <div class="container" style="text-align: center">
              <h2>🎉 Fase 4 Completada com Sucesso!</h2>
              <h3>🏆 ESCAPE ROOM SAASI CONCLUÍDO!</h3>

              <div class="score-display" style="margin: 30px 0">
                <p>Nível: <span id="final-level">Técnico Iniciante</span></p>
                <p>
                  Certificação:
                  <span id="final-certification">Técnico Competente SAASI</span>
                </p>
              </div>

              <div class="achievements-final" id="achievements-final">
                <!-- Achievements finais serão carregados dinamicamente -->
              </div>

              <div style="margin-top: 30px">
                <button onclick="showFinalReport()" class="btn btn-primary">
                  📊 Ver Relatório Final Completo
                </button>
                <button onclick="restartPhase4()" class="btn btn-secondary">
                  🔄 Repetir Fase 4
                </button>
                <a href="index.html" class="btn btn-secondary"
                  >🏠 Voltar ao Menu</a
                >
              </div>
            </div>
          </div>

          <!-- Modal do Relatório Final -->
          <div id="final-report-modal" class="state state-hidden">
            <div class="container">
              <h2>📊 Relatório Final Integrado - Escape Room SAASI</h2>
              <div id="final-report-content">
                <!-- Relatório será gerado dinamicamente -->
              </div>
              <div style="text-align: center; margin-top: 20px">
                <button onclick="exportResults()" class="btn btn-success">
                  💾 Exportar Resultados
                </button>
                <button onclick="closeReport()" class="btn btn-secondary">
                  ❌ Fechar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar com Progresso -->
        <div class="sidebar">
          <h3>📊 Progresso Fase 4</h3>

          <div class="progress-item">
            <h4>Puzzle 1: Gestão Progresso</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-puzzle1"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="puzzle1-progress">0</span>/3 avaliações</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 2: Gestão Crises</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-puzzle2"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="puzzle2-progress">0</span>/3 crises resolvidas</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 3: Ajuste Estratégias</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-puzzle3"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="puzzle3-progress">0</span>/3 ajustes</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 4: Preparação Autonomia</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-puzzle4"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="puzzle4-progress">0</span>/4 áreas</p>
          </div>

          <div class="score-summary">
            <h4>🏆 Pontuação Fase 4</h4>
            <div class="score-circle">
              <span id="total-score-phase4">0</span>/100
            </div>
          </div>

          <div class="phase-data">
            <h4>📋 Escape Room Completo</h4>
            <p>
              <strong>Fase 1:</strong>
              <span id="sidebar-phase1-score">--</span>/100
            </p>
            <p>
              <strong>Fase 2:</strong>
              <span id="sidebar-phase2-score">--</span>/100
            </p>
            <p>
              <strong>Fase 3:</strong>
              <span id="sidebar-phase3-score">--</span>/100
            </p>
            <p>
              <strong>Fase 4:</strong>
              <span id="sidebar-phase4-score">0</span>/100
            </p>
            <hr />
            <p>
              <strong>TOTAL:</strong>
              <span id="sidebar-total-score">0</span>/400
            </p>
          </div>

          <div class="felisbina-status">
            <h4>👤 Estado da Felisbina</h4>
            <div style="font-size: 0.9rem; color: #7f8c8d">
              <p>
                <strong>Autonomia:</strong> <span id="autonomy-level">65%</span>
              </p>
              <p>
                <strong>Emprego:</strong>
                <span id="employment-status">Part-time</span>
              </p>
              <p>
                <strong>Habitação:</strong>
                <span id="housing-status">Temporária</span>
              </p>
              <p>
                <strong>Saúde Mental:</strong>
                <span id="mental-health">Estável</span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/shared.js"></script>
    <script src="js/selection-state-manager.js"></script>
    <script src="js/success-rate-system.js"></script>
    <script src="js/modal-system.js"></script>
    <script src="js/phase4-engine.js"></script>
    <script>
      // IMPLEMENTAÇÃO COMPLETA DA FASE 4 - CONFORME ESPECIFICAÇÃO DETALHADA
      // INTEGRAÇÃO COM NOVOS MOTORES - Agent 4 Implementation

      // NOTA: Estado do jogo agora é gerido pelo Phase4Engine
      // Mantendo compatibilidade com código existente que pode referenciar gameState
      let gameState = null;

      // Aguardar inicialização do Phase4Engine
      document.addEventListener("DOMContentLoaded", function () {
        // O gameState será definido pelo Phase4Engine quando inicializar
        const checkGameState = () => {
          if (window.gameState) {
            gameState = window.gameState;
            console.log("HTML gameState synchronized with Phase4Engine");
          } else if (window.phase4Engine) {
            gameState = window.phase4Engine.gameState;
            console.log(
              "HTML gameState synchronized with phase4Engine instance"
            );
          } else {
            // Try again in 50ms
            setTimeout(checkGameState, 50);
          }
        };

        // Start checking immediately
        checkGameState();
      });

      // DADOS MOVIDOS PARA phase4-engine.js - Agent 4 Implementation

      // TEMPORARY: Add missing data structures for HTML compatibility
      const crisisManagementData = {
        cenarios_crise: [
          {
            id: "crise_habitacional",
            titulo: "Crise Habitacional",
            descricao:
              "Felisbina foi despejada da pensão por atraso no pagamento",
            gravidade: "alta",
            urgencia: "alta",
            tempo_limite: 180, // 3 minutos em segundos
            opcoes_resposta: [
              {
                id: "contactar_emergencia_social",
                acao: "Contactar serviços de emergência social",
                probabilidade_sucesso: 85,
                consequencias:
                  "Abrigo temporário garantido, continuidade dos programas",
                pontos: 15,
                correto: true,
              },
              {
                id: "negociar_com_pensao",
                acao: "Tentar negociar com proprietário da pensão",
                probabilidade_sucesso: 45,
                consequencias:
                  "Solução temporária, dependente da boa vontade do proprietário",
                pontos: 8,
                correto: false,
              },
              {
                id: "procurar_familia",
                acao: "Contactar familiares para apoio",
                probabilidade_sucesso: 30,
                consequencias:
                  "Alto risco devido a conflitos familiares existentes",
                pontos: 5,
                correto: false,
              },
            ],
          },
          {
            id: "crise_emprego",
            titulo: "Perda de Oportunidade de Emprego",
            descricao: "A empresa onde faria estágio cancelou o programa",
            gravidade: "media",
            urgencia: "media",
            tempo_limite: 240, // 4 minutos
            opcoes_resposta: [
              {
                id: "buscar_alternativas_iefp",
                acao: "Buscar alternativas através do IEFP",
                probabilidade_sucesso: 75,
                consequencias:
                  "Aproveitamento da rede de contactos, novas oportunidades",
                pontos: 12,
                correto: true,
              },
              {
                id: "intensificar_formacao",
                acao: "Intensificar formação para melhorar competências",
                probabilidade_sucesso: 60,
                consequencias:
                  "Melhor preparação mas atraso nos objetivos de emprego",
                pontos: 8,
                correto: false,
              },
              {
                id: "procura_independente",
                acao: "Procura independente de emprego",
                probabilidade_sucesso: 35,
                consequencias: "Menor eficácia sem apoio especializado",
                pontos: 6,
                correto: false,
              },
            ],
          },
          {
            id: "crise_psicologica",
            titulo: "Crise Psicológica",
            descricao: "Felisbina manifesta sinais de depressão severa",
            gravidade: "critica",
            urgencia: "critica",
            tempo_limite: 120, // 2 minutos
            opcoes_resposta: [
              {
                id: "contactar_psiquiatra_urgencia",
                acao: "Contactar psiquiatra de urgência",
                probabilidade_sucesso: 95,
                consequencias:
                  "Intervenção especializada imediata, segurança garantida",
                pontos: 18,
                correto: true,
              },
              {
                id: "intensificar_psicologia",
                acao: "Intensificar consultas de psicologia",
                probabilidade_sucesso: 50,
                consequencias:
                  "Apoio importante mas pode não ser suficiente para crise",
                pontos: 10,
                correto: false,
              },
              {
                id: "medicacao_ansiedade",
                acao: "Prescrever medicação para ansiedade",
                probabilidade_sucesso: 20,
                consequencias:
                  "Fora da competência do técnico SAASI, sem efeito adequado",
                pontos: 3,
                correto: false,
              },
            ],
          },
        ],
      };

      const strategyAdjustmentData = {
        estrategias_ajuste: [
          {
            id: "mentoria_peer",
            nome: "Programa de Mentoria Entre Pares",
            descricao:
              "Conectar Felisbina com pessoas que superaram situações similares",
            categoria: "apoio_social",
            pontos: 12,
            adequado: true,
            vantagens: [
              "Apoio emocional",
              "Experiência partilhada",
              "Motivação",
            ],
            desafios: ["Disponibilidade de mentores", "Compatibilidade"],
          },
          {
            id: "formacao_competencias_vida",
            nome: "Formação em Competências de Vida",
            descricao: "Desenvolver autonomia pessoal e competências práticas",
            categoria: "capacitacao",
            pontos: 15,
            adequado: true,
            vantagens: [
              "Autonomia pessoal",
              "Competências práticas",
              "Autoconfiança",
            ],
            desafios: ["Tempo de formação", "Aplicação prática"],
          },
          {
            id: "apoio_juridico",
            nome: "Apoio Jurídico Especializado",
            descricao:
              "Assistência legal para questões habitacionais e familiares",
            categoria: "juridico",
            pontos: 10,
            adequado: true,
            vantagens: [
              "Resolução legal",
              "Proteção de direitos",
              "Orientação especializada",
            ],
            desafios: ["Custos", "Processos demorados"],
          },
          {
            id: "programa_voluntariado",
            nome: "Programa de Voluntariado",
            descricao:
              "Participação em atividades de voluntariado para autoestima",
            categoria: "integracao_social",
            pontos: 8,
            adequado: false,
            vantagens: ["Autoestima", "Rede social", "Propósito"],
            desafios: ["Baixa prioridade atual", "Energia limitada"],
            justificacao_inadequada:
              "Felisbina precisa focar primeiro na estabilidade básica antes de atividades voluntárias",
          },
          {
            id: "curso_empreendedorismo",
            nome: "Curso de Empreendedorismo Social",
            descricao: "Desenvolver projeto próprio de geração de rendimento",
            categoria: "empreendedorismo",
            pontos: 14,
            adequado: false,
            vantagens: ["Autonomia financeira", "Inovação", "Independência"],
            desafios: [
              "Complexidade alta",
              "Risco financeiro",
              "Conhecimentos técnicos",
            ],
            justificacao_inadequada:
              "Complexidade muito elevada para o perfil atual da Felisbina, requer base sólida primeiro",
          },
        ],
      };

      const autonomyPreparationData = {
        areas_autonomia: [
          {
            id: "gestao_financeira",
            nome: "Gestão Financeira",
            descricao: "Capacidade de gerir dinheiro e orçamento pessoal",
            nivel_atual: 40,
            nivel_objetivo: 80,
            status_atual: "basico_com_apoio",
            meta_6_meses: "autonomo_completo",
            acoes_necessarias: [
              {
                texto: "Criar orçamento mensal detalhado",
                acao: "Criar orçamento mensal detalhado",
                prazo: "2 semanas",
                responsavel: "tecnico_saasi",
                pontos: 8,
              },
              {
                texto: "Abrir conta bancária individual",
                acao: "Abrir conta bancária individual",
                prazo: "1 semana",
                responsavel: "felisbina_apoiada",
                pontos: 6,
              },
              {
                texto: "Aprender a usar homebanking",
                acao: "Aprender a usar homebanking",
                prazo: "3 semanas",
                responsavel: "iefp_formacao",
                pontos: 4,
              },
              {
                texto: "Planear poupanças mensais",
                acao: "Planear poupanças mensais",
                prazo: "1 mês",
                responsavel: "tecnico_saasi",
                pontos: 7,
              },
            ],
          },
          {
            id: "relacoes_interpessoais",
            nome: "Relações Interpessoais",
            descricao: "Desenvolver relações saudáveis e assertividade",
            nivel_atual: 35,
            nivel_objetivo: 75,
            status_atual: "dependente_emocional",
            meta_6_meses: "relacoes_equilibradas",
            acoes_necessarias: [
              {
                texto: "Participar em grupo de apoio",
                acao: "Participar em grupo de apoio",
                prazo: "6 meses",
                responsavel: "centro_saude",
                pontos: 10,
              },
              {
                texto: "Praticar comunicação assertiva",
                acao: "Praticar comunicação assertiva",
                prazo: "4 semanas",
                responsavel: "psicologo",
                pontos: 8,
              },
              {
                texto: "Estabelecer limites saudáveis",
                acao: "Estabelecer limites saudáveis",
                prazo: "3 meses",
                responsavel: "tecnico_saasi",
                pontos: 9,
              },
              {
                texto: "Desenvolver rede social de apoio",
                acao: "Desenvolver rede social de apoio",
                prazo: "5 meses",
                responsavel: "ipss_local",
                pontos: 7,
              },
            ],
          },
          {
            id: "gestao_domestica",
            nome: "Gestão Doméstica",
            descricao: "Autonomia nas tarefas domésticas e organização",
            nivel_atual: 70,
            nivel_objetivo: 90,
            status_atual: "parcialmente_autonomo",
            meta_6_meses: "totalmente_autonomo",
            acoes_necessarias: [
              {
                texto: "Planear refeições semanais",
                acao: "Planear refeições semanais",
                prazo: "2 semanas",
                responsavel: "felisbina_apoiada",
                pontos: 5,
              },
              {
                texto: "Gerir manutenção da casa",
                acao: "Gerir manutenção da casa",
                prazo: "3 meses",
                responsavel: "tecnico_saasi",
                pontos: 6,
              },
              {
                texto: "Organizar documentos pessoais",
                acao: "Organizar documentos pessoais",
                prazo: "1 semana",
                responsavel: "felisbina_apoiada",
                pontos: 4,
              },
              {
                texto: "Gerir contratos e serviços",
                acao: "Gerir contratos e serviços",
                prazo: "4 semanas",
                responsavel: "tecnico_saasi",
                pontos: 8,
              },
            ],
          },
          {
            id: "desenvolvimento_profissional",
            nome: "Desenvolvimento Profissional",
            descricao: "Autonomia na gestão da carreira profissional",
            nivel_atual: 55,
            nivel_objetivo: 85,
            status_atual: "em_desenvolvimento",
            meta_6_meses: "carreira_definida",
            acoes_necessarias: [
              {
                texto: "Definir objetivos de carreira",
                acao: "Definir objetivos de carreira",
                prazo: "2 semanas",
                responsavel: "consultor_iefp",
                pontos: 7,
              },
              {
                texto: "Desenvolver competências técnicas",
                acao: "Desenvolver competências técnicas",
                prazo: "6 meses",
                responsavel: "centro_formacao",
                pontos: 9,
              },
              {
                texto: "Construir rede profissional",
                acao: "Construir rede profissional",
                prazo: "4 meses",
                responsavel: "felisbina_apoiada",
                pontos: 8,
              },
              {
                texto: "Gerir procura ativa de emprego",
                acao: "Gerir procura ativa de emprego",
                prazo: "3 meses",
                responsavel: "tecnico_emprego",
                pontos: 10,
              },
            ],
          },
        ],
        estrategias_manutencao: [
          {
            id: "rede_apoio_comunidade",
            nome: "Rede de Apoio Comunitário",
            descricao: "Manter ligação com serviços locais de apoio",
            pontos: 8,
          },
          {
            id: "acompanhamento_periodico",
            nome: "Acompanhamento Periódico",
            descricao: "Consultas de follow-up mensais",
            pontos: 6,
          },
          {
            id: "grupo_apoio_autonomia",
            nome: "Grupo de Apoio à Autonomia",
            descricao: "Participação em grupo de pessoas em transição",
            pontos: 10,
          },
          {
            id: "plano_contingencia",
            nome: "Plano de Contingência",
            descricao: "Estratégias para situações de crise",
            pontos: 9,
          },
        ],
      };

      // INICIALIZAÇÃO AGORA GERIDA PELO PHASE4ENGINE
      // Funções de compatibilidade mantidas para transição suave

      // Toast System
      function showToast(message, type = "info", duration = 5000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
          ${message}
          <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Carregar dados das fases anteriores
      function loadPreviousPhases() {
        gameState.phase1Data = SaaSIStorage.loadPhaseResults(1);
        gameState.phase2Data = SaaSIStorage.loadPhaseResults(2);
        gameState.phase3Data = SaaSIStorage.loadPhaseResults(3);

        console.log("Phase 4 - Loading previous phases:");
        console.log("Phase 1 data:", gameState.phase1Data);
        console.log("Phase 2 data:", gameState.phase2Data);
        console.log("Phase 3 data:", gameState.phase3Data);

        // Verificar se pode aceder à Fase 4
        if (!gameState.phase3Data) {
          showToast(
            "⚠️ Acesso negado à Fase 4!<br><br>Deve completar a Fase 3 primeiro.<br>Redirecionando para o menu principal...",
            "error",
            3000
          );
          setTimeout(() => (window.location.href = "index.html"), 3000);
          return;
        }

        const phase3Score = gameState.phase3Data.score || 0;
        console.log("Phase 3 score for access check:", phase3Score);

        if (phase3Score < 65) {
          showToast(
            "⚠️ Acesso negado à Fase 4!<br><br>Deve completar a Fase 3 com pelo menos 65 pontos.<br>Pontuação atual: " +
              phase3Score +
              "/100<br><br>Redirecionando para o menu principal...",
            "error",
            4000
          );
          setTimeout(() => (window.location.href = "index.html"), 4000);
          return;
        }

        console.log("Phase 4 access granted - Phase 3 score:", phase3Score);

        // Atualizar sidebar com dados das fases anteriores
        if (gameState.phase1Data) {
          document.getElementById("sidebar-phase1-score").textContent =
            gameState.phase1Data.score;
        }
        if (gameState.phase2Data) {
          document.getElementById("sidebar-phase2-score").textContent =
            gameState.phase2Data.score;
        }
        if (gameState.phase3Data) {
          document.getElementById("sidebar-phase3-score").textContent =
            gameState.phase3Data.score;
        }
      }

      // Mudar estado do jogo
      function changeState(newState) {
        // Esconder todos os estados
        document.querySelectorAll(".state").forEach((state) => {
          state.classList.add("state-hidden");
        });

        // Mostrar novo estado
        document
          .getElementById(`state-${newState}`)
          .classList.remove("state-hidden");
        gameState.currentState = newState;

        // Adicionar animação
        document.getElementById(`state-${newState}`).classList.add("fade-in");

        // Inicializar estado específico
        switch (newState) {
          case "gestao-progresso":
            initProgressManagement();
            break;
          case "gestao-crises":
            initCrisisManagement();
            break;
          case "ajuste-estrategias":
            initStrategyAdjustment();
            break;
          case "preparacao-autonomia":
            initAutonomyPreparation();
            break;
          case "conclusao":
            showConclusion();
            break;
        }

        SaaSIAnalytics.trackEvent("phase4_state_change", {
          newState,
          timestamp: Date.now(),
        });
      }

      // PUZZLE 1: Inicializar gestão de progresso
      function initProgressManagement() {
        const container = document.getElementById(
          "progress-analysis-container"
        );
        container.innerHTML = "";

        progressManagementData.programas_em_curso.forEach((programa) => {
          const card = document.createElement("div");
          card.className = "indicator-card";
          card.innerHTML = `
            <h4>${programa.nome}</h4>
            <p><strong>Entidade:</strong> ${programa.entidade}</p>
            <p><strong>Progresso:</strong> ${programa.progresso_atual}%</p>
            <div class="progress-indicator">
              <div class="progress-fill" style="width: ${
                programa.progresso_atual
              }%; --progress-start: ${getProgressColor(
            programa.status
          )}; --progress-end: ${getProgressColor(programa.status)};"></div>
            </div>
            <p><strong>Observações:</strong> ${programa.observacoes}</p>
            <div style="margin-top: 15px;">
              <label><strong>Próxima ação recomendada:</strong></label>
              <select onchange="evaluateProgram('${
                programa.id
              }', this.value)" class="form-control">
                <option value="">Selecione uma ação...</option>
                <option value="continuar_conforme_planeado">Continuar conforme planeado</option>
                <option value="ajustar_metodologia">Ajustar metodologia</option>
                <option value="estrategia_alternativa">Estratégia alternativa</option>
                <option value="reforcar_apoio">Reforçar apoio</option>
                <option value="reduzir_intensidade">Reduzir intensidade</option>
              </select>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function getProgressColor(status) {
        switch (status) {
          case "em_curso":
            return "#4caf50";
          case "com_dificuldades":
            return "#ff9800";
          case "resistencia":
            return "#f44336";
          default:
            return "#2196f3";
        }
      }

      function evaluateProgram(programId, action) {
        const programa = progressManagementData.programas_em_curso.find(
          (p) => p.id === programId
        );

        if (action === programa.proxima_acao) {
          gameState.progressEvaluations[programId] = true;
          gameState.puzzle1Score += programa.pontos_avaliacao_correta;
          gameState.puzzle1Progress++;
        } else {
          gameState.progressEvaluations[programId] = false;
          gameState.puzzle1Progress++;
        }

        updateProgress();

        // Verificar se pode continuar
        if (gameState.puzzle1Progress >= 3) {
          document.getElementById("btn-continue-crisis").style.display =
            "block";
        }

        SaaSIAnalytics.trackInteraction("program_evaluation", {
          programId,
          action,
          correct: gameState.progressEvaluations[programId],
        });
      }

      // PUZZLE 2: Inicializar gestão de crises
      function initCrisisManagement() {
        const container = document.getElementById("crisis-scenarios-container");
        container.innerHTML = "";

        crisisManagementData.cenarios_crise.forEach((cenario, index) => {
          const card = document.createElement("div");
          card.className = "crisis-scenario";
          card.innerHTML = `
            <div class="crisis-timer" id="timer-${cenario.id}">${Math.floor(
            cenario.tempo_limite / 60
          )}:${(cenario.tempo_limite % 60).toString().padStart(2, "0")}</div>
            <h4>🚨 ${cenario.titulo}</h4>
            <p><strong>Urgência:</strong> ${cenario.urgencia.toUpperCase()}</p>
            <p>${cenario.descricao}</p>
            <div class="crisis-options" id="options-${cenario.id}">
              ${cenario.opcoes_resposta
                .map(
                  (opcao) => `
                <div class="crisis-option" onclick="selectCrisisOption('${cenario.id}', '${opcao.id}')">
                  <h5>${opcao.acao}</h5>
                  <p><strong>Probabilidade de sucesso:</strong> ${opcao.probabilidade_sucesso}%</p>
                  <p><strong>Consequências:</strong> ${opcao.consequencias}</p>
                </div>
              `
                )
                .join("")}
            </div>
            <div style="text-align: center; margin-top: 15px;">
              <button onclick="confirmCrisisResponse('${
                cenario.id
              }')" class="action-button" id="confirm-${cenario.id}" disabled>
                Confirmar Resposta
              </button>
            </div>
          `;
          container.appendChild(card);

          // Iniciar cronómetro
          startCrisisTimer(cenario.id, cenario.tempo_limite);
        });
      }

      let selectedCrisisOptions = {};

      function selectCrisisOption(cenarioId, opcaoId) {
        // Remover seleção anterior
        document
          .querySelectorAll(`#options-${cenarioId} .crisis-option`)
          .forEach((option) => {
            option.classList.remove("selected");
          });

        // Selecionar nova opção
        event.target.closest(".crisis-option").classList.add("selected");
        selectedCrisisOptions[cenarioId] = opcaoId;

        // Ativar botão de confirmação
        document.getElementById(`confirm-${cenarioId}`).disabled = false;
      }

      function confirmCrisisResponse(cenarioId) {
        const cenario = crisisManagementData.cenarios_crise.find(
          (c) => c.id === cenarioId
        );
        const opcaoId = selectedCrisisOptions[cenarioId];
        const opcao = cenario.opcoes_resposta.find((o) => o.id === opcaoId);

        if (opcao) {
          gameState.crisisResponses[cenarioId] = opcaoId;

          if (opcao.correto) {
            gameState.puzzle2Score += opcao.pontos;
            document
              .querySelector(`#options-${cenarioId} .crisis-option.selected`)
              .classList.add("correct");
          } else {
            gameState.puzzle2Score += Math.max(opcao.pontos, 0); // Não penalizar pontos negativos
            document
              .querySelector(`#options-${cenarioId} .crisis-option.selected`)
              .classList.add("incorrect");
          }

          gameState.puzzle2Progress++;

          // Desativar opções
          document
            .querySelectorAll(`#options-${cenarioId} .crisis-option`)
            .forEach((option) => {
              option.style.pointerEvents = "none";
            });
          document.getElementById(`confirm-${cenarioId}`).disabled = true;

          updateProgress();

          // Verificar se pode continuar
          if (gameState.puzzle2Progress >= 3) {
            document.getElementById("btn-continue-strategies").style.display =
              "block";
          }

          SaaSIAnalytics.trackInteraction("crisis_response", {
            cenarioId,
            opcaoId,
            correct: opcao.correto,
            points: opcao.pontos,
          });
        }
      }

      function startCrisisTimer(cenarioId, timeLimit) {
        let timeRemaining = timeLimit;
        const timerElement = document.getElementById(`timer-${cenarioId}`);

        const interval = setInterval(() => {
          timeRemaining--;
          const minutes = Math.floor(timeRemaining / 60);
          const seconds = timeRemaining % 60;
          timerElement.textContent = `${minutes}:${seconds
            .toString()
            .padStart(2, "0")}`;

          if (timeRemaining <= 0) {
            clearInterval(interval);
            timerElement.textContent = "TEMPO ESGOTADO";
            timerElement.style.background = "#f44336";

            // Auto-confirmar resposta se selecionada
            if (selectedCrisisOptions[cenarioId]) {
              confirmCrisisResponse(cenarioId);
            } else {
              // Penalizar por não responder
              gameState.puzzle2Progress++;
              updateProgress();
            }
          }
        }, 1000);
      }

      // PUZZLE 3: Inicializar ajuste de estratégias
      function initStrategyAdjustment() {
        const container = document.getElementById(
          "strategy-adjustment-container"
        );
        container.innerHTML = "";

        const header = document.createElement("div");
        header.innerHTML = `
          <h4>Selecione as estratégias de ajuste mais adequadas (escolha 3):</h4>
          <p>Baseie-se nos resultados dos primeiros 3 meses e nas situações imprevistas.</p>
        `;
        container.appendChild(header);

        strategyAdjustmentData.estrategias_ajuste.forEach((estrategia) => {
          const card = document.createElement("div");
          card.className = `strategy-card ${
            estrategia.adequado ? "selectable" : "inadequate"
          }`;
          card.onclick = () => toggleStrategy(estrategia.id);

          card.innerHTML = `
            <h4>${estrategia.nome}</h4>
            <p>${estrategia.descricao}</p>
            <div style="margin: 10px 0;">
              <strong>Vantagens:</strong> ${estrategia.vantagens.join(", ")}
            </div>
            <div style="margin: 10px 0;">
              <strong>Desafios:</strong> ${estrategia.desafios.join(", ")}
            </div>
            ${
              estrategia.justificacao_inadequada
                ? `
              <div style="color: #f44336; margin-top: 10px;">
                <strong>Por que inadequada:</strong> ${estrategia.justificacao_inadequada}
              </div>
            `
                : ""
            }
            <div style="text-align: right; margin-top: 10px;">
              <span class="badge ${
                estrategia.adequado ? "badge-success" : "badge-warning"
              }">
                ${estrategia.pontos > 0 ? "+" : ""}${estrategia.pontos} pontos
              </span>
            </div>
          `;
          container.appendChild(card);
        });
      }

      let selectedStrategies = [];

      function toggleStrategy(estrategiaId) {
        const estrategia = strategyAdjustmentData.estrategias_ajuste.find(
          (e) => e.id === estrategiaId
        );
        const card = event.currentTarget;

        if (!estrategia.adequado) {
          showToast(
            "⚠️ Esta estratégia não é adequada para a situação atual da Felisbina.",
            "warning",
            4000
          );
          return;
        }

        if (selectedStrategies.includes(estrategiaId)) {
          // Remover seleção
          selectedStrategies = selectedStrategies.filter(
            (id) => id !== estrategiaId
          );
          card.classList.remove("selected");
          gameState.puzzle3Score -= estrategia.pontos;
        } else {
          // Adicionar seleção (máximo 3)
          if (selectedStrategies.length >= 3) {
            showToast("🚫 Pode selecionar no máximo 3 estratégias.", "warning");
            return;
          }

          selectedStrategies.push(estrategiaId);
          card.classList.add("selected");
          gameState.puzzle3Score += estrategia.pontos;
        }

        gameState.strategyAdjustments = selectedStrategies;
        gameState.puzzle3Progress = selectedStrategies.length;

        updateProgress();

        // Verificar se pode continuar
        if (selectedStrategies.length >= 3) {
          document.getElementById("btn-continue-autonomy").style.display =
            "block";
        }

        SaaSIAnalytics.trackInteraction("strategy_selection", {
          estrategiaId,
          selected: selectedStrategies.includes(estrategiaId),
        });
      }

      // PUZZLE 4: Inicializar preparação para autonomia
      function initAutonomyPreparation() {
        const container = document.getElementById(
          "autonomy-preparation-container"
        );
        container.innerHTML = "";

        // Áreas de autonomia
        const areasSection = document.createElement("div");
        areasSection.innerHTML =
          "<h4>Áreas de Autonomia - Selecione ações para cada área:</h4>";
        container.appendChild(areasSection);

        autonomyPreparationData.areas_autonomia.forEach((area) => {
          const areaDiv = document.createElement("div");
          areaDiv.className = "autonomy-area";
          areaDiv.innerHTML = `
            <h5>${area.nome}</h5>
            <p><strong>Estado atual:</strong> ${area.status_atual.replace(
              /_/g,
              " "
            )}</p>
            <p><strong>Meta 6 meses:</strong> ${area.meta_6_meses.replace(
              /_/g,
              " "
            )}</p>
            <div class="actions-list">
              ${area.acoes_necessarias
                .map(
                  (acao, index) => `
                <div class="action-item">
                  <label>
                    <input type="checkbox" onchange="selectAutonomyAction('${
                      area.id
                    }', ${index}, this.checked)">
                    <strong>${acao.acao}</strong> (${acao.prazo})
                    <span class="badge badge-info">+${acao.pontos} pts</span>
                  </label>
                  <p>Responsável: ${acao.responsavel.replace(/_/g, " ")}</p>
                </div>
              `
                )
                .join("")}
            </div>
          `;
          container.appendChild(areaDiv);
        });

        // Estratégias de manutenção
        const maintenanceSection = document.createElement("div");
        maintenanceSection.innerHTML = `
          <h4 style="margin-top: 30px;">Estratégias de Manutenção - Selecione 3 estratégias:</h4>
        `;
        container.appendChild(maintenanceSection);

        autonomyPreparationData.estrategias_manutencao.forEach((estrategia) => {
          const strategyDiv = document.createElement("div");
          strategyDiv.className = "maintenance-strategy";
          strategyDiv.onclick = () => toggleMaintenanceStrategy(estrategia.id);

          strategyDiv.innerHTML = `
            <h5>${estrategia.nome}</h5>
            <p>${estrategia.descricao}</p>
            <div style="text-align: right; margin-top: 10px;">
              <span class="badge ${
                estrategia.adequado ? "badge-success" : "badge-warning"
              }">
                ${estrategia.pontos > 0 ? "+" : ""}${estrategia.pontos} pontos
              </span>
            </div>
            ${
              estrategia.justificacao
                ? `
              <div style="color: #f44336; margin-top: 10px; font-size: 0.9rem;">
                <strong>Justificação:</strong> ${estrategia.justificacao}
              </div>
            `
                : ""
            }
          `;
          container.appendChild(strategyDiv);
        });
      }

      let selectedAutonomyActions = {};
      let selectedMaintenanceStrategies = [];

      function selectAutonomyAction(areaId, actionIndex, checked) {
        if (!selectedAutonomyActions[areaId]) {
          selectedAutonomyActions[areaId] = [];
        }

        const area = autonomyPreparationData.areas_autonomia.find(
          (a) => a.id === areaId
        );
        const action = area.acoes_necessarias[actionIndex];

        if (checked) {
          selectedAutonomyActions[areaId].push(actionIndex);
          gameState.puzzle4Score += action.pontos;
        } else {
          selectedAutonomyActions[areaId] = selectedAutonomyActions[
            areaId
          ].filter((i) => i !== actionIndex);
          gameState.puzzle4Score -= action.pontos;
        }

        gameState.autonomyPlanning = {
          actions: selectedAutonomyActions,
          maintenanceStrategies: selectedMaintenanceStrategies,
        };

        // Calcular progresso (4 áreas)
        gameState.puzzle4Progress = Object.keys(selectedAutonomyActions).filter(
          (areaId) => selectedAutonomyActions[areaId].length > 0
        ).length;

        updateProgress();
        checkAutonomyCompletion();

        SaaSIAnalytics.trackInteraction("autonomy_action_selection", {
          areaId,
          actionIndex,
          checked,
        });
      }

      function toggleMaintenanceStrategy(estrategiaId) {
        const estrategia = autonomyPreparationData.estrategias_manutencao.find(
          (e) => e.id === estrategiaId
        );
        const card = event.currentTarget;

        if (!estrategia.adequado) {
          showToast(
            "⚠️ Esta estratégia não é adequada e pode impedir o desenvolvimento da autonomia.",
            "warning",
            4000
          );
          // Ainda permitir seleção mas com penalização
        }

        if (selectedMaintenanceStrategies.includes(estrategiaId)) {
          // Remover seleção
          selectedMaintenanceStrategies = selectedMaintenanceStrategies.filter(
            (id) => id !== estrategiaId
          );
          card.classList.remove("selected");
          gameState.puzzle4Score -= estrategia.pontos;
        } else {
          // Adicionar seleção (máximo 3)
          if (selectedMaintenanceStrategies.length >= 3) {
            showToast(
              "🚫 Pode selecionar no máximo 3 estratégias de manutenção.",
              "warning"
            );
            return;
          }

          selectedMaintenanceStrategies.push(estrategiaId);
          card.classList.add("selected");
          gameState.puzzle4Score += estrategia.pontos;
        }

        gameState.autonomyPlanning = {
          actions: selectedAutonomyActions,
          maintenanceStrategies: selectedMaintenanceStrategies,
        };

        updateProgress();
        checkAutonomyCompletion();

        SaaSIAnalytics.trackInteraction("maintenance_strategy_selection", {
          estrategiaId,
          selected: selectedMaintenanceStrategies.includes(estrategiaId),
        });
      }

      function checkAutonomyCompletion() {
        // Verificar se pode finalizar (pelo menos 2 ações por área e 3 estratégias de manutenção)
        const areasWithActions = Object.keys(selectedAutonomyActions).filter(
          (areaId) => selectedAutonomyActions[areaId].length >= 2
        );

        if (
          areasWithActions.length >= 3 &&
          selectedMaintenanceStrategies.length >= 3
        ) {
          document.getElementById("btn-finalize-phase4").style.display =
            "block";
        }
      }

      // Atualizar progresso
      function updateProgress() {
        // Atualizar pontuação total
        gameState.score =
          gameState.puzzle1Score +
          gameState.puzzle2Score +
          gameState.puzzle3Score +
          gameState.puzzle4Score;

        // Atualizar interface
        document.getElementById("total-score-phase4").textContent =
          gameState.score;
        document.getElementById("sidebar-phase4-score").textContent =
          gameState.score;

        // Atualizar pontuações dos puzzles
        document.getElementById(
          "puzzle1-score"
        ).textContent = `${gameState.puzzle1Score}/25 pontos`;
        document.getElementById(
          "puzzle2-score"
        ).textContent = `${gameState.puzzle2Score}/30 pontos`;
        document.getElementById(
          "puzzle3-score"
        ).textContent = `${gameState.puzzle3Score}/25 pontos`;
        document.getElementById(
          "puzzle4-score"
        ).textContent = `${gameState.puzzle4Score}/20 pontos`;

        // Atualizar barras de progresso
        document.getElementById("progress-puzzle1").style.width = `${
          (gameState.puzzle1Progress / 3) * 100
        }%`;
        document.getElementById("progress-puzzle2").style.width = `${
          (gameState.puzzle2Progress / 3) * 100
        }%`;
        document.getElementById("progress-puzzle3").style.width = `${
          (gameState.puzzle3Progress / 3) * 100
        }%`;
        document.getElementById("progress-puzzle4").style.width = `${
          (gameState.puzzle4Progress / 4) * 100
        }%`;

        // Atualizar contadores
        document.getElementById("puzzle1-progress").textContent =
          gameState.puzzle1Progress;
        document.getElementById("puzzle2-progress").textContent =
          gameState.puzzle2Progress;
        document.getElementById("puzzle3-progress").textContent =
          gameState.puzzle3Progress;
        document.getElementById("puzzle4-progress").textContent =
          gameState.puzzle4Progress;

        updateSidebar();
      }

      function updateSidebar() {
        // Calcular pontuação total do escape room (limitada ao máximo de 400)
        let totalScore = gameState.score;
        if (gameState.phase1Data) totalScore += gameState.phase1Data.score;
        if (gameState.phase2Data) totalScore += gameState.phase2Data.score;
        if (gameState.phase3Data) totalScore += gameState.phase3Data.score;

        // Limitar ao máximo de 400 pontos
        totalScore = Math.min(totalScore, 400);

        document.getElementById("sidebar-total-score").textContent = totalScore;

        // Atualizar estado da Felisbina baseado no progresso
        const autonomyLevel = Math.min(95, 65 + gameState.score / 4); // Começa com 65% e aumenta com progresso
        document.getElementById("autonomy-level").textContent = `${Math.round(
          autonomyLevel
        )}%`;

        // Atualizar outros indicadores baseados nas decisões tomadas
        if (selectedStrategies.includes("modelo_hibrido_emprego_formacao")) {
          document.getElementById("employment-status").textContent =
            "Part-time + Formação";
        }

        if (
          gameState.crisisResponses["crise_habitacional"] ===
          "contactar_emergencia_social"
        ) {
          document.getElementById("housing-status").textContent =
            "Estável (temporária)";
        }

        document.getElementById("mental-health").textContent =
          gameState.score > 70 ? "Muito Estável" : "Estável";
      }

      // Mostrar conclusão
      function showConclusion() {
        gameState.completionTime = Date.now();
        const duration = Math.round(
          (gameState.completionTime - gameState.startTime) / 60000
        );

        // Calcular nível final
        let level = "Técnico Iniciante";
        let certification = "Técnico Competente SAASI";

        if (gameState.score >= 95) {
          level = "Master SAASI";
          certification = "Master SAASI";
        } else if (gameState.score >= 85) {
          level = "Técnico Especialista";
          certification = "Técnico Especialista SAASI";
        } else if (gameState.score >= 70) {
          level = "Técnico Proficiente";
          certification = "Técnico Proficiente SAASI";
        } else if (gameState.score >= 50) {
          level = "Técnico Competente";
        }

        // Calcular pontuação total do escape room
        let totalScore = gameState.score;
        if (gameState.phase1Data) totalScore += gameState.phase1Data.score;
        if (gameState.phase2Data) totalScore += gameState.phase2Data.score;
        if (gameState.phase3Data) totalScore += gameState.phase3Data.score;

        document.getElementById("final-score-phase4").textContent =
          gameState.score;
        document.getElementById("final-score-total").textContent = totalScore;
        document.getElementById("final-level").textContent = level;
        document.getElementById("final-certification").textContent =
          certification;

        // Salvar resultados da Fase 4
        const phase4Results = {
          phase: 4,
          score: gameState.score,
          maxScore: 100,
          percentage: gameState.score,
          duration: duration,
          level: { title: level },
          certification: certification,
          progressEvaluations: gameState.progressEvaluations,
          crisisResponses: gameState.crisisResponses,
          strategyAdjustments: gameState.strategyAdjustments,
          autonomyPlanning: gameState.autonomyPlanning,
          puzzleScores: {
            puzzle1: gameState.puzzle1Score,
            puzzle2: gameState.puzzle2Score,
            puzzle3: gameState.puzzle3Score,
            puzzle4: gameState.puzzle4Score,
          },
          totalEscapeRoomScore: totalScore,
          completionTime: gameState.completionTime,
          startTime: gameState.startTime,
        };

        SaaSIStorage.savePhaseResults(4, phase4Results);

        // Gerar achievements finais
        generateFinalAchievements(totalScore);

        SaaSIAnalytics.trackPhaseCompletion(4, phase4Results);
        SaaSIAnalytics.trackEvent("escape_room_completed", {
          totalScore,
          duration,
          certification,
        });
      }

      function generateFinalAchievements(totalScore) {
        const achievementsContainer =
          document.getElementById("achievements-final");
        const achievements = [];

        // Achievements da Fase 4
        if (gameState.puzzle2Score >= 25)
          achievements.push("🚨 Gestor de Crises");
        if (gameState.puzzle3Score >= 20)
          achievements.push("🎯 Estrategista Adaptável");
        if (gameState.puzzle4Score >= 18)
          achievements.push("🌟 Mentor da Autonomia");

        // Achievement final do escape room
        if (totalScore >= 340) achievements.push("👑 Master SAASI");
        else if (totalScore >= 280)
          achievements.push("🏆 Especialista SAASI Completo");
        else if (totalScore >= 220)
          achievements.push("⭐ Técnico SAASI Proficiente");

        if (achievements.length > 0) {
          achievementsContainer.innerHTML = `
            <h4>🏆 Conquistas Desbloqueadas:</h4>
            <div style="margin: 15px 0;">
              ${achievements
                .map(
                  (achievement) =>
                    `<span class="badge badge-achievement">${achievement}</span>`
                )
                .join("")}
            </div>
          `;
        } else {
          achievementsContainer.innerHTML = `
            <h4>🏆 Continue a praticar para desbloquear conquistas!</h4>
          `;
        }
      }

      // Mostrar relatório final
      function showFinalReport() {
        document
          .getElementById("state-conclusao")
          .classList.add("state-hidden");
        document
          .getElementById("final-report-modal")
          .classList.remove("state-hidden");

        generateFinalReport();
      }

      function generateFinalReport() {
        const content = document.getElementById("final-report-content");

        const totalScore =
          (gameState.phase1Data?.score || 0) +
          (gameState.phase2Data?.score || 0) +
          (gameState.phase3Data?.score || 0) +
          gameState.score;

        const totalDuration =
          (gameState.phase1Data?.duration || 0) +
          (gameState.phase2Data?.duration || 0) +
          (gameState.phase3Data?.duration || 0) +
          Math.round((gameState.completionTime - gameState.startTime) / 60000);

        content.innerHTML = `
          <div class="final-report">
            <h3>📊 Resumo Executivo</h3>
            <div class="row">
              <div class="col">
                <div class="card">
                  <div class="card-body">
                    <h4>Pontuação Total</h4>
                    <div class="score-circle" style="margin: 20px auto;">
                      ${totalScore}/400
                    </div>
                    <p><strong>Percentagem:</strong> ${Math.round(
                      (totalScore / 400) * 100
                    )}%</p>
                    <p><strong>Tempo Total:</strong> ${totalDuration} minutos</p>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card">
                  <div class="card-body">
                    <h4>Desempenho por Fase</h4>
                    <p><strong>Fase 1:</strong> ${
                      gameState.phase1Data?.score || 0
                    }/100 (${gameState.phase1Data?.duration || 0}min)</p>
                    <p><strong>Fase 2:</strong> ${
                      gameState.phase2Data?.score || 0
                    }/100 (${gameState.phase2Data?.duration || 0}min)</p>
                    <p><strong>Fase 3:</strong> ${
                      gameState.phase3Data?.score || 0
                    }/100 (${gameState.phase3Data?.duration || 0}min)</p>
                    <p><strong>Fase 4:</strong> ${
                      gameState.score
                    }/100 (${Math.round(
          (gameState.completionTime - gameState.startTime) / 60000
        )}min)</p>
                  </div>
                </div>
              </div>
            </div>

            <h3>🎯 Resultado do Caso Felisbina Santos</h3>
            <div class="card">
              <div class="card-body">
                <h4>Estado Final da Beneficiária</h4>
                <div class="row">
                  <div class="col">
                    <p><strong>Autonomia Pessoal:</strong> ${
                      document.getElementById("autonomy-level").textContent
                    }</p>
                    <p><strong>Situação Profissional:</strong> ${
                      document.getElementById("employment-status").textContent
                    }</p>
                  </div>
                  <div class="col">
                    <p><strong>Habitação:</strong> ${
                      document.getElementById("housing-status").textContent
                    }</p>
                    <p><strong>Saúde Mental:</strong> ${
                      document.getElementById("mental-health").textContent
                    }</p>
                  </div>
                </div>
                <h5>Fatores de Sucesso:</h5>
                <ul>
                  ${
                    totalScore >= 300
                      ? "<li>Excelente coordenação multissetorial</li>"
                      : ""
                  }
                  ${
                    gameState.puzzle2Score >= 25
                      ? "<li>Gestão eficaz de situações de crise</li>"
                      : ""
                  }
                  ${
                    gameState.puzzle4Score >= 18
                      ? "<li>Planeamento sustentável para autonomia</li>"
                      : ""
                  }
                  <li>Abordagem personalizada e adaptativa</li>
                </ul>
              </div>
            </div>

            <h3>💡 Recomendações para Desenvolvimento Profissional</h3>
            <div class="card">
              <div class="card-body">
                ${
                  totalScore >= 340
                    ? `
                  <div class="alert alert-success">
                    <h5>🏆 Excelente Desempenho!</h5>
                    <p>Demonstrou competências avançadas em todas as áreas. Considere:</p>
                    <ul>
                      <li>Mentoria de novos técnicos</li>
                      <li>Formação especializada em casos complexos</li>
                      <li>Participação em desenvolvimento de metodologias</li>
                    </ul>
                  </div>
                `
                    : totalScore >= 280
                    ? `
                  <div class="alert alert-info">
                    <h5>⭐ Bom Desempenho!</h5>
                    <p>Competências sólidas demonstradas. Áreas para desenvolvimento:</p>
                    <ul>
                      <li>Aprofundar gestão de situações de crise</li>
                      <li>Desenvolver competências de planeamento estratégico</li>
                      <li>Fortalecer articulação interinstitucional</li>
                    </ul>
                  </div>
                `
                    : `
                  <div class="alert alert-warning">
                    <h5>📚 Continue a Desenvolver!</h5>
                    <p>Base sólida estabelecida. Focos prioritários:</p>
                    <ul>
                      <li>Praticar avaliação sistemática de necessidades</li>
                      <li>Melhorar competências de tomada de decisão</li>
                      <li>Desenvolver visão sistémica de intervenção</li>
                    </ul>
                  </div>
                `
                }
              </div>
            </div>
          </div>
        `;
      }

      function closeReport() {
        document
          .getElementById("final-report-modal")
          .classList.add("state-hidden");
        document
          .getElementById("state-conclusao")
          .classList.remove("state-hidden");
      }

      function exportResults() {
        const results = {
          escapeRoom: "SAASI",
          completionDate: new Date().toISOString(),
          totalScore:
            (gameState.phase1Data?.score || 0) +
            (gameState.phase2Data?.score || 0) +
            (gameState.phase3Data?.score || 0) +
            gameState.score,
          phases: {
            phase1: gameState.phase1Data,
            phase2: gameState.phase2Data,
            phase3: gameState.phase3Data,
            phase4: {
              score: gameState.score,
              progressEvaluations: gameState.progressEvaluations,
              crisisResponses: gameState.crisisResponses,
              strategyAdjustments: gameState.strategyAdjustments,
              autonomyPlanning: gameState.autonomyPlanning,
            },
          },
        };

        const dataStr = JSON.stringify(results, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `SAASI_EscapeRoom_Results_${
          new Date().toISOString().split("T")[0]
        }.json`;
        link.click();
        URL.revokeObjectURL(url);

        SaaSIAnalytics.trackEvent("results_exported", {
          totalScore: results.totalScore,
        });
      }

      // Reiniciar Fase 4
      async function restartPhase4() {
        const confirmRestart = await ModalSystem.confirm(
          "🔄 Tem certeza que deseja reiniciar a Fase 4?<br><br>Todos os progressos desta fase serão perdidos.",
          {
            title: "🔄 Reiniciar Fase 4",
            okText: "Sim, reiniciar",
            cancelText: "Cancelar",
            type: "warning",
          }
        );

        if (confirmRestart) {
          localStorage.removeItem("saasi_phase4_results");
          location.reload();
        }
      }

      // Funcionalidade de continuar para próxima fase (futuro)
      function continueToPhase5() {
        showToast(
          "🎉 Parabéns! Completou todo o Escape Room SAASI!<br><br>Este é o final da experiência de formação.",
          "success",
          8000
        );
      }
    </script>
  </body>
</html>
