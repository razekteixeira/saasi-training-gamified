<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAASI Escape Room - Fase 4: Implementa√ß√£o e Acompanhamento</title>
    <link rel="stylesheet" href="css/main.css" />
    <style>
      /* Toast System */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
      }

      .toast {
        background: #333;
        color: white;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        padding-right: 50px;
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        background: #28a745;
        border-left: 4px solid #1e7e34;
      }

      .toast.error {
        background: #dc3545;
        border-left: 4px solid #c82333;
      }

      .toast.warning {
        background: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .toast.info {
        background: #17a2b8;
        border-left: 4px solid #138496;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* Estilos espec√≠ficos da Fase 4 - CONFORME ESPECIFICA√á√ÉO DETALHADA */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
      }

      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        z-index: 1000;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .back-button:hover {
        background: rgba(84, 91, 98, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      /* Layout Grid Fase 4 - CONFORME ESPECIFICA√á√ÉO */
      .fase4-container {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 30px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .puzzle-area {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        min-height: 600px;
      }

      .sidebar {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 25px;
        height: fit-content;
        position: sticky;
        top: 20px;
      }

      /* Dashboard de Acompanhamento - CONFORME ESPECIFICA√á√ÉO */
      .progress-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .program-progress-card {
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 20px;
        border-left: 4px solid var(--progress-color);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .program-progress-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .progress-indicator {
        position: relative;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 15px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--progress-start),
          var(--progress-end)
        );
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      /* Sistema de Alertas de Crise - CONFORME ESPECIFICA√á√ÉO */
      .crisis-alert {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        animation: pulse 2s infinite;
        border: 2px solid #ff4757;
        position: relative;
      }

      .crisis-timer {
        position: absolute;
        top: 10px;
        right: 15px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 0.9rem;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      /* Timeline de Ajustes - CONFORME ESPECIFICA√á√ÉO */
      .adjustment-timeline {
        position: relative;
        padding: 20px 0;
      }

      .timeline-line {
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #667eea, #764ba2);
        transform: translateX(-50%);
      }

      .timeline-event {
        position: relative;
        margin: 20px 0;
        display: flex;
        align-items: center;
      }

      .timeline-event:nth-child(odd) {
        flex-direction: row-reverse;
      }

      .event-content {
        flex: 1;
        margin: 0 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      /* Estados do jogo */
      .state {
        display: block;
      }

      .state-hidden {
        display: none;
      }

      .puzzle-section {
        margin-bottom: 30px;
        padding: 25px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.8);
      }

      .puzzle-section.active {
        background: rgba(255, 243, 205, 0.6);
        border: 2px solid #ffc107;
      }

      .puzzle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .puzzle-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }

      .puzzle-score {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* Componentes espec√≠ficos dos puzzles */
      .indicator-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .indicator-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
      }

      .indicator-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-bottom: 5px;
      }

      .indicator-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .status-positive {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .status-neutral {
        background: #fff3e0;
        color: #f57c00;
      }
      .status-negative {
        background: #ffebee;
        color: #c62828;
      }

      /* Bot√µes de a√ß√£o */
      .action-button {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin: 5px;
        transition: all 0.3s ease;
      }

      .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
      }

      .action-button.inadequate {
        background: linear-gradient(135deg, #f44336, #d32f2f);
      }

      .action-button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Crisis management espec√≠fico */
      .crisis-scenario {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border: 2px solid #ff9800;
        animation: highlightCrisis 1s ease-in-out;
      }

      @keyframes highlightCrisis {
        0% {
          background: #fff3e0;
        }
        50% {
          background: #ffecb3;
        }
        100% {
          background: white;
        }
      }

      .crisis-options {
        display: grid;
        gap: 10px;
        margin-top: 15px;
      }

      .crisis-option {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .crisis-option:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .crisis-option.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .crisis-option.correct {
        border-color: #4caf50;
        background: #e8f5e9;
      }

      .crisis-option.incorrect {
        border-color: #f44336;
        background: #ffebee;
      }

      /* Strategy adjustment espec√≠fico */
      .strategy-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .strategy-card.selectable:hover {
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .strategy-card.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.05);
      }

      .strategy-card.inadequate {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Autonomy preparation espec√≠fico */
      .autonomy-area {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
      }

      .action-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        border-left: 3px solid #667eea;
      }

      .maintenance-strategy {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .maintenance-strategy:hover {
        border-color: #667eea;
      }

      .maintenance-strategy.selected {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.05);
      }

      /* Responsividade */
      @media (max-width: 1200px) {
        .fase4-container {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .sidebar {
          position: static;
          margin-top: 20px;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
        }

        .container,
        .puzzle-area {
          padding: 20px;
        }

        .progress-dashboard {
          grid-template-columns: 1fr;
        }

        .timeline-event {
          flex-direction: column !important;
        }

        .timeline-line {
          left: 20px;
        }
      }

      /* Anima√ß√µes espec√≠ficas */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 15px auto;
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <a href="index.html" class="back-button">üè† Voltar ao Menu</a>

    <div class="main-container">
      <div class="fase4-container">
        <!-- √Årea Principal dos Puzzles -->
        <div class="puzzle-area">
          <div class="header">
            <h1>üéØ Fase 4: Implementa√ß√£o e Acompanhamento</h1>
            <p class="subtitle">
              Executar o plano de interven√ß√£o, gerir imprevistos e ajustar
              estrat√©gias
            </p>
          </div>

          <!-- Estado: Introdu√ß√£o -->
          <div id="state-intro" class="state">
            <div class="container">
              <h3>üìÖ Situa√ß√£o Atual - 3 Meses Depois</h3>
              <p>
                Passaram-se 3 meses desde o in√≠cio da implementa√ß√£o do plano de
                interven√ß√£o da Felisbina. O plano est√° em execu√ß√£o, mas surgem
                desafios que requerem ajustes e tomadas de decis√£o em tempo
                real.
              </p>

              <div class="progress-dashboard">
                <div
                  class="program-progress-card"
                  style="--progress-color: #4caf50"
                >
                  <h4>üß† Consultas de Psicologia</h4>
                  <div class="progress-indicator">
                    <div
                      class="progress-fill"
                      style="
                        --progress-start: #4caf50;
                        --progress-end: #66bb6a;
                        width: 67%;
                      "
                    ></div>
                  </div>
                  <p>
                    <strong>8 de 12 sess√µes realizadas</strong> - Progresso
                    positivo
                  </p>
                  <div class="indicator-status status-positive">
                    Em curso - Progresso consistente
                  </div>
                </div>

                <div
                  class="program-progress-card"
                  style="--progress-color: #ff9800"
                >
                  <h4>üìö Programa Qualifica</h4>
                  <div class="progress-indicator">
                    <div
                      class="progress-fill"
                      style="
                        --progress-start: #ff9800;
                        --progress-end: #ffb74d;
                        width: 50%;
                      "
                    ></div>
                  </div>
                  <p><strong>50% conclu√≠do</strong> - Algumas dificuldades</p>
                  <div class="indicator-status status-neutral">
                    Dificuldades na componente te√≥rica
                  </div>
                </div>

                <div
                  class="program-progress-card"
                  style="--progress-color: #f44336"
                >
                  <h4>üë• Grupos de Apoio Social</h4>
                  <div class="progress-indicator">
                    <div
                      class="progress-fill"
                      style="
                        --progress-start: #f44336;
                        --progress-end: #ef5350;
                        width: 40%;
                      "
                    ></div>
                  </div>
                  <p>
                    <strong>Participa√ß√£o irregular</strong> - Resist√™ncia
                    inicial
                  </p>
                  <div class="indicator-status status-negative">
                    Resist√™ncia √† participa√ß√£o
                  </div>
                </div>
              </div>

              <div class="alert alert-warning">
                <h4>üö® Situa√ß√µes que Requerem Aten√ß√£o:</h4>
                <ul>
                  <li>
                    <strong>Situa√ß√£o habitacional:</strong> Mudan√ßa inesperada -
                    precisa novo alojamento
                  </li>
                  <li>
                    <strong>Oportunidade de emprego:</strong> Surgiu vaga em
                    empresa de limpeza
                  </li>
                  <li>
                    <strong>Programa Qualifica:</strong> Dificuldades na
                    componente te√≥rica
                  </li>
                </ul>
              </div>

              <div style="text-align: center; margin-top: 30px">
                <button
                  onclick="changeState('gestao-progresso')"
                  class="btn btn-primary"
                >
                  üöÄ Iniciar Gest√£o do Acompanhamento
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Gest√£o de Progresso (PUZZLE 1) -->
          <div id="state-gestao-progresso" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  üìä Puzzle 1: Gest√£o de Progresso e Indicadores
                </h2>
                <div class="puzzle-score" id="puzzle1-score">0/25 pontos</div>
              </div>

              <p>
                Avalie o progresso atual dos programas e identifique √°reas que
                necessitam ajuste.
              </p>

              <div id="progress-analysis-container">
                <!-- Conte√∫do ser√° carregado dinamicamente -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-crisis"
                  onclick="changeState('gestao-crises')"
                  class="btn btn-primary"
                  style="display: none"
                >
                  ‚û°Ô∏è Continuar para Gest√£o de Crises
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Gest√£o de Crises (PUZZLE 2) -->
          <div id="state-gestao-crises" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  üö® Puzzle 2: Gest√£o de Situa√ß√µes Imprevistas
                </h2>
                <div class="puzzle-score" id="puzzle2-score">0/30 pontos</div>
              </div>

              <p>
                Responda a crises e situa√ß√µes n√£o planeadas que surgem durante a
                implementa√ß√£o.
              </p>

              <div id="crisis-scenarios-container">
                <!-- Cen√°rios de crise ser√£o carregados dinamicamente -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-strategies"
                  onclick="changeState('ajuste-estrategias')"
                  class="btn btn-primary"
                  style="display: none"
                >
                  ‚û°Ô∏è Continuar para Ajuste de Estrat√©gias
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Ajuste de Estrat√©gias (PUZZLE 3) -->
          <div id="state-ajuste-estrategias" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">üéØ Puzzle 3: Ajuste de Estrat√©gias</h2>
                <div class="puzzle-score" id="puzzle3-score">0/25 pontos</div>
              </div>

              <p>
                Modifique o plano original baseado nos resultados obtidos e
                situa√ß√µes imprevistas.
              </p>

              <div id="strategy-adjustment-container">
                <!-- Estrat√©gias de ajuste ser√£o carregadas dinamicamente -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-autonomy"
                  onclick="changeState('preparacao-autonomia')"
                  class="btn btn-primary"
                  style="display: none"
                >
                  ‚û°Ô∏è Continuar para Prepara√ß√£o de Autonomia
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Prepara√ß√£o para Autonomia (PUZZLE 4) -->
          <div id="state-preparacao-autonomia" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  üåü Puzzle 4: Prepara√ß√£o para Autonomia
                </h2>
                <div class="puzzle-score" id="puzzle4-score">0/20 pontos</div>
              </div>

              <p>
                Defina estrat√©gias de manuten√ß√£o e redu√ß√£o gradual do apoio para
                promover a autonomia sustent√°vel.
              </p>

              <div id="autonomy-preparation-container">
                <!-- Planeamento de autonomia ser√° carregado dinamicamente -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-finalize-phase4"
                  onclick="changeState('conclusao')"
                  class="btn btn-primary"
                  style="display: none"
                >
                  ‚úÖ Finalizar Fase 4
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Conclus√£o -->
          <div id="state-conclusao" class="state state-hidden">
            <div class="container" style="text-align: center">
              <h2>üéâ Fase 4 Completada com Sucesso!</h2>
              <h3>üèÜ ESCAPE ROOM SAASI CONCLU√çDO!</h3>

              <div class="score-display" style="margin: 30px 0">
                <p>N√≠vel: <span id="final-level">T√©cnico Iniciante</span></p>
                <p>
                  Certifica√ß√£o:
                  <span id="final-certification">T√©cnico Competente SAASI</span>
                </p>
              </div>

              <div class="achievements-final" id="achievements-final">
                <!-- Achievements finais ser√£o carregados dinamicamente -->
              </div>

              <div style="margin-top: 30px">
                <button onclick="showFinalReport()" class="btn btn-primary">
                  üìä Ver Relat√≥rio Final Completo
                </button>
                <button onclick="restartPhase4()" class="btn btn-secondary">
                  üîÑ Repetir Fase 4
                </button>
                <a href="index.html" class="btn btn-secondary"
                  >üè† Voltar ao Menu</a
                >
              </div>
            </div>
          </div>

          <!-- Modal do Relat√≥rio Final -->
          <div id="final-report-modal" class="state state-hidden">
            <div class="container">
              <h2>üìä Relat√≥rio Final Integrado - Escape Room SAASI</h2>
              <div id="final-report-content">
                <!-- Relat√≥rio ser√° gerado dinamicamente -->
              </div>
              <div style="text-align: center; margin-top: 20px">
                <button onclick="exportResults()" class="btn btn-success">
                  üíæ Exportar Resultados
                </button>
                <button onclick="closeReport()" class="btn btn-secondary">
                  ‚ùå Fechar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar com Progresso -->
        <div class="sidebar">
          <h3>üìä Progresso Fase 4</h3>

          <div class="progress-item">
            <h4>Puzzle 1: Gest√£o Progresso</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-puzzle1"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="puzzle1-progress">0</span>/3 avalia√ß√µes</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 2: Gest√£o Crises</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-puzzle2"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="puzzle2-progress">0</span>/3 crises resolvidas</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 3: Ajuste Estrat√©gias</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-puzzle3"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="puzzle3-progress">0</span>/3 ajustes</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 4: Prepara√ß√£o Autonomia</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-puzzle4"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="puzzle4-progress">0</span>/4 √°reas</p>
          </div>

          <div class="score-summary">
            <h4>üèÜ Pontua√ß√£o Fase 4</h4>
            <div class="score-circle">
              <span id="total-score-phase4">0</span>/100
            </div>
          </div>

          <div class="phase-data">
            <h4>üìã Escape Room Completo</h4>
            <p>
              <strong>Fase 1:</strong>
              <span id="sidebar-phase1-score">--</span>/100
            </p>
            <p>
              <strong>Fase 2:</strong>
              <span id="sidebar-phase2-score">--</span>/100
            </p>
            <p>
              <strong>Fase 3:</strong>
              <span id="sidebar-phase3-score">--</span>/100
            </p>
            <p>
              <strong>Fase 4:</strong>
              <span id="sidebar-phase4-score">0</span>/100
            </p>
            <hr />
            <p>
              <strong>TOTAL:</strong>
              <span id="sidebar-total-score">0</span>/400
            </p>
          </div>

          <div class="felisbina-status">
            <h4>üë§ Estado da Felisbina</h4>
            <div style="font-size: 0.9rem; color: #7f8c8d">
              <p>
                <strong>Autonomia:</strong> <span id="autonomy-level">65%</span>
              </p>
              <p>
                <strong>Emprego:</strong>
                <span id="employment-status">Part-time</span>
              </p>
              <p>
                <strong>Habita√ß√£o:</strong>
                <span id="housing-status">Tempor√°ria</span>
              </p>
              <p>
                <strong>Sa√∫de Mental:</strong>
                <span id="mental-health">Est√°vel</span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/shared.js"></script>
    <script src="js/selection-state-manager.js"></script>
    <script src="js/success-rate-system.js"></script>
    <script src="js/modal-system.js"></script>
    <script src="js/phase4-engine.js"></script>
    <script>
      // IMPLEMENTA√á√ÉO COMPLETA DA FASE 4 - CONFORME ESPECIFICA√á√ÉO DETALHADA
      // INTEGRA√á√ÉO COM NOVOS MOTORES - Agent 4 Implementation

      // NOTA: Estado do jogo agora √© gerido pelo Phase4Engine
      // Mantendo compatibilidade com c√≥digo existente que pode referenciar gameState
      let gameState = null;

      // Aguardar inicializa√ß√£o do Phase4Engine
      document.addEventListener("DOMContentLoaded", function () {
        // O gameState ser√° definido pelo Phase4Engine quando inicializar
        const checkGameState = () => {
          if (window.gameState) {
            gameState = window.gameState;
            console.log("HTML gameState synchronized with Phase4Engine");
          } else if (window.phase4Engine) {
            gameState = window.phase4Engine.gameState;
            console.log(
              "HTML gameState synchronized with phase4Engine instance"
            );
          } else {
            // Try again in 50ms
            setTimeout(checkGameState, 50);
          }
        };

        // Start checking immediately
        checkGameState();
      });

      // DADOS MOVIDOS PARA phase4-engine.js - Agent 4 Implementation

      // TEMPORARY: Add missing data structures for HTML compatibility
      const crisisManagementData = {
        cenarios_crise: [
          {
            id: "crise_habitacional",
            titulo: "Crise Habitacional",
            descricao:
              "Felisbina foi despejada da pens√£o por atraso no pagamento",
            gravidade: "alta",
            urgencia: "alta",
            tempo_limite: 180, // 3 minutos em segundos
            opcoes_resposta: [
              {
                id: "contactar_emergencia_social",
                acao: "Contactar servi√ßos de emerg√™ncia social",
                probabilidade_sucesso: 85,
                consequencias:
                  "Abrigo tempor√°rio garantido, continuidade dos programas",
                pontos: 15,
                correto: true,
              },
              {
                id: "negociar_com_pensao",
                acao: "Tentar negociar com propriet√°rio da pens√£o",
                probabilidade_sucesso: 45,
                consequencias:
                  "Solu√ß√£o tempor√°ria, dependente da boa vontade do propriet√°rio",
                pontos: 8,
                correto: false,
              },
              {
                id: "procurar_familia",
                acao: "Contactar familiares para apoio",
                probabilidade_sucesso: 30,
                consequencias:
                  "Alto risco devido a conflitos familiares existentes",
                pontos: 5,
                correto: false,
              },
            ],
          },
          {
            id: "crise_emprego",
            titulo: "Perda de Oportunidade de Emprego",
            descricao: "A empresa onde faria est√°gio cancelou o programa",
            gravidade: "media",
            urgencia: "media",
            tempo_limite: 240, // 4 minutos
            opcoes_resposta: [
              {
                id: "buscar_alternativas_iefp",
                acao: "Buscar alternativas atrav√©s do IEFP",
                probabilidade_sucesso: 75,
                consequencias:
                  "Aproveitamento da rede de contactos, novas oportunidades",
                pontos: 12,
                correto: true,
              },
              {
                id: "intensificar_formacao",
                acao: "Intensificar forma√ß√£o para melhorar compet√™ncias",
                probabilidade_sucesso: 60,
                consequencias:
                  "Melhor prepara√ß√£o mas atraso nos objetivos de emprego",
                pontos: 8,
                correto: false,
              },
              {
                id: "procura_independente",
                acao: "Procura independente de emprego",
                probabilidade_sucesso: 35,
                consequencias: "Menor efic√°cia sem apoio especializado",
                pontos: 6,
                correto: false,
              },
            ],
          },
          {
            id: "crise_psicologica",
            titulo: "Crise Psicol√≥gica",
            descricao: "Felisbina manifesta sinais de depress√£o severa",
            gravidade: "critica",
            urgencia: "critica",
            tempo_limite: 120, // 2 minutos
            opcoes_resposta: [
              {
                id: "contactar_psiquiatra_urgencia",
                acao: "Contactar psiquiatra de urg√™ncia",
                probabilidade_sucesso: 95,
                consequencias:
                  "Interven√ß√£o especializada imediata, seguran√ßa garantida",
                pontos: 18,
                correto: true,
              },
              {
                id: "intensificar_psicologia",
                acao: "Intensificar consultas de psicologia",
                probabilidade_sucesso: 50,
                consequencias:
                  "Apoio importante mas pode n√£o ser suficiente para crise",
                pontos: 10,
                correto: false,
              },
              {
                id: "medicacao_ansiedade",
                acao: "Prescrever medica√ß√£o para ansiedade",
                probabilidade_sucesso: 20,
                consequencias:
                  "Fora da compet√™ncia do t√©cnico SAASI, sem efeito adequado",
                pontos: 3,
                correto: false,
              },
            ],
          },
        ],
      };

      const strategyAdjustmentData = {
        estrategias_ajuste: [
          {
            id: "mentoria_peer",
            nome: "Programa de Mentoria Entre Pares",
            descricao:
              "Conectar Felisbina com pessoas que superaram situa√ß√µes similares",
            categoria: "apoio_social",
            pontos: 12,
            adequado: true,
            vantagens: [
              "Apoio emocional",
              "Experi√™ncia partilhada",
              "Motiva√ß√£o",
            ],
            desafios: ["Disponibilidade de mentores", "Compatibilidade"],
          },
          {
            id: "formacao_competencias_vida",
            nome: "Forma√ß√£o em Compet√™ncias de Vida",
            descricao: "Desenvolver autonomia pessoal e compet√™ncias pr√°ticas",
            categoria: "capacitacao",
            pontos: 15,
            adequado: true,
            vantagens: [
              "Autonomia pessoal",
              "Compet√™ncias pr√°ticas",
              "Autoconfian√ßa",
            ],
            desafios: ["Tempo de forma√ß√£o", "Aplica√ß√£o pr√°tica"],
          },
          {
            id: "apoio_juridico",
            nome: "Apoio Jur√≠dico Especializado",
            descricao:
              "Assist√™ncia legal para quest√µes habitacionais e familiares",
            categoria: "juridico",
            pontos: 10,
            adequado: true,
            vantagens: [
              "Resolu√ß√£o legal",
              "Prote√ß√£o de direitos",
              "Orienta√ß√£o especializada",
            ],
            desafios: ["Custos", "Processos demorados"],
          },
          {
            id: "programa_voluntariado",
            nome: "Programa de Voluntariado",
            descricao:
              "Participa√ß√£o em atividades de voluntariado para autoestima",
            categoria: "integracao_social",
            pontos: 8,
            adequado: false,
            vantagens: ["Autoestima", "Rede social", "Prop√≥sito"],
            desafios: ["Baixa prioridade atual", "Energia limitada"],
            justificacao_inadequada:
              "Felisbina precisa focar primeiro na estabilidade b√°sica antes de atividades volunt√°rias",
          },
          {
            id: "curso_empreendedorismo",
            nome: "Curso de Empreendedorismo Social",
            descricao: "Desenvolver projeto pr√≥prio de gera√ß√£o de rendimento",
            categoria: "empreendedorismo",
            pontos: 14,
            adequado: false,
            vantagens: ["Autonomia financeira", "Inova√ß√£o", "Independ√™ncia"],
            desafios: [
              "Complexidade alta",
              "Risco financeiro",
              "Conhecimentos t√©cnicos",
            ],
            justificacao_inadequada:
              "Complexidade muito elevada para o perfil atual da Felisbina, requer base s√≥lida primeiro",
          },
        ],
      };

      const autonomyPreparationData = {
        areas_autonomia: [
          {
            id: "gestao_financeira",
            nome: "Gest√£o Financeira",
            descricao: "Capacidade de gerir dinheiro e or√ßamento pessoal",
            nivel_atual: 40,
            nivel_objetivo: 80,
            status_atual: "basico_com_apoio",
            meta_6_meses: "autonomo_completo",
            acoes_necessarias: [
              {
                texto: "Criar or√ßamento mensal detalhado",
                acao: "Criar or√ßamento mensal detalhado",
                prazo: "2 semanas",
                responsavel: "tecnico_saasi",
                pontos: 8,
              },
              {
                texto: "Abrir conta banc√°ria individual",
                acao: "Abrir conta banc√°ria individual",
                prazo: "1 semana",
                responsavel: "felisbina_apoiada",
                pontos: 6,
              },
              {
                texto: "Aprender a usar homebanking",
                acao: "Aprender a usar homebanking",
                prazo: "3 semanas",
                responsavel: "iefp_formacao",
                pontos: 4,
              },
              {
                texto: "Planear poupan√ßas mensais",
                acao: "Planear poupan√ßas mensais",
                prazo: "1 m√™s",
                responsavel: "tecnico_saasi",
                pontos: 7,
              },
            ],
          },
          {
            id: "relacoes_interpessoais",
            nome: "Rela√ß√µes Interpessoais",
            descricao: "Desenvolver rela√ß√µes saud√°veis e assertividade",
            nivel_atual: 35,
            nivel_objetivo: 75,
            status_atual: "dependente_emocional",
            meta_6_meses: "relacoes_equilibradas",
            acoes_necessarias: [
              {
                texto: "Participar em grupo de apoio",
                acao: "Participar em grupo de apoio",
                prazo: "6 meses",
                responsavel: "centro_saude",
                pontos: 10,
              },
              {
                texto: "Praticar comunica√ß√£o assertiva",
                acao: "Praticar comunica√ß√£o assertiva",
                prazo: "4 semanas",
                responsavel: "psicologo",
                pontos: 8,
              },
              {
                texto: "Estabelecer limites saud√°veis",
                acao: "Estabelecer limites saud√°veis",
                prazo: "3 meses",
                responsavel: "tecnico_saasi",
                pontos: 9,
              },
              {
                texto: "Desenvolver rede social de apoio",
                acao: "Desenvolver rede social de apoio",
                prazo: "5 meses",
                responsavel: "ipss_local",
                pontos: 7,
              },
            ],
          },
          {
            id: "gestao_domestica",
            nome: "Gest√£o Dom√©stica",
            descricao: "Autonomia nas tarefas dom√©sticas e organiza√ß√£o",
            nivel_atual: 70,
            nivel_objetivo: 90,
            status_atual: "parcialmente_autonomo",
            meta_6_meses: "totalmente_autonomo",
            acoes_necessarias: [
              {
                texto: "Planear refei√ß√µes semanais",
                acao: "Planear refei√ß√µes semanais",
                prazo: "2 semanas",
                responsavel: "felisbina_apoiada",
                pontos: 5,
              },
              {
                texto: "Gerir manuten√ß√£o da casa",
                acao: "Gerir manuten√ß√£o da casa",
                prazo: "3 meses",
                responsavel: "tecnico_saasi",
                pontos: 6,
              },
              {
                texto: "Organizar documentos pessoais",
                acao: "Organizar documentos pessoais",
                prazo: "1 semana",
                responsavel: "felisbina_apoiada",
                pontos: 4,
              },
              {
                texto: "Gerir contratos e servi√ßos",
                acao: "Gerir contratos e servi√ßos",
                prazo: "4 semanas",
                responsavel: "tecnico_saasi",
                pontos: 8,
              },
            ],
          },
          {
            id: "desenvolvimento_profissional",
            nome: "Desenvolvimento Profissional",
            descricao: "Autonomia na gest√£o da carreira profissional",
            nivel_atual: 55,
            nivel_objetivo: 85,
            status_atual: "em_desenvolvimento",
            meta_6_meses: "carreira_definida",
            acoes_necessarias: [
              {
                texto: "Definir objetivos de carreira",
                acao: "Definir objetivos de carreira",
                prazo: "2 semanas",
                responsavel: "consultor_iefp",
                pontos: 7,
              },
              {
                texto: "Desenvolver compet√™ncias t√©cnicas",
                acao: "Desenvolver compet√™ncias t√©cnicas",
                prazo: "6 meses",
                responsavel: "centro_formacao",
                pontos: 9,
              },
              {
                texto: "Construir rede profissional",
                acao: "Construir rede profissional",
                prazo: "4 meses",
                responsavel: "felisbina_apoiada",
                pontos: 8,
              },
              {
                texto: "Gerir procura ativa de emprego",
                acao: "Gerir procura ativa de emprego",
                prazo: "3 meses",
                responsavel: "tecnico_emprego",
                pontos: 10,
              },
            ],
          },
        ],
        estrategias_manutencao: [
          {
            id: "rede_apoio_comunidade",
            nome: "Rede de Apoio Comunit√°rio",
            descricao: "Manter liga√ß√£o com servi√ßos locais de apoio",
            pontos: 8,
          },
          {
            id: "acompanhamento_periodico",
            nome: "Acompanhamento Peri√≥dico",
            descricao: "Consultas de follow-up mensais",
            pontos: 6,
          },
          {
            id: "grupo_apoio_autonomia",
            nome: "Grupo de Apoio √† Autonomia",
            descricao: "Participa√ß√£o em grupo de pessoas em transi√ß√£o",
            pontos: 10,
          },
          {
            id: "plano_contingencia",
            nome: "Plano de Conting√™ncia",
            descricao: "Estrat√©gias para situa√ß√µes de crise",
            pontos: 9,
          },
        ],
      };

      // INICIALIZA√á√ÉO AGORA GERIDA PELO PHASE4ENGINE
      // Fun√ß√µes de compatibilidade mantidas para transi√ß√£o suave

      // Toast System
      function showToast(message, type = "info", duration = 5000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
          ${message}
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Carregar dados das fases anteriores
      function loadPreviousPhases() {
        gameState.phase1Data = SaaSIStorage.loadPhaseResults(1);
        gameState.phase2Data = SaaSIStorage.loadPhaseResults(2);
        gameState.phase3Data = SaaSIStorage.loadPhaseResults(3);

        console.log("Phase 4 - Loading previous phases:");
        console.log("Phase 1 data:", gameState.phase1Data);
        console.log("Phase 2 data:", gameState.phase2Data);
        console.log("Phase 3 data:", gameState.phase3Data);

        // Verificar se pode aceder √† Fase 4
        if (!gameState.phase3Data) {
          showToast(
            "‚ö†Ô∏è Acesso negado √† Fase 4!<br><br>Deve completar a Fase 3 primeiro.<br>Redirecionando para o menu principal...",
            "error",
            3000
          );
          setTimeout(() => (window.location.href = "index.html"), 3000);
          return;
        }

        const phase3Score = gameState.phase3Data.score || 0;
        console.log("Phase 3 score for access check:", phase3Score);

        if (phase3Score < 65) {
          showToast(
            "‚ö†Ô∏è Acesso negado √† Fase 4!<br><br>Deve completar a Fase 3 com pelo menos 65 pontos.<br>Pontua√ß√£o atual: " +
              phase3Score +
              "/100<br><br>Redirecionando para o menu principal...",
            "error",
            4000
          );
          setTimeout(() => (window.location.href = "index.html"), 4000);
          return;
        }

        console.log("Phase 4 access granted - Phase 3 score:", phase3Score);

        // Atualizar sidebar com dados das fases anteriores
        if (gameState.phase1Data) {
          document.getElementById("sidebar-phase1-score").textContent =
            gameState.phase1Data.score;
        }
        if (gameState.phase2Data) {
          document.getElementById("sidebar-phase2-score").textContent =
            gameState.phase2Data.score;
        }
        if (gameState.phase3Data) {
          document.getElementById("sidebar-phase3-score").textContent =
            gameState.phase3Data.score;
        }
      }

      // Mudar estado do jogo
      function changeState(newState) {
        // Esconder todos os estados
        document.querySelectorAll(".state").forEach((state) => {
          state.classList.add("state-hidden");
        });

        // Mostrar novo estado
        document
          .getElementById(`state-${newState}`)
          .classList.remove("state-hidden");
        gameState.currentState = newState;

        // Adicionar anima√ß√£o
        document.getElementById(`state-${newState}`).classList.add("fade-in");

        // Inicializar estado espec√≠fico
        switch (newState) {
          case "gestao-progresso":
            initProgressManagement();
            break;
          case "gestao-crises":
            initCrisisManagement();
            break;
          case "ajuste-estrategias":
            initStrategyAdjustment();
            break;
          case "preparacao-autonomia":
            initAutonomyPreparation();
            break;
          case "conclusao":
            showConclusion();
            break;
        }

        SaaSIAnalytics.trackEvent("phase4_state_change", {
          newState,
          timestamp: Date.now(),
        });
      }

      // PUZZLE 1: Inicializar gest√£o de progresso
      function initProgressManagement() {
        const container = document.getElementById(
          "progress-analysis-container"
        );
        container.innerHTML = "";

        progressManagementData.programas_em_curso.forEach((programa) => {
          const card = document.createElement("div");
          card.className = "indicator-card";
          card.innerHTML = `
            <h4>${programa.nome}</h4>
            <p><strong>Entidade:</strong> ${programa.entidade}</p>
            <p><strong>Progresso:</strong> ${programa.progresso_atual}%</p>
            <div class="progress-indicator">
              <div class="progress-fill" style="width: ${
                programa.progresso_atual
              }%; --progress-start: ${getProgressColor(
            programa.status
          )}; --progress-end: ${getProgressColor(programa.status)};"></div>
            </div>
            <p><strong>Observa√ß√µes:</strong> ${programa.observacoes}</p>
            <div style="margin-top: 15px;">
              <label><strong>Pr√≥xima a√ß√£o recomendada:</strong></label>
              <select onchange="evaluateProgram('${
                programa.id
              }', this.value)" class="form-control">
                <option value="">Selecione uma a√ß√£o...</option>
                <option value="continuar_conforme_planeado">Continuar conforme planeado</option>
                <option value="ajustar_metodologia">Ajustar metodologia</option>
                <option value="estrategia_alternativa">Estrat√©gia alternativa</option>
                <option value="reforcar_apoio">Refor√ßar apoio</option>
                <option value="reduzir_intensidade">Reduzir intensidade</option>
              </select>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function getProgressColor(status) {
        switch (status) {
          case "em_curso":
            return "#4caf50";
          case "com_dificuldades":
            return "#ff9800";
          case "resistencia":
            return "#f44336";
          default:
            return "#2196f3";
        }
      }

      function evaluateProgram(programId, action) {
        const programa = progressManagementData.programas_em_curso.find(
          (p) => p.id === programId
        );

        if (action === programa.proxima_acao) {
          gameState.progressEvaluations[programId] = true;
          gameState.puzzle1Score += programa.pontos_avaliacao_correta;
          gameState.puzzle1Progress++;
        } else {
          gameState.progressEvaluations[programId] = false;
          gameState.puzzle1Progress++;
        }

        updateProgress();

        // Verificar se pode continuar
        if (gameState.puzzle1Progress >= 3) {
          document.getElementById("btn-continue-crisis").style.display =
            "block";
        }

        SaaSIAnalytics.trackInteraction("program_evaluation", {
          programId,
          action,
          correct: gameState.progressEvaluations[programId],
        });
      }

      // PUZZLE 2: Inicializar gest√£o de crises
      function initCrisisManagement() {
        const container = document.getElementById("crisis-scenarios-container");
        container.innerHTML = "";

        crisisManagementData.cenarios_crise.forEach((cenario, index) => {
          const card = document.createElement("div");
          card.className = "crisis-scenario";
          card.innerHTML = `
            <div class="crisis-timer" id="timer-${cenario.id}">${Math.floor(
            cenario.tempo_limite / 60
          )}:${(cenario.tempo_limite % 60).toString().padStart(2, "0")}</div>
            <h4>üö® ${cenario.titulo}</h4>
            <p><strong>Urg√™ncia:</strong> ${cenario.urgencia.toUpperCase()}</p>
            <p>${cenario.descricao}</p>
            <div class="crisis-options" id="options-${cenario.id}">
              ${cenario.opcoes_resposta
                .map(
                  (opcao) => `
                <div class="crisis-option" onclick="selectCrisisOption('${cenario.id}', '${opcao.id}')">
                  <h5>${opcao.acao}</h5>
                  <p><strong>Probabilidade de sucesso:</strong> ${opcao.probabilidade_sucesso}%</p>
                  <p><strong>Consequ√™ncias:</strong> ${opcao.consequencias}</p>
                </div>
              `
                )
                .join("")}
            </div>
            <div style="text-align: center; margin-top: 15px;">
              <button onclick="confirmCrisisResponse('${
                cenario.id
              }')" class="action-button" id="confirm-${cenario.id}" disabled>
                Confirmar Resposta
              </button>
            </div>
          `;
          container.appendChild(card);

          // Iniciar cron√≥metro
          startCrisisTimer(cenario.id, cenario.tempo_limite);
        });
      }

      let selectedCrisisOptions = {};

      function selectCrisisOption(cenarioId, opcaoId) {
        // Remover sele√ß√£o anterior
        document
          .querySelectorAll(`#options-${cenarioId} .crisis-option`)
          .forEach((option) => {
            option.classList.remove("selected");
          });

        // Selecionar nova op√ß√£o
        event.target.closest(".crisis-option").classList.add("selected");
        selectedCrisisOptions[cenarioId] = opcaoId;

        // Ativar bot√£o de confirma√ß√£o
        document.getElementById(`confirm-${cenarioId}`).disabled = false;
      }

      function confirmCrisisResponse(cenarioId) {
        const cenario = crisisManagementData.cenarios_crise.find(
          (c) => c.id === cenarioId
        );
        const opcaoId = selectedCrisisOptions[cenarioId];
        const opcao = cenario.opcoes_resposta.find((o) => o.id === opcaoId);

        if (opcao) {
          gameState.crisisResponses[cenarioId] = opcaoId;

          if (opcao.correto) {
            gameState.puzzle2Score += opcao.pontos;
            document
              .querySelector(`#options-${cenarioId} .crisis-option.selected`)
              .classList.add("correct");
          } else {
            gameState.puzzle2Score += Math.max(opcao.pontos, 0); // N√£o penalizar pontos negativos
            document
              .querySelector(`#options-${cenarioId} .crisis-option.selected`)
              .classList.add("incorrect");
          }

          gameState.puzzle2Progress++;

          // Desativar op√ß√µes
          document
            .querySelectorAll(`#options-${cenarioId} .crisis-option`)
            .forEach((option) => {
              option.style.pointerEvents = "none";
            });
          document.getElementById(`confirm-${cenarioId}`).disabled = true;

          updateProgress();

          // Verificar se pode continuar
          if (gameState.puzzle2Progress >= 3) {
            document.getElementById("btn-continue-strategies").style.display =
              "block";
          }

          SaaSIAnalytics.trackInteraction("crisis_response", {
            cenarioId,
            opcaoId,
            correct: opcao.correto,
            points: opcao.pontos,
          });
        }
      }

      function startCrisisTimer(cenarioId, timeLimit) {
        let timeRemaining = timeLimit;
        const timerElement = document.getElementById(`timer-${cenarioId}`);

        const interval = setInterval(() => {
          timeRemaining--;
          const minutes = Math.floor(timeRemaining / 60);
          const seconds = timeRemaining % 60;
          timerElement.textContent = `${minutes}:${seconds
            .toString()
            .padStart(2, "0")}`;

          if (timeRemaining <= 0) {
            clearInterval(interval);
            timerElement.textContent = "TEMPO ESGOTADO";
            timerElement.style.background = "#f44336";

            // Auto-confirmar resposta se selecionada
            if (selectedCrisisOptions[cenarioId]) {
              confirmCrisisResponse(cenarioId);
            } else {
              // Penalizar por n√£o responder
              gameState.puzzle2Progress++;
              updateProgress();
            }
          }
        }, 1000);
      }

      // PUZZLE 3: Inicializar ajuste de estrat√©gias
      function initStrategyAdjustment() {
        const container = document.getElementById(
          "strategy-adjustment-container"
        );
        container.innerHTML = "";

        const header = document.createElement("div");
        header.innerHTML = `
          <h4>Selecione as estrat√©gias de ajuste mais adequadas (escolha 3):</h4>
          <p>Baseie-se nos resultados dos primeiros 3 meses e nas situa√ß√µes imprevistas.</p>
        `;
        container.appendChild(header);

        strategyAdjustmentData.estrategias_ajuste.forEach((estrategia) => {
          const card = document.createElement("div");
          card.className = `strategy-card ${
            estrategia.adequado ? "selectable" : "inadequate"
          }`;
          card.onclick = () => toggleStrategy(estrategia.id);

          card.innerHTML = `
            <h4>${estrategia.nome}</h4>
            <p>${estrategia.descricao}</p>
            <div style="margin: 10px 0;">
              <strong>Vantagens:</strong> ${estrategia.vantagens.join(", ")}
            </div>
            <div style="margin: 10px 0;">
              <strong>Desafios:</strong> ${estrategia.desafios.join(", ")}
            </div>
            ${
              estrategia.justificacao_inadequada
                ? `
              <div style="color: #f44336; margin-top: 10px;">
                <strong>Por que inadequada:</strong> ${estrategia.justificacao_inadequada}
              </div>
            `
                : ""
            }
            <div style="text-align: right; margin-top: 10px;">
              <span class="badge ${
                estrategia.adequado ? "badge-success" : "badge-warning"
              }">
                ${estrategia.pontos > 0 ? "+" : ""}${estrategia.pontos} pontos
              </span>
            </div>
          `;
          container.appendChild(card);
        });
      }

      let selectedStrategies = [];

      function toggleStrategy(estrategiaId) {
        const estrategia = strategyAdjustmentData.estrategias_ajuste.find(
          (e) => e.id === estrategiaId
        );
        const card = event.currentTarget;

        if (!estrategia.adequado) {
          showToast(
            "‚ö†Ô∏è Esta estrat√©gia n√£o √© adequada para a situa√ß√£o atual da Felisbina.",
            "warning",
            4000
          );
          return;
        }

        if (selectedStrategies.includes(estrategiaId)) {
          // Remover sele√ß√£o
          selectedStrategies = selectedStrategies.filter(
            (id) => id !== estrategiaId
          );
          card.classList.remove("selected");
          gameState.puzzle3Score -= estrategia.pontos;
        } else {
          // Adicionar sele√ß√£o (m√°ximo 3)
          if (selectedStrategies.length >= 3) {
            showToast("üö´ Pode selecionar no m√°ximo 3 estrat√©gias.", "warning");
            return;
          }

          selectedStrategies.push(estrategiaId);
          card.classList.add("selected");
          gameState.puzzle3Score += estrategia.pontos;
        }

        gameState.strategyAdjustments = selectedStrategies;
        gameState.puzzle3Progress = selectedStrategies.length;

        updateProgress();

        // Verificar se pode continuar
        if (selectedStrategies.length >= 3) {
          document.getElementById("btn-continue-autonomy").style.display =
            "block";
        }

        SaaSIAnalytics.trackInteraction("strategy_selection", {
          estrategiaId,
          selected: selectedStrategies.includes(estrategiaId),
        });
      }

      // PUZZLE 4: Inicializar prepara√ß√£o para autonomia
      function initAutonomyPreparation() {
        const container = document.getElementById(
          "autonomy-preparation-container"
        );
        container.innerHTML = "";

        // √Åreas de autonomia
        const areasSection = document.createElement("div");
        areasSection.innerHTML =
          "<h4>√Åreas de Autonomia - Selecione a√ß√µes para cada √°rea:</h4>";
        container.appendChild(areasSection);

        autonomyPreparationData.areas_autonomia.forEach((area) => {
          const areaDiv = document.createElement("div");
          areaDiv.className = "autonomy-area";
          areaDiv.innerHTML = `
            <h5>${area.nome}</h5>
            <p><strong>Estado atual:</strong> ${area.status_atual.replace(
              /_/g,
              " "
            )}</p>
            <p><strong>Meta 6 meses:</strong> ${area.meta_6_meses.replace(
              /_/g,
              " "
            )}</p>
            <div class="actions-list">
              ${area.acoes_necessarias
                .map(
                  (acao, index) => `
                <div class="action-item">
                  <label>
                    <input type="checkbox" onchange="selectAutonomyAction('${
                      area.id
                    }', ${index}, this.checked)">
                    <strong>${acao.acao}</strong> (${acao.prazo})
                    <span class="badge badge-info">+${acao.pontos} pts</span>
                  </label>
                  <p>Respons√°vel: ${acao.responsavel.replace(/_/g, " ")}</p>
                </div>
              `
                )
                .join("")}
            </div>
          `;
          container.appendChild(areaDiv);
        });

        // Estrat√©gias de manuten√ß√£o
        const maintenanceSection = document.createElement("div");
        maintenanceSection.innerHTML = `
          <h4 style="margin-top: 30px;">Estrat√©gias de Manuten√ß√£o - Selecione 3 estrat√©gias:</h4>
        `;
        container.appendChild(maintenanceSection);

        autonomyPreparationData.estrategias_manutencao.forEach((estrategia) => {
          const strategyDiv = document.createElement("div");
          strategyDiv.className = "maintenance-strategy";
          strategyDiv.onclick = () => toggleMaintenanceStrategy(estrategia.id);

          strategyDiv.innerHTML = `
            <h5>${estrategia.nome}</h5>
            <p>${estrategia.descricao}</p>
            <div style="text-align: right; margin-top: 10px;">
              <span class="badge ${
                estrategia.adequado ? "badge-success" : "badge-warning"
              }">
                ${estrategia.pontos > 0 ? "+" : ""}${estrategia.pontos} pontos
              </span>
            </div>
            ${
              estrategia.justificacao
                ? `
              <div style="color: #f44336; margin-top: 10px; font-size: 0.9rem;">
                <strong>Justifica√ß√£o:</strong> ${estrategia.justificacao}
              </div>
            `
                : ""
            }
          `;
          container.appendChild(strategyDiv);
        });
      }

      let selectedAutonomyActions = {};
      let selectedMaintenanceStrategies = [];

      function selectAutonomyAction(areaId, actionIndex, checked) {
        if (!selectedAutonomyActions[areaId]) {
          selectedAutonomyActions[areaId] = [];
        }

        const area = autonomyPreparationData.areas_autonomia.find(
          (a) => a.id === areaId
        );
        const action = area.acoes_necessarias[actionIndex];

        if (checked) {
          selectedAutonomyActions[areaId].push(actionIndex);
          gameState.puzzle4Score += action.pontos;
        } else {
          selectedAutonomyActions[areaId] = selectedAutonomyActions[
            areaId
          ].filter((i) => i !== actionIndex);
          gameState.puzzle4Score -= action.pontos;
        }

        gameState.autonomyPlanning = {
          actions: selectedAutonomyActions,
          maintenanceStrategies: selectedMaintenanceStrategies,
        };

        // Calcular progresso (4 √°reas)
        gameState.puzzle4Progress = Object.keys(selectedAutonomyActions).filter(
          (areaId) => selectedAutonomyActions[areaId].length > 0
        ).length;

        updateProgress();
        checkAutonomyCompletion();

        SaaSIAnalytics.trackInteraction("autonomy_action_selection", {
          areaId,
          actionIndex,
          checked,
        });
      }

      function toggleMaintenanceStrategy(estrategiaId) {
        const estrategia = autonomyPreparationData.estrategias_manutencao.find(
          (e) => e.id === estrategiaId
        );
        const card = event.currentTarget;

        if (!estrategia.adequado) {
          showToast(
            "‚ö†Ô∏è Esta estrat√©gia n√£o √© adequada e pode impedir o desenvolvimento da autonomia.",
            "warning",
            4000
          );
          // Ainda permitir sele√ß√£o mas com penaliza√ß√£o
        }

        if (selectedMaintenanceStrategies.includes(estrategiaId)) {
          // Remover sele√ß√£o
          selectedMaintenanceStrategies = selectedMaintenanceStrategies.filter(
            (id) => id !== estrategiaId
          );
          card.classList.remove("selected");
          gameState.puzzle4Score -= estrategia.pontos;
        } else {
          // Adicionar sele√ß√£o (m√°ximo 3)
          if (selectedMaintenanceStrategies.length >= 3) {
            showToast(
              "üö´ Pode selecionar no m√°ximo 3 estrat√©gias de manuten√ß√£o.",
              "warning"
            );
            return;
          }

          selectedMaintenanceStrategies.push(estrategiaId);
          card.classList.add("selected");
          gameState.puzzle4Score += estrategia.pontos;
        }

        gameState.autonomyPlanning = {
          actions: selectedAutonomyActions,
          maintenanceStrategies: selectedMaintenanceStrategies,
        };

        updateProgress();
        checkAutonomyCompletion();

        SaaSIAnalytics.trackInteraction("maintenance_strategy_selection", {
          estrategiaId,
          selected: selectedMaintenanceStrategies.includes(estrategiaId),
        });
      }

      function checkAutonomyCompletion() {
        // Verificar se pode finalizar (pelo menos 2 a√ß√µes por √°rea e 3 estrat√©gias de manuten√ß√£o)
        const areasWithActions = Object.keys(selectedAutonomyActions).filter(
          (areaId) => selectedAutonomyActions[areaId].length >= 2
        );

        if (
          areasWithActions.length >= 3 &&
          selectedMaintenanceStrategies.length >= 3
        ) {
          document.getElementById("btn-finalize-phase4").style.display =
            "block";
        }
      }

      // Atualizar progresso
      function updateProgress() {
        // Atualizar pontua√ß√£o total
        gameState.score =
          gameState.puzzle1Score +
          gameState.puzzle2Score +
          gameState.puzzle3Score +
          gameState.puzzle4Score;

        // Atualizar interface
        document.getElementById("total-score-phase4").textContent =
          gameState.score;
        document.getElementById("sidebar-phase4-score").textContent =
          gameState.score;

        // Atualizar pontua√ß√µes dos puzzles
        document.getElementById(
          "puzzle1-score"
        ).textContent = `${gameState.puzzle1Score}/25 pontos`;
        document.getElementById(
          "puzzle2-score"
        ).textContent = `${gameState.puzzle2Score}/30 pontos`;
        document.getElementById(
          "puzzle3-score"
        ).textContent = `${gameState.puzzle3Score}/25 pontos`;
        document.getElementById(
          "puzzle4-score"
        ).textContent = `${gameState.puzzle4Score}/20 pontos`;

        // Atualizar barras de progresso
        document.getElementById("progress-puzzle1").style.width = `${
          (gameState.puzzle1Progress / 3) * 100
        }%`;
        document.getElementById("progress-puzzle2").style.width = `${
          (gameState.puzzle2Progress / 3) * 100
        }%`;
        document.getElementById("progress-puzzle3").style.width = `${
          (gameState.puzzle3Progress / 3) * 100
        }%`;
        document.getElementById("progress-puzzle4").style.width = `${
          (gameState.puzzle4Progress / 4) * 100
        }%`;

        // Atualizar contadores
        document.getElementById("puzzle1-progress").textContent =
          gameState.puzzle1Progress;
        document.getElementById("puzzle2-progress").textContent =
          gameState.puzzle2Progress;
        document.getElementById("puzzle3-progress").textContent =
          gameState.puzzle3Progress;
        document.getElementById("puzzle4-progress").textContent =
          gameState.puzzle4Progress;

        updateSidebar();
      }

      function updateSidebar() {
        // Calcular pontua√ß√£o total do escape room (limitada ao m√°ximo de 400)
        let totalScore = gameState.score;
        if (gameState.phase1Data) totalScore += gameState.phase1Data.score;
        if (gameState.phase2Data) totalScore += gameState.phase2Data.score;
        if (gameState.phase3Data) totalScore += gameState.phase3Data.score;

        // Limitar ao m√°ximo de 400 pontos
        totalScore = Math.min(totalScore, 400);

        document.getElementById("sidebar-total-score").textContent = totalScore;

        // Atualizar estado da Felisbina baseado no progresso
        const autonomyLevel = Math.min(95, 65 + gameState.score / 4); // Come√ßa com 65% e aumenta com progresso
        document.getElementById("autonomy-level").textContent = `${Math.round(
          autonomyLevel
        )}%`;

        // Atualizar outros indicadores baseados nas decis√µes tomadas
        if (selectedStrategies.includes("modelo_hibrido_emprego_formacao")) {
          document.getElementById("employment-status").textContent =
            "Part-time + Forma√ß√£o";
        }

        if (
          gameState.crisisResponses["crise_habitacional"] ===
          "contactar_emergencia_social"
        ) {
          document.getElementById("housing-status").textContent =
            "Est√°vel (tempor√°ria)";
        }

        document.getElementById("mental-health").textContent =
          gameState.score > 70 ? "Muito Est√°vel" : "Est√°vel";
      }

      // Mostrar conclus√£o
      function showConclusion() {
        gameState.completionTime = Date.now();
        const duration = Math.round(
          (gameState.completionTime - gameState.startTime) / 60000
        );

        // Calcular n√≠vel final
        let level = "T√©cnico Iniciante";
        let certification = "T√©cnico Competente SAASI";

        if (gameState.score >= 95) {
          level = "Master SAASI";
          certification = "Master SAASI";
        } else if (gameState.score >= 85) {
          level = "T√©cnico Especialista";
          certification = "T√©cnico Especialista SAASI";
        } else if (gameState.score >= 70) {
          level = "T√©cnico Proficiente";
          certification = "T√©cnico Proficiente SAASI";
        } else if (gameState.score >= 50) {
          level = "T√©cnico Competente";
        }

        // Calcular pontua√ß√£o total do escape room
        let totalScore = gameState.score;
        if (gameState.phase1Data) totalScore += gameState.phase1Data.score;
        if (gameState.phase2Data) totalScore += gameState.phase2Data.score;
        if (gameState.phase3Data) totalScore += gameState.phase3Data.score;

        document.getElementById("final-score-phase4").textContent =
          gameState.score;
        document.getElementById("final-score-total").textContent = totalScore;
        document.getElementById("final-level").textContent = level;
        document.getElementById("final-certification").textContent =
          certification;

        // Salvar resultados da Fase 4
        const phase4Results = {
          phase: 4,
          score: gameState.score,
          maxScore: 100,
          percentage: gameState.score,
          duration: duration,
          level: { title: level },
          certification: certification,
          progressEvaluations: gameState.progressEvaluations,
          crisisResponses: gameState.crisisResponses,
          strategyAdjustments: gameState.strategyAdjustments,
          autonomyPlanning: gameState.autonomyPlanning,
          puzzleScores: {
            puzzle1: gameState.puzzle1Score,
            puzzle2: gameState.puzzle2Score,
            puzzle3: gameState.puzzle3Score,
            puzzle4: gameState.puzzle4Score,
          },
          totalEscapeRoomScore: totalScore,
          completionTime: gameState.completionTime,
          startTime: gameState.startTime,
        };

        SaaSIStorage.savePhaseResults(4, phase4Results);

        // Gerar achievements finais
        generateFinalAchievements(totalScore);

        SaaSIAnalytics.trackPhaseCompletion(4, phase4Results);
        SaaSIAnalytics.trackEvent("escape_room_completed", {
          totalScore,
          duration,
          certification,
        });
      }

      function generateFinalAchievements(totalScore) {
        const achievementsContainer =
          document.getElementById("achievements-final");
        const achievements = [];

        // Achievements da Fase 4
        if (gameState.puzzle2Score >= 25)
          achievements.push("üö® Gestor de Crises");
        if (gameState.puzzle3Score >= 20)
          achievements.push("üéØ Estrategista Adapt√°vel");
        if (gameState.puzzle4Score >= 18)
          achievements.push("üåü Mentor da Autonomia");

        // Achievement final do escape room
        if (totalScore >= 340) achievements.push("üëë Master SAASI");
        else if (totalScore >= 280)
          achievements.push("üèÜ Especialista SAASI Completo");
        else if (totalScore >= 220)
          achievements.push("‚≠ê T√©cnico SAASI Proficiente");

        if (achievements.length > 0) {
          achievementsContainer.innerHTML = `
            <h4>üèÜ Conquistas Desbloqueadas:</h4>
            <div style="margin: 15px 0;">
              ${achievements
                .map(
                  (achievement) =>
                    `<span class="badge badge-achievement">${achievement}</span>`
                )
                .join("")}
            </div>
          `;
        } else {
          achievementsContainer.innerHTML = `
            <h4>üèÜ Continue a praticar para desbloquear conquistas!</h4>
          `;
        }
      }

      // Mostrar relat√≥rio final
      function showFinalReport() {
        document
          .getElementById("state-conclusao")
          .classList.add("state-hidden");
        document
          .getElementById("final-report-modal")
          .classList.remove("state-hidden");

        generateFinalReport();
      }

      function generateFinalReport() {
        const content = document.getElementById("final-report-content");

        const totalScore =
          (gameState.phase1Data?.score || 0) +
          (gameState.phase2Data?.score || 0) +
          (gameState.phase3Data?.score || 0) +
          gameState.score;

        const totalDuration =
          (gameState.phase1Data?.duration || 0) +
          (gameState.phase2Data?.duration || 0) +
          (gameState.phase3Data?.duration || 0) +
          Math.round((gameState.completionTime - gameState.startTime) / 60000);

        content.innerHTML = `
          <div class="final-report">
            <h3>üìä Resumo Executivo</h3>
            <div class="row">
              <div class="col">
                <div class="card">
                  <div class="card-body">
                    <h4>Pontua√ß√£o Total</h4>
                    <div class="score-circle" style="margin: 20px auto;">
                      ${totalScore}/400
                    </div>
                    <p><strong>Percentagem:</strong> ${Math.round(
                      (totalScore / 400) * 100
                    )}%</p>
                    <p><strong>Tempo Total:</strong> ${totalDuration} minutos</p>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card">
                  <div class="card-body">
                    <h4>Desempenho por Fase</h4>
                    <p><strong>Fase 1:</strong> ${
                      gameState.phase1Data?.score || 0
                    }/100 (${gameState.phase1Data?.duration || 0}min)</p>
                    <p><strong>Fase 2:</strong> ${
                      gameState.phase2Data?.score || 0
                    }/100 (${gameState.phase2Data?.duration || 0}min)</p>
                    <p><strong>Fase 3:</strong> ${
                      gameState.phase3Data?.score || 0
                    }/100 (${gameState.phase3Data?.duration || 0}min)</p>
                    <p><strong>Fase 4:</strong> ${
                      gameState.score
                    }/100 (${Math.round(
          (gameState.completionTime - gameState.startTime) / 60000
        )}min)</p>
                  </div>
                </div>
              </div>
            </div>

            <h3>üéØ Resultado do Caso Felisbina Santos</h3>
            <div class="card">
              <div class="card-body">
                <h4>Estado Final da Benefici√°ria</h4>
                <div class="row">
                  <div class="col">
                    <p><strong>Autonomia Pessoal:</strong> ${
                      document.getElementById("autonomy-level").textContent
                    }</p>
                    <p><strong>Situa√ß√£o Profissional:</strong> ${
                      document.getElementById("employment-status").textContent
                    }</p>
                  </div>
                  <div class="col">
                    <p><strong>Habita√ß√£o:</strong> ${
                      document.getElementById("housing-status").textContent
                    }</p>
                    <p><strong>Sa√∫de Mental:</strong> ${
                      document.getElementById("mental-health").textContent
                    }</p>
                  </div>
                </div>
                <h5>Fatores de Sucesso:</h5>
                <ul>
                  ${
                    totalScore >= 300
                      ? "<li>Excelente coordena√ß√£o multissetorial</li>"
                      : ""
                  }
                  ${
                    gameState.puzzle2Score >= 25
                      ? "<li>Gest√£o eficaz de situa√ß√µes de crise</li>"
                      : ""
                  }
                  ${
                    gameState.puzzle4Score >= 18
                      ? "<li>Planeamento sustent√°vel para autonomia</li>"
                      : ""
                  }
                  <li>Abordagem personalizada e adaptativa</li>
                </ul>
              </div>
            </div>

            <h3>üí° Recomenda√ß√µes para Desenvolvimento Profissional</h3>
            <div class="card">
              <div class="card-body">
                ${
                  totalScore >= 340
                    ? `
                  <div class="alert alert-success">
                    <h5>üèÜ Excelente Desempenho!</h5>
                    <p>Demonstrou compet√™ncias avan√ßadas em todas as √°reas. Considere:</p>
                    <ul>
                      <li>Mentoria de novos t√©cnicos</li>
                      <li>Forma√ß√£o especializada em casos complexos</li>
                      <li>Participa√ß√£o em desenvolvimento de metodologias</li>
                    </ul>
                  </div>
                `
                    : totalScore >= 280
                    ? `
                  <div class="alert alert-info">
                    <h5>‚≠ê Bom Desempenho!</h5>
                    <p>Compet√™ncias s√≥lidas demonstradas. √Åreas para desenvolvimento:</p>
                    <ul>
                      <li>Aprofundar gest√£o de situa√ß√µes de crise</li>
                      <li>Desenvolver compet√™ncias de planeamento estrat√©gico</li>
                      <li>Fortalecer articula√ß√£o interinstitucional</li>
                    </ul>
                  </div>
                `
                    : `
                  <div class="alert alert-warning">
                    <h5>üìö Continue a Desenvolver!</h5>
                    <p>Base s√≥lida estabelecida. Focos priorit√°rios:</p>
                    <ul>
                      <li>Praticar avalia√ß√£o sistem√°tica de necessidades</li>
                      <li>Melhorar compet√™ncias de tomada de decis√£o</li>
                      <li>Desenvolver vis√£o sist√©mica de interven√ß√£o</li>
                    </ul>
                  </div>
                `
                }
              </div>
            </div>
          </div>
        `;
      }

      function closeReport() {
        document
          .getElementById("final-report-modal")
          .classList.add("state-hidden");
        document
          .getElementById("state-conclusao")
          .classList.remove("state-hidden");
      }

      function exportResults() {
        const results = {
          escapeRoom: "SAASI",
          completionDate: new Date().toISOString(),
          totalScore:
            (gameState.phase1Data?.score || 0) +
            (gameState.phase2Data?.score || 0) +
            (gameState.phase3Data?.score || 0) +
            gameState.score,
          phases: {
            phase1: gameState.phase1Data,
            phase2: gameState.phase2Data,
            phase3: gameState.phase3Data,
            phase4: {
              score: gameState.score,
              progressEvaluations: gameState.progressEvaluations,
              crisisResponses: gameState.crisisResponses,
              strategyAdjustments: gameState.strategyAdjustments,
              autonomyPlanning: gameState.autonomyPlanning,
            },
          },
        };

        const dataStr = JSON.stringify(results, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `SAASI_EscapeRoom_Results_${
          new Date().toISOString().split("T")[0]
        }.json`;
        link.click();
        URL.revokeObjectURL(url);

        SaaSIAnalytics.trackEvent("results_exported", {
          totalScore: results.totalScore,
        });
      }

      // Reiniciar Fase 4
      async function restartPhase4() {
        const confirmRestart = await ModalSystem.confirm(
          "üîÑ Tem certeza que deseja reiniciar a Fase 4?<br><br>Todos os progressos desta fase ser√£o perdidos.",
          {
            title: "üîÑ Reiniciar Fase 4",
            okText: "Sim, reiniciar",
            cancelText: "Cancelar",
            type: "warning",
          }
        );

        if (confirmRestart) {
          localStorage.removeItem("saasi_phase4_results");
          location.reload();
        }
      }

      // Funcionalidade de continuar para pr√≥xima fase (futuro)
      function continueToPhase5() {
        showToast(
          "üéâ Parab√©ns! Completou todo o Escape Room SAASI!<br><br>Este √© o final da experi√™ncia de forma√ß√£o.",
          "success",
          8000
        );
      }
    </script>
  </body>
</html>
