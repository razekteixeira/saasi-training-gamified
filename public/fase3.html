<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAASI Escape Room - Fase 3</title>
    <link rel="stylesheet" href="css/main.css" />
    <style>
      /* Toast System */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
      }

      .toast {
        background: #333;
        color: white;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        padding-right: 50px;
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        background: #28a745;
        border-left: 4px solid #1e7e34;
      }

      .toast.error {
        background: #dc3545;
        border-left: 4px solid #c82333;
      }

      .toast.warning {
        background: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .toast.info {
        background: #17a2b8;
        border-left: 4px solid #138496;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* Estilos específicos da Fase 3 - CONFORME ESPECIFICAÇÃO DETALHADA */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .main-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
      }

      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        z-index: 1000;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .back-button:hover {
        background: rgba(84, 91, 98, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      /* Layout Grid Conforme Especificação */
      .fase3-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .puzzle-area {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      .sidebar {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        height: fit-content;
        position: sticky;
        top: 20px;
      }

      /* PUZZLE 1: Seleção de Programas - CONFORME ESPECIFICAÇÃO */
      .program-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        padding: 20px;
        margin: 10px 0;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        user-select: none;
      }

      .program-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
      }

      .program-card.selected {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
      }

      .program-card.rejected {
        border-color: #f44336;
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        opacity: 0.7;
      }

      .program-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .program-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
        flex: 1;
      }

      .program-category {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-left: 10px;
      }

      .program-details {
        color: #6c757d;
        font-size: 0.9rem;
        margin: 8px 0;
        text-align: left;
      }

      .program-status {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      /* PUZZLE 2: Articulação de Entidades */
      .entity-map {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .entity-card {
        background: linear-gradient(135deg, #fff, #f8f9fa);
        border-radius: 12px;
        padding: 15px;
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        user-select: none;
      }

      .entity-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-color: #17a2b8;
      }

      .entity-card.contacted {
        border-color: #17a2b8;
        background: linear-gradient(135deg, #e1f7fa, #b2ebf2);
      }

      .entity-card.essential {
        border-color: #ffc107;
        background: linear-gradient(135deg, #fff8e1, #ffecb3);
      }

      .entity-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .entity-specialty {
        color: #6c757d;
        font-size: 0.85rem;
        margin-bottom: 10px;
      }

      .entity-contact {
        color: #495057;
        font-size: 0.8rem;
        margin-bottom: 5px;
      }

      .contact-button {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
        width: 100%;
        text-align: center;
      }

      .contact-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        background: linear-gradient(135deg, #1496af, #117a8b);
      }

      .contact-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(23, 162, 184, 0.2);
      }

      .contact-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* PUZZLE 3: Timeline Builder */
      .timeline-month {
        margin: 20px 0;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        border-left: 4px solid #667eea;
      }

      .timeline-month h4 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .timeline-activities {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        min-height: 60px;
        padding: 10px;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.5);
      }

      .timeline-activities.droppable {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .activity-item {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: grab;
        user-select: none;
        transition: all 0.3s ease;
      }

      .activity-item:active {
        cursor: grabbing;
        transform: scale(1.05);
        z-index: 10;
      }

      /* PUZZLE 4: Validação e Aprovação */
      .validation-sections {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 20px 0;
      }

      .validation-item {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .validation-item.completed {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
      }

      .validation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .validation-header h4 {
        margin: 0;
        color: #495057;
      }

      .validation-status {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        background: #ffc107;
        color: #212529;
      }

      .validation-status.completed {
        background: #28a745;
        color: white;
      }

      .validation-checklist {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin: 15px 0;
      }

      .validation-checklist label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .entity-approvals {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 15px 0;
      }

      .approval-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
      }

      .consent-checklist {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin: 15px 0;
      }

      .consent-checklist label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 14px;
      }

      .activity-item.placed {
        background: linear-gradient(135deg, #4caf50, #45a049);
      }

      .available-activities {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .available-activities h4 {
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .activities-pool {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .state-hidden {
        display: none;
      }

      .case-info {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        text-align: left;
      }

      .case-info h3 {
        color: #1565c0;
        margin-bottom: 15px;
      }

      .puzzle-section {
        margin-bottom: 30px;
        padding: 20px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.7);
      }

      .puzzle-section.active {
        background: rgba(255, 243, 205, 0.5);
        border: 2px solid #ffc107;
      }

      .puzzle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .puzzle-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }

      .puzzle-score {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <a href="index.html" class="back-button">🏠 Voltar ao Menu</a>

    <div class="main-container">
      <div class="fase3-container">
        <!-- Área Principal dos Puzzles -->
        <div class="puzzle-area">
          <div class="header">
            <h1>🎯 Fase 3: Plano de Intervenção</h1>
            <p class="subtitle">
              Criar estratégia de acompanhamento personalizada
            </p>
          </div>

          <!-- Estado: Introdução -->
          <div id="state-intro" class="state">
            <div class="case-info">
              <h3>📋 Resumo do Caso - Felisbina Santos</h3>
              <p><strong>Problemas Priorizados na Fase 2:</strong></p>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                  gap: 10px;
                  margin: 15px 0;
                "
              >
                <div
                  style="
                    background: rgba(233, 30, 99, 0.1);
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #e91e63;
                  "
                >
                  <strong>🧠 Prioridade ALTA</strong><br />
                  Dependência emocional do pai
                </div>
                <div
                  style="
                    background: rgba(233, 30, 99, 0.1);
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #e91e63;
                  "
                >
                  <strong>👥 Prioridade ALTA</strong><br />
                  Perda de suporte familiar (irmão)
                </div>
                <div
                  style="
                    background: rgba(255, 152, 0, 0.1);
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #ff9800;
                  "
                >
                  <strong>🏠 Prioridade MÉDIA-ALTA</strong><br />
                  Isolamento social significativo
                </div>
                <div
                  style="
                    background: rgba(33, 150, 243, 0.1);
                    padding: 10px;
                    border-radius: 8px;
                    border-left: 4px solid #2196f3;
                  "
                >
                  <strong>📚 Prioridade MÉDIA</strong><br />
                  Necessidades qualificação profissional
                </div>
              </div>
              <p>
                <strong>Objetivo:</strong> Selecionar programas adequados,
                estabelecer articulação com entidades e criar cronograma de
                acompanhamento.
              </p>
            </div>

            <div style="text-align: center; margin-top: 20px">
              <button onclick="changeState('programa-selecao')" class="btn">
                🚀 Começar Planeamento
              </button>
            </div>
          </div>

          <!-- Estado: Seleção de Programas (PUZZLE 1) -->
          <div id="state-programa-selecao" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">🎯 Puzzle 1: Seleção de Programas</h2>
                <div class="puzzle-score">0/25 pontos</div>
              </div>

              <p>
                Selecione os programas mais adequados para a Felisbina.
                <strong
                  >Clique nos programas corretos (✅) e rejeite os inadequados
                  (❌).</strong
                >
              </p>

              <div id="programs-container">
                <!-- Programas serão carregados dinamicamente CONFORME ESPECIFICAÇÃO -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-entities"
                  onclick="changeState('entidades-articulacao')"
                  class="btn"
                  style="display: none"
                >
                  ➡️ Continuar para Articulação
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Articulação de Entidades (PUZZLE 2) -->
          <div id="state-entidades-articulacao" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  🤝 Puzzle 2: Articulação de Entidades
                </h2>
                <div class="puzzle-score">0/25 pontos</div>
              </div>

              <p>
                Contacte as entidades competentes para implementar os programas
                selecionados.
              </p>

              <div class="entity-map" id="entities-container">
                <!-- Entidades serão carregadas dinamicamente CONFORME ESPECIFICAÇÃO -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-timeline"
                  onclick="changeState('cronograma-timeline')"
                  class="btn"
                  style="display: none"
                >
                  ➡️ Continuar para Cronograma
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Cronograma Timeline (PUZZLE 3) -->
          <div id="state-cronograma-timeline" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  📅 Puzzle 3: Cronograma de Acompanhamento
                </h2>
                <div class="puzzle-score">0/30 pontos</div>
              </div>

              <p>
                Organize as atividades numa sequência lógica ao longo de 7
                meses.
                <strong>Arraste cada atividade para o mês correto.</strong>
              </p>

              <div class="available-activities">
                <h4>Atividades Disponíveis:</h4>
                <div class="activities-pool" id="activities-pool">
                  <!-- Atividades serão carregadas dinamicamente CONFORME ESPECIFICAÇÃO -->
                </div>
              </div>

              <div class="timeline-builder" id="timeline-container">
                <!-- Timeline será carregada dinamicamente CONFORME ESPECIFICAÇÃO -->
              </div>

              <div style="text-align: center; margin-top: 20px">
                <button
                  id="btn-continue-validation"
                  onclick="changeState('validacao-aprovacao')"
                  class="btn"
                  style="display: none"
                >
                  ✅ Continuar para Validação
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Validação e Aprovação (PUZZLE 4) -->
          <div id="state-validacao-aprovacao" class="state state-hidden">
            <div class="puzzle-section active">
              <div class="puzzle-header">
                <h2 class="puzzle-title">
                  ✅ Puzzle 4: Validação e Aprovação Final
                </h2>
                <div class="puzzle-score">0/20 pontos</div>
              </div>

              <p>
                Valide o plano completo e obtenha as aprovações necessárias
                antes da implementação.
                <strong>Complete todas as validações obrigatórias.</strong>
              </p>

              <div class="validation-sections">
                <div class="validation-item" id="validation-coherence">
                  <div class="validation-header">
                    <h4>🔍 Coerência do Plano</h4>
                    <span class="validation-status">Pendente</span>
                  </div>
                  <div class="validation-content">
                    <p>
                      Verifique se o plano tem objetivos claros, cronograma
                      realista e recursos adequados.
                    </p>
                    <div class="validation-checklist">
                      <label
                        ><input type="checkbox" id="check-objetivos" />
                        Objetivos claros e específicos</label
                      >
                      <label
                        ><input type="checkbox" id="check-cronograma" />
                        Cronograma realista e sequencial</label
                      >
                      <label
                        ><input type="checkbox" id="check-recursos" /> Recursos
                        adequados identificados</label
                      >
                    </div>
                    <button
                      onclick="validateCoherence()"
                      class="btn btn-small"
                      id="btn-validate-coherence"
                    >
                      Validar Coerência
                    </button>
                  </div>
                </div>

                <div class="validation-item" id="validation-approvals">
                  <div class="validation-header">
                    <h4>📋 Aprovação das Entidades</h4>
                    <span class="validation-status">Pendente</span>
                  </div>
                  <div class="validation-content">
                    <p>
                      Obtenha confirmação das entidades parceiras para os
                      programas selecionados.
                    </p>
                    <div class="entity-approvals">
                      <div class="approval-item">
                        <span>IEFP Porto</span>
                        <button
                          onclick="requestApproval('iefp')"
                          class="btn btn-small"
                          id="btn-approval-iefp"
                        >
                          Solicitar Aprovação
                        </button>
                      </div>
                      <div class="approval-item">
                        <span>Centro de Saúde</span>
                        <button
                          onclick="requestApproval('saude')"
                          class="btn btn-small"
                          id="btn-approval-saude"
                        >
                          Solicitar Aprovação
                        </button>
                      </div>
                      <div class="approval-item">
                        <span>IPSS Local</span>
                        <button
                          onclick="requestApproval('ipss')"
                          class="btn btn-small"
                          id="btn-approval-ipss"
                        >
                          Solicitar Aprovação
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="validation-item" id="validation-consent">
                  <div class="validation-header">
                    <h4>👤 Consentimento da Felisbina</h4>
                    <span class="validation-status">Pendente</span>
                  </div>
                  <div class="validation-content">
                    <p>
                      Assegure que a Felisbina compreende e concorda com o plano
                      proposto.
                    </p>
                    <div class="consent-checklist">
                      <label
                        ><input type="checkbox" id="check-compreensao" />
                        Felisbina compreende o plano</label
                      >
                      <label
                        ><input type="checkbox" id="check-acordo" /> Felisbina
                        concorda com a participação</label
                      >
                      <label
                        ><input type="checkbox" id="check-expectativas" />
                        Expectativas são realistas</label
                      >
                    </div>
                    <button
                      onclick="validateConsent()"
                      class="btn btn-small"
                      id="btn-validate-consent"
                    >
                      Obter Consentimento
                    </button>
                  </div>
                </div>
              </div>

              <div style="text-align: center; margin-top: 30px">
                <button
                  id="btn-finalize-plan"
                  onclick="changeState('conclusao')"
                  class="btn"
                  style="display: none"
                >
                  🎉 Finalizar Plano Completo
                </button>
              </div>
            </div>
          </div>

          <!-- Estado: Conclusão -->
          <div id="state-conclusao" class="state state-hidden">
            <div class="container" style="text-align: center">
              <h2>🎉 Plano de Intervenção Completado!</h2>

              <div class="score-display">
                <h3>Pontuação Final: <span id="final-score">0</span>/100</h3>
                <p>Nível: <span id="final-level">Técnico Iniciante</span></p>
              </div>

              <div style="margin-top: 30px">
                <button onclick="continueToPhase4()" class="btn">
                  🚀 Continuar para Fase 4
                </button>
                <button onclick="restartPhase3()" class="btn btn-secondary">
                  🔄 Repetir Fase 3
                </button>
                <a href="index.html" class="btn btn-secondary"
                  >🏠 Voltar ao Menu</a
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar com Progresso - CONFORME ESPECIFICAÇÃO -->
        <div class="sidebar">
          <h3>📊 Progresso</h3>

          <div class="progress-item">
            <h4>Puzzle 1: Programas</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-programs"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="programs-selected">0</span>/4 corretos</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 2: Entidades</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-entities"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="entities-contacted">0</span>/3 contactadas</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 3: Cronograma</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-timeline"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="activities-placed">0</span>/10 atividades</p>
          </div>

          <div class="progress-item">
            <h4>Puzzle 4: Validação</h4>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-validation"
                style="width: 0%"
              ></div>
            </div>
            <p><span id="validations-completed">0</span>/3 validações</p>
          </div>

          <div class="score-summary">
            <h4>🏆 Pontuação Total</h4>
            <div class="score-circle"><span id="total-score">0</span>/100</div>
          </div>

          <div class="phase-data">
            <h4>📋 Dados Anteriores</h4>
            <p>
              <strong>Fase 1:</strong> <span id="phase1-score">--</span>/100
            </p>
            <p>
              <strong>Fase 2:</strong> <span id="phase2-score">--</span>/100
            </p>
          </div>
        </div>
      </div>
    </div>

    <script src="js/shared.js"></script>
    <script src="js/modal-system.js"></script>
    <script src="js/phase3-engine.js"></script>
    <script>
      // IMPLEMENTAÇÃO COMPLETA CONFORME ESPECIFICAÇÃO DETALHADA

      // Estado do jogo da Fase 3
      const gameState = {
        currentState: "intro",
        score: 0,

        // Puzzle 1: Seleção de Programas
        programsSelected: [],
        programsRejected: [],
        puzzle1Score: 0,

        // Puzzle 2: Articulação de Entidades
        entitiesContacted: [],
        puzzle2Score: 0,

        // Puzzle 3: Cronograma
        activitiesPlaced: {},
        puzzle3Score: 0,

        // Puzzle 4: Validação e Aprovação
        validationCoherence: false,
        entityApprovals: { iefp: false, saude: false, ipss: false },
        consentObtained: false,
        puzzle4Score: 0,

        // Dados das fases anteriores
        phase1Data: null,
        phase2Data: null,
      };

      // DADOS DOS PROGRAMAS - EXATAMENTE CONFORME ESPECIFICAÇÃO
      const programsData = [
        {
          id: "programa_qualifica",
          nome: "Medida + Emprego - Programa Qualifica",
          categoria: "emprego_formacao",
          adequado_felisbina: true,
          pontos_se_selecionado: 6,
          pontos_se_rejeitado: -2,
          entidade_responsavel: "IEFP",
          duracao_meses: 6,
          justificacao_correta:
            "Adequado: Felisbina tem 9º ano, experiência em limpeza e disponibilidade total",
          icone: "💼",
          cor: "#2196f3",
        },
        {
          id: "apoio_psicossocial",
          nome: "Medida + Inclusão - Apoio Psicossocial",
          categoria: "apoio_psicossocial",
          adequado_felisbina: true,
          pontos_se_selecionado: 6,
          pontos_se_rejeitado: -3,
          entidade_responsavel: "centro_saude",
          duracao_meses: 8,
          justificacao_correta:
            "Essencial: Dependência emocional e isolamento social são problemas prioritários",
          icone: "🧠",
          cor: "#e91e63",
        },
        {
          id: "grupos_apoio_social",
          nome: "Grupos de Apoio Social - IPSS",
          categoria: "apoio_social",
          adequado_felisbina: true,
          pontos_se_selecionado: 5,
          pontos_se_rejeitado: -2,
          entidade_responsavel: "ipss_local",
          duracao_meses: 6,
          justificacao_correta:
            "Adequado: Isolamento social severo necessita intervenção específica",
          icone: "👥",
          cor: "#ff9800",
        },
        {
          id: "formacao_digital",
          nome: "Formação Modular - Competências Digitais",
          categoria: "formacao_especializada",
          adequado_felisbina: false,
          pontos_se_selecionado: -3,
          pontos_se_rejeitado: 3,
          entidade_responsavel: "centro_formacao",
          duracao_meses: 3,
          justificacao_correta:
            "Inadequado: Competências digitais muito limitadas, não é prioridade atual",
          icone: "📚",
          cor: "#9c27b0",
        },
        {
          id: "trabalho_necessario",
          nome: "Trabalho Socialmente Necessário",
          categoria: "emprego_protegido",
          adequado_felisbina: false,
          pontos_se_selecionado: -5,
          pontos_se_rejeitado: 4,
          entidade_responsavel: "camara_municipal",
          duracao_meses: 12,
          justificacao_correta:
            "Inadequado: Felisbina tem capacidade para emprego regular com apoio adequado",
          icone: "🛡️",
          cor: "#607d8b",
        },
        {
          id: "estagios_iniciar",
          nome: "Estágios INICIAR - Inclusão Social",
          categoria: "estagio_inclusao",
          adequado_felisbina: false,
          pontos_se_selecionado: -2,
          pontos_se_rejeitado: 1,
          entidade_responsavel: "ipss_local",
          duracao_meses: 4,
          justificacao_correta:
            "Inadequado: Conflito temporal com Programa Qualifica que é prioritário",
          icone: "🌱",
          cor: "#4caf50",
        },
      ];

      // DADOS DAS ENTIDADES - EXATAMENTE CONFORME ESPECIFICAÇÃO
      const entitiesData = [
        {
          id: "iefp_porto",
          nome: "IEFP - Instituto do Emprego e Formação Profissional",
          localizacao: "Porto",
          contacto: "225 073 000",
          email: "porto@iefp.pt",
          especialidade: [
            "qualifica",
            "medidas_emprego",
            "formacao_profissional",
          ],
          tempo_resposta: "3-5 dias úteis",
          adequado_felisbina: true,
          pontos: 8,
        },
        {
          id: "centro_saude_ramalde",
          nome: "Centro de Saúde de Ramalde",
          localizacao: "Porto - Ramalde",
          contacto: "225 073 200",
          email: "ramalde@arsnorte.min-saude.pt",
          especialidade: ["psicologia", "psiquiatria", "apoio_psicossocial"],
          tempo_resposta: "2-3 semanas",
          adequado_felisbina: true,
          pontos: 9,
        },
        {
          id: "ipss_solidariedade",
          nome: "IPSS Solidariedade Social",
          localizacao: "Porto",
          contacto: "225 073 300",
          email: "geral@solidariedadesocial.pt",
          especialidade: [
            "grupos_apoio",
            "atividades_sociais",
            "estagios_inclusao",
          ],
          tempo_resposta: "1-2 semanas",
          adequado_felisbina: true,
          pontos: 8,
        },
        {
          id: "centro_formacao_digital",
          nome: "Centro de Formação Digital",
          localizacao: "Porto",
          contacto: "225 073 400",
          email: "formacao@digitalporto.pt",
          especialidade: ["competencias_digitais", "formacao_modular"],
          tempo_resposta: "1 semana",
          adequado_felisbina: false,
          pontos: -3,
        },
      ];

      // DADOS DAS ATIVIDADES DO CRONOGRAMA - CONFORME ESPECIFICAÇÃO
      const activitiesData = [
        {
          id: "consulta_psicologia_inicial",
          nome: "Primeira consulta de psicologia",
          mes: 1,
          pontos: 3,
        },
        {
          id: "avaliacao_iefp",
          nome: "Avaliação inicial no IEFP",
          mes: 1,
          pontos: 3,
        },
        {
          id: "inicio_qualifica",
          nome: "Início do Programa Qualifica",
          mes: 2,
          pontos: 4,
        },
        {
          id: "grupos_apoio_inicio",
          nome: "Integração em grupos de apoio social",
          mes: 2,
          pontos: 3,
        },
        {
          id: "consultas_regulares",
          nome: "Consultas de psicologia quinzenais",
          mes: 2,
          pontos: 3,
        },
        {
          id: "rvcc_desenvolvimento",
          nome: "Desenvolvimento do RVCC 12º ano",
          mes: 3,
          pontos: 4,
        },
        {
          id: "acompanhamento_grupo_apoio",
          nome: "Acompanhamento em grupos de apoio",
          mes: 3,
          pontos: 3,
        },
        {
          id: "formacao_competencias_profissionais",
          nome: "Formação em competências profissionais",
          mes: 4,
          pontos: 4,
        },
        {
          id: "avaliacao_intermedia",
          nome: "Avaliação intermédia do progresso",
          mes: 4,
          pontos: 3,
        },
        {
          id: "estagio_profissional",
          nome: "Estágio profissional (Qualifica)",
          mes: 5,
          pontos: 4,
        },
        {
          id: "preparacao_autonomia",
          nome: "Preparação para autonomia",
          mes: 6,
          pontos: 3,
        },
        {
          id: "avaliacao_final",
          nome: "Avaliação final do processo",
          mes: 7,
          pontos: 2,
        },
      ];

      function loadPreviousPhases() {
        const phase1Results = localStorage.getItem("saasi_phase1_results");
        const phase2Results = localStorage.getItem("saasi_phase2_results");

        if (phase1Results) {
          gameState.phase1Data = JSON.parse(phase1Results);
          document.getElementById("phase1-score").textContent =
            gameState.phase1Data.score;
        }

        if (phase2Results) {
          gameState.phase2Data = JSON.parse(phase2Results);
          document.getElementById("phase2-score").textContent =
            gameState.phase2Data.score;
        }
      }

      // Mudar estado do jogo
      function changeState(newState) {
        // Esconder todos os estados
        document.querySelectorAll(".state").forEach((state) => {
          state.classList.add("state-hidden");
        });

        // Mostrar novo estado
        document
          .getElementById(`state-${newState}`)
          .classList.remove("state-hidden");
        gameState.currentState = newState;

        // Inicializar estado específico
        switch (newState) {
          case "programa-selecao":
            if (phase3EngineEnhanced) {
              phase3EngineEnhanced.initializeProgramSelection();
            } else {
              initProgramSelection();
            }
            break;
          case "entidades-articulacao":
            if (phase3EngineEnhanced) {
              phase3EngineEnhanced.initializeEntityArticulation();
            } else {
              initEntityArticulation();
            }
            break;
          case "cronograma-timeline":
            if (phase3EngineEnhanced) {
              phase3EngineEnhanced.initializeTimelineBuilder();
            } else {
              initTimelineBuilder();
            }
            break;
          case "conclusao":
            showConclusion();
            break;
        }
      }

      // PUZZLE 1: Inicializar seleção de programas
      function initProgramSelection() {
        const container = document.getElementById("programs-container");
        container.innerHTML = "";

        programsData.forEach((program) => {
          const card = document.createElement("div");
          card.className = "program-card";
          card.dataset.programId = program.id;
          card.onclick = () => toggleProgram(program.id);

          card.innerHTML = `
            <div class="program-status"></div>
            <div class="program-header">
              <h4 class="program-title">${program.icone} ${program.nome}</h4>
              <span class="program-category" style="background: rgba(${hexToRgb(
                program.cor
              )}, 0.1); color: ${program.cor};">
                ${program.categoria}
              </span>
            </div>
            <div class="program-details">
              <strong>Entidade:</strong> ${program.entidade_responsavel}<br>
              <strong>Duração:</strong> ${program.duracao_meses} meses<br>
              <strong>Justificação:</strong> ${program.justificacao_correta}
            </div>
          `;

          container.appendChild(card);
        });
      }

      // Helper function para converter hex para RGB
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? parseInt(result[1], 16) +
              "," +
              parseInt(result[2], 16) +
              "," +
              parseInt(result[3], 16)
          : "0,0,0";
      }

      // PUZZLE 1: Toggle seleção de programa - FIXED VERSION
      async function toggleProgram(programId) {
        const program = programsData.find((p) => p.id === programId);
        const card = document.querySelector(`[data-program-id="${programId}"]`);

        // Always allow re-selection - show current status and allow change
        let currentStatus = "none";
        if (gameState.programsSelected.includes(programId))
          currentStatus = "selected";
        if (gameState.programsRejected.includes(programId))
          currentStatus = "rejected";

        // Create message and button text based on current status
        let message = "";
        let okText = "";
        let cancelText = "";

        if (currentStatus === "selected") {
          message = `Programa <strong>SELECIONADO</strong> atualmente.<br><br>Deseja <strong>ALTERAR</strong> para REJEITAR?<br><br>Clique <strong>SIM</strong> para REJEITAR<br>Clique <strong>NÃO</strong> para manter SELECIONADO`;
          okText = "Sim, rejeitar";
          cancelText = "Não, manter atual";
        } else if (currentStatus === "rejected") {
          message = `Programa <strong>REJEITADO</strong> atualmente.<br><br>Deseja <strong>ALTERAR</strong> para SELECIONAR?<br><br>Clique <strong>SIM</strong> para SELECIONAR<br>Clique <strong>NÃO</strong> para manter REJEITADO`;
          okText = "Sim, selecionar";
          cancelText = "Não, manter atual";
        } else {
          message = `Deseja <strong>SELECIONAR</strong> este programa para a Felisbina?<br><br>Clique <strong>SIM</strong> para SELECIONAR<br>Clique <strong>NÃO</strong> para REJEITAR`;
          okText = "Sim, selecionar";
          cancelText = "Não, rejeitar";
        }

        const selectProgram = await ModalSystem.confirm(message, {
          title: "🤔 Decisão sobre Programa",
          okText: okText,
          cancelText: cancelText,
          type: "confirm",
        });

        // Remove from both lists first (reset state)
        const wasSelected = gameState.programsSelected.includes(programId);
        const wasRejected = gameState.programsRejected.includes(programId);

        if (wasSelected) {
          gameState.programsSelected = gameState.programsSelected.filter(
            (id) => id !== programId
          );
          gameState.puzzle1Score -= program.pontos_se_selecionado;
        }

        if (wasRejected) {
          gameState.programsRejected = gameState.programsRejected.filter(
            (id) => id !== programId
          );
          gameState.puzzle1Score -= program.pontos_se_rejeitado;
        }

        // Clear visual state
        card.classList.remove("selected", "rejected");
        card.querySelector(".program-status").textContent = "";

        // Apply new state based on decision
        if (
          (currentStatus === "none" && selectProgram) ||
          (currentStatus === "rejected" && selectProgram) ||
          (currentStatus === "selected" && !selectProgram)
        ) {
          // SELECT the program
          gameState.programsSelected.push(programId);
          card.classList.add("selected");
          card.querySelector(".program-status").textContent = "✅";
          gameState.puzzle1Score += program.pontos_se_selecionado;

          showToast(
            `✅ ${program.nome} SELECIONADO (+${program.pontos_se_selecionado} pontos)`,
            "success",
            2000
          );
        } else {
          // REJECT the program
          gameState.programsRejected.push(programId);
          card.classList.add("rejected");
          card.querySelector(".program-status").textContent = "❌";
          gameState.puzzle1Score += program.pontos_se_rejeitado;

          showToast(
            `❌ ${program.nome} REJEITADO (+${program.pontos_se_rejeitado} pontos)`,
            "warning",
            2000
          );
        }

        updateProgress();
        checkPuzzle1Completion();
      }

      // Separate function to check puzzle 1 completion
      function checkPuzzle1Completion() {
        // Verificar critérios de sucesso - RELAXED CRITERIA
        const adequateSelected = gameState.programsSelected.filter(
          (id) => programsData.find((p) => p.id === id).adequado_felisbina
        ).length;

        const inadequateRejected = gameState.programsRejected.filter(
          (id) => !programsData.find((p) => p.id === id).adequado_felisbina
        ).length;

        const totalDecisions =
          gameState.programsSelected.length + gameState.programsRejected.length;

        // More relaxed criteria: at least 4 total decisions with good balance
        if (
          totalDecisions >= 4 &&
          adequateSelected >= 2 &&
          inadequateRejected >= 2
        ) {
          document.getElementById("btn-continue-entities").style.display =
            "block";
          showToast(
            "🎯 Critérios de seleção atingidos! Pode continuar para a próxima fase.",
            "success",
            3000
          );
        } else {
          document.getElementById("btn-continue-entities").style.display =
            "none";
        }
      }

      // PUZZLE 2: Inicializar articulação de entidades
      function initEntityArticulation() {
        const container = document.getElementById("entities-container");
        container.innerHTML = "";

        entitiesData.forEach((entity) => {
          const card = document.createElement("div");
          card.className = `entity-card ${
            entity.adequado_felisbina ? "essential" : ""
          }`;
          card.dataset.entityId = entity.id;

          card.innerHTML = `
            <div class="entity-name">${entity.nome}</div>
            <div class="entity-specialty">${entity.especialidade.join(
              ", "
            )}</div>
            <div class="entity-contact">📍 ${entity.localizacao}</div>
            <div class="entity-contact">📞 ${entity.contacto}</div>
            <div class="entity-contact">📧 ${entity.email}</div>
            <div class="entity-contact">⏰ ${entity.tempo_resposta}</div>
            <button class="contact-button" data-entity-id="${entity.id}">
              Contactar
            </button>
          `;

          // Adicionar evento click ao botão
          const button = card.querySelector(".contact-button");
          button.onclick = () => contactEntity(entity.id);

          container.appendChild(card);
        });
      }

      // PUZZLE 2: Contactar entidade
      function contactEntity(entityId) {
        const entity = entitiesData.find((e) => e.id === entityId);
        const card = document.querySelector(`[data-entity-id="${entityId}"]`);
        const button = card.querySelector(".contact-button");

        if (!gameState.entitiesContacted.includes(entityId)) {
          gameState.entitiesContacted.push(entityId);
          card.classList.add("contacted");
          button.textContent = "Contactado ✓";
          button.disabled = true;
          gameState.puzzle2Score += entity.pontos;

          updateProgress();

          // Verificar critério de sucesso: 3 entidades contactadas
          if (gameState.entitiesContacted.length >= 3) {
            document.getElementById("btn-continue-timeline").style.display =
              "block";
          }
        }
      }

      // PUZZLE 3: Inicializar timeline builder
      function initTimelineBuilder() {
        const poolContainer = document.getElementById("activities-pool");
        const timelineContainer = document.getElementById("timeline-container");

        // Criar pool de atividades
        poolContainer.innerHTML = "";
        activitiesData.forEach((activity) => {
          const item = document.createElement("div");
          item.className = "activity-item";
          item.draggable = true;
          item.dataset.activityId = activity.id;
          item.textContent = activity.nome;
          item.ondragstart = (e) =>
            e.dataTransfer.setData("text/plain", activity.id);
          poolContainer.appendChild(item);
        });

        // Criar timeline de 7 meses CONFORME ESPECIFICAÇÃO
        timelineContainer.innerHTML = "";
        const months = [
          "Fevereiro",
          "Março",
          "Abril",
          "Maio",
          "Junho",
          "Julho",
          "Agosto",
        ];

        for (let mes = 1; mes <= 7; mes++) {
          const monthDiv = document.createElement("div");
          monthDiv.className = "timeline-month";
          monthDiv.innerHTML = `
            <h4>Mês ${mes} - ${months[mes - 1]}</h4>
            <div class="timeline-activities" data-month="${mes}" 
                 ondrop="dropActivity(event)" ondragover="allowDrop(event)"></div>
          `;
          timelineContainer.appendChild(monthDiv);
        }
      }

      // PUZZLE 3: Permitir drop
      function allowDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.add("droppable");
      }

      // PUZZLE 3: Drop atividade
      function dropActivity(event) {
        event.preventDefault();
        const activityId = event.dataTransfer.getData("text/plain");
        const month = parseInt(event.currentTarget.dataset.month);
        const activity = activitiesData.find((a) => a.id === activityId);

        // Verificar se é o mês correto CONFORME ESPECIFICAÇÃO
        if (activity.mes === month) {
          const activityElement = document.querySelector(
            `[data-activity-id="${activityId}"]`
          );
          activityElement.classList.add("placed");
          event.currentTarget.appendChild(activityElement);

          gameState.activitiesPlaced[activityId] = month;
          gameState.puzzle3Score += activity.pontos;

          updateProgress();

          // Verificar se pode finalizar (6+ atividades colocadas)
          if (Object.keys(gameState.activitiesPlaced).length >= 6) {
            document.getElementById("btn-continue-validation").style.display =
              "block";
          }
        }

        event.currentTarget.classList.remove("droppable");
      }

      // Atualizar progresso
      function updateProgress() {
        // Atualizar pontuação total CONFORME ESPECIFICAÇÃO - máximo 100 pontos
        gameState.score = Math.min(
          gameState.puzzle1Score +
            gameState.puzzle2Score +
            gameState.puzzle3Score +
            gameState.puzzle4Score,
          100
        );
        document.getElementById("total-score").textContent = gameState.score;

        // Atualizar barras de progresso
        const programsProgress = (gameState.programsSelected.length / 4) * 100;
        document.getElementById("progress-programs").style.width = `${Math.min(
          programsProgress,
          100
        )}%`;
        document.getElementById("programs-selected").textContent =
          gameState.programsSelected.length;

        const entitiesProgress = (gameState.entitiesContacted.length / 3) * 100;
        document.getElementById(
          "progress-entities"
        ).style.width = `${entitiesProgress}%`;
        document.getElementById("entities-contacted").textContent =
          gameState.entitiesContacted.length;

        const activitiesProgress =
          (Object.keys(gameState.activitiesPlaced).length / 10) * 100;
        document.getElementById(
          "progress-timeline"
        ).style.width = `${activitiesProgress}%`;
        document.getElementById("activities-placed").textContent = Object.keys(
          gameState.activitiesPlaced
        ).length;

        // Puzzle 4: Validação
        const validationsCompleted =
          (gameState.validationCoherence ? 1 : 0) +
          (Object.values(gameState.entityApprovals).every(
            (approved) => approved
          )
            ? 1
            : 0) +
          (gameState.consentObtained ? 1 : 0);
        const validationProgress = (validationsCompleted / 3) * 100;
        document.getElementById(
          "progress-validation"
        ).style.width = `${validationProgress}%`;
        document.getElementById("validations-completed").textContent =
          validationsCompleted;

        // Atualizar pontuações dos puzzles - FIXED VERSION
        const puzzleScores = document.querySelectorAll(".puzzle-score");
        if (puzzleScores[0])
          puzzleScores[0].textContent = `${Math.max(
            0,
            gameState.puzzle1Score
          )}/25 pontos`;
        if (puzzleScores[1])
          puzzleScores[1].textContent = `${Math.max(
            0,
            gameState.puzzle2Score
          )}/25 pontos`;
        if (puzzleScores[2])
          puzzleScores[2].textContent = `${Math.max(
            0,
            gameState.puzzle3Score
          )}/30 pontos`;
        if (puzzleScores[3])
          puzzleScores[3].textContent = `${Math.max(
            0,
            gameState.puzzle4Score
          )}/20 pontos`;

        // Also update puzzle-specific score display if visible
        const currentPuzzleScore = document.querySelector(
          "#state-programa-selecao .puzzle-score"
        );
        if (
          currentPuzzleScore &&
          gameState.currentState === "programa-selecao"
        ) {
          currentPuzzleScore.textContent = `${Math.max(
            0,
            gameState.puzzle1Score
          )}/25 pontos`;
        }
      }

      // Mostrar conclusão
      function showConclusion() {
        // Limitar pontuação máxima a 100 (conforme especificação)
        const finalScore = Math.min(gameState.score, 100);

        // Calcular nível final CONFORME ESPECIFICAÇÃO
        let level = "Técnico Iniciante";
        if (finalScore >= 90) level = "Mestre SAASI";
        else if (finalScore >= 80) level = "Técnico Especialista";
        else if (finalScore >= 70) level = "Técnico Proficiente";
        else if (finalScore >= 60) level = "Técnico Competente";

        document.getElementById("final-score").textContent = finalScore;
        document.getElementById("final-level").textContent = level;

        // SALVAR AUTOMATICAMENTE OS RESULTADOS DA FASE 3 (CONSISTENTE COM OUTRAS FASES)

        const phase3Results = {
          phase: 3,
          score: finalScore,
          maxScore: 100,
          percentage: finalScore,
          rawScore: gameState.score, // Manter pontuação bruta para debugging
          duration: Math.round((Date.now() - gameStartTime) / 60000) || 20,
          level: { title: level },
          programsSelected: gameState.programsSelected,
          programsRejected: gameState.programsRejected,
          entitiesContacted: gameState.entitiesContacted,
          activitiesPlaced: gameState.activitiesPlaced,
          phase1Data: gameState.phase1Data,
          phase2Data: gameState.phase2Data,
          puzzleScores: {
            puzzle1: gameState.puzzle1Score,
            puzzle2: gameState.puzzle2Score,
            puzzle3: gameState.puzzle3Score,
            puzzle4: gameState.puzzle4Score,
          },
        };

        localStorage.setItem(
          "saasi_phase3_results",
          JSON.stringify(phase3Results)
        );
      }

      // PUZZLE 4: Funções de Validação e Aprovação
      function validateCoherence() {
        const objetivos = document.getElementById("check-objetivos").checked;
        const cronograma = document.getElementById("check-cronograma").checked;
        const recursos = document.getElementById("check-recursos").checked;

        if (objetivos && cronograma && recursos) {
          gameState.validationCoherence = true;
          gameState.puzzle4Score += 10;

          const item = document.getElementById("validation-coherence");
          item.classList.add("completed");
          item.querySelector(".validation-status").textContent = "Completo";
          item.querySelector(".validation-status").classList.add("completed");

          document.getElementById("btn-validate-coherence").textContent =
            "✅ Validado";
          document.getElementById("btn-validate-coherence").disabled = true;

          checkPuzzle4Completion();
          updateProgress();
        } else {
          showToast(
            "Por favor, complete todas as verificações antes de validar.",
            "warning"
          );
        }
      }

      function requestApproval(entity) {
        // Simular pedido de aprovação
        setTimeout(() => {
          gameState.entityApprovals[entity] = true;
          gameState.puzzle4Score += 3.33; // 10 pontos / 3 entidades

          const button = document.getElementById(`btn-approval-${entity}`);
          button.textContent = "✅ Aprovado";
          button.disabled = true;
          button.style.background = "#28a745";

          checkPuzzle4Completion();
          updateProgress();
        }, 1000);
      }

      function validateConsent() {
        const compreensao =
          document.getElementById("check-compreensao").checked;
        const acordo = document.getElementById("check-acordo").checked;
        const expectativas =
          document.getElementById("check-expectativas").checked;

        if (compreensao && acordo && expectativas) {
          gameState.consentObtained = true;
          gameState.puzzle4Score += 5;

          const item = document.getElementById("validation-consent");
          item.classList.add("completed");
          item.querySelector(".validation-status").textContent = "Completo";
          item.querySelector(".validation-status").classList.add("completed");

          document.getElementById("btn-validate-consent").textContent =
            "✅ Consentimento Obtido";
          document.getElementById("btn-validate-consent").disabled = true;

          checkPuzzle4Completion();
          updateProgress();
        } else {
          showToast(
            "Por favor, complete todas as verificações de consentimento.",
            "warning"
          );
        }
      }

      function checkPuzzle4Completion() {
        const allApprovals = Object.values(gameState.entityApprovals).every(
          (approved) => approved
        );

        if (
          gameState.validationCoherence &&
          allApprovals &&
          gameState.consentObtained
        ) {
          document.getElementById("btn-finalize-plan").style.display = "block";

          // Atualizar status geral
          const approvalItem = document.getElementById("validation-approvals");
          approvalItem.classList.add("completed");
          approvalItem.querySelector(".validation-status").textContent =
            "Completo";
          approvalItem
            .querySelector(".validation-status")
            .classList.add("completed");
        }
      }

      // Continuar para Fase 4
      function continueToPhase4() {
        const finalScore = Math.min(gameState.score, 100);
        console.log(
          "continueToPhase4() called with raw score:",
          gameState.score,
          "final score:",
          finalScore
        );

        // Critério de desbloqueio: 65/100 pontos CONFORME ESPECIFICAÇÃO
        if (finalScore >= 65) {
          showConclusion(); // Salvar resultados
          showToast(
            '🎉 Parabéns! Desbloqueou a Fase 4!<br><br>Código de desbloqueio: "INTERVENCAO2025"<br><br>Pontuação: ' +
              finalScore +
              "/100<br><br>Redirecionando para a Fase 4...",
            "success",
            3000
          );
          // Redirecionar para fase4.html
          setTimeout(() => {
            console.log("Redirecting to fase4.html");
            window.location.href = "fase4.html";
          }, 2000);
        } else {
          showToast(
            "⚠️ Pontuação insuficiente para Fase 4!<br><br>Necessário: 65/100 pontos<br>Obtido: " +
              finalScore +
              "/100<br><br>Tente novamente!",
            "error",
            6000
          );
          return;
        }
      }

      // Reiniciar Fase 3
      function restartPhase3() {
        localStorage.removeItem("saasi_phase3_results");
        location.reload();
      }

      // Variável para tracking do tempo
      let gameStartTime = Date.now();

      // Toast System
      function showToast(message, type = "info", duration = 5000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
          ${message}
          <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Inicialização
      document.addEventListener("DOMContentLoaded", function () {
        loadPreviousPhases();

        // Initialize enhanced Phase 3 Engine
        if (
          phase3EngineEnhanced &&
          gameState.phase1Data &&
          gameState.phase2Data
        ) {
          phase3EngineEnhanced.initialize(
            gameState.phase1Data,
            gameState.phase2Data
          );
        }

        updateProgress();
      });
    </script>
  </body>
</html>
