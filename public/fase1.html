<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAASI - Fase 1</title>
    <style>
      /* Toast System */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
      }

      .toast {
        background: #333;
        color: white;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        padding-right: 50px;
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        background: #28a745;
        border-left: 4px solid #1e7e34;
      }

      .toast.error {
        background: #dc3545;
        border-left: 4px solid #c82333;
      }

      .toast.warning {
        background: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .toast.info {
        background: #17a2b8;
        border-left: 4px solid #138496;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .main-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
      }
      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        z-index: 1000;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .back-button:hover {
        background: rgba(84, 91, 98, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }
      .state {
        display: none;
      }
      .state.active {
        display: block;
      }
      .progress {
        background: #e0e0e0;
        height: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }
      .progress-fill {
        background: #4caf50;
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s;
      }
      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        margin: 8px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }
      .btn.selected {
        background: #4caf50;
      }
      .dialogue-option {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 20px;
        margin: 15px 0;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .dialogue-option:hover {
        border-color: rgba(102, 126, 234, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }
      .dialogue-option.selected {
        border-color: #4caf50;
        background: rgba(232, 245, 233, 0.9);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
      }
      .drag-item {
        background: rgba(255, 243, 224, 0.9);
        backdrop-filter: blur(5px);
        border: 2px solid #ff9800;
        padding: 15px;
        margin: 8px;
        border-radius: 12px;
        cursor: pointer;
        display: inline-block;
        user-select: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(255, 152, 0, 0.2);
        position: relative;
        min-height: 50px;
        min-width: 120px;
        text-align: center;
        font-weight: 500;
        touch-action: manipulation;
      }
      .drag-item:hover {
        background: rgba(255, 224, 178, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
      }
      .drag-item:active {
        transform: scale(0.98);
      }
      .drag-item.selected {
        background: rgba(102, 126, 234, 0.9);
        border-color: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      .drag-item.placed {
        opacity: 0.6;
        background: rgba(200, 200, 200, 0.8);
        border-color: #999;
        color: #666;
        cursor: not-allowed;
        pointer-events: none;
      }
      .drop-zone {
        min-height: 120px;
        border: 3px dashed rgba(204, 204, 204, 0.7);
        padding: 20px;
        margin: 15px 0;
        border-radius: 15px;
        background: rgba(249, 249, 249, 0.8);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
        position: relative;
        touch-action: manipulation;
      }
      .drop-zone.drag-over,
      .drop-zone.active {
        border-color: #667eea;
        background: rgba(227, 242, 253, 0.9);
        border-style: solid;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }
      .drop-zone.correct {
        border-color: #4caf50;
        background: rgba(232, 245, 233, 0.9);
        border-style: solid;
      }
      .drop-zone.incorrect {
        border-color: #f44336;
        background: rgba(255, 235, 238, 0.9);
        border-style: solid;
        animation: shake 0.5s ease-in-out;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }
      .mobile-instructions {
        background: rgba(227, 242, 253, 0.9);
        backdrop-filter: blur(5px);
        padding: 15px;
        border-radius: 12px;
        margin: 15px 0;
        border: 2px solid rgba(33, 150, 243, 0.3);
      }
      .mobile-mode-button {
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin: 10px 5px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        touch-action: manipulation;
      }
      .mobile-mode-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
      }
      .document-item {
        background: #f5f5f5;
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .score {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(51, 51, 51, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }
      .metrics {
        background: rgba(240, 240, 240, 0.8);
        backdrop-filter: blur(5px);
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      /* Mobile Responsive Enhancements */
      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
        }
        .container {
          padding: 20px;
          margin-bottom: 10px;
        }
        .back-button {
          top: 10px;
          left: 10px;
          padding: 8px 16px;
          font-size: 14px;
        }
        .score {
          top: 10px;
          right: 10px;
          padding: 8px 16px;
          font-size: 14px;
        }
        .btn {
          padding: 12px 20px;
          font-size: 14px;
          margin: 6px 3px;
          min-width: 100px;
        }
        .dialogue-option {
          padding: 15px;
          margin: 10px 0;
          font-size: 14px;
        }
        .drag-item {
          min-width: 100px;
          padding: 12px;
          margin: 6px 3px;
          font-size: 14px;
        }
        .drop-zone {
          min-height: 100px;
          padding: 15px;
          margin: 10px 0;
        }
        .metrics {
          padding: 15px;
          font-size: 14px;
        }
        h1 {
          font-size: 1.8rem;
        }
        h2 {
          font-size: 1.4rem;
        }
        h3 {
          font-size: 1.2rem;
        }
        .mobile-instructions {
          display: block;
        }
        /* Make drag container scrollable on small screens */
        #elements-pool {
          max-height: 200px;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }
        /* Stack drop zones vertically on mobile */
        .analysis-container {
          flex-direction: column;
          gap: 10px;
        }
        .analysis-container > div {
          flex: 1;
          min-width: 100%;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 10px;
        }
        .main-container {
          padding: 5px;
        }
        .container {
          padding: 15px;
        }
        .back-button,
        .score {
          position: static;
          display: inline-block;
          margin: 5px;
          font-size: 12px;
          padding: 6px 12px;
        }
        .mobile-nav {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          padding: 10px;
          z-index: 1001;
          display: flex;
          justify-content: space-between;
          align-items: center;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .main-container {
          margin-top: 60px;
        }
        .btn {
          width: 100%;
          margin: 5px 0;
          padding: 15px;
          font-size: 16px;
        }
        .dialogue-option {
          margin: 8px 0;
          padding: 12px;
        }
        .drag-item {
          width: calc(50% - 10px);
          margin: 5px;
          padding: 10px;
          font-size: 12px;
          min-width: 90px;
        }
        h1 {
          font-size: 1.5rem;
        }
        h2 {
          font-size: 1.3rem;
        }
        h3 {
          font-size: 1.1rem;
        }
      }

      /* Touch-friendly improvements */
      @media (hover: none) and (pointer: coarse) {
        .drag-item {
          min-height: 60px;
          padding: 15px;
        }
        .btn {
          min-height: 48px;
          padding: 15px 20px;
        }
        .dialogue-option {
          min-height: 60px;
          padding: 18px;
        }
        .drop-zone {
          min-height: 140px;
          padding: 25px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <a href="index.html" class="back-button">← Voltar ao Menu</a>
    <div class="score">Pontuação: <span id="score">0</span>/100</div>

    <div class="main-container">
      <div class="container">
        <div class="progress">
          <div class="progress-fill" id="progress" style="width: 0%"></div>
        </div>

        <!-- ESTADO 1: INICIO -->
        <div id="state-inicio" class="state active">
          <h1>SAASI - Fase 1</h1>
          <h2>Acolhimento e Avaliação Inicial</h2>

          <div
            style="
              background: #e3f2fd;
              padding: 20px;
              border-radius: 5px;
              margin: 20px 0;
            "
          >
            <h3>Contexto:</h3>
            <p>
              <strong>Felisbina Santos</strong>, 56 anos, 9º ano de
              escolaridade, vive sozinha numa pensão.
            </p>
            <p>
              Beneficiária de RSI desde Março 2025 + Prestação Social para a
              Inclusão (PSI).
            </p>
            <p>
              <strong>Experiência profissional:</strong> 6 meses como empregada
              de limpeza.
            </p>
            <p>
              <strong>Situação familiar:</strong> Dependência emocional do pai,
              perdeu apoio do irmão que a orientava financeiramente.
            </p>
            <p>
              <strong>Objetivo:</strong> Realizar acolhimento inicial e
              determinar se tem
              <strong>Disponibilidade e Capacidade Para Trabalhar</strong>.
            </p>
          </div>

          <button class="btn" onclick="startGame()">Começar Consulta</button>
        </div>

        <!-- ESTADO 2: CONVERSA -->
        <div id="state-conversa" class="state">
          <h2>Conversa com Felisbina</h2>
          <div class="metrics">
            <strong>Empatia:</strong> <span id="empathy">0</span>/25 |
            <strong>Informação:</strong> <span id="information">0</span>% |
            <strong>Interações:</strong> <span id="interactions">0</span>/5
          </div>

          <div id="dialogue-content">
            <h3 id="dialogue-question">Selecione como iniciar a conversa:</h3>
            <div id="dialogue-options">
              <!-- Opções serão inseridas dinamicamente -->
            </div>
          </div>

          <button
            class="btn"
            id="next-dialogue"
            onclick="nextState()"
            style="display: none"
          >
            Continuar para Análise
          </button>
        </div>

        <!-- ESTADO 3: ANALISE -->
        <div id="state-analise" class="state">
          <h2>Análise de Fatores de Risco e Proteção</h2>
          <div class="metrics">
            <strong>Elementos Categorizados:</strong>
            <span id="categorized">0</span>/6 | <strong>Precisão:</strong>
            <span id="accuracy">0</span>%
          </div>

          <div class="mobile-instructions">
            <h4>📱 Instruções:</h4>
            <p>
              <strong>Desktop:</strong> Arraste os elementos para as categorias
            </p>
            <p>
              <strong>Mobile:</strong> Toque num elemento para selecioná-lo,
              depois toque na categoria desejada
            </p>
            <button class="mobile-mode-button" onclick="toggleMobileMode()">
              <span id="mode-text">Modo Toque</span>
            </button>
          </div>

          <div id="elements-pool">
            <h4>Elementos para Análise:</h4>
            <!-- Elementos serão inseridos dinamicamente -->
          </div>

          <div class="analysis-container" style="display: flex; gap: 20px">
            <div style="flex: 1">
              <h4 style="color: #d32f2f">🔴 Fatores de Risco</h4>
              <div
                class="drop-zone"
                id="risk-zone"
                ondrop="drop(event)"
                ondragover="allowDrop(event)"
                onclick="handleZoneClick('risk')"
              >
                <p>Selecione fatores de risco</p>
              </div>
            </div>
            <div style="flex: 1">
              <h4 style="color: #388e3c">🟢 Fatores de Proteção</h4>
              <div
                class="drop-zone"
                id="protection-zone"
                ondrop="drop(event)"
                ondragover="allowDrop(event)"
                onclick="handleZoneClick('protection')"
              >
                <p>Selecione fatores de proteção</p>
              </div>
            </div>
          </div>

          <button
            class="btn"
            id="next-analysis"
            onclick="nextState()"
            style="display: none"
          >
            Continuar para Documentação
          </button>
        </div>

        <!-- ESTADO 4: DOCUMENTACAO -->
        <div id="state-documentacao" class="state">
          <h2>Verificação de Documentação</h2>
          <div class="metrics">
            <strong>Documentos Identificados:</strong>
            <span id="docs-identified">0</span>/3 |
            <strong>Eficiência:</strong> <span id="efficiency">0</span>%
          </div>

          <div id="documents-list">
            <!-- Documentos serão inseridos dinamicamente -->
          </div>

          <button
            class="btn"
            id="next-docs"
            onclick="nextState()"
            style="display: none"
          >
            Continuar para Avaliação
          </button>
        </div>

        <!-- ESTADO 5: AVALIACAO -->
        <div id="state-avaliacao" class="state">
          <h2>Avaliação DLD - Decisão Final</h2>

          <div
            id="dld-criteria-display"
            style="
              background: #f5f5f5;
              padding: 20px;
              border-radius: 5px;
              margin: 20px 0;
            "
          >
            <h4>Critérios DLD:</h4>
            <!-- Content will be populated by assessment logic -->
          </div>

          <div>
            <h4>1. A Felisbina tem DISPONIBILIDADE para trabalhar?</h4>
            <div id="availability-options">
              <div
                class="dialogue-option"
                onclick="selectAvailability('sim_total')"
              >
                <strong>SIM - Disponibilidade total</strong><br />
                Sem dependentes, horário flexível, motivada para mudança
              </div>
              <div
                class="dialogue-option"
                onclick="selectAvailability('sim_condicionada')"
              >
                <strong>SIM - Disponibilidade condicionada</strong><br />
                Disponível mas com necessidade de apoio psicológico
              </div>
              <div class="dialogue-option" onclick="selectAvailability('nao')">
                <strong>NÃO - Indisponível temporariamente</strong><br />
                Necessita primeiro de estabilização emocional
              </div>
            </div>
          </div>

          <div id="capacity-section" style="display: none">
            <h4>2. A Felisbina tem CAPACIDADE para trabalhar?</h4>
            <div id="capacity-options">
              <div
                class="dialogue-option"
                onclick="selectCapacity('sim_plena')"
              >
                <strong>SIM - Capacidade plena</strong><br />
                Experiência anterior, sem limitações físicas
              </div>
              <div
                class="dialogue-option"
                onclick="selectCapacity('sim_formacao')"
              >
                <strong>SIM - Capacidade com formação</strong><br />
                Capacidade existente mas necessita qualificação adicional
              </div>
              <div class="dialogue-option" onclick="selectCapacity('nao')">
                <strong>NÃO - Incapacidade temporária</strong><br />
                Limitações emocionais impedem trabalho imediato
              </div>
            </div>
          </div>

          <button
            class="btn"
            id="finalize-assessment"
            onclick="nextState()"
            style="display: none"
          >
            Finalizar Avaliação
          </button>
        </div>

        <!-- ESTADO 6: CONCLUSAO -->
        <div id="state-conclusao" class="state">
          <h1>Fase 1 Concluída!</h1>

          <div
            style="
              text-align: center;
              background: #e8f5e9;
              padding: 30px;
              border-radius: 10px;
              margin: 20px 0;
            "
          >
            <h2>Pontuação Final: <span id="final-score">0</span>/100</h2>
            <h3 id="final-level">Técnico Iniciante</h3>
          </div>

          <div id="final-report">
            <!-- Relatório será inserido dinamicamente -->
          </div>

          <div style="text-align: center; margin-top: 30px">
            <button class="btn" onclick="restartGame()">Repetir Fase 1</button>
            <button
              class="btn"
              style="background: #4caf50"
              onclick="continueToPhase2()"
            >
              Continuar para Fase 2
            </button>
            <a
              href="index.html"
              class="btn"
              style="background: #6c757d; text-decoration: none"
              >Voltar ao Menu</a
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Load scoring system -->
    <script src="js/scoring-system.js"></script>
    <script src="js/assessment-logic.js"></script>
    <script src="js/case-data-felisbina.js"></script>
    <script src="js/modal-system.js"></script>
    <script src="js/phase-data-generator.js"></script>
    <script src="js/url-navigation.js"></script>

    <script>
      // ESTADO DO JOGO
      let gameState = {
        currentState: "inicio",
        score: 0,
        progress: 0,

        // Métricas da conversa
        empathy: 0,
        information: 0,
        interactions: 0,

        // Métricas da análise
        categorized: 0,
        accuracy: 0,

        // Métricas da documentação
        docsIdentified: 0,
        efficiency: 0,

        // Decisões finais
        availability: null,
        capacity: null,
      };

      // DADOS DO JOGO
      const dialogues = [
        {
          id: "abertura",
          question: "Olá Felisbina, sou técnica do SAASI. Como se sente hoje?",
          options: [
            {
              text: "Vejo que está nervosa. Não se preocupe, estamos aqui para a ajudar.",
              empathy: 8,
              info: 2,
            },
            {
              text: "Preciso que me forneça algumas informações sobre a sua situação.",
              empathy: 2,
              info: 6,
            },
            {
              text: "Conte-me um pouco sobre si e o que a trouxe até aqui.",
              empathy: 5,
              info: 5,
            },
          ],
        },
        {
          id: "situacao_atual",
          question: "Vive sozinha numa pensão. Como é essa situação para si?",
          options: [
            {
              text: "Imagino que não seja fácil viver numa pensão. Como se sente lá?",
              empathy: 7,
              info: 4,
            },
            {
              text: "Há quanto tempo vive na pensão? Quanto paga de renda?",
              empathy: 1,
              info: 8,
            },
            {
              text: "A pensão é temporária? Tem planos para mudar?",
              empathy: 4,
              info: 6,
            },
          ],
        },
        {
          id: "experiencia_limpeza",
          question:
            "Tem experiência de trabalho como empregada de limpeza. Como foi?",
          options: [
            {
              text: "Seis meses é um bom período. Deve ter aprendido muito.",
              empathy: 6,
              info: 5,
            },
            {
              text: "Porque é que o trabalho terminou? Houve algum problema?",
              empathy: 2,
              info: 8,
            },
            {
              text: "Gostaria de voltar a trabalhar na área de limpeza?",
              empathy: 5,
              info: 6,
            },
          ],
        },
        {
          id: "dependencia_emocional",
          question:
            "Falou-me do seu pai e do irmão. Como são essas relações familiares?",
          options: [
            {
              text: "Vejo que o seu pai é muito importante para si. Essa ligação é muito forte.",
              empathy: 8,
              info: 4,
            },
            {
              text: "Deve ser difícil ter perdido o apoio do irmão que a orientava.",
              empathy: 7,
              info: 6,
            },
            {
              text: "Como se sente agora sem o apoio financeiro e orientação do irmão?",
              empathy: 5,
              info: 8,
            },
          ],
        },
        {
          id: "mudancas_atuais",
          question:
            "Disse que se sente sozinha agora. Como está a lidar com essas mudanças?",
          options: [
            {
              text: "É compreensível sentir-se assim. Estas mudanças são muito difíceis.",
              empathy: 9,
              info: 3,
            },
            {
              text: "Tem algum apoio além do RSI? Conhece outros serviços que possam ajudar?",
              empathy: 4,
              info: 8,
            },
            {
              text: "Como imagina o seu futuro? Que objetivos tem para si própria?",
              empathy: 6,
              info: 6,
            },
          ],
        },
      ];

      const analysisElements = [
        { id: "idade_56", text: "Idade: 56 anos", category: "risk", points: 5 },
        {
          id: "experiencia_limpeza",
          text: "Experiência em limpeza",
          category: "protection",
          points: 8,
        },
        {
          id: "isolamento_social",
          text: "Isolamento social",
          category: "risk",
          points: 7,
        },
        {
          id: "dependencia_pai",
          text: "Dependência emocional do pai",
          category: "risk",
          points: 10,
        },
        {
          id: "9ano_escolaridade",
          text: "9º ano escolaridade",
          category: "protection",
          points: 8,
        },
        {
          id: "psi_ativa",
          text: "PSI ativa",
          category: "protection",
          points: 6,
        },
      ];

      const documents = [
        {
          id: "rsi",
          name: "Comprovativo RSI",
          mandatory: true,
          available: true,
          points: 8,
        },
        {
          id: "historico",
          name: "Histórico Profissional",
          mandatory: true,
          available: false,
          points: 10,
        },
        {
          id: "habilitacoes",
          name: "Certificado de Habilitações",
          mandatory: true,
          available: true,
          points: 6,
        },
        {
          id: "medico",
          name: "Relatório Médico",
          mandatory: false,
          available: false,
          points: 3,
        },
        {
          id: "referencias",
          name: "Referências de Empregadores",
          mandatory: false,
          available: false,
          points: 2,
        },
      ];

      let currentDialogue = 0;

      // FUNÇÕES PRINCIPAIS
      function startGame() {
        changeState("conversa");
        showDialogue();
      }

      function changeState(newState) {
        // Esconder estado atual
        document.querySelector(".state.active").classList.remove("active");

        // Mostrar novo estado
        document.getElementById(`state-${newState}`).classList.add("active");

        gameState.currentState = newState;
        updateProgress();
      }

      function updateProgress() {
        const states = [
          "inicio",
          "conversa",
          "analise",
          "documentacao",
          "avaliacao",
          "conclusao",
        ];
        const currentIndex = states.indexOf(gameState.currentState);
        const progress = (currentIndex / (states.length - 1)) * 100;

        document.getElementById("progress").style.width = progress + "%";
      }

      function nextState() {
        const states = [
          "inicio",
          "conversa",
          "analise",
          "documentacao",
          "avaliacao",
          "conclusao",
        ];
        const currentIndex = states.indexOf(gameState.currentState);
        const nextState = states[currentIndex + 1];

        if (nextState) {
          changeState(nextState);

          // Inicializar próximo estado
          if (nextState === "analise") {
            showAnalysis();
          } else if (nextState === "documentacao") {
            showDocuments();
          } else if (nextState === "avaliacao") {
            showAssessment();
          } else if (nextState === "conclusao") {
            showConclusion();
          }
        }
      }

      // SISTEMA DE DIÁLOGOS
      function showDialogue() {
        if (currentDialogue >= dialogues.length) {
          document.getElementById("next-dialogue").style.display = "block";
          return;
        }

        const dialogue = dialogues[currentDialogue];
        document.getElementById("dialogue-question").textContent =
          dialogue.question;

        const optionsContainer = document.getElementById("dialogue-options");
        optionsContainer.innerHTML = "";

        dialogue.options.forEach((option, index) => {
          const div = document.createElement("div");
          div.className = "dialogue-option";
          div.textContent = option.text;
          div.onclick = () => selectDialogueOption(option);
          optionsContainer.appendChild(div);
        });
      }

      function selectDialogueOption(option) {
        // Remover seleção anterior
        document
          .querySelectorAll(".dialogue-option")
          .forEach((el) => el.classList.remove("selected"));
        event.target.classList.add("selected");

        // Use new weighted scoring system
        const dialogue = dialogues[currentDialogue];
        const optionIndex = dialogue.options.indexOf(option);
        const rawScores = { empathy: option.empathy, info: option.info };

        // Calculate weighted scores with proper limits
        const weightedScores = ScoringSystem.calculateWeightedResponse(
          dialogue.id,
          optionIndex,
          rawScores
        );

        // Update metrics with capping
        const updatedMetrics = ScoringSystem.updateDialogueMetrics(
          gameState,
          weightedScores
        );

        // Add to total score with proper limits
        addScore(weightedScores.totalPoints);

        // Show quality feedback
        showToast(
          updatedMetrics.qualityFeedback,
          weightedScores.quality === "excellent"
            ? "success"
            : weightedScores.quality === "poor"
            ? "warning"
            : "info"
        );

        updateDialogueMetrics();

        // Próximo diálogo após 1 segundo
        setTimeout(() => {
          currentDialogue++;
          showDialogue();
        }, 1000);
      }

      function updateDialogueMetrics() {
        // Apply proper limits and display
        document.getElementById("empathy").textContent =
          ScoringSystem.applyLimit("empathy", gameState.empathy);
        document.getElementById("information").textContent = Math.round(
          (ScoringSystem.applyLimit("information", gameState.information) /
            SCORING_LIMITS.information.max) *
            100
        );
        document.getElementById("interactions").textContent =
          ScoringSystem.applyLimit("interactions", gameState.interactions);
      }

      // SISTEMA DE ANÁLISE
      function showAnalysis() {
        const pool = document.getElementById("elements-pool");

        analysisElements.forEach((element) => {
          const div = document.createElement("div");
          div.className = "drag-item";
          div.draggable = true;
          div.textContent = element.text;
          div.dataset.id = element.id;
          div.dataset.category = element.category;
          div.dataset.points = element.points;
          div.ondragstart = drag;
          pool.appendChild(div);
        });
      }

      function allowDrop(ev) {
        ev.preventDefault();
        ev.target.classList.add("drag-over");
      }

      function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.dataset.id);
      }

      function drop(ev) {
        ev.preventDefault();
        ev.target.classList.remove("drag-over");

        const elementId = ev.dataTransfer.getData("text");
        const element = document.querySelector(`[data-id="${elementId}"]`);
        const correctCategory = element.dataset.category;
        const points = parseInt(element.dataset.points);

        let isCorrect = false;
        if (ev.target.id === "risk-zone" && correctCategory === "risk") {
          isCorrect = true;
        } else if (
          ev.target.id === "protection-zone" &&
          correctCategory === "protection"
        ) {
          isCorrect = true;
        }

        if (isCorrect) {
          addScore(points);
          element.style.background = "#c8e6c9";
          ev.target.classList.add("correct");
        } else {
          element.style.background = "#ffcdd2";
          ev.target.classList.add("incorrect");
          setTimeout(() => ev.target.classList.remove("incorrect"), 500);
        }

        ev.target.appendChild(element);
        element.classList.add("placed");
        gameState.categorized++;

        updateAnalysisMetrics();

        if (gameState.categorized >= 6) {
          document.getElementById("next-analysis").style.display = "block";
        }
      }

      // MOBILE TOUCH FUNCTIONALITY
      let selectedElement = null;
      let isMobileMode = false;

      // Detect if device is touch-enabled
      function isTouchDevice() {
        return "ontouchstart" in window || navigator.maxTouchPoints > 0;
      }

      function toggleMobileMode() {
        isMobileMode = !isMobileMode;
        const modeText = document.getElementById("mode-text");
        const button = document.querySelector(".mobile-mode-button");

        if (isMobileMode) {
          modeText.textContent = "Modo Arrastar";
          button.style.background = "linear-gradient(135deg, #4caf50, #45a049)";
          enableTouchMode();
        } else {
          modeText.textContent = "Modo Toque";
          button.style.background = "linear-gradient(135deg, #ff9800, #f57c00)";
          disableTouchMode();
        }
      }

      function enableTouchMode() {
        // Add click handlers to elements
        const elements = document.querySelectorAll(".drag-item:not(.placed)");
        elements.forEach((element) => {
          element.onclick = handleElementClick;
          element.style.cursor = "pointer";
        });

        // Update zone text
        document.querySelector("#risk-zone p").textContent =
          "Toque aqui após selecionar um elemento";
        document.querySelector("#protection-zone p").textContent =
          "Toque aqui após selecionar um elemento";
      }

      function disableTouchMode() {
        // Remove click handlers
        const elements = document.querySelectorAll(".drag-item");
        elements.forEach((element) => {
          element.onclick = null;
          element.style.cursor = "grab";
        });

        // Reset zone text
        document.querySelector("#risk-zone p").textContent =
          "Arraste fatores de risco aqui";
        document.querySelector("#protection-zone p").textContent =
          "Arraste fatores de proteção aqui";

        // Clear selection
        if (selectedElement) {
          selectedElement.classList.remove("selected");
          selectedElement = null;
        }
      }

      function handleElementClick(event) {
        if (!isMobileMode || event.target.classList.contains("placed")) return;

        // Clear previous selection
        if (selectedElement) {
          selectedElement.classList.remove("selected");
        }

        // Select new element
        selectedElement = event.target;
        selectedElement.classList.add("selected");

        // Provide feedback
        const zones = document.querySelectorAll(".drop-zone");
        zones.forEach((zone) => zone.classList.add("active"));

        // Show instruction
        showToast("Agora toque numa zona para colocar o elemento", "info");
      }

      function handleZoneClick(zoneType) {
        if (!isMobileMode || !selectedElement) return;

        const elementId = selectedElement.dataset.id;
        const correctCategory = selectedElement.dataset.category;
        const points = parseInt(selectedElement.dataset.points);

        let isCorrect = false;
        let targetZone = null;

        if (zoneType === "risk" && correctCategory === "risk") {
          isCorrect = true;
          targetZone = document.getElementById("risk-zone");
        } else if (
          zoneType === "protection" &&
          correctCategory === "protection"
        ) {
          isCorrect = true;
          targetZone = document.getElementById("protection-zone");
        } else {
          targetZone = document.getElementById(zoneType + "-zone");
        }

        // Visual feedback
        if (isCorrect) {
          addScore(points);
          selectedElement.style.background = "#c8e6c9";
          targetZone.classList.add("correct");
          showToast("Correto! +" + points + " pontos", "success");
        } else {
          selectedElement.style.background = "#ffcdd2";
          targetZone.classList.add("incorrect");
          setTimeout(() => targetZone.classList.remove("incorrect"), 500);
          showToast("Incorreto. Tente novamente!", "error");
        }

        // Move element
        targetZone.appendChild(selectedElement);
        selectedElement.classList.add("placed");
        selectedElement.classList.remove("selected");

        // Clear selection and active states
        selectedElement = null;
        const zones = document.querySelectorAll(".drop-zone");
        zones.forEach((zone) => zone.classList.remove("active"));

        gameState.categorized++;
        updateAnalysisMetrics();

        if (gameState.categorized >= 6) {
          document.getElementById("next-analysis").style.display = "block";
        }
      }

      // Toast notification system
      function showToast(message, type = "info") {
        // Remove existing toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: ${
            type === "success"
              ? "#4caf50"
              : type === "error"
              ? "#f44336"
              : "#2196f3"
          };
          color: white;
          padding: 12px 24px;
          border-radius: 25px;
          font-weight: 600;
          font-size: 14px;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          backdrop-filter: blur(10px);
          animation: slideDown 0.3s ease;
        `;

        document.body.appendChild(toast);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.animation = "slideUp 0.3s ease";
            setTimeout(() => toast.remove(), 300);
          }
        }, 3000);
      }

      // Add CSS animations for toast
      if (!document.querySelector("#toast-animations")) {
        const style = document.createElement("style");
        style.id = "toast-animations";
        style.textContent = `
          @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
          }
          @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }

      // Auto-enable mobile mode on touch devices
      document.addEventListener("DOMContentLoaded", function () {
        if (isTouchDevice()) {
          // Auto-enable mobile mode for touch devices
          setTimeout(() => {
            if (
              document
                .getElementById("state-analise")
                .classList.contains("active")
            ) {
              toggleMobileMode();
            }
          }, 1000);
        }
      });

      function updateAnalysisMetrics() {
        document.getElementById("categorized").textContent =
          gameState.categorized;
        const accuracy = Math.round((gameState.categorized / 6) * 100);
        document.getElementById("accuracy").textContent = accuracy;
      }

      // SISTEMA DE DOCUMENTAÇÃO
      function showDocuments() {
        const container = document.getElementById("documents-list");

        documents.forEach((doc) => {
          const div = document.createElement("div");
          div.className = "document-item";
          div.innerHTML = `
                    <h4>${doc.name} ${
            doc.mandatory ? "(Obrigatório)" : "(Opcional)"
          }</h4>
                    <p>Disponível: ${doc.available ? "Sim" : "Não"}</p>
                    <button class="btn" onclick="processDocument('${doc.id}', ${
            doc.available
          }, ${doc.mandatory}, ${doc.points})">
                        ${doc.available ? "Recolher" : "Solicitar"}
                    </button>
                `;
          container.appendChild(div);
        });
      }

      function processDocument(id, available, mandatory, points) {
        if (mandatory) {
          gameState.docsIdentified++;
          addScore(points);
        }

        event.target.disabled = true;
        event.target.textContent = available ? "Recolhido" : "Solicitado";
        event.target.style.background = "#4CAF50";

        updateDocumentMetrics();

        if (gameState.docsIdentified >= 3) {
          document.getElementById("next-docs").style.display = "block";
        }
      }

      function updateDocumentMetrics() {
        document.getElementById("docs-identified").textContent =
          gameState.docsIdentified;
        const efficiency = Math.round((gameState.docsIdentified / 3) * 100);
        document.getElementById("efficiency").textContent = efficiency;
      }

      // SISTEMA DE AVALIAÇÃO
      function showAssessment() {
        // Generate and display corrected DLD criteria using assessment logic
        const dldCriteria = AssessmentLogic.generateDLDCriteria();
        const criteriaDisplay = document.getElementById("dld-criteria-display");

        criteriaDisplay.innerHTML = `
          <h4>Critérios DLD:</h4>
          <p>${dldCriteria.unemployment.status} ${dldCriteria.unemployment.text}</p>
          <p>${dldCriteria.age.status} ${dldCriteria.age.text}</p>
          <p>${dldCriteria.education.status} ${dldCriteria.education.text}</p>
          <p style="margin-left: 20px; font-size: 0.9em; color: #666;"><em>Nota: ${dldCriteria.education.context}</em></p>
          <p>${dldCriteria.benefits.status} ${dldCriteria.benefits.text}</p>
          <p>${dldCriteria.emotional.status} ${dldCriteria.emotional.text}</p>
          <p>${dldCriteria.experience.status} ${dldCriteria.experience.text}</p>
        `;
      }

      function selectAvailability(choice) {
        document
          .querySelectorAll("#availability-options .dialogue-option")
          .forEach((el) => el.classList.remove("selected"));
        event.target.classList.add("selected");

        gameState.availability = choice;

        // Use new assessment logic for proper evaluation and feedback
        const evaluation = AssessmentLogic.evaluateResponse(
          "availability",
          choice
        );
        addScore(evaluation.points);

        // Show detailed feedback with justification and scoring
        const scoreDisplay =
          evaluation.points > 0 ? `+${evaluation.points}` : evaluation.points;
        showToast(
          `${evaluation.quality.toUpperCase()}: ${
            evaluation.justification
          } (${scoreDisplay} pontos)`,
          evaluation.quality === "excellent"
            ? "success"
            : evaluation.quality === "poor"
            ? "warning"
            : "info",
          6000
        );

        // Show additional gamification feedback
        if (evaluation.quality === "excellent") {
          setTimeout(() => {
            showToast(
              `🎉 EXCELENTE ESCOLHA! Máxima pontuação para disponibilidade`,
              "success",
              4000
            );
          }, 2000);
        } else if (evaluation.quality === "poor") {
          setTimeout(() => {
            showToast(
              `⚠️ ATENÇÃO: Escolha conservadora pode limitar oportunidades de inserção`,
              "warning",
              5000
            );
          }, 2000);
        }

        // Reset capacity selection and validate combinations
        resetCapacitySelection();
        updateCapacityOptions(choice);
        document.getElementById("capacity-section").style.display = "block";
      }

      function selectCapacity(choice) {
        // Validate the combination before proceeding
        const validationResult = validateAssessmentCombination(
          gameState.availability,
          choice
        );

        if (!validationResult.valid) {
          // Calculate what the score WOULD have been for educational purposes
          const hypotheticalEvaluation = AssessmentLogic.evaluateResponse(
            "capacity",
            choice
          );
          const scorePenalty = Math.floor(hypotheticalEvaluation.points * 0.5); // 50% penalty for invalid combinations

          // Apply penalty for poor decision-making
          addScore(-scorePenalty);

          // Show comprehensive feedback with scoring impact
          showToast(
            `⚠️ COMBINAÇÃO INADEQUADA: ${validationResult.reason}`,
            "warning",
            8000
          );

          // Show scoring impact
          setTimeout(() => {
            showToast(
              `📉 PENALIZAÇÃO: -${scorePenalty} pontos por escolha inconsistente`,
              "error",
              6000
            );
          }, 1500);

          // Provide educational feedback
          setTimeout(() => {
            showToast(
              `💡 SUGESTÃO: ${validationResult.suggestion}`,
              "info",
              8000
            );
          }, 3000);

          // Also show what the correct score would have been
          setTimeout(() => {
            const correctChoice = getOptimalCapacityChoice(
              gameState.availability
            );
            const correctEvaluation = AssessmentLogic.evaluateResponse(
              "capacity",
              correctChoice
            );
            showToast(
              `🎯 ESCOLHA IDEAL: "${getChoiceDisplayName(correctChoice)}" (+${
                correctEvaluation.points
              } pontos)`,
              "info",
              6000
            );
          }, 4500);

          return; // Don't proceed with invalid selection
        }

        document
          .querySelectorAll("#capacity-options .dialogue-option")
          .forEach((el) => el.classList.remove("selected"));
        event.target.classList.add("selected");

        gameState.capacity = choice;

        // Use new assessment logic for proper evaluation and feedback
        const evaluation = AssessmentLogic.evaluateResponse("capacity", choice);
        addScore(evaluation.points);

        // Show detailed feedback with justification and scoring
        const scoreDisplay =
          evaluation.points > 0 ? `+${evaluation.points}` : evaluation.points;
        showToast(
          `${evaluation.quality.toUpperCase()}: ${
            evaluation.justification
          } (${scoreDisplay} pontos)`,
          evaluation.quality === "excellent"
            ? "success"
            : evaluation.quality === "poor"
            ? "warning"
            : "info",
          6000
        );

        // Show additional gamification feedback for capacity
        if (evaluation.quality === "excellent") {
          setTimeout(() => {
            showToast(
              `🏆 DECISÃO PERFEITA! Combinação otimizada para o perfil da Felisbina`,
              "success",
              4000
            );
          }, 2000);
        } else if (evaluation.quality === "adequate") {
          setTimeout(() => {
            showToast(
              `✅ ESCOLHA VÁLIDA, mas pode haver opções mais otimizadas`,
              "info",
              4000
            );
          }, 2000);
        }

        // Generate comprehensive assessment report for learning
        const fullReport = AssessmentLogic.generateAssessmentReport({
          availability: gameState.availability,
          capacity: gameState.capacity,
        });

        // Store assessment report for conclusion display
        gameState.assessmentReport = fullReport;

        document.getElementById("finalize-assessment").style.display = "block";
      }

      // CONCLUSÃO
      function showConclusion() {
        // Calculate final score using new scoring system
        const finalScore = ScoringSystem.calculatePhase1Score(gameState);
        gameState.score = finalScore;

        // Generate comprehensive performance report
        const performanceReport =
          ScoringSystem.generatePerformanceReport(gameState);

        document.getElementById("final-score").textContent =
          performanceReport.totalScore;
        document.getElementById("final-level").textContent =
          performanceReport.level.title;

        const report = document.getElementById("final-report");
        report.innerHTML = `
                <h3>Relatório de Performance Detalhado:</h3>
                
                <div style="background: ${
                  performanceReport.level.color
                }20; padding: 15px; border-radius: 8px; margin: 10px 0;">
                  <h4 style="color: ${
                    performanceReport.level.color
                  }; margin: 0;">
                    ${performanceReport.level.title}
                  </h4>
                  <p style="margin: 5px 0;"><em>${
                    performanceReport.level.description
                  }</em></p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                  <div>
                    <h4>📊 Métricas Principais:</h4>
                    <p><strong>Empatia:</strong> ${
                      performanceReport.metrics.empathy.score
                    }/${performanceReport.metrics.empathy.max} (${
          performanceReport.metrics.empathy.percentage
        }%)</p>
                    <p><strong>Informação:</strong> ${
                      performanceReport.metrics.information.score
                    }/${performanceReport.metrics.information.max} (${
          performanceReport.metrics.information.percentage
        }%)</p>
                    <p><strong>Interações:</strong> ${
                      performanceReport.metrics.interactions.score
                    }/${performanceReport.metrics.interactions.max} (${
          performanceReport.metrics.interactions.percentage
        }%)</p>
                  </div>
                  
                  <div>
                    <h4>🎯 Atividades:</h4>
                    <p><strong>Elementos Categorizados:</strong> ${
                      gameState.categorized
                    }/6</p>
                    <p><strong>Documentos Identificados:</strong> ${
                      gameState.docsIdentified
                    }/3</p>
                    <p><strong>Avaliação DLD:</strong> ${
                      gameState.availability && gameState.capacity
                        ? "Completa"
                        : "Incompleta"
                    }</p>
                  </div>
                </div>

                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                  <h4>💡 Recomendações de Melhoria:</h4>
                  ${
                    performanceReport.recommendations.length > 0
                      ? performanceReport.recommendations
                          .map(
                            (rec) =>
                              `<p style="margin: 5px 0;"><strong>${rec.area}:</strong> ${rec.suggestion}</p>`
                          )
                          .join("")
                      : "<p>Excelente trabalho! Continue a praticar para manter o nível.</p>"
                  }
                </div>

                 

                 ${
                   gameState.assessmentReport
                     ? `
                   <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                     <h4>📋 Avaliação DLD Detalhada:</h4>
                     <p><strong>Disponibilidade:</strong> ${
                       gameState.assessmentReport.availability.justification
                     }</p>
                     <p><strong>Capacidade:</strong> ${
                       gameState.assessmentReport.capacity.justification
                     }</p>
                     <p><strong>Recomendação Final:</strong> ${
                       gameState.assessmentReport.overall.recommendation
                     }</p>
                     <p><strong>Qualidade Geral:</strong> ${gameState.assessmentReport.overall.quality.toUpperCase()} (${
                         gameState.assessmentReport.overall.percentage
                       }%)</p>
                   </div>
                 `
                     : ""
                 }
            `;
      }

      function restartGame() {
        location.reload();
      }

      // Função para atualizar pontuação com limite usando scoring system
      function addScore(points) {
        gameState.score = ScoringSystem.applyLimit(
          "phase1_total",
          gameState.score + points
        );
        document.getElementById("score").textContent = gameState.score;
      }

      // Toast System
      function showToast(message, type = "info", duration = 5000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
          ${message}
          <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      function continueToPhase2() {
        // Verificar se pontuação é suficiente
        if (gameState.score < 70) {
          showToast(
            "⚠️ Precisa de pelo menos 70 pontos para desbloquear a Fase 2.<br>Pontuação atual: " +
              gameState.score,
            "warning",
            6000
          );
          return;
        }

        // Generate comprehensive phase 1 data using new scoring system
        const performanceReport =
          ScoringSystem.generatePerformanceReport(gameState);

        const phase1Data = {
          phase: 1,
          score: performanceReport.totalScore,
          maxScore: performanceReport.maxScore,
          percentage: performanceReport.percentage,
          duration: Math.round((Date.now() - gameStartTime) / 60000) || 15,
          level: performanceReport.level,
          achievements: [],

          // Detailed metrics from new scoring system
          metrics: performanceReport.metrics,
          validation: performanceReport.validation,
          recommendations: performanceReport.recommendations,

          // Enhanced task reports with weighted scoring
          taskReports: {
            conversa_inicial: {
              completed: true,
              score: performanceReport.metrics.empathy.score,
              percentage: performanceReport.metrics.empathy.percentage,
              quality: "Scored using weighted response system",
            },
            analise_perfil: {
              completed: gameState.categorized >= 6,
              score: gameState.categorized * 5,
              accuracy: Math.round((gameState.categorized / 6) * 100),
              feedback:
                gameState.categorized >= 6
                  ? "Análise completa"
                  : "Análise incompleta",
            },
            documentacao: {
              completed: gameState.docsIdentified >= 3,
              score: gameState.docsIdentified * 5,
              efficiency: Math.round((gameState.docsIdentified / 3) * 100),
              feedback:
                gameState.docsIdentified >= 3
                  ? "Documentação adequada"
                  : "Documentação incompleta",
            },
            avaliacao_final: {
              completed: gameState.availability && gameState.capacity,
              score: ScoringSystem.calculateAssessmentScore(gameState) * 100,
              availability: gameState.availability,
              capacity: gameState.capacity,
              decision_quality:
                ScoringSystem.calculateAssessmentScore(gameState) >= 0.8
                  ? "Excelente"
                  : ScoringSystem.calculateAssessmentScore(gameState) >= 0.6
                  ? "Boa"
                  : "Adequada",
            },
          },

          nextSteps:
            gameState.availability === "sim_total" &&
            gameState.capacity === "sim_formacao"
              ? "Encaminhamento para IEFP com formação profissional"
              : gameState.availability !== "nao" && gameState.capacity !== "nao"
              ? "Encaminhamento para IEFP aprovado"
              : "Apoio adicional necessário antes do encaminhamento",

          // Enhanced Felisbina data with contextual analysis using case data
          felisbinaData: {
            ...FELISBINA_CASE_DATA.personal,
            ...FELISBINA_CASE_DATA.benefits.rsi,
            beneficios: "RSI (desde Março 2025) + PSI",
            experiencia_profissional:
              FELISBINA_CASE_DATA.work_experience.empregada_limpeza.duracao +
              " como empregada de limpeza",
            situacao_dld: determineDLDStatus(gameState),

            // Contextual education assessment
            educacao_contextual: {
              nivel: FELISBINA_CASE_DATA.education.nivel,
              adequacao: "9º ano completo",
              contexto:
                FELISBINA_CASE_DATA.education.contexto_historico
                  .contexto_social,
              avaliacao_moderna: "Ensino básico completo",
            },

            // Analysis results from Phase 1 with proper context
            problemas_identificados:
              FELISBINA_CASE_DATA.dld_analysis.fatores_risco.map(
                (r) => r.fator
              ),
            fatores_protecao:
              FELISBINA_CASE_DATA.dld_analysis.fatores_protecao.map(
                (p) => p.fator
              ),

            // DLD assessment results
            avaliacao_dld: gameState.assessmentReport
              ? {
                  disponibilidade: {
                    decisao: gameState.availability,
                    justificacao:
                      gameState.assessmentReport.availability.justification,
                    qualidade: gameState.assessmentReport.availability.quality,
                  },
                  capacidade: {
                    decisao: gameState.capacity,
                    justificacao:
                      gameState.assessmentReport.capacity.justification,
                    qualidade: gameState.assessmentReport.capacity.quality,
                  },
                  recomendacao_final:
                    gameState.assessmentReport.overall.recommendation,
                  qualidade_geral: gameState.assessmentReport.overall.quality,
                }
              : null,

            // Empathy and communication assessment
            relacao_tecnico: {
              empatia_estabelecida:
                performanceReport.metrics.empathy.percentage >= 60,
              comunicacao_eficaz:
                performanceReport.metrics.information.percentage >= 60,
              confianca_construida:
                performanceReport.metrics.interactions.percentage >= 80,
              contexto_adequado:
                FelisbinaCaseUtils.calculateDLDBalance().assessment ===
                "favorable",
            },
          },
        };

        // Salvar no localStorage
        localStorage.setItem(
          "saasi_phase1_results",
          JSON.stringify(phase1Data)
        );

        // Redirecionar para a página da Fase 2
        window.location.href = "fase2.html";
      }

      // Função para determinar status DLD baseado nas decisões
      function determineDLDStatus(gameState) {
        if (!gameState.availability || !gameState.capacity) {
          return "Avaliação incompleta";
        }

        const hasAvailability = gameState.availability !== "nao";
        const hasCapacity = gameState.capacity !== "nao";

        if (hasAvailability && hasCapacity) {
          return "Disponível e com capacidade para trabalhar";
        } else if (hasAvailability && !hasCapacity) {
          return "Disponível mas necessita desenvolvimento de capacidades";
        } else if (!hasAvailability && hasCapacity) {
          return "Com capacidade mas temporariamente indisponível";
        } else {
          return "Necessita apoio antes de integração laboral";
        }
      }

      // VALIDATION FUNCTIONS FOR ASSESSMENT LOGIC

      /**
       * Validate assessment combination based on Felisbina's case profile
       * @param {string} availability - Selected availability option
       * @param {string} capacity - Selected capacity option
       * @returns {Object} Validation result with educational feedback
       */
      function validateAssessmentCombination(availability, capacity) {
        // Felisbina's profile constraints: 56 anos, dependência emocional, experiência limitada (6 meses)

        // Define invalid combinations based on case analysis
        const invalidCombinations = [
          {
            availability: "sim_total",
            capacity: "sim_plena",
            reason:
              "Com dependência emocional e experiência limitada, 'capacidade plena' não é realista",
            suggestion:
              "Considere 'Capacidade com formação' - reconhece potencial mas identifica necessidade de desenvolvimento",
          },
          {
            availability: "nao",
            capacity: "sim_plena",
            reason:
              "Contradição: se não tem disponibilidade, não faz sentido ter capacidade plena",
            suggestion:
              "Se não está disponível, a capacidade também deve ser limitada ou condicionada",
          },
          {
            availability: "nao",
            capacity: "sim_formacao",
            reason:
              "Incoerência: sem disponibilidade mas com capacidade para formação",
            suggestion:
              "Seja consistente: indisponibilidade implica incapacidade temporária",
          },
        ];

        // Check for specific invalid combination
        const invalidMatch = invalidCombinations.find(
          (combo) =>
            combo.availability === availability && combo.capacity === capacity
        );

        if (invalidMatch) {
          return {
            valid: false,
            reason: invalidMatch.reason,
            suggestion: invalidMatch.suggestion,
            educational_note:
              "Baseado no perfil da Felisbina: 56 anos, dependência emocional, experiência limitada",
          };
        }

        return { valid: true };
      }

      /**
       * Reset capacity selection when availability changes
       */
      function resetCapacitySelection() {
        gameState.capacity = null;
        document
          .querySelectorAll("#capacity-options .dialogue-option")
          .forEach((el) => el.classList.remove("selected"));

        // Hide finalize button until new capacity is selected
        document.getElementById("finalize-assessment").style.display = "none";
      }

      /**
       * Update capacity options styling based on availability choice
       * @param {string} availability - Selected availability option
       */
      function updateCapacityOptions(availability) {
        const capacityOptions = document.querySelectorAll(
          "#capacity-options .dialogue-option"
        );

        // Reset all options
        capacityOptions.forEach((option) => {
          option.style.opacity = "1";
          option.style.pointerEvents = "auto";
          option.title = "";
        });

        // Add visual hints for problematic combinations
        if (availability === "sim_total") {
          const plenaOption = document.querySelector(
            "[onclick=\"selectCapacity('sim_plena')\"]"
          );
          if (plenaOption) {
            plenaOption.style.opacity = "0.6";
            plenaOption.title =
              "⚠️ Combinação não recomendada para o perfil da Felisbina";
          }
        }

        if (availability === "nao") {
          const formacaoOption = document.querySelector(
            "[onclick=\"selectCapacity('sim_formacao')\"]"
          );
          const plenaOption = document.querySelector(
            "[onclick=\"selectCapacity('sim_plena')\"]"
          );

          [formacaoOption, plenaOption].forEach((option) => {
            if (option) {
              option.style.opacity = "0.6";
              option.title = "⚠️ Incoerente com indisponibilidade";
            }
          });
        }
      }

      /**
       * Get optimal capacity choice based on availability selection
       * @param {string} availability - Selected availability option
       * @returns {string} Optimal capacity choice
       */
      function getOptimalCapacityChoice(availability) {
        // Based on Felisbina's profile analysis and scoring system
        switch (availability) {
          case "sim_total":
          case "sim_condicionada":
            return "sim_formacao"; // Best choice: recognizes experience + need for development
          case "nao":
            return "nao"; // Consistent choice: no availability = no capacity
          default:
            return "sim_formacao";
        }
      }

      /**
       * Get display name for choice codes
       * @param {string} choice - Choice code
       * @returns {string} Display name
       */
      function getChoiceDisplayName(choice) {
        const displayNames = {
          sim_total: "SIM - Disponibilidade total",
          sim_condicionada: "SIM - Disponibilidade condicionada",
          sim_plena: "SIM - Capacidade plena",
          sim_formacao: "SIM - Capacidade com formação",
          nao: "NÃO - Indisponível/Incapacidade temporária",
        };
        return displayNames[choice] || choice;
      }

      // Variável para tracking do tempo
      let gameStartTime = Date.now();

      // Test scoring system on load (development only)
      if (
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
      ) {
        console.log("🧪 Running scoring system tests...");
        ScoringSystemTests.runAllTests();
      }

      // Inicializar
      updateProgress();
    </script>
  </body>
</html>
