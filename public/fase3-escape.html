<!DOCTYPE html>
<html lang="pt-PT">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAASI Escape Room - Fase 3: Plano de Interven√ß√£o</title>
    <style>
      /* ===== TOAST SYSTEM - COPIED FROM FASE1-ESCAPE.HTML ===== */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
      }

      .toast {
        background: #333;
        color: white;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        position: relative;
        padding-right: 50px;
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.success {
        background: #28a745;
        border-left: 4px solid #1e7e34;
      }

      .toast.error {
        background: #dc3545;
        border-left: 4px solid #c82333;
      }

      .toast.warning {
        background: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
      }

      .toast.info {
        background: #17a2b8;
        border-left: 4px solid #138496;
      }

      .toast-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* ===== BASE STYLES - FOLLOWING FASE1-ESCAPE.HTML PATTERN ===== */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
      }

      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(108, 117, 125, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        z-index: 1000;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .back-button:hover {
        background: rgba(84, 91, 98, 0.95);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .score {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(51, 51, 51, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: rgba(245, 245, 245, 0.8);
        backdrop-filter: blur(5px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      .progress-bar {
        background: #e0e0e0;
        height: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .progress-fill {
        background: #4caf50;
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s;
        width: 0%;
      }

      .state {
        display: none;
        padding: 30px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .state.active {
        display: block;
        animation: slideIn 0.5s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        margin: 8px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* ===== PUZZLE 1: ENHANCED PROGRAM SELECTION MATRIX ===== */
      .program-selection-matrix {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 30px;
        margin: 20px 0;
      }

      .felisbina-profile-panel {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 20px;
        height: fit-content;
        position: sticky;
        top: 20px;
      }

      .profile-attributes {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
      }

      .attribute {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .attr-label {
        font-weight: 600;
        color: #495057;
        display: block;
      }

      .attr-value {
        color: #2c3e50;
        font-size: 1.1rem;
        margin: 5px 0;
      }

      .compatibility-indicator {
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 8px;
      }

      .compatibility-indicator:contains("‚úÖ") {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .compatibility-indicator:contains("‚ö†Ô∏è") {
        background: #fff3e0;
        color: #f57c00;
      }

      .programs-evaluation-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .program-card {
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 25px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .program-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
      }

      .program-card.selected {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .program-card.rejected {
        border-color: #f44336;
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        opacity: 0.7;
      }

      .program-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .program-icon {
        font-size: 2rem;
        margin-right: 15px;
      }

      .program-title {
        flex: 1;
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
      }

      .adequacy-meter {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }

      .meter-fill {
        width: 100px;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
      }

      .meter-fill::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background: linear-gradient(90deg, #f44336, #ff9800, #4caf50);
        border-radius: 4px;
        width: var(--adequacy-width);
        transition: width 0.5s ease;
      }

      .meter-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #495057;
      }

      .compatibility-analysis {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin: 15px 0;
      }

      .requirement {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .requirement.met {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .requirement.warning {
        background: #fff3e0;
        color: #f57c00;
      }

      .requirement.not-met {
        background: #ffebee;
        color: #c62828;
      }

      .req-icon {
        font-size: 1rem;
      }

      .program-impact-preview {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
      }

      .impact-metrics {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
      }

      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .metric-label {
        font-size: 0.9rem;
        color: #495057;
      }

      .metric-bar {
        flex: 1;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        margin: 0 10px;
        position: relative;
        overflow: hidden;
      }

      .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #66bb6a);
        border-radius: 3px;
        color: white;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 5px;
        font-weight: 600;
      }

      .selection-controls {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .btn-select-program,
      .btn-reject-program {
        flex: 1;
        padding: 10px 15px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-select-program {
        background: #4caf50;
        color: white;
      }

      .btn-select-program:hover {
        background: #45a049;
        transform: translateY(-1px);
      }

      .btn-reject-program {
        background: #f44336;
        color: white;
      }

      .btn-reject-program:hover {
        background: #da190b;
        transform: translateY(-1px);
      }

      .selection-summary {
        grid-column: 1 / -1;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
      }

      .selected-programs-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
      }

      .selected-program-badge {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .selection-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .selection-metrics .metric {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }

      .selection-metrics .label {
        display: block;
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
      }

      .selection-metrics .value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
      }

      /* ===== PUZZLE 2: DYNAMIC ENTITY COORDINATION HUB ===== */
      .entity-coordination-hub {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
      }

      .coordination-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .coordination-metrics {
        display: flex;
        justify-content: space-around;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
      }

      .coordination-metrics .metric {
        text-align: center;
      }

      .coordination-metrics .label {
        display: block;
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
      }

      .coordination-metrics .value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
      }

      .entity-network-visualization {
        position: relative;
        background: radial-gradient(circle at center, #f8f9fa, #e9ecef);
        border-radius: 15px;
        padding: 40px;
        margin: 30px 0;
        min-height: 500px;
        overflow: hidden;
      }

      .network-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .felisbina-node {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .node-avatar {
        font-size: 2rem;
        margin-bottom: 5px;
      }

      .node-label {
        font-size: 0.9rem;
        text-align: center;
      }

      .entity-nodes {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .entity-node {
        position: absolute;
        width: 180px;
        background: white;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all 0.3s ease;
        transform: translate(-50%, -50%);
      }

      .entity-node:hover {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: #4caf50;
      }

      .entity-node.contacted {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .entity-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #17a2b8, #138496);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        margin-bottom: 10px;
      }

      .entity-status {
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 600;
        margin: 5px 0;
      }

      .entity-status.offline {
        background: #fff3e0;
        color: #f57c00;
      }

      .entity-status.online {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .services-list {
        display: flex;
        flex-wrap: wrap;
        gap: 3px;
        margin: 8px 0;
      }

      .service {
        background: #e3f2fd;
        color: #1565c0;
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.7rem;
      }

      .btn-contact-entity {
        width: 100%;
        padding: 8px 12px;
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 8px;
      }

      .btn-contact-entity:hover {
        background: #138496;
        transform: translateY(-1px);
      }

      .btn-contact-entity:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .connection-line {
        position: absolute;
        background: #4caf50;
        height: 3px;
        border-radius: 2px;
        transform-origin: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
      }

      .connection-line.active {
        opacity: 1;
        animation: pulse 2s infinite;
      }

      .coordination-timeline {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
      }

      .timeline-visualization {
        margin-top: 15px;
      }

      .timeline-track {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #667eea;
      }

      .track-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .entity-name {
        font-weight: 600;
        color: #2c3e50;
      }

      .track-status {
        font-size: 0.8rem;
        color: #6c757d;
      }

      .timeline-events {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .timeline-event {
        background: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        border: 1px solid #dee2e6;
      }

      /* ===== PUZZLE 3: ADVANCED TIMELINE ORCHESTRATOR ===== */
      .timeline-orchestrator {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
      }

      .orchestration-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .timeline-tools {
        display: flex;
        gap: 10px;
      }

      .tool-btn {
        padding: 10px 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .tool-btn:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      .timeline-workspace {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 30px;
      }

      .activities-palette {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        max-height: 600px;
        overflow-y: auto;
      }

      .activity-categories {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .category {
        border-radius: 10px;
        overflow: hidden;
      }

      .category h5 {
        background: #667eea;
        color: white;
        margin: 0;
        padding: 12px 15px;
        font-size: 0.9rem;
      }

      .activities-list {
        background: white;
        padding: 15px;
      }

      .activity-item {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        padding: 12px;
        margin: 8px 0;
        border: 2px solid transparent;
        cursor: grab;
        transition: all 0.3s ease;
        user-select: none;
      }

      .activity-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .activity-item.dragging {
        opacity: 0.8;
        transform: scale(1.05);
        cursor: grabbing;
      }

      .activity-item.placed {
        opacity: 0.5;
        pointer-events: none;
      }

      .activity-icon {
        font-size: 1.2rem;
        margin-right: 8px;
      }

      .activity-info h6 {
        margin: 0 0 5px 0;
        font-size: 0.9rem;
        color: #2c3e50;
      }

      .activity-metadata {
        display: flex;
        gap: 8px;
        font-size: 0.7rem;
        color: #6c757d;
      }

      .duration,
      .frequency,
      .priority {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
      }

      .priority.high {
        background: #ffebee;
        color: #c62828;
      }

      .timeline-canvas-advanced {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
      }

      .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .month-labels {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 15px;
        margin-bottom: 15px;
      }

      .month-label {
        text-align: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .month-name {
        font-weight: 600;
        color: #2c3e50;
        display: block;
        margin-bottom: 5px;
      }

      .month-capacity {
        font-size: 0.8rem;
        color: #6c757d;
      }

      .timeline-grid-advanced {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .timeline-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 15px;
        align-items: stretch;
      }

      .row-header {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .entity-info {
        text-align: center;
      }

      .entity-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .availability-indicator {
        font-size: 0.8rem;
        color: #6c757d;
      }

      .available-slots {
        font-weight: 600;
        color: #4caf50;
      }

      .timeline-slots {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
      }

      .time-slot {
        background: rgba(255, 255, 255, 0.8);
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 10px;
        min-height: 60px;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .time-slot.drop-target {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .time-slot.occupied {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .placed-activity {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 5px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
      }

      .timeline-analysis {
        grid-column: 1 / -1;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
      }

      .analysis-panels {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 15px;
      }

      .panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
      }

      .panel h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-size: 1rem;
      }

      .conflicts-list,
      .optimization-suggestions {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .conflict-item,
      .suggestion-item {
        background: white;
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid #f44336;
        font-size: 0.9rem;
      }

      .suggestion-item {
        border-left-color: #4caf50;
      }

      .efficiency-metrics {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .efficiency-metrics .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .progress-bar {
        flex: 1;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        margin: 0 10px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #66bb6a);
        border-radius: 3px;
        transition: width 0.5s ease;
      }

      /* ===== PUZZLE 4: COMPREHENSIVE VALIDATION & APPROVAL ===== */
      .validation-approval-system {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
      }

      .validation-dashboard {
        text-align: center;
        margin-bottom: 30px;
      }

      .validation-progress {
        display: inline-block;
        position: relative;
        margin: 20px;
      }

      .progress-ring {
        position: relative;
      }

      .progress-ring-svg {
        transform: rotate(-90deg);
      }

      .progress-ring-circle-bg {
        fill: none;
        stroke: #e9ecef;
        stroke-width: 8;
      }

      .progress-ring-circle {
        fill: none;
        stroke: #4caf50;
        stroke-width: 8;
        stroke-dasharray: 314;
        stroke-dashoffset: 314;
        transition: stroke-dashoffset 0.5s ease;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }

      .progress-text .percentage {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
        display: block;
      }

      .progress-text .label {
        font-size: 0.9rem;
        color: #6c757d;
      }

      .validation-stages {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .stage {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .stage.completed {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .stage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .stage-icon {
        font-size: 1.5rem;
        margin-right: 10px;
      }

      .stage-status {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .stage-status.pending {
        background: #fff3e0;
        color: #f57c00;
      }

      .stage-status.completed {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .validation-checklist {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 15px 0;
      }

      .checklist-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
      }

      .check-content {
        flex: 1;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .check-icon {
        font-size: 1.2rem;
        margin-top: 2px;
      }

      .check-info h5 {
        margin: 0 0 5px 0;
        font-size: 1rem;
        color: #2c3e50;
      }

      .check-info p {
        margin: 0;
        font-size: 0.9rem;
        color: #6c757d;
      }

      .check-controls {
        display: flex;
        gap: 8px;
      }

      .btn-validate {
        padding: 8px 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-validate:hover {
        background: #5a6fd8;
      }

      .btn-validate:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .validation-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      .validation-result.success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }

      .validation-result.error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #f44336;
      }

      .approvals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .approval-card {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 15px;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
      }

      .approval-card.approved {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .entity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .entity-logo {
        font-size: 1.5rem;
        margin-right: 10px;
      }

      .approval-status {
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .approval-status.pending {
        background: #fff3e0;
        color: #f57c00;
      }

      .approval-status.approved {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .approval-details {
        margin: 15px 0;
      }

      .programs-list {
        margin: 10px 0;
      }

      .program-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        font-size: 0.9rem;
      }

      .program-name {
        color: #2c3e50;
      }

      .program-status {
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 6px;
        background: #e3f2fd;
        color: #1565c0;
      }

      .approval-timeline {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin: 10px 0;
      }

      .timeline-step {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        font-size: 0.8rem;
        border-bottom: 1px solid #dee2e6;
      }

      .timeline-step:last-child {
        border-bottom: none;
      }

      .timeline-step.completed {
        color: #2e7d32;
      }

      .timeline-step.active {
        color: #f57c00;
        font-weight: 600;
      }

      .timeline-step.pending {
        color: #6c757d;
      }

      .step-label {
        flex: 1;
      }

      .step-time {
        font-size: 0.7rem;
        color: #6c757d;
      }

      .approval-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
      }

      .btn-request-approval,
      .btn-follow-up {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-request-approval {
        background: #17a2b8;
        color: white;
      }

      .btn-request-approval:hover {
        background: #138496;
      }

      .btn-request-approval:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .btn-follow-up {
        background: #ffc107;
        color: #212529;
      }

      .btn-follow-up:hover {
        background: #e0a800;
      }

      .consent-interface {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
      }

      .felisbina-avatar {
        text-align: center;
        margin-bottom: 20px;
      }

      .avatar-image {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
        margin-bottom: 10px;
      }

      .avatar-status {
        display: flex;
        justify-content: center;
        gap: 15px;
        font-size: 0.9rem;
      }

      .mood-indicator {
        font-size: 1.5rem;
      }

      .comprehension-level {
        color: #6c757d;
      }

      .consent-dialogue {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
      }

      .dialogue-bubble {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
        border-left: 4px solid #667eea;
      }

      .dialogue-bubble::before {
        content: '"';
        font-size: 2rem;
        color: #667eea;
        position: absolute;
        top: -5px;
        left: 10px;
      }

      .explanation-tools {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .tool-btn {
        padding: 8px 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .tool-btn:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      .consent-checklist {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 15px 0;
      }

      .consent-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
      }

      .item-icon {
        font-size: 1.2rem;
      }

      .item-content {
        flex: 1;
      }

      .item-content h5 {
        margin: 0 0 5px 0;
        font-size: 1rem;
        color: #2c3e50;
      }

      .item-content p {
        margin: 0;
        font-size: 0.9rem;
        color: #6c757d;
      }

      .item-status {
        font-size: 1.2rem;
      }

      /* ===== MOBILE RESPONSIVENESS ===== */
      @media (max-width: 1200px) {
        .program-selection-matrix,
        .timeline-workspace {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .felisbina-profile-panel {
          position: static;
        }

        .timeline-row {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .month-labels,
        .timeline-slots {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      @media (max-width: 768px) {
        .main-container {
          padding: 10px;
        }

        .container {
          padding: 20px;
        }

        .back-button,
        .score {
          position: static;
          display: inline-block;
          margin: 5px;
        }

        .program-card,
        .entity-node,
        .activity-item {
          padding: 15px;
          margin: 10px 0;
        }

        .coordination-metrics {
          flex-direction: column;
          gap: 15px;
        }

        .analysis-panels,
        .approvals-grid {
          grid-template-columns: 1fr;
        }

        .month-labels,
        .timeline-slots {
          grid-template-columns: repeat(2, 1fr);
        }

        .btn {
          width: 100%;
          margin: 5px 0;
          padding: 15px;
          font-size: 16px;
        }

        .explanation-tools {
          flex-direction: column;
        }
      }

      /* ===== ANIMATIONS ===== */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      .shake {
        animation: shake 0.5s ease-in-out;
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      /* ===== LOADING STATE ===== */
      .loading {
        text-align: center;
        padding: 50px;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <a href="index.html" class="back-button">‚Üê Voltar ao Menu</a>
    <div class="score">Pontua√ß√£o: <span id="score">0</span>/100</div>

    <div class="main-container">
      <div class="container">
        <div class="header">
          <h1>üéØ SAASI Escape Room - Fase 3</h1>
          <h2>Plano de Interven√ß√£o Avan√ßado</h2>
          <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
          </div>
          <p>Progresso: <span id="progress-text">0%</span></p>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <h3>Inicializando Escape Room Fase 3...</h3>
          <p>Preparando puzzles avan√ßados de planeamento estrat√©gico</p>
        </div>

        <!-- Estado 1: In√≠cio -->
        <div id="state-inicio" class="state">
          <h2>üéØ Bem-vindo √† Fase 3 - Escape Room</h2>
          <div id="phases-summary">
            <h3>üìã Resumo das Fases Anteriores</h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
              "
            >
              <div
                style="background: #e8f5e9; padding: 15px; border-radius: 10px"
              >
                <h4>Fase 1</h4>
                <p>
                  <strong>Pontua√ß√£o:</strong>
                  <span id="phase1-score">0</span>/100
                </p>
                <p><strong>N√≠vel:</strong> <span id="phase1-level">-</span></p>
              </div>
              <div
                style="background: #e3f2fd; padding: 15px; border-radius: 10px"
              >
                <h4>Fase 2</h4>
                <p>
                  <strong>Pontua√ß√£o:</strong>
                  <span id="phase2-score">0</span>/100
                </p>
                <p>
                  <strong>Puzzles:</strong> <span id="phase2-puzzles">0</span>/4
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background: #fff3e0;
              padding: 20px;
              border-radius: 15px;
              margin: 20px 0;
            "
          >
            <h3>üéÆ 4 Puzzles Avan√ßados:</h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-top: 15px;
              "
            >
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #2196f3;
                "
              >
                <h4>üéØ Puzzle 1</h4>
                <p>
                  <strong>Sele√ß√£o de Programas</strong><br />Matriz de adequa√ß√£o
                  avan√ßada
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #17a2b8;
                "
              >
                <h4>ü§ù Puzzle 2</h4>
                <p>
                  <strong>Coordena√ß√£o Din√¢mica</strong><br />Hub de articula√ß√£o
                  interativa
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #ffc107;
                "
              >
                <h4>üìÖ Puzzle 3</h4>
                <p>
                  <strong>Orquestra√ß√£o Timeline</strong><br />Dete√ß√£o autom√°tica
                  de conflitos
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #4caf50;
                "
              >
                <h4>‚úÖ Puzzle 4</h4>
                <p>
                  <strong>Valida√ß√£o Completa</strong><br />Sistema multi-etapa
                  de aprova√ß√£o
                </p>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <button class="btn" onclick="startEscapeRoom()">
              üöÄ Iniciar Escape Room Fase 3
            </button>
          </div>
        </div>

        <!-- Estado 2: Puzzle 1 - Enhanced Program Selection -->
        <div id="state-puzzle1" class="state">
          <h2>üéØ Puzzle 1: Sele√ß√£o de Programas Avan√ßada</h2>
          <p>
            <strong>Objetivo:</strong> Selecione programas com base na adequa√ß√£o
            para a Felisbina. Meta: adequa√ß√£o m√©dia >85%
          </p>

          <div class="program-selection-matrix">
            <div class="felisbina-profile-panel">
              <h3>üë§ Perfil da Felisbina</h3>
              <div class="profile-attributes">
                <div class="attribute">
                  <span class="attr-label">Idade</span>
                  <span class="attr-value">56 anos</span>
                  <div class="compatibility-indicator">‚ö†Ô∏è Fator limitante</div>
                </div>
                <div class="attribute">
                  <span class="attr-label">Escolaridade</span>
                  <span class="attr-value">9¬∫ ano</span>
                  <div class="compatibility-indicator">‚úÖ Adequado</div>
                </div>
                <div class="attribute">
                  <span class="attr-label">Experi√™ncia</span>
                  <span class="attr-value">6 meses limpeza</span>
                  <div class="compatibility-indicator">‚úÖ Vantagem</div>
                </div>
                <div class="attribute">
                  <span class="attr-label">Situa√ß√£o</span>
                  <span class="attr-value">RSI ativo</span>
                  <div class="compatibility-indicator">‚úÖ Eleg√≠vel</div>
                </div>
              </div>
            </div>

            <div class="programs-evaluation-grid" id="programs-container">
              <!-- Programs will be loaded dynamically -->
            </div>

            <div class="selection-summary">
              <h3>üìä Resumo da Sele√ß√£o</h3>
              <div class="selected-programs-list" id="selected-programs-list">
                <!-- Selected programs will appear here -->
              </div>
              <div class="selection-metrics">
                <div class="metric">
                  <span class="label">Adequa√ß√£o M√©dia</span>
                  <span class="value" id="avg-adequacy">0%</span>
                </div>
                <div class="metric">
                  <span class="label">Cobertura de Problemas</span>
                  <span class="value" id="problem-coverage">0%</span>
                </div>
                <div class="metric">
                  <span class="label">Viabilidade Or√ßamental</span>
                  <span class="value" id="budget-viability">0%</span>
                </div>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <p>
              <strong>Progresso:</strong> <span id="puzzle1-progress">0</span>/4
              programas selecionados
            </p>
            <button
              id="btn-continue-puzzle2"
              class="btn"
              onclick="nextPuzzle(2)"
              style="display: none"
            >
              ‚û°Ô∏è Continuar para Puzzle 2
            </button>
          </div>
        </div>

        <!-- Estado 3: Puzzle 2 - Dynamic Entity Coordination -->
        <div id="state-puzzle2" class="state">
          <h2>ü§ù Puzzle 2: Hub de Coordena√ß√£o Din√¢mica</h2>
          <p>
            <strong>Objetivo:</strong> Estabele√ßa coordena√ß√£o eficaz entre
            entidades. Meta: 5+ conex√µes com cronograma s√≠ncrono
          </p>

          <div class="entity-coordination-hub">
            <div class="coordination-dashboard">
              <h3>ü§ù Central de Coordena√ß√£o</h3>
              <div class="coordination-metrics">
                <div class="metric">
                  <span class="label">Entidades Ativas</span>
                  <span class="value" id="active-entities">0/6</span>
                </div>
                <div class="metric">
                  <span class="label">Coordena√ß√£o</span>
                  <span class="value" id="coordination-score">0%</span>
                </div>
                <div class="metric">
                  <span class="label">Tempo Resposta</span>
                  <span class="value" id="avg-response-time">-- dias</span>
                </div>
              </div>
            </div>

            <div class="entity-network-visualization">
              <div class="network-center">
                <div class="felisbina-node">
                  <div class="node-avatar">üë§</div>
                  <span class="node-label">Felisbina</span>
                </div>
              </div>

              <div class="entity-nodes" id="entity-nodes-container">
                <!-- Entity nodes will be positioned around Felisbina -->
              </div>

              <!-- Connection lines container -->
              <div id="connection-lines-container"></div>
            </div>

            <div class="coordination-timeline">
              <h3>üìÖ Cronograma de Coordena√ß√£o</h3>
              <div
                class="timeline-visualization"
                id="coordination-timeline-viz"
              >
                <!-- Timeline tracks will be populated dynamically -->
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <p>
              <strong>Progresso:</strong> <span id="puzzle2-progress">0</span>/5
              entidades coordenadas
            </p>
            <button
              id="btn-continue-puzzle3"
              class="btn"
              onclick="nextPuzzle(3)"
              style="display: none"
            >
              ‚û°Ô∏è Continuar para Puzzle 3
            </button>
          </div>
        </div>

        <!-- Estado 4: Puzzle 3 - Advanced Timeline Orchestrator -->
        <div id="state-puzzle3" class="state">
          <h2>üìÖ Puzzle 3: Orquestra√ß√£o Avan√ßada de Timeline</h2>
          <p>
            <strong>Objetivo:</strong> Construa timeline otimizada com dete√ß√£o
            de conflitos. Meta: utiliza√ß√£o >80% sem conflitos
          </p>

          <div class="timeline-orchestrator">
            <div class="orchestration-controls">
              <div>
                <h3>üéº Orquestra√ß√£o de Interven√ß√µes</h3>
              </div>
              <div class="timeline-tools">
                <button class="tool-btn" onclick="autoSequence()">
                  ü§ñ Sequenciamento Autom√°tico
                </button>
                <button class="tool-btn" onclick="detectConflicts()">
                  ‚ö†Ô∏è Detetor de Conflitos
                </button>
                <button class="tool-btn" onclick="optimizeIntelligent()">
                  ‚ö° Otimiza√ß√£o Inteligente
                </button>
              </div>
            </div>

            <div class="timeline-workspace">
              <div class="activities-palette">
                <h4>üéØ Atividades Dispon√≠veis</h4>
                <div class="activity-categories" id="activity-categories">
                  <!-- Activity categories will be loaded dynamically -->
                </div>
              </div>

              <div class="timeline-canvas-advanced">
                <div class="timeline-header">
                  <div class="month-labels" id="month-labels">
                    <!-- Month labels will be generated -->
                  </div>
                </div>

                <div class="timeline-grid-advanced" id="timeline-grid-advanced">
                  <!-- Timeline rows for each entity -->
                </div>
              </div>
            </div>

            <div class="timeline-analysis">
              <h3>üìä An√°lise do Cronograma</h3>
              <div class="analysis-panels">
                <div class="panel" id="conflicts-panel">
                  <h4>‚ö†Ô∏è Conflitos Detetados</h4>
                  <div class="conflicts-list" id="conflicts-list">
                    <p style="text-align: center; color: #6c757d">
                      Nenhum conflito detetado
                    </p>
                  </div>
                </div>
                <div class="panel" id="optimization-panel">
                  <h4>‚ö° Sugest√µes de Otimiza√ß√£o</h4>
                  <div
                    class="optimization-suggestions"
                    id="optimization-suggestions"
                  >
                    <p style="text-align: center; color: #6c757d">
                      Construa o cronograma para ver sugest√µes
                    </p>
                  </div>
                </div>
                <div class="panel" id="metrics-panel">
                  <h4>üìà M√©tricas de Efici√™ncia</h4>
                  <div class="efficiency-metrics">
                    <div class="metric">
                      <span class="label">Utiliza√ß√£o de Recursos</span>
                      <div class="progress-bar">
                        <div
                          class="progress-fill"
                          id="resource-utilization"
                          style="width: 0%"
                        ></div>
                      </div>
                      <span class="value">0%</span>
                    </div>
                    <div class="metric">
                      <span class="label">Sequenciamento L√≥gico</span>
                      <div class="progress-bar">
                        <div
                          class="progress-fill"
                          id="logical-sequencing"
                          style="width: 0%"
                        ></div>
                      </div>
                      <span class="value">0%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <p>
              <strong>Progresso:</strong>
              <span id="puzzle3-progress">0</span>/12 atividades organizadas
            </p>
            <button
              id="btn-continue-puzzle4"
              class="btn"
              onclick="nextPuzzle(4)"
              style="display: none"
            >
              ‚û°Ô∏è Continuar para Puzzle 4
            </button>
          </div>
        </div>

        <!-- Estado 5: Puzzle 4 - Comprehensive Validation & Approval -->
        <div id="state-puzzle4" class="state">
          <h2>‚úÖ Puzzle 4: Valida√ß√£o e Aprova√ß√£o Compreensiva</h2>
          <p>
            <strong>Objetivo:</strong> Complete todas as valida√ß√µes e obtenha
            aprova√ß√µes. Meta: 100% valida√ß√£o em todas as etapas
          </p>

          <div class="validation-approval-system">
            <div class="validation-dashboard">
              <h3>‚úÖ Central de Valida√ß√£o</h3>
              <div class="validation-progress">
                <div class="progress-ring">
                  <svg class="progress-ring-svg" width="120" height="120">
                    <circle
                      class="progress-ring-circle-bg"
                      cx="60"
                      cy="60"
                      r="50"
                    ></circle>
                    <circle
                      class="progress-ring-circle"
                      cx="60"
                      cy="60"
                      r="50"
                      id="validation-progress-circle"
                    ></circle>
                  </svg>
                  <div class="progress-text">
                    <span class="percentage" id="validation-percentage"
                      >0%</span
                    >
                    <span class="label">Validado</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="validation-stages">
              <div class="stage" id="stage-coherence">
                <div class="stage-header">
                  <div style="display: flex; align-items: center">
                    <div class="stage-icon">üîç</div>
                    <h4>Valida√ß√£o de Coer√™ncia</h4>
                  </div>
                  <div class="stage-status pending">Pendente</div>
                </div>

                <div class="validation-checklist">
                  <div class="checklist-item">
                    <div class="check-content">
                      <div class="check-icon">üìã</div>
                      <div class="check-info">
                        <h5>Objetivos Claros e Espec√≠ficos</h5>
                        <p>
                          Verificar se todos os objetivos s√£o SMART
                          (Espec√≠ficos, Mensur√°veis, Ating√≠veis, Relevantes,
                          Temporais)
                        </p>
                      </div>
                      <div class="check-controls">
                        <button
                          class="btn-validate"
                          onclick="validateObjectives()"
                        >
                          Validar Objetivos
                        </button>
                      </div>
                    </div>
                    <div class="validation-result" id="objectives-result"></div>
                  </div>

                  <div class="checklist-item">
                    <div class="check-content">
                      <div class="check-icon">üìÖ</div>
                      <div class="check-info">
                        <h5>Cronograma Realista</h5>
                        <p>
                          Confirmar que o cronograma √© exequ√≠vel e respeita
                          depend√™ncias
                        </p>
                      </div>
                      <div class="check-controls">
                        <button
                          class="btn-validate"
                          onclick="validateSchedule()"
                        >
                          Validar Cronograma
                        </button>
                      </div>
                    </div>
                    <div class="validation-result" id="schedule-result"></div>
                  </div>

                  <div class="checklist-item">
                    <div class="check-content">
                      <div class="check-icon">üí∞</div>
                      <div class="check-info">
                        <h5>Recursos Adequados</h5>
                        <p>
                          Verificar disponibilidade de recursos humanos e
                          financeiros
                        </p>
                      </div>
                      <div class="check-controls">
                        <button
                          class="btn-validate"
                          onclick="validateResources()"
                        >
                          Validar Recursos
                        </button>
                      </div>
                    </div>
                    <div class="validation-result" id="resources-result"></div>
                  </div>
                </div>
              </div>

              <div class="stage" id="stage-approvals">
                <div class="stage-header">
                  <div style="display: flex; align-items: center">
                    <div class="stage-icon">üìã</div>
                    <h4>Aprova√ß√£o das Entidades</h4>
                  </div>
                  <div class="stage-status pending">Pendente</div>
                </div>

                <div class="approvals-grid" id="approvals-grid">
                  <!-- Approval cards will be generated dynamically -->
                </div>
              </div>

              <div class="stage" id="stage-consent">
                <div class="stage-header">
                  <div style="display: flex; align-items: center">
                    <div class="stage-icon">üë§</div>
                    <h4>Consentimento da Felisbina</h4>
                  </div>
                  <div class="stage-status pending">Pendente</div>
                </div>

                <div class="consent-interface">
                  <div class="felisbina-avatar">
                    <div class="avatar-image">üë§</div>
                    <div class="avatar-status">
                      <span class="mood-indicator" id="mood-indicator">üòê</span>
                      <span class="comprehension-level"
                        >Compreens√£o:
                        <span id="comprehension-level">0%</span></span
                      >
                    </div>
                  </div>

                  <div class="consent-dialogue">
                    <div class="dialogue-bubble" id="dialogue-bubble">
                      <p>"Preciso entender melhor o que vai acontecer..."</p>
                    </div>

                    <div class="explanation-tools">
                      <button class="tool-btn" onclick="explainPrograms()">
                        üìö Explicar Programas
                      </button>
                      <button class="tool-btn" onclick="showTimeline()">
                        üìÖ Mostrar Cronograma
                      </button>
                      <button class="tool-btn" onclick="addressConcerns()">
                        üí≠ Esclarecer D√∫vidas
                      </button>
                    </div>
                  </div>

                  <div class="consent-checklist">
                    <div class="consent-item">
                      <div class="item-icon">üß†</div>
                      <div class="item-content">
                        <h5>Compreens√£o do Plano</h5>
                        <p>
                          Felisbina demonstra compreender os objetivos e etapas
                        </p>
                      </div>
                      <div class="item-status" id="understanding-status">
                        ‚ùå
                      </div>
                    </div>

                    <div class="consent-item">
                      <div class="item-icon">‚úã</div>
                      <div class="item-content">
                        <h5>Consentimento Informado</h5>
                        <p>
                          Felisbina concorda conscientemente com a participa√ß√£o
                        </p>
                      </div>
                      <div class="item-status" id="consent-status">‚ùå</div>
                    </div>

                    <div class="consent-item">
                      <div class="item-icon">üéØ</div>
                      <div class="item-content">
                        <h5>Expectativas Realistas</h5>
                        <p>
                          Felisbina tem expectativas alinhadas com os resultados
                          poss√≠veis
                        </p>
                      </div>
                      <div class="item-status" id="expectations-status">‚ùå</div>
                    </div>
                  </div>

                  <div style="text-align: center; margin-top: 15px">
                    <button
                      class="btn-validate"
                      onclick="finalizeConsent()"
                      id="btn-finalize-consent"
                      disabled
                    >
                      ‚úÖ Finalizar Consentimento
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <p>
              <strong>Progresso:</strong> <span id="puzzle4-progress">0</span>/3
              etapas validadas
            </p>
            <button
              id="btn-finalize-phase"
              class="btn"
              onclick="nextState('conclusao')"
              style="display: none"
            >
              üéâ Finalizar Fase 3
            </button>
          </div>
        </div>

        <!-- Estado 6: Conclus√£o -->
        <div id="state-conclusao" class="state">
          <h1>üéâ Fase 3 Escape Room Conclu√≠da!</h1>

          <div
            style="
              text-align: center;
              background: #e8f5e9;
              padding: 30px;
              border-radius: 10px;
              margin: 20px 0;
            "
          >
            <h2>Pontua√ß√£o Final: <span id="final-score">0</span>/100</h2>
            <h3 id="final-level">T√©cnico Especialista</h3>
            <p>
              <strong>Tempo Total:</strong>
              <span id="total-time">0</span> minutos
            </p>
            <p>
              <strong>Adequa√ß√£o M√©dia:</strong>
              <span id="final-adequacy">0</span>%
            </p>
          </div>

          <div id="final-report">
            <h3>üìä Relat√≥rio de Performance por Puzzle:</h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
              "
            >
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #2196f3;
                "
              >
                <h4>üéØ Puzzle 1: Sele√ß√£o</h4>
                <p>
                  <strong>Pontos:</strong>
                  <span id="puzzle1-final-score">0</span>/25
                </p>
                <p>
                  <strong>Adequa√ß√£o:</strong>
                  <span id="puzzle1-final-adequacy">0</span>%
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #17a2b8;
                "
              >
                <h4>ü§ù Puzzle 2: Coordena√ß√£o</h4>
                <p>
                  <strong>Pontos:</strong>
                  <span id="puzzle2-final-score">0</span>/25
                </p>
                <p>
                  <strong>Entidades:</strong>
                  <span id="puzzle2-final-entities">0</span>/5
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #ffc107;
                "
              >
                <h4>üìÖ Puzzle 3: Timeline</h4>
                <p>
                  <strong>Pontos:</strong>
                  <span id="puzzle3-final-score">0</span>/30
                </p>
                <p>
                  <strong>Utiliza√ß√£o:</strong>
                  <span id="puzzle3-final-utilization">0</span>%
                </p>
              </div>
              <div
                style="
                  background: white;
                  padding: 15px;
                  border-radius: 10px;
                  border-left: 4px solid #4caf50;
                "
              >
                <h4>‚úÖ Puzzle 4: Valida√ß√£o</h4>
                <p>
                  <strong>Pontos:</strong>
                  <span id="puzzle4-final-score">0</span>/20
                </p>
                <p>
                  <strong>Valida√ß√µes:</strong>
                  <span id="puzzle4-final-validations">0</span>/3
                </p>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 30px">
            <button class="btn" onclick="restartPhase3()">
              üîÑ Repetir Fase 3
            </button>
            <button
              class="btn"
              onclick="continueToPhase4()"
              style="background: #4caf50"
            >
              ‚û°Ô∏è Continuar para Fase 4
            </button>
            <a
              href="index.html"
              class="btn"
              style="background: #6c757d; text-decoration: none"
              >‚¨ÖÔ∏è Voltar ao Menu</a
            >
          </div>
        </div>
      </div>
    </div>

    <script src="js/fase3-escape-engine.js"></script>
    <script src="js/phase-data-generator.js"></script>
    <script src="js/url-navigation.js"></script>
    <script>
      // Game state following the exact pattern from fase1-escape.html
      let gameState = {
        currentState: "loading",
        score: 0,
        startTime: Date.now(),
        progress: 0,
        phase1Data: null,
        phase2Data: null,

        // Puzzle-specific states
        puzzle1: {
          score: 0,
          progress: 0,
          selectedPrograms: [],
          rejectedPrograms: [],
          avgAdequacy: 0,
          problemCoverage: 0,
          budgetViability: 0,
          completed: false,
        },
        puzzle2: {
          score: 0,
          progress: 0,
          connectedEntities: [],
          coordinationScore: 0,
          avgResponseTime: 0,
          completed: false,
        },
        puzzle3: {
          score: 0,
          progress: 0,
          placedActivities: {},
          resourceUtilization: 0,
          logicalSequencing: 0,
          conflicts: [],
          completed: false,
        },
        puzzle4: {
          score: 0,
          progress: 0,
          validationStages: {
            coherence: false,
            approvals: false,
            consent: false,
          },
          approvalStatus: {},
          comprehensionLevel: 0,
          completed: false,
        },
      };

      // Initialize the escape room
      document.addEventListener("DOMContentLoaded", async () => {
        await loadPreviousPhases();
        await delay(2000); // Show loading animation

        // Initialize escape room engine
        if (typeof EscapeRoomPhase3 !== "undefined") {
          window.escapeRoom = new EscapeRoomPhase3(gameState);
        }

        startGame();
      });

      // Toast System - exact copy from fase1-escape.html
      function showToast(message, type = "info", duration = 5000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
                ${message}
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Load previous phases data
      async function loadPreviousPhases() {
        const phase1Data = localStorage.getItem("saasi_phase1_results");
        const phase2Data = localStorage.getItem("saasi_phase2_results");

        if (!phase1Data || !phase2Data) {
          showToast(
            "‚ö†Ô∏è Dados das fases anteriores n√£o encontrados. Redirecionando...",
            "error",
            3000
          );
          setTimeout(() => (window.location.href = "index.html"), 3000);
          return;
        }

        gameState.phase1Data = JSON.parse(phase1Data);
        gameState.phase2Data = JSON.parse(phase2Data);

        console.log("Previous phases data loaded:", {
          phase1: gameState.phase1Data,
          phase2: gameState.phase2Data,
        });

        // Check Phase 2 access requirement (60+ points)
        if (gameState.phase2Data.score < 60) {
          showToast(
            "‚ö†Ô∏è Acesso negado √† Fase 3!<br><br>Deve completar a Fase 2 com pelo menos 60 pontos.<br>Redirecionando...",
            "error",
            4000
          );
          setTimeout(() => (window.location.href = "fase2-escape.html"), 4000);
          return;
        }

        // Update summary
        document.getElementById("phase1-score").textContent =
          gameState.phase1Data.score;
        document.getElementById("phase1-level").textContent =
          gameState.phase1Data.level.title;
        document.getElementById("phase2-score").textContent =
          gameState.phase2Data.score;
        document.getElementById("phase2-puzzles").textContent = "4"; // Always 4 puzzles in phase 2
      }

      // Start the game
      function startGame() {
        changeState("inicio");
      }

      // Start escape room
      function startEscapeRoom() {
        changeState("puzzle1");
        if (window.escapeRoom) {
          window.escapeRoom.initializePuzzle1();
        }
      }

      // Change state function - following fase1-escape.html pattern
      function changeState(newState) {
        // Hide current state
        document.querySelectorAll(".state").forEach((state) => {
          state.classList.remove("active");
        });
        document.getElementById("loading").style.display = "none";

        // Show new state
        document.getElementById(`state-${newState}`).classList.add("active");
        gameState.currentState = newState;
        updateProgress();

        // Add fade-in animation
        document.getElementById(`state-${newState}`).classList.add("fade-in");
      }

      // Next puzzle
      function nextPuzzle(puzzleNumber) {
        changeState(`puzzle${puzzleNumber}`);
        if (window.escapeRoom) {
          window.escapeRoom[`initializePuzzle${puzzleNumber}`]();
        }
      }

      // Next state
      function nextState(state) {
        changeState(state);
      }

      // Update progress
      function updateProgress() {
        const states = [
          "loading",
          "inicio",
          "puzzle1",
          "puzzle2",
          "puzzle3",
          "puzzle4",
          "conclusao",
        ];
        const currentIndex = states.indexOf(gameState.currentState);
        const progress =
          Math.max(0, (currentIndex - 1) / (states.length - 2)) * 100;

        document.getElementById("progress").style.width = progress + "%";
        document.getElementById("progress-text").textContent =
          Math.round(progress) + "%";

        // Update score display
        updateScore();
      }

      // Update score
      function updateScore() {
        gameState.score =
          gameState.puzzle1.score +
          gameState.puzzle2.score +
          gameState.puzzle3.score +
          gameState.puzzle4.score;
        document.getElementById("score").textContent = gameState.score;
      }

      // Add score
      function addScore(points, puzzle = null) {
        if (puzzle) {
          gameState[puzzle].score = Math.min(
            gameState[puzzle].score + points,
            25
          );
        }
        updateScore();
      }

      // Puzzle 3 functions
      function autoSequence() {
        if (window.escapeRoom) {
          window.escapeRoom.autoSequence();
        }
      }

      function detectConflicts() {
        if (window.escapeRoom) {
          window.escapeRoom.detectConflicts();
        }
      }

      function optimizeIntelligent() {
        if (window.escapeRoom) {
          window.escapeRoom.optimizeIntelligent();
        }
      }

      // Puzzle 4 functions
      function validateObjectives() {
        if (window.escapeRoom) {
          window.escapeRoom.validateObjectives();
        }
      }

      function validateSchedule() {
        if (window.escapeRoom) {
          window.escapeRoom.validateSchedule();
        }
      }

      function validateResources() {
        if (window.escapeRoom) {
          window.escapeRoom.validateResources();
        }
      }

      function explainPrograms() {
        if (window.escapeRoom) {
          window.escapeRoom.explainPrograms();
        }
      }

      function showTimeline() {
        if (window.escapeRoom) {
          window.escapeRoom.showTimeline();
        }
      }

      function addressConcerns() {
        if (window.escapeRoom) {
          window.escapeRoom.addressConcerns();
        }
      }

      function finalizeConsent() {
        if (window.escapeRoom) {
          window.escapeRoom.finalizeConsent();
        }
      }

      // Show conclusion
      function showConclusion() {
        const duration = Math.round((Date.now() - gameState.startTime) / 60000);

        // Calculate final level
        let level = "T√©cnico Iniciante";
        if (gameState.score >= 95) level = "Mestre SAASI";
        else if (gameState.score >= 85) level = "T√©cnico Especialista";
        else if (gameState.score >= 70) level = "T√©cnico Proficiente";
        else if (gameState.score >= 50) level = "T√©cnico Competente";

        document.getElementById("final-score").textContent = gameState.score;
        document.getElementById("final-level").textContent = level;
        document.getElementById("total-time").textContent = duration;
        document.getElementById("final-adequacy").textContent = Math.round(
          gameState.puzzle1.avgAdequacy
        );

        // Update puzzle reports
        document.getElementById("puzzle1-final-score").textContent =
          gameState.puzzle1.score;
        document.getElementById("puzzle1-final-adequacy").textContent =
          Math.round(gameState.puzzle1.avgAdequacy);
        document.getElementById("puzzle2-final-score").textContent =
          gameState.puzzle2.score;
        document.getElementById("puzzle2-final-entities").textContent =
          gameState.puzzle2.progress;
        document.getElementById("puzzle3-final-score").textContent =
          gameState.puzzle3.score;
        document.getElementById("puzzle3-final-utilization").textContent =
          Math.round(gameState.puzzle3.resourceUtilization);
        document.getElementById("puzzle4-final-score").textContent =
          gameState.puzzle4.score;
        document.getElementById("puzzle4-final-validations").textContent =
          gameState.puzzle4.progress;
      }

      // Continue to Phase 4
      function continueToPhase4() {
        // Save Phase 3 results
        const phase3Results = {
          phase: 3,
          score: gameState.score,
          maxScore: 100,
          percentage: gameState.score,
          duration: Math.round((Date.now() - gameState.startTime) / 60000),
          level: { title: getLevelTitle(gameState.score) },
          puzzleResults: {
            puzzle1: gameState.puzzle1,
            puzzle2: gameState.puzzle2,
            puzzle3: gameState.puzzle3,
            puzzle4: gameState.puzzle4,
          },
          phase1Data: gameState.phase1Data,
          phase2Data: gameState.phase2Data,
        };

        localStorage.setItem(
          "saasi_phase3_results",
          JSON.stringify(phase3Results)
        );

        // Check unlock criteria: 65/100 points (from specification)
        if (gameState.score >= 65) {
          showToast(
            'üéâ Parab√©ns! Desbloqueou a Fase 4!<br><br>C√≥digo de desbloqueio: "INTERVENCAO2025"<br><br>Pontua√ß√£o: ' +
              gameState.score +
              "/100<br><br>Redirecionando para a Fase 4...",
            "success",
            3000
          );
          setTimeout(() => (window.location.href = "fase4-escape.html"), 3000);
        } else {
          showToast(
            "‚ö†Ô∏è Pontua√ß√£o insuficiente para Fase 4!<br><br>Necess√°rio: 65/100 pontos<br>Obtido: " +
              gameState.score +
              "/100<br><br>Tente novamente!",
            "error",
            6000
          );
        }
      }

      // Restart Phase 3
      function restartPhase3() {
        localStorage.removeItem("saasi_phase3_results");
        location.reload();
      }

      // Get level title
      function getLevelTitle(score) {
        if (score >= 95) return "Mestre SAASI";
        if (score >= 85) return "T√©cnico Especialista";
        if (score >= 70) return "T√©cnico Proficiente";
        if (score >= 50) return "T√©cnico Competente";
        return "T√©cnico Iniciante";
      }

      // Utility function for delays
      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // When changing to conclusion, show the report
      const originalChangeState = changeState;
      changeState = function (newState) {
        originalChangeState(newState);
        if (newState === "conclusao") {
          showConclusion();
        }
      };
    </script>
  </body>
</html>
